import{r as hn,g as fn,a as wn}from"./vendor-B4QdQTOU.js";import{_ as vn,a as jn}from"./pdfjs-Cp9nfDvG.js";import{u as Bt,w as Tn}from"./xlsx-DIVJSiuo.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const m of document.querySelectorAll('link[rel="modulepreload"]'))h(m);new MutationObserver(m=>{for(const x of m)if(x.type==="childList")for(const j of x.addedNodes)j.tagName==="LINK"&&j.rel==="modulepreload"&&h(j)}).observe(document,{childList:!0,subtree:!0});function N(m){const x={};return m.integrity&&(x.integrity=m.integrity),m.referrerPolicy&&(x.referrerPolicy=m.referrerPolicy),m.crossOrigin==="use-credentials"?x.credentials="include":m.crossOrigin==="anonymous"?x.credentials="omit":x.credentials="same-origin",x}function h(m){if(m.ep)return;m.ep=!0;const x=N(m);fetch(m.href,x)}})();var Zt={exports:{}},Wt={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var nn;function kn(){if(nn)return Wt;nn=1;var t=hn(),o=Symbol.for("react.element"),N=Symbol.for("react.fragment"),h=Object.prototype.hasOwnProperty,m=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,x={key:!0,ref:!0,__self:!0,__source:!0};function j(c,d,v){var p,k={},w=null,L=null;v!==void 0&&(w=""+v),d.key!==void 0&&(w=""+d.key),d.ref!==void 0&&(L=d.ref);for(p in d)h.call(d,p)&&!x.hasOwnProperty(p)&&(k[p]=d[p]);if(c&&c.defaultProps)for(p in d=c.defaultProps,d)k[p]===void 0&&(k[p]=d[p]);return{$$typeof:o,type:c,key:w,ref:L,props:k,_owner:m.current}}return Wt.Fragment=N,Wt.jsx=j,Wt.jsxs=j,Wt}var sn;function Cn(){return sn||(sn=1,Zt.exports=kn()),Zt.exports}var e=Cn(),s=hn();const at=fn(s);var Gt={},on;function Ln(){if(on)return Gt;on=1;var t=wn();return Gt.createRoot=t.createRoot,Gt.hydrateRoot=t.hydrateRoot,Gt}var Sn=Ln();const An=fn(Sn);let Xt;const En=new Uint8Array(16);function Rn(){if(!Xt&&(Xt=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Xt))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Xt(En)}const qe=[];for(let t=0;t<256;++t)qe.push((t+256).toString(16).slice(1));function In(t,o=0){return qe[t[o+0]]+qe[t[o+1]]+qe[t[o+2]]+qe[t[o+3]]+"-"+qe[t[o+4]]+qe[t[o+5]]+"-"+qe[t[o+6]]+qe[t[o+7]]+"-"+qe[t[o+8]]+qe[t[o+9]]+"-"+qe[t[o+10]]+qe[t[o+11]]+qe[t[o+12]]+qe[t[o+13]]+qe[t[o+14]]+qe[t[o+15]]}const Dn=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),rn={randomUUID:Dn};function Me(t,o,N){if(rn.randomUUID&&!t)return rn.randomUUID();t=t||{};const h=t.random||(t.rng||Rn)();return h[6]=h[6]&15|64,h[8]=h[8]&63|128,In(h)}const Mn=({onFileSelect:t})=>{const[o,N]=s.useState(!1),h=s.useCallback(d=>{d.preventDefault(),d.stopPropagation(),N(!0)},[]),m=s.useCallback(d=>{d.preventDefault(),d.stopPropagation(),N(!1)},[]),x=s.useCallback(d=>{d.preventDefault(),d.stopPropagation()},[]),j=s.useCallback(d=>{d.preventDefault(),d.stopPropagation(),N(!1),d.dataTransfer.files&&d.dataTransfer.files.length>0&&(d.dataTransfer.files[0].type==="application/pdf"&&t(d.dataTransfer.files[0]),d.dataTransfer.clearData())},[t]),c=d=>{d.target.files&&d.target.files[0]&&t(d.target.files[0])};return e.jsx("div",{className:"flex items-center justify-center h-full p-8",children:e.jsxs("div",{className:`w-full max-w-2xl h-full max-h-[500px] border-2 border-dashed rounded-xl flex flex-col items-center justify-center text-center transition-colors ${o?"border-sky-400 bg-sky-50":"border-gray-300 bg-gray-50"}`,onDragEnter:h,onDragLeave:m,onDragOver:x,onDrop:j,children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:`h-16 w-16 mb-4 transition-colors ${o?"text-sky-400":"text-gray-500"}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 16a4 4 0 01-4-4V6a2 2 0 012-2h10a2 2 0 012 2v6a4 4 0 01-4 4H7z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 9v6m3-3H7"})]}),e.jsx("h2",{className:"text-2xl font-bold mb-2 text-gray-800",children:"P&ID 도면 업로드"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"PDF 파일을 여기에 끌어다 놓거나 클릭하여 선택하세요."}),e.jsx("label",{htmlFor:"file-upload",className:"cursor-pointer px-6 py-2.5 text-sm font-semibold text-white bg-sky-600 rounded-md hover:bg-sky-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 focus:ring-offset-white",children:"파일 선택"}),e.jsx("input",{id:"file-upload",type:"file",className:"hidden",accept:".pdf",onChange:c})]})})},b={Line:"Line",Instrument:"Instrument",DrawingNumber:"DrawingNumber",NotesAndHolds:"NotesAndHolds",Uncategorized:"Uncategorized"},ne={Connection:"Connection",Installation:"Installation",Annotation:"Annotation",Note:"Note",Description:"Description"},Tt={[b.Line]:'^.*".*-.*-.*$',[b.Instrument]:{func:"[A-Z]{2,4}",num:"\\d{3,4}(?:\\s?[A-Z])?"},[b.DrawingNumber]:"[A-Z0-9][A-Z0-9\\-]{10,}",[b.NotesAndHolds]:"^(NOTE|HOLD).*"},Vt={[b.Instrument]:{vertical:15,horizontal:20,autoLinkDistance:30}},_e={autoGenerateLoops:!0,autoRemoveWhitespace:!0,hyphenSettings:{line:!1,instrument:!0,drawingNumber:!1,notesAndHolds:!1},drawingSearchArea:{unit:"percent",enabled:!0,top:5,right:95,bottom:20,left:5,showOverlay:!1},sheetNoPattern:"^\\d{3}$",combineDrawingAndSheet:!0,sheetNoTolerancePx:3,sheetNoTolerance:60,loopRules:{TT:"T",TE:"T",TI:"T",TC:"T",TCV:"T",TSH:"T",TSL:"T",TIS:"T",TXT:"T",PT:"P",PE:"P",PI:"P",PC:"P",PCV:"P",PSH:"P",PSL:"P",PIT:"P",PDT:"P",PSV:"P",FT:"F",FE:"F",FI:"F",FC:"F",FCV:"F",FSH:"F",FSL:"F",FIT:"F",FIC:"F",FICA:"F",LT:"L",LE:"L",LI:"L",LC:"L",LCV:"L",LSH:"L",LSL:"L",LIT:"L",LIC:"L",AT:"A",AE:"A",AI:"A",AC:"A",AIC:"A",XV:"X",XCV:"X",HV:"H",HCV:"H",HS:"H",HC:"H",HIC:"H",ZT:"Z",ZI:"Z",ZS:"Z",VT:"V",VE:"V",VSH:"V"},instrumentMappings:{TE:{instrumentType:"TEMPERATURE ELEMENT",ioType:"AI"},TT:{instrumentType:"TEMPERATURE TRANSMITTER",ioType:"AI"},TC:{instrumentType:"TEMPERATURE CONTROLLER",ioType:"AO"},TI:{instrumentType:"TEMPERATURE INDICATOR",ioType:"Local"},TCV:{instrumentType:"TEMPERATURE CONTROL VALVE",ioType:"AO"},TSH:{instrumentType:"TEMPERATURE SWITCH HIGH",ioType:"DI"},TSL:{instrumentType:"TEMPERATURE SWITCH LOW",ioType:"DI"},TIS:{instrumentType:"TEMPERATURE INDICATOR WITH SWITCH",ioType:"DI"},TXT:{instrumentType:"TEMPERATURE SWITCH",ioType:"DI"},TIC:{instrumentType:"TEMPERATURE INDICATING CONTROLLER",ioType:"AO"},PE:{instrumentType:"PRESSURE ELEMENT",ioType:"AI"},PT:{instrumentType:"PRESSURE TRANSMITTER",ioType:"AI"},PI:{instrumentType:"PRESSURE INDICATOR",ioType:"Local"},PC:{instrumentType:"PRESSURE CONTROLLER",ioType:"AO"},PCV:{instrumentType:"PRESSURE CONTROL VALVE",ioType:"AO"},PSH:{instrumentType:"PRESSURE SWITCH HIGH",ioType:"DI"},PSL:{instrumentType:"PRESSURE SWITCH LOW",ioType:"DI"},PIT:{instrumentType:"PRESSURE INDICATING TRANSMITTER",ioType:"AI"},PIC:{instrumentType:"PRESSURE INDICATING CONTROLLER",ioType:"AO"},PY:{instrumentType:"PRESSURE CONVERTER/COMPUTER",ioType:"AI"},LE:{instrumentType:"LEVEL ELEMENT",ioType:"AI"},LT:{instrumentType:"LEVEL TRANSMITTER",ioType:"AI"},LI:{instrumentType:"LEVEL INDICATOR",ioType:"Local"},LC:{instrumentType:"LEVEL CONTROLLER",ioType:"AO"},LCV:{instrumentType:"LEVEL CONTROL VALVE",ioType:"AO"},LSH:{instrumentType:"LEVEL SWITCH HIGH",ioType:"DI"},LSL:{instrumentType:"LEVEL SWITCH LOW",ioType:"DI"},LIT:{instrumentType:"LEVEL INDICATING TRANSMITTER",ioType:"AI"},FE:{instrumentType:"FLOW ELEMENT",ioType:"AI"},FT:{instrumentType:"FLOW TRANSMITTER",ioType:"AI"},FI:{instrumentType:"FLOW INDICATOR",ioType:"Local"},FC:{instrumentType:"FLOW CONTROLLER",ioType:"AO"},FCV:{instrumentType:"FLOW CONTROL VALVE",ioType:"AO"},FSH:{instrumentType:"FLOW SWITCH HIGH",ioType:"DI"},FSL:{instrumentType:"FLOW SWITCH LOW",ioType:"DI"},FIT:{instrumentType:"FLOW INDICATING TRANSMITTER",ioType:"AI"},FDI:{instrumentType:"FLOW DIFFERENTIAL INDICATOR",ioType:"Local"},AE:{instrumentType:"ANALYSIS ELEMENT",ioType:"AI"},AT:{instrumentType:"ANALYSIS TRANSMITTER",ioType:"AI"},AI:{instrumentType:"ANALYSIS INDICATOR",ioType:"Local"},AC:{instrumentType:"ANALYSIS CONTROLLER",ioType:"AO"},HV:{instrumentType:"HAND VALVE",ioType:"Local"},HCV:{instrumentType:"HAND CONTROL VALVE",ioType:"Local"},PSV:{instrumentType:"PRESSURE SAFETY VALVE",ioType:"Local"},XV:{instrumentType:"ON/OFF VALVE",ioType:"DO"},XCV:{instrumentType:"ON/OFF CONTROL VALVE",ioType:"DO"},HS:{instrumentType:"HAND SWITCH",ioType:"DI"},HC:{instrumentType:"HAND CONTROLLER",ioType:"DO"},ZI:{instrumentType:"POSITION INDICATOR",ioType:"Local"},ZT:{instrumentType:"POSITION TRANSMITTER",ioType:"AI"},ZS:{instrumentType:"POSITION SWITCH",ioType:"DI"},VE:{instrumentType:"VIBRATION ELEMENT",ioType:"AI"},VT:{instrumentType:"VIBRATION TRANSMITTER",ioType:"AI"},VSH:{instrumentType:"VIBRATION SWITCH HIGH",ioType:"DI"},TG:{instrumentType:"TEMPERATURE GAUGE",ioType:"Local"},TV:{instrumentType:"TEMPERATURE VALVE",ioType:"AO"},TAG:{instrumentType:"TEMPERATURE ALARM GENERAL",ioType:"DO"},TXE:{instrumentType:"TEMPERATURE ELEMENT (STATUS)",ioType:"AI"},TXI:{instrumentType:"TEMPERATURE STATUS INDICATOR",ioType:"DI"},TXHH:{instrumentType:"TEMPERATURE ALARM VERY HIGH",ioType:"DO"},PG:{instrumentType:"PRESSURE GAUGE",ioType:"Local"},PDI:{instrumentType:"PRESSURE DIFFERENTIAL INDICATOR",ioType:"Local"},PDT:{instrumentType:"PRESSURE DIFFERENTIAL TRANSMITTER",ioType:"AI"},PDY:{instrumentType:"PRESSURE DIFFERENTIAL CONVERTER",ioType:"AI"},PV:{instrumentType:"PRESSURE VALVE",ioType:"AO"},PXI:{instrumentType:"PRESSURE STATUS INDICATOR",ioType:"DI"},PXT:{instrumentType:"PRESSURE STATUS TRANSMITTER",ioType:"AI"},PXLL:{instrumentType:"PRESSURE ALARM VERY LOW",ioType:"DO"},PDV:{instrumentType:"PRESSURE DIFFERENTIAL VALVE",ioType:"AO"},PDXI:{instrumentType:"PRESSURE DIFFERENTIAL STATUS INDICATOR",ioType:"DI"},PDXT:{instrumentType:"PRESSURE DIFFERENTIAL STATUS TRANSMITTER",ioType:"AI"},PDIC:{instrumentType:"PRESSURE DIFFERENTIAL INDICATING CONTROLLER",ioType:"AO"},FIC:{instrumentType:"FLOW INDICATING CONTROLLER",ioType:"AO"},FV:{instrumentType:"FLOW VALVE",ioType:"AO"},FY:{instrumentType:"FLOW CONVERTER/COMPUTER",ioType:"AI"},FXI:{instrumentType:"FLOW STATUS INDICATOR",ioType:"DI"},FXT:{instrumentType:"FLOW STATUS TRANSMITTER",ioType:"AI"},FXY:{instrumentType:"FLOW STATUS CONVERTER",ioType:"AI"},FXLL:{instrumentType:"FLOW ALARM VERY LOW",ioType:"DO"},LG:{instrumentType:"LEVEL GAUGE",ioType:"Local"},LIC:{instrumentType:"LEVEL INDICATING CONTROLLER",ioType:"AO"},LXI:{instrumentType:"LEVEL STATUS INDICATOR",ioType:"DI"},LXT:{instrumentType:"LEVEL STATUS TRANSMITTER",ioType:"AI"},LXHH:{instrumentType:"LEVEL ALARM VERY HIGH",ioType:"DO"},HIC:{instrumentType:"HAND INDICATING CONTROLLER",ioType:"AO"},HSW:{instrumentType:"HAND SWITCH",ioType:"DI"},ESD:{instrumentType:"EMERGENCY SHUTDOWN",ioType:"DI"},XPB:{instrumentType:"AUXILIARY PUSH BUTTON",ioType:"DI"}}},qt={[b.Line]:{border:"border-rose-400",bg:"bg-rose-500/20",text:"text-rose-400"},[b.Instrument]:{border:"border-amber-400",bg:"bg-amber-500/20",text:"text-amber-400"},[b.DrawingNumber]:{border:"border-indigo-400",bg:"bg-indigo-500/20",text:"text-indigo-400"},[b.NotesAndHolds]:{border:"border-teal-400",bg:"bg-teal-500/20",text:"text-teal-400"},[b.Uncategorized]:{border:"border-slate-500",bg:"bg-slate-500/20",text:"text-slate-400"}},Ke={entities:{line:"#fb7185",instrument:"#fbbf24",drawingNumber:"#818cf8",notesAndHolds:"#14b8a6",uncategorized:"#94a3b8",description:"#a855f7"},relationships:{connection:"#38bdf8",installation:"#facc15",annotation:"#a78bfa",note:"#14b8a6"},highlights:{primary:"#ef4444",note:"#8b5cf6",description:"#a855f7",related:"#6366f1",noteRelated:"#6366f1",selected:"#ef4444"}},_t=at.memo(({bbox:t,type:o,effect:N,isPinged:h=!1,isSelected:m=!1,isHighlighted:x=!1,isMultiSelection:j=!1,customColor:c,colorSettings:d})=>{const{x1:v,y1:p,x2:k,y2:w}=t,L=Math.min(v,k),U=Math.min(p,w),z=Math.abs(k-v),P=Math.abs(w-p),W={...Ke.highlights,...(d==null?void 0:d.highlights)||{}},de=c||W[o]||W.primary;if(!(h||m||x))return null;const G=()=>null,F=()=>{if(N!=="box"&&N!=="all")return null;const g=4,K=h?"ping-highlight-box":"";return e.jsx("rect",{x:L-g,y:U-g,width:z+g*2,height:P+g*2,fill:"none",stroke:de,strokeWidth:h?"3":"2",className:K,rx:"4"})},I=()=>N!=="outline"&&N!=="all"?null:e.jsx("rect",{x:L,y:U,width:z,height:P,fill:`${de}99`,stroke:de,strokeWidth:"2",rx:"2",className:x?"animate-pulse":""});return e.jsxs("g",{children:[F(),I(),G()]})}),On=(t,o,N)=>t?"arrows":N?"outline":"all",Pn=at.memo(({rel:t,start:o,end:N,strokeColor:h,marker:m,isPinged:x})=>{const j=x?"4":t.type===ne.Note?"2.5":"2",c=x?"#ef4444":h,d=x?"none":t.type===ne.Annotation||t.type===ne.Note?"3 3":"none",v=t.type===ne.Note;return e.jsxs("g",{children:[v&&!x&&e.jsx("line",{x1:o.x,y1:o.y,x2:N.x,y2:N.y,stroke:c,strokeWidth:"6",strokeOpacity:"0.15",strokeDasharray:"none",strokeLinecap:"round"}),e.jsx("line",{x1:o.x,y1:o.y,x2:N.x,y2:N.y,stroke:c,strokeWidth:j,strokeDasharray:d,markerEnd:m,className:x?"ping-highlight-line":v?"note-connection-line":"",strokeLinecap:v?"round":"butt"}),x&&e.jsx("line",{x1:o.x,y1:o.y,x2:N.x,y2:N.y,stroke:"#ef4444",strokeWidth:"8",strokeOpacity:"0.3",strokeDasharray:"none",className:"ping-highlight-line-glow"})]})}),Hn=({pdfDoc:t,tags:o,setTags:N,relationships:h,setRelationships:m,currentPage:x,setCurrentPage:j,selectedTagIds:c,setSelectedTagIds:d,selectedDescriptionIds:v,setSelectedDescriptionIds:p,rawTextItems:k,descriptions:w,onCreateTag:L,onCreateDescription:U,onCreateHoldDescription:z,selectedRawTextItemIds:P,setSelectedRawTextItemIds:W,onDeleteTags:ie,onMergeRawTextItems:de,onManualCreateLoop:he,onManualAreaSelect:G,onUpdateTagText:F,onUpdateRawTextItemText:I,scale:g,setScale:K,mode:V,setMode:ue,relationshipStartTag:ge,setRelationshipStartTag:Ee,visibilitySettings:se,updateVisibilitySettings:fe,pingedTagId:Oe,pingedDescriptionId:Xe,pingedRelationshipId:Ue,colorSettings:ce,scrollToCenter:ae,setScrollToCenter:we,showAutoLinkRanges:ke,tolerances:Ae,showAllRelationships:Re,setShowAllRelationships:Be,showOnlySelectedRelationships:ze,setShowOnlySelectedRelationships:ve,onOPCTagClick:Pe,detectedLines:$e=[],appSettings:Se})=>{const Ie=s.useRef(null),$=s.useRef(null),Z=s.useRef(null),Ce=s.useRef({x:0,y:0}),S=s.useRef(!1),[T,X]=s.useState(null),[le,Le]=s.useState(0),[He,Te]=s.useState(!1),[Fe,Ye]=s.useState(null),[lt,Je]=s.useState(new Set),[It,Nt]=s.useState(new Set),[dt,wt]=s.useState(null),[ct,Qe]=s.useState(null),[nt,mt]=s.useState(""),At=s.useRef(null),We=s.useRef(null),[Ge,st]=s.useState(null),[ht,ot]=s.useState(null),[et,ft]=s.useState(Number.isFinite(Se==null?void 0:Se.sheetNoTolerance)?Number(Se.sheetNoTolerance):80),je=s.useMemo(()=>{const n=(Se==null?void 0:Se.sheetNoPattern)||"^\\d{3}$";try{return new RegExp(n)}catch{return/^\d{3}$/}},[Se==null?void 0:Se.sheetNoPattern]);s.useEffect(()=>{Number.isFinite(Se==null?void 0:Se.sheetNoTolerance)&&ft(Number(Se.sheetNoTolerance))},[Se==null?void 0:Se.sheetNoTolerance]);const Dt=(n,y)=>y.x2<=n.x1?n.x1-y.x2:y.x1>=n.x2?y.x1-n.x2:0,Mt=n=>({x1:n.x1*g,y1:n.y1*g,x2:n.x2*g,y2:n.y2*g,w:(n.x2-n.x1)*g,h:(n.y2-n.y1)*g,cx:(n.x1+n.x2)/2*g,cy:(n.y1+n.y2)/2*g}),Ot=(n,y)=>{const E=Math.max(n.y1,y.y1),f=Math.min(n.y2,y.y2),H=Math.max(0,f-E),B=Math.min(n.h,y.h)||1;return H/B},Et=s.useCallback(n=>{if(!T||!n)return null;const y=Mt(n.bbox),E=k.filter(f=>f.page===x).map(f=>({...f,rect:Mt(f.bbox)})).filter(f=>{const H=f.rect.x2<=y.x1,B=f.rect.x1>=y.x2;if(!H&&!B)return!1;const ee=Dt(y,f.rect);return ee<0||ee>et||Ot(y,f.rect)<.1?!1:je.test(f.text)}).map(f=>{const H=Dt(y,f.rect),B=Ot(y,f.rect),ee=1e4-H*100+B*50;return{item:f,dist:H,vScore:B,score:ee}}).sort((f,H)=>H.score-f.score);return E.length>0?E[0].item:null},[T,k,x,g,et,je]);s.useEffect(()=>{if(!c||c.length!==1)return;const n=o.find(H=>H.id===c[0]);if(!n||n.page!==x||n.category!==b.DrawingNumber)return;const y=Et(n);if(!y)return;if(!h.some(H=>H.type===ne.Annotation&&H.from===n.id&&H.to===y.id)){const H={id:Me(),from:n.id,to:y.id,type:ne.Annotation};m(B=>[...B,H])}W([y.id]),Nt(new Set([y.id]));const f=setTimeout(()=>Nt(new Set),2e3);return()=>clearTimeout(f)},[c,x,o,h,m,W,Nt,Et]);const Ct=s.useCallback(()=>{if(Ge){const{targetTagId:n,targetPage:y}=Ge;ot({targetTagId:n,targetPage:y}),j(y),st(null)}},[Ge,j,x]);s.useEffect(()=>{if(ht&&x===ht.targetPage&&T){const{targetTagId:n}=ht;if(o.find(E=>E.id===n&&E.page===x)){const E=setTimeout(()=>{d([n]),ut(new Set([n]));const f={tagId:n,timestamp:Date.now()};we(f),ot(null),setTimeout(()=>{ut(new Set)},2e3)},300);return()=>clearTimeout(E)}}},[x,ht,T,o,d,we]);const[Lt,ut]=s.useState(new Set);s.useEffect(()=>{(dt||ct)&&At.current&&(At.current.focus(),At.current.select())},[dt,ct]),s.useEffect(()=>{c.length>0?ut(new Set(c)):ut(new Set)},[c]),s.useEffect(()=>(We.current&&(clearTimeout(We.current),We.current=null),Lt.size>0&&(We.current=setTimeout(()=>{ut(new Set),We.current=null},3e3)),()=>{We.current&&(clearTimeout(We.current),We.current=null)}),[Lt]);const pt=s.useCallback((n=!0)=>{n&&nt.trim()&&(dt?F(dt,nt.trim()):ct&&I(ct,nt.trim())),wt(null),Qe(null),mt("")},[dt,ct,nt,F,I]);s.useCallback(n=>{n.key==="Enter"?(n.preventDefault(),pt(!0)):n.key==="Escape"&&(n.preventDefault(),pt(!1))},[pt]);const De=s.useMemo(()=>{const n=new Set(h.filter(y=>y.type===ne.Note).map(y=>y.to));return new Set(h.filter(y=>y.type!==ne.Annotation?!1:n.has(y.from)).map(y=>y.to))},[h]),Ne={entities:{...Ke.entities,...(ce==null?void 0:ce.entities)||{}},relationships:{...Ke.relationships,...(ce==null?void 0:ce.relationships)||{}},highlights:{...Ke.highlights,...(ce==null?void 0:ce.highlights)||{}}},tt=s.useCallback(n=>{switch(n){case b.Line:return Ne.entities.line;case b.Instrument:return Ne.entities.instrument;case b.DrawingNumber:return Ne.entities.drawingNumber;case b.NotesAndHolds:return Ne.entities.notesAndHolds;default:return Ne.entities.uncategorized}},[Ne]),St=s.useCallback(n=>{switch(n){case ne.Connection:return Ne.relationships.connection;case ne.Installation:return Ne.relationships.installation;case ne.Annotation:return Ne.relationships.annotation;case ne.Note:return Ne.relationships.note;default:return"#94a3b8"}},[Ne]),Pt=s.useCallback(n=>{switch(n.category){case b.Line:return se.tags.line;case b.Instrument:return se.tags.instrument;case b.DrawingNumber:return se.tags.drawingNumber;case b.NotesAndHolds:return se.tags.notesAndHolds;default:return!0}},[se.tags]),Ht=s.useCallback(n=>{switch(n.type){case ne.Connection:return se.relationships.connection;case ne.Installation:return se.relationships.installation;case ne.Annotation:return se.relationships.annotation;case ne.Note:return se.relationships.note;case ne.Description:return!1;default:return!0}},[se.relationships]),gt=s.useRef(!1),[ye,i]=s.useState(!1),a=s.useRef({scrollX:0,scrollY:0,clientX:0,clientY:0}),u=s.useRef(null),A=s.useRef(0),C=s.useRef(Promise.resolve()),M=s.useCallback(async n=>{if(!t)return;const y=++A.current;return C.current=C.current.then(async()=>{if(A.current===y){if(u.current){try{u.current.cancel()}catch{}u.current=null,await new Promise(E=>setTimeout(E,10))}try{const E=await t.getPage(n);if(A.current!==y)return;const f=E.getViewport({scale:g}),H=Ie.current;if(!H)return;const B=H.getContext("2d");if(!B||(B.clearRect(0,0,H.width,H.height),H.height=f.height,H.width=f.width,B.clearRect(0,0,H.width,H.height),A.current!==y))return;const ee={canvasContext:B,viewport:f};u.current=E.render(ee),await u.current.promise,A.current===y&&(X(f),Le(f.rotation))}catch(E){E.name}finally{u.current&&(u.current=null)}}}),C.current},[t,g]);s.useLayoutEffect(()=>(M(x),()=>{if(A.current++,u.current){try{u.current.cancel()}catch{}u.current=null}}),[x,M,g]),s.useEffect(()=>{let n=new Set,y=new Set;if(c.length>0&&(y=new Set(h.filter(E=>E.type===ne.Annotation&&c.includes(E.from)).map(E=>E.to)),c.length===1)){const E=o.find(f=>f.id===c[0]);E&&(E.category===b.Instrument||E.category===b.Line)&&(n=new Set(h.filter(f=>f.type===ne.Installation&&f.to===E.id).map(f=>f.from)))}Je(n),Nt(y)},[c,h,o]),s.useEffect(()=>{if(ae&&T&&Z.current){let n=ae.x,y=ae.y;if(ae.tagId&&(!ae.x||!ae.y)){const E=o.find(f=>f.id===ae.tagId);if(E){const{x1:f,y1:H,x2:B,y2:ee}=E.bbox,te=(f+B)/2,xe=(H+ee)/2,me=pe(te,xe);n=me.x,y=me.y}}else if(ae.descriptionId&&(!ae.x||!ae.y)){const E=w.find(f=>f.id===ae.descriptionId);if(E){const{x1:f,y1:H,x2:B,y2:ee}=E.bbox,te=(f+B)/2,xe=(H+ee)/2,me=pe(te,xe);n=me.x,y=me.y}}if(n!==void 0&&y!==void 0){const E=Z.current,f=E.getBoundingClientRect(),H=n-f.width/2,B=y-f.height/2;E.scrollTo({left:Math.max(0,H),top:Math.max(0,B),behavior:"smooth"})}}},[ae,T,o,k]),s.useEffect(()=>{const n=y=>{const E=y.target;if(!(E.tagName==="INPUT"||E.tagName==="TEXTAREA"||E.tagName==="SELECT"))if(y.key==="1")P.length>0?(L(k.filter(f=>P.includes(f.id)),b.Line),W([])):(G(),setTimeout(()=>{const f=new CustomEvent("manualTagCreate",{detail:{category:b.Line}});window.dispatchEvent(f)},100)),y.preventDefault();else if(y.key==="2")P.length>0?(L(k.filter(f=>P.includes(f.id)),b.Line),W([])):(G(),setTimeout(()=>{const f=new CustomEvent("manualTagCreate",{detail:{category:b.Line}});window.dispatchEvent(f)},100)),y.preventDefault();else if(y.key==="3")P.length>0?(L(k.filter(f=>P.includes(f.id)),b.Instrument),W([])):(G(),setTimeout(()=>{const f=new CustomEvent("manualTagCreate",{detail:{category:b.Instrument}});window.dispatchEvent(f)},100)),y.preventDefault();else if(y.key==="4")P.length>0?(L(k.filter(f=>P.includes(f.id)),b.Instrument),W([])):(G(),setTimeout(()=>{const f=new CustomEvent("manualTagCreate",{detail:{category:b.Instrument}});window.dispatchEvent(f)},100)),y.preventDefault();else if(y.key==="5")P.length>0?(L(k.filter(f=>P.includes(f.id)),b.NotesAndHolds),W([])):(G(),setTimeout(()=>{const f=new CustomEvent("manualTagCreate",{detail:{category:b.NotesAndHolds}});window.dispatchEvent(f)},100)),y.preventDefault();else if(y.key==="6")P.length>0?W([]):(G(),setTimeout(()=>{window.dispatchEvent(event)},100)),y.preventDefault();else if(y.key==="Delete"||y.key==="Backspace")c.length>0&&(y.preventDefault(),ie(c),d([]));else if(y.key==="F2"){if(c.length===1){const f=c[0],H=o.find(B=>B.id===f);H&&(wt(f),Qe(null),mt(H.text))}else if(P.length===1){const f=P[0],H=k.find(B=>B.id===f);H&&(Qe(f),wt(null),mt(H.text))}y.preventDefault()}else if(y.key.toLowerCase()==="c")if(c.length>=2){y.preventDefault();const f=c.map(B=>o.find(ee=>ee.id===B)).filter(B=>!!B),H=[];for(let B=0;B<f.length-1;B++){const ee=f[B],te=f[B+1];h.some(me=>me.from===ee.id&&me.to===te.id&&me.type===ne.Connection)||H.push({id:Me(),from:ee.id,to:te.id,type:ne.Connection})}H.length>0&&m(B=>[...B,...H]),d([]),W([])}else V==="connect"?(ue("select"),Ee(null)):(ue("connect"),c.length===1?(o.find(f=>f.id===c[0]),Ee(c[0])):(Ee(null),d([])),W([]));else if(y.key.toLowerCase()==="k")V==="manualCreate"?ue("select"):(ue("manualCreate"),Ee(null),d([]),W([]));else if(y.key==="Escape")ue("select"),Ee(null),d([]),W([]);else if(y.key.toLowerCase()==="m")P.length>=2?(de(P),W([])):alert("The 'M' hotkey merges multiple selected text items into one. Select at least 2 text items first.");else if(y.key.toLowerCase()==="n"){const f=o.filter(ee=>c.includes(ee.id)),H=k.filter(ee=>P.includes(ee.id)),B=[...f,...H];B.length>0?(U(B),d([]),W([])):alert("Select tags or text items first, then press 'N' to create a description.")}else if(y.key.toLowerCase()==="h"){const f=o.filter(ee=>c.includes(ee.id)),H=k.filter(ee=>P.includes(ee.id)),B=[...f,...H];B.length>0?(z(B),d([]),W([])):alert("Select tags or text items first, then press 'H' to create a hold description.")}else if(y.key.toLowerCase()==="r"&&V==="select"&&(c.length>0||P.length>0)){const f=[],H=o.filter(te=>c.includes(te.id)),B=[b.Instrument,b.Line],ee=H.filter(te=>B.includes(te.category));if(ee.length>1){alert("Please select only one Equipment, Line, or Instrument tag at a time to create relationships.");return}if(ee.length===1){const te=ee[0],xe=H.filter(me=>me.category===b.NotesAndHolds);if(te.category===b.Instrument){const me={x:(te.bbox.x1+te.bbox.x2)/2,y:(te.bbox.y1+te.bbox.y2)/2},Ve=te.bbox.x2-te.bbox.x1,yt=te.bbox.y2-te.bbox.y1,vt=Math.sqrt(Ve*Ve+yt*yt)/2*3,bt=(xt,jt,it)=>{const Ze=Math.max(it.x1,Math.min(xt.x,it.x2)),tn=Math.max(it.y1,Math.min(xt.y,it.y2)),$t=xt.x-Ze,Ut=xt.y-tn;return Math.sqrt($t*$t+Ut*Ut)<=jt};for(const xt of xe)bt(me,vt,xt.bbox)&&f.push({id:Me(),from:te.id,to:xt.id,type:ne.Note})}else for(const me of xe)f.push({id:Me(),from:te.id,to:me.id,type:ne.Note});for(const me of P)f.push({id:Me(),from:te.id,to:me,type:ne.Annotation})}if(f.length>0){const te=new Set(h.map(me=>`${me.from}-${me.to}-${me.type}`)),xe=f.filter(me=>!te.has(`${me.from}-${me.to}-${me.type}`));xe.length>0&&m(me=>[...me,...xe]),d([]),W([])}}else if(y.key.toLowerCase()==="i"&&V==="select"&&c.length>1){const f=o.filter(ee=>c.includes(ee.id)),H=f.filter(ee=>ee.category===b.Instrument||ee.category===b.Line),B=f.filter(ee=>ee.category===b.Instrument);if(H.length===1&&B.length>=1){const ee=H[0],te=B.map(Ve=>({id:Me(),from:Ve.id,to:ee.id,type:ne.Installation})),xe=new Set(h.map(Ve=>`${Ve.from}-${Ve.to}-${Ve.type}`)),me=te.filter(Ve=>!xe.has(`${Ve.from}-${Ve.to}-${Ve.type}`));me.length>0&&m(Ve=>[...Ve,...me]),d([])}}else if(y.key.toLowerCase()==="l"&&V==="select"&&c.length>=2)o.filter(H=>c.includes(H.id)&&H.category===b.Instrument).length>=2&&he&&(he(c),d([]));else if(y.key.toLowerCase()==="v"){const H=!Object.values(se.relationships).every(Boolean);fe({relationships:{connection:H,installation:H,annotation:H,note:H}})}else y.key.toLowerCase()==="q"&&t?j(f=>Math.max(1,f-1)):y.key.toLowerCase()==="w"&&t&&j(f=>Math.min(t.numPages,f+1))};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[V,c,o,h,m,d,k,P,L,U,z,W,ie,de,he,ue,Ee,g,t,j]),s.useEffect(()=>{const n=$.current;if(!n)return;const y=E=>{if(E.ctrlKey||E.metaKey){E.preventDefault();const f=E.deltaY>0?-.25:.25;K(H=>Math.min(10,Math.max(.25,H+f)))}};return n.addEventListener("wheel",y,{passive:!1}),()=>{n.removeEventListener("wheel",y)}},[g]),s.useLayoutEffect(()=>{if(c.length===1&&Z.current&&T){const n=c[0],y=o.find(E=>E.id===n);y&&y.page===x&&setTimeout(()=>{we({tagId:y.id,timestamp:Date.now()}),setTimeout(()=>we(null),100)},50)}},[c,x,T,o,g,we]),s.useLayoutEffect(()=>{if(v.length===1&&Z.current&&T){const n=v[0],y=w.find(E=>E.id===n);y&&y.page===x&&setTimeout(()=>{we({descriptionId:y.id,timestamp:Date.now()}),setTimeout(()=>we(null),100)},50)}},[v,w,x,T,g,we]);const Y=(n,y)=>{n.stopPropagation(),S.current=!0;const E=n.ctrlKey||n.metaKey,f=k.find(B=>B.id===y);f&&/[A-Z\d-]{5,}-[A-Z\d-]{5,}-\d{3,}/i.test(f.text);const H=h.find(B=>B.type===ne.Annotation&&B.to===y);if(H&&!E){const B=H.from;if(o.find(te=>te.id===B)){const te=h.filter(xe=>xe.type===ne.Annotation&&xe.from===B).map(xe=>xe.to);W(te),d([B])}}else E?W(B=>B.includes(y)?B.filter(ee=>ee!==y):[...B,y]):(W([y]),d([]))},_=s.useMemo(()=>o.filter(n=>n.page===x),[o,x]),J=s.useMemo(()=>k.filter(n=>n.page===x),[k,x]),l=s.useMemo(()=>w.filter(n=>n.page===x),[w,x]),D=n=>{if(n.target.closest("[data-tag-id]")||n.target.closest("[data-raw-text-id]"))return;if(S.current=!1,gt.current=!1,st(null),V==="manualCreate"&&$.current){const E=$.current.getBoundingClientRect();Ce.current={x:n.clientX-E.left,y:n.clientY-E.top},Te(!0),Ye({...Ce.current,width:0,height:0});return}const y=n.ctrlKey||n.metaKey;if(y&&V==="select"&&$.current){const E=$.current.getBoundingClientRect();Ce.current={x:n.clientX-E.left,y:n.clientY-E.top},Te(!0),Ye({...Ce.current,width:0,height:0})}else!y&&V==="select"&&Z.current&&(i(!0),a.current={scrollX:Z.current.scrollLeft,scrollY:Z.current.scrollTop,clientX:n.clientX,clientY:n.clientY},n.preventDefault())},R=n=>{if((ye||He)&&(gt.current=!0),ye&&Z.current){const y=n.clientX-a.current.clientX,E=n.clientY-a.current.clientY;Z.current.scrollLeft=a.current.scrollX-y,Z.current.scrollTop=a.current.scrollY-E;return}if(He&&$.current){const y=$.current.getBoundingClientRect(),E=n.clientX-y.left,f=n.clientY-y.top,H=Math.min(Ce.current.x,E),B=Math.min(Ce.current.y,f),ee=Math.abs(Ce.current.x-E),te=Math.abs(Ce.current.y-f);Ye({x:H,y:B,width:ee,height:te})}},q=n=>{if(S.current){He&&(Te(!1),Ye(null));return}if(ye&&i(!1),!gt.current&&!He&&(d([]),W([])),!He||!Fe||!T){He&&Te(!1);return}if(V==="manualCreate"){if(Te(!1),Fe.width>5&&Fe.height>5){const{x:f,y:H,width:B,height:ee}=Fe,te={x1:f/g,y1:H/g,x2:(f+B)/g,y2:(H+ee)/g};G(te,x)}Ye(null),ue("select");return}Te(!1);const y=new Set;for(const f of _){const{x1:H,y1:B,x2:ee,y2:te}=f.bbox,xe={x:H*g,y:B*g,width:(ee-H)*g,height:(te-B)*g};Fe.x<xe.x+xe.width&&Fe.x+Fe.width>xe.x&&Fe.y<xe.y+xe.height&&Fe.y+Fe.height>xe.y&&y.add(f.id)}y.size>0&&d(f=>Array.from(new Set([...f,...y])));const E=new Set;for(const f of J){const{x1:H,y1:B,x2:ee,y2:te}=f.bbox,xe={x:H*g,y:B*g,width:(ee-H)*g,height:(te-B)*g};Fe.x<xe.x+xe.width&&Fe.x+Fe.width>xe.x&&Fe.y<xe.y+xe.height&&Fe.y+Fe.height>xe.y&&E.add(f.id)}E.size>0&&W(f=>Array.from(new Set([...f,...E]))),Ye(null)},r=n=>{if(!T||!n||!n.bbox)return{x:0,y:0};const y=(n.bbox.x1+n.bbox.x2)/2,E=(n.bbox.y1+n.bbox.y2)/2;let f,H;switch(le){case 90:f=E*g,H=y*g;break;case 180:f=y*g,H=E*g;break;case 270:f=y*g,H=E*g;break;default:f=y*g,H=E*g;break}return{x:f,y:H}},O=s.useMemo(()=>new Map(o.map(n=>[n.id,n])),[o]),oe=s.useMemo(()=>new Map(k.map(n=>[n.id,n])),[k]),Q=s.useMemo(()=>{if(!Re)return[];const n=[];for(const y of h){if(y.type!==ne.Connection&&y.type!==ne.Installation||!Ht(y))continue;const E=O.get(y.from);if(!E||E.page!==x)continue;const f=O.get(y.to);if(!(!f||f.page!==x)){if(ze&&c.length>0){const H=c.includes((E==null?void 0:E.id)||""),B=c.includes((f==null?void 0:f.id)||"");if(!H&&!B)continue}n.push({rel:y,fromTag:E,toItem:f,isAnnotation:!1})}}return n},[h,O,x,se.relationships,Re,ze,c]),re=n=>{var ee,te,xe,me;if(!T)return{x:0,y:0};const y=oe.get(n);if(!y)return{x:0,y:0};const E=((((ee=y.bbox)==null?void 0:ee.x1)||0)+(((te=y.bbox)==null?void 0:te.x2)||0))/2,f=((((xe=y.bbox)==null?void 0:xe.y1)||0)+(((me=y.bbox)==null?void 0:me.y2)||0))/2;let H,B;switch(le){case 90:H=f*g,B=E*g;break;case 180:H=(T.width/g-E)*g,B=(T.height/g-f)*g;break;case 270:H=E*g,B=f*g;break;default:H=E*g,B=f*g;break}return{x:H,y:B}},pe=(n,y)=>{if(!T)return{x:0,y:0};let E,f;switch(le){case 90:E=n*g,f=y*g;break;case 180:E=n*g,f=y*g;break;case 270:E=n*g,f=y*g;break;default:E=n*g,f=y*g;break}return{x:E,y:f}},be=(n,y,E,f)=>{if(!T)return{rectX:0,rectY:0,rectWidth:0,rectHeight:0};let H,B,ee,te;switch(le){case 90:H=n*g,B=y*g,ee=(E-n)*g,te=(f-y)*g;break;case 180:H=n*g,B=y*g,ee=(E-n)*g,te=(f-y)*g;break;case 270:H=n*g,B=y*g,ee=(E-n)*g,te=(f-y)*g;break;default:H=n*g,B=y*g,ee=(E-n)*g,te=(f-y)*g;break}return{rectX:H,rectY:B,rectWidth:ee,rectHeight:te}},rt=()=>{switch(V){case"connect":return"cursor-crosshair ring-2 ring-blue-500";case"manualCreate":return"cursor-crosshair ring-2 ring-green-500";default:return""}};return e.jsxs("div",{className:"relative h-full w-full",children:[e.jsx("div",{ref:Z,className:`h-full w-full overflow-auto ${ye?"cursor-grabbing":"cursor-grab"}`,children:e.jsx("div",{className:"p-4 grid place-items-center min-h-full",children:e.jsxs("div",{ref:$,className:`relative shadow-2xl ${rt()}`,onMouseDown:D,onMouseMove:R,onMouseUp:q,onMouseLeave:q,children:[e.jsx("canvas",{ref:Ie}),T&&e.jsxs("svg",{className:"absolute top-0 left-0",width:T.width,height:T.height,style:{overflow:"visible"},children:[e.jsxs("defs",{children:[e.jsx("marker",{id:"arrowhead-connect",markerWidth:"10",markerHeight:"7",refX:"0",refY:"3.5",orient:"auto",children:e.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:Ne.relationships.connection})}),e.jsx("marker",{id:"arrowhead-install",markerWidth:"10",markerHeight:"7",refX:"0",refY:"3.5",orient:"auto",children:e.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:Ne.relationships.installation})})]}),$e.filter(n=>n.page===x).map((n,y)=>{const f=n.confidence?Math.max(1,n.confidence*3):2,H=n.type==="horizontal"?"#00ff00":"#0088ff";return e.jsx("line",{x1:n.start.x,y1:n.start.y,x2:n.end.x,y2:n.end.y,stroke:H,strokeWidth:f,strokeOpacity:.3,strokeLinecap:"round",pointerEvents:"none"},`detected-line-${y}`)}),J.map(n=>{const{x1:y,y1:E,x2:f,y2:H}=n.bbox,{rectX:B,rectY:ee,rectWidth:te,rectHeight:xe}=be(y,E,f,H),me=P.includes(n.id),Ve=It.has(n.id),yt=De.has(n.id),vt=T?T.width/g:800,xt=y>vt*.4&&!yt&&!me,jt=me&&P.length>1&&h.some(Ze=>Ze.type===ne.Annotation&&P.includes(Ze.to)&&Ze.to===n.id),it=()=>xt?{fill:"rgba(255, 255, 255, 0.003)",stroke:"transparent",strokeWidth:"0",strokeDasharray:"none"}:me?jt?{fill:"rgb(251 191 36 / 0.5)",stroke:"#fbbf24",strokeWidth:"2.5",strokeDasharray:"none"}:{fill:"rgb(56 189 248 / 0.5)",stroke:"#38bdf8",strokeWidth:"2.5",strokeDasharray:"none"}:Ve?{fill:"rgb(139 69 255 / 0.6)",stroke:"#8b5cf6",strokeWidth:"2.5",strokeDasharray:"none"}:yt?{fill:`${Ne.relationships.annotation}4D`,stroke:Ne.relationships.annotation,strokeWidth:"1.5",strokeDasharray:"none"}:{fill:"transparent",stroke:"#64748b",strokeWidth:"2",strokeDasharray:"3 3",className:"group-hover:stroke-sky-400 group-hover:fill-sky-400/30 transition-all"};return e.jsx("g",{"data-raw-text-id":n.id,onMouseDown:Ze=>Y(Ze,n.id),className:"cursor-pointer group",children:e.jsx("rect",{x:B,y:ee,width:te,height:xe,...it()})},n.id)}),Q.map(({rel:n,fromTag:y,toItem:E,isAnnotation:f})=>{if(!y||!E)return null;const H=r(y);let B,ee,te;f?(B=re(n.to),ee=St(n.type),te=""):(B=r(E),ee=St(n.type),n.type===ne.Connection?te="url(#arrowhead-connect)":n.type===ne.Installation?te="url(#arrowhead-install)":te="");const xe=Ue===n.id;return e.jsx(Pn,{rel:n,start:H,end:B,strokeColor:ee,marker:te,isPinged:xe},n.id)}),_.map(n=>{const{x1:y,y1:E,x2:f,y2:H}=n.bbox;if(isNaN(y)||isNaN(E)||isNaN(f)||isNaN(H))return null;const{rectX:B,rectY:ee,rectWidth:te,rectHeight:xe}=be(y,E,f,H);if(isNaN(B)||isNaN(ee)||isNaN(te)||isNaN(xe))return null;const me=c.includes(n.id),Ve=Lt.has(n.id),yt=n.id===ge,vt=lt.has(n.id),bt=n.category===b.NotesAndHolds&&n.text.toUpperCase().includes("NOTE"),xt=h.some(Ze=>Ze.type===ne.Note&&Ze.to===n.id),jt=h.some(Ze=>Ze.type===ne.Note&&(Ze.from===n.id||Ze.to===n.id)),it=bt&&!xt?!1:Pt(n);return tt(n.category),e.jsxs("g",{"data-tag-id":n.id,onMouseDown:Ze=>{Ze.stopPropagation(),S.current=!0,Ze.ctrlKey||Ze.metaKey?d($t=>$t.includes(n.id)?$t.filter(Ut=>Ut!==n.id):[...$t,n.id]):(d([n.id]),W([]),p([]))},className:"cursor-pointer",children:[jt&&it&&!bt&&e.jsxs(e.Fragment,{children:[e.jsx("rect",{x:B-4,y:ee-4,width:te+8,height:xe+8,stroke:Ne.relationships.note||"#14b8a6",strokeWidth:"2",fill:"none",opacity:"0.3",rx:"4",className:"animate-pulse"}),e.jsx("rect",{x:B-2,y:ee-2,width:te+4,height:xe+4,stroke:Ne.relationships.note||"#14b8a6",strokeWidth:"1",fill:`${Ne.relationships.note||"#14b8a6"}1A`,opacity:"0.5",rx:"2"})]}),e.jsx("rect",{x:B,y:ee,width:te,height:xe,stroke:it?tt(n.category):"transparent",strokeWidth:me?"4":jt?"3":"2",className:"transition-all duration-150",fill:it?me?`${tt(n.category)}CC`:jt&&!bt?`${tt(n.category)}59`:`${tt(n.category)}33`:"rgba(255, 255, 255, 0.003)",strokeDasharray:yt?"4 2":"none",style:{pointerEvents:"all"}}),e.jsx(_t,{bbox:{x1:B,y1:ee,x2:B+te,y2:ee+xe},type:vt&&!Ve?"related":"primary",effect:On(me,!1,vt),isSelected:me&&it,isHighlighted:Ve&&it,isMultiSelection:c.length>1,colorSettings:Ne}),it&&!1]},n.id)}),c.map(n=>{const y=_.find(bt=>bt.id===n);if(!y||y.category!==b.Instrument)return null;const{x1:E,y1:f,x2:H,y2:B}=y.bbox,{rectX:ee,rectY:te,rectWidth:xe,rectHeight:me}=be(E,f,H,B),Ve=ee+xe/2,yt=te+me/2,vt=Math.sqrt(xe*xe+me*me)/2*3;return e.jsx("circle",{cx:Ve,cy:yt,r:vt,fill:"none",stroke:"#fbbf24",strokeWidth:"1.5",strokeDasharray:"5 5",opacity:"0.6",pointerEvents:"none"},`circle-${n}`)}),Oe&&(()=>{const n=_.find(me=>me.id===Oe);if(!n)return null;const{x1:y,y1:E,x2:f,y2:H}=n.bbox,{rectX:B,rectY:ee,rectWidth:te,rectHeight:xe}=be(y,E,f,H);return e.jsx(_t,{bbox:{x1:B,y1:ee,x2:B+te,y2:ee+xe},type:"primary",effect:"box",isPinged:!0,colorSettings:Ne})})(),se.descriptions&&l.map(n=>{var Ve,yt,vt;const{x1:y,y1:E,x2:f,y2:H}=n.bbox,{rectX:B,rectY:ee,rectWidth:te,rectHeight:xe}=be(y,E,f,H),me=v.includes(n.id);return e.jsx("g",{children:e.jsx("rect",{x:B,y:ee,width:te,height:xe,fill:me?`${((Ve=Ne.entities)==null?void 0:Ve.description)||Ke.entities.description}4D`:`${((yt=Ne.entities)==null?void 0:yt.description)||Ke.entities.description}26`,stroke:((vt=Ne.entities)==null?void 0:vt.description)||Ke.entities.description,strokeWidth:"2",className:"cursor-pointer hover:opacity-80 transition-opacity",onClick:bt=>{bt.stopPropagation();const xt=bt.ctrlKey||bt.metaKey;p(xt?me?jt=>jt.filter(it=>it!==n.id):jt=>[...jt,n.id]:[n.id])},rx:"3"})},n.id)}),Xe&&(()=>{const n=w.find(me=>me.id===Xe);if(!n||n.page!==x)return null;const{x1:y,y1:E,x2:f,y2:H}=n.bbox,{rectX:B,rectY:ee,rectWidth:te,rectHeight:xe}=be(y,E,f,H);return e.jsx(_t,{bbox:{x1:B,y1:ee,x2:B+te,y2:ee+xe},type:"description",effect:"box",isPinged:!0,colorSettings:Ne})})()]})]})})}),Ge&&e.jsx("div",{className:"fixed z-50 pointer-events-none",style:{left:Ge.x+10,top:Ge.y-10},children:e.jsxs("button",{onClick:Ct,className:"pointer-events-auto bg-violet-600 hover:bg-violet-500 text-white px-3 py-2 rounded-lg shadow-lg flex items-center space-x-2 transition-all duration-200 animate-fade-in",children:[e.jsxs("span",{className:"text-sm font-medium",children:["Go to ",Ge.referenceText]}),e.jsxs("span",{className:"text-xs bg-white/20 px-1.5 py-0.5 rounded",children:["P",Ge.targetPage]}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 7l5 5m0 0l-5 5m5-5H6"})})]})})]})},$n=at.memo(Hn,(t,o)=>t.currentPage===o.currentPage&&t.scale===o.scale&&t.mode===o.mode&&t.tags===o.tags&&t.relationships===o.relationships&&t.rawTextItems===o.rawTextItems&&t.descriptions===o.descriptions&&t.selectedTagIds===o.selectedTagIds&&t.selectedRawTextItemIds===o.selectedRawTextItemIds&&t.selectedDescriptionIds===o.selectedDescriptionIds&&t.visibilitySettings===o.visibilitySettings&&t.showAutoLinkRanges===o.showAutoLinkRanges),Fn=(t,o)=>{const N=(t.bbox.x1+t.bbox.x2)/2,h=(t.bbox.y1+t.bbox.y2)/2,m=(o.bbox.x1+o.bbox.x2)/2,x=(o.bbox.y1+o.bbox.y2)/2,j=m-N,c=x-h;return Math.sqrt(j*j+c*c)},Vn=(t,o)=>{if(!t||!o||o.length===0)return null;const N=o.filter(x=>x.page===t.page);if(N.length===0)return null;let h=null,m=1/0;return N.forEach(x=>{const j=Fn(t,x);j<m&&(m=j,h=x)}),h},Yt=(t,o={})=>{const N=t.match(/^([A-Z]+)[- ]?(\d+)/i);if(N){const h=N[1].toUpperCase();if(h==="FF")return"";let m;o[h]?m=o[h]:m=h[0];const x=N[2];return`${m}-${x}`}return""},Bn=(t,o={})=>{const N=t.match(/^([A-Z]+)[- ]?(\d+)/i);if(!N)return"";const h=N[1].toUpperCase();return h==="FF"?"":o[h]?o[h].instrumentType:""},Wn=(t,o={})=>{const N=t.match(/^([A-Z]+)[- ]?(\d+)/i);if(!N)return"";const h=N[1].toUpperCase();return h==="FF"?"":o[h]?o[h].ioType:""},zn=(t,o,N,h=[],m=[],x=[],j=[],c=[],d=!1,v={},p={})=>{const k=t.filter(I=>I.category===b.Instrument),w=t.filter(I=>I.category===b.DrawingNumber),L=t.filter(I=>I.category===b.NotesAndHolds),U=t.filter(I=>I.category===b.Line),z=o.filter(I=>I.type===ne.Annotation);L.filter(I=>I.text.includes("NOTE")),z.length>0&&z.slice(0,3).forEach(I=>{t.find(g=>g.id===I.from),N.find(g=>g.id===I.to)});const P=new Map(w.map(I=>[I.page,I.text])),W=new Map,ie=new Map;d&&(o.filter(I=>I.type===ne.Annotation).forEach(I=>{const g=L.find(V=>V.id===I.from),K=N.find(V=>V.id===I.to);if(g&&K){const V=ie.get(g.id)||"",ue=V?V+" "+K.text:K.text;ie.set(g.id,ue)}}),ie.size>0&&ie.forEach((I,g)=>{L.find(V=>V.id===g)&&I.length>60&&I.substring(0,60)+""})),o.filter(I=>I.type===ne.Note).forEach(I=>{const g=t.find(V=>V.id===I.from),K=L.find(V=>V.id===I.to);if(g&&g.category===b.Instrument&&K){W.has(g.id)||W.set(g.id,[]);let V="";if(d){const ue=ie.get(K.id);ue?V=ue:(V=K.text.replace(/^NOTE\s*\d+\s*:?\s*/i,"").trim(),V||(V=K.text))}else V=K.text.replace(/^NOTE\s*\d+\s*:?\s*/i,"").trim(),V||(V=K.text);V&&W.get(g.id).push(V)}});const de=new Map;k.forEach(I=>{const g=Vn(I,U);g&&de.set(I.id,g.text)});const he=k.sort((I,g)=>{if(I.page!==g.page)return I.page-g.page;const K=Yt(I.text,p),V=Yt(g.text,p);return K!==V?K.localeCompare(V):I.text.localeCompare(g.text)}).map((I,g)=>{const K=P.get(I.page)||"",V=Yt(I.text,p),ue=Bn(I.text,v),ge=Wn(I.text,v),Ee=de.get(I.id)||"",fe=(W.get(I.id)||[]).join("; ");return{"No.":g+1,"P&ID Number":K,"Loop Number":V,"Tag Number":I.text,"Line Number":Ee,"Instrument Type":ue,"I/O Type":ge,NOTE:fe}}),G=Bt.book_new(),F=Bt.json_to_sheet(he);if(Bt.book_append_sheet(G,F,"Instrument List"),c&&c.length>0){const I=c.map((K,V)=>({"No.":V+1,"Line ID":K.id||"","Start X":K.start?Math.round(K.start.x):"","Start Y":K.start?Math.round(K.start.y):"","End X":K.end?Math.round(K.end.x):"","End Y":K.end?Math.round(K.end.y):"",Type:K.type||"straight",Page:K.page||1,Source:K.source||"unknown",Length:K.start&&K.end?Math.round(Math.sqrt(Math.pow(K.end.x-K.start.x,2)+Math.pow(K.end.y-K.start.y,2))):""})),g=Bt.json_to_sheet(I);Bt.book_append_sheet(G,g,"Detected Lines")}Tn(G,"P&ID_Instrument_List.xlsx")},kt=at.memo(({onClick:t})=>e.jsx("button",{onClick:o=>{o.stopPropagation(),t()},className:"ml-2 p-0.5 rounded-full text-gray-500 hover:bg-red-500/20 hover:text-red-400 transition-colors",title:"관계 삭제",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})),en=at.memo(({onClick:t})=>e.jsx("button",{onClick:o=>{o.stopPropagation(),t()},className:"p-1 rounded-full text-gray-500 hover:bg-red-500/20 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100",title:"태그 삭제",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})),Kt=at.memo(({onClick:t,title:o="편집"})=>e.jsx("button",{onClick:N=>{N.stopPropagation(),t()},className:"p-1 rounded-full text-gray-500 hover:bg-sky-500/20 hover:text-sky-400 transition-colors opacity-0 group-hover:opacity-100",title:o,children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:[e.jsx("path",{d:"M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"}),e.jsx("path",{fillRule:"evenodd",d:"M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z",clipRule:"evenodd"})]})})),Jt=at.memo(({onClick:t,title:o="저장"})=>e.jsx("button",{onClick:N=>{N.stopPropagation(),t()},className:"p-1 rounded-full text-green-600 hover:text-green-700 transition-colors",title:o,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})),Qt=at.memo(({onClick:t,title:o="취소"})=>e.jsx("button",{onClick:N=>{N.stopPropagation(),t()},className:"p-1 rounded-full text-gray-600 hover:text-gray-700 transition-colors",title:o,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})),pn=Kt,Un=at.memo(({item:t,relId:o,onDeleteRelationship:N,onDeleteItem:h,onUpdateItemText:m})=>{const[x,j]=s.useState(!1),[c,d]=s.useState(t.text),v=s.useRef(null);s.useEffect(()=>{x&&v.current&&(v.current.focus(),v.current.select())},[x]),s.useEffect(()=>{d(t.text)},[t.text]);const p=()=>{const w=c.trim();w&&w!==t.text&&m(t.id,w),j(!1)},k=w=>{w.key==="Enter"?p():w.key==="Escape"&&(d(t.text),j(!1))};return e.jsxs("div",{className:"group flex items-center justify-between",onClick:w=>{x&&w.stopPropagation()},children:[e.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0",title:t.text,children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3 text-gray-500 flex-shrink-0",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z",clipRule:"evenodd"})}),x?e.jsx("input",{ref:v,type:"text",value:c,onChange:w=>d(w.target.value),onBlur:p,onKeyDown:k,onClick:w=>w.stopPropagation(),className:"font-mono text-sm text-gray-900 bg-gray-100 border border-sky-500 rounded px-1 w-full"}):e.jsx("span",{className:"text-gray-700 font-mono truncate max-w-[180px]",children:t.text})]}),e.jsxs("div",{className:"flex items-center flex-shrink-0",children:[e.jsx(pn,{onClick:()=>j(!0)}),e.jsx(en,{onClick:()=>h(t.id)}),e.jsx(kt,{onClick:()=>N(o)})]})]})}),Gn=at.memo(({tag:t,isSelected:o,onItemClick:N,onGoToTag:h,relationships:m,allTags:x,allRawTextItems:j,descriptions:c,loops:d,onToggleReviewStatus:v,onDeleteRelationship:p,onDeleteTag:k,onUpdateTagText:w,onDeleteItem:L,onUpdateItemText:U,onUpdateLoop:z,showDetails:P})=>{const[W,ie]=s.useState(!1),[de,he]=s.useState(t.text),[G,F]=s.useState(new Set),[I,g]=s.useState(new Set),[K,V]=s.useState(new Set),ue=s.useRef(null),ge=s.useRef(!1),Ee=qt[t.category],se={[b.Line]:"L",[b.Instrument]:"I",[b.DrawingNumber]:"D",[b.NotesAndHolds]:"N",[b.Uncategorized]:"U"},fe=s.useMemo(()=>new Map(x.map($=>[$.id,$])),[x]),Oe=s.useMemo(()=>new Map(j.map($=>[$.id,$])),[j]);s.useEffect(()=>{W&&ue.current&&(ue.current.focus(),ue.current.select())},[W]),s.useEffect(()=>{he(t.text)},[t.text]);const Xe=()=>{const $=de.trim();$&&$!==t.text&&w(t.id,$),ie(!1)},Ue=$=>{$.key==="Enter"?Xe():$.key==="Escape"&&(he(t.text),ie(!1))},ce=($,Z)=>{$.stopPropagation();const Ce=fe.get(Z)||x.find(S=>S.id===Z);Ce&&h(Ce)},ae=($,Z)=>e.jsx("span",{onClick:Ce=>ce(Ce,$),className:"text-sky-600 hover:text-sky-700 hover:underline cursor-pointer font-mono",children:Z}),we=s.useMemo(()=>{const $=x.filter(Z=>Z.page===t.page&&Z.category===b.DrawingNumber);return $.length>0?$[0]:null},[x,t.page]),ke=m.filter($=>$.from===t.id&&$.type===ne.Connection),Ae=m.filter($=>$.to===t.id&&$.type===ne.Connection),Re=m.find($=>$.from===t.id&&$.type===ne.Installation),Be=m.filter($=>$.to===t.id&&$.type===ne.Installation),ze=m.filter($=>$.from===t.id&&$.type===ne.Annotation),ve=m.filter($=>$.from===t.id&&$.type===ne.Note),Pe=m.filter($=>$.to===t.id&&$.type===ne.Note),$e=m.filter($=>$.from===t.id&&$.type===ne.Description),Se=m.filter($=>$.to===t.id&&$.type===ne.Description),Ie=ke.length>0||Ae.length>0||Re||Be.length>0||ze.length>0||ve.length>0||Pe.length>0||$e.length>0||Se.length>0;return e.jsxs("li",{"data-tag-id":t.id,onClick:$=>{W||N($)},className:`group p-2 rounded-md cursor-pointer transition-colors ${o?"bg-red-500/20 ring-1 ring-red-500":"hover:bg-gray-100"}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-grow mr-2",children:[W?e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("input",{ref:ue,type:"text",value:de,onChange:$=>he($.target.value),onKeyDown:Ue,onClick:$=>$.stopPropagation(),className:"font-mono text-sm text-gray-900 bg-gray-100 border border-sky-500 rounded px-1 flex-grow"}),e.jsx(Jt,{onClick:Xe}),e.jsx(Qt,{onClick:()=>{he(t.text),ie(!1)}})]}):e.jsx("div",{className:"flex items-center justify-between w-full",children:e.jsxs("div",{className:"flex items-center space-x-2 flex-grow min-w-0",children:[e.jsx("input",{type:"checkbox",checked:t.isReviewed||!1,onChange:$=>{$.stopPropagation(),v(t.id)},className:"w-4 h-4 text-sky-600 bg-white border-gray-400 rounded focus:ring-sky-500 focus:ring-2",title:"검토 완료 표시"}),e.jsx("span",{className:`inline-flex items-center justify-center w-5 h-5 rounded text-xs font-bold text-gray-900 ${Ee.bg} ${Ee.border} border flex-shrink-0`,title:t.category,children:se[t.category]}),e.jsx("span",{className:"font-mono text-sm text-gray-900 truncate",children:t.text})]})}),t.category!==b.DrawingNumber&&we&&e.jsxs("div",{className:"text-xs text-gray-500 mt-0.5 font-mono",children:["DWG: ",we.text]}),t.category===b.Instrument&&P&&(()=>{const $=d.filter(Z=>Z.tagIds.includes(t.id));return $.length>0&&e.jsx("div",{className:"mt-1",children:$.map(Z=>{const Ce=K.has(Z.id),S=Z.tagIds.map(T=>x.find(X=>X.id===T)).filter(Boolean);return e.jsxs("div",{className:"mb-1",children:[e.jsxs("div",{className:"flex items-center justify-between cursor-pointer hover:bg-gray-100 rounded px-1 py-0.5 transition-colors",onClick:T=>{T.stopPropagation(),V(X=>{const le=new Set(X);return le.has(Z.id)?le.delete(Z.id):le.add(Z.id),le})},children:[e.jsxs("span",{className:"text-xs text-blue-400 font-mono",children:["루프: ",Z.name||Z.id]}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:`h-3 w-3 text-gray-600 transition-transform ${Ce?"rotate-180":""}`,viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z",clipRule:"evenodd"})})]}),Ce&&e.jsxs("div",{className:"mt-1 ml-2 p-2 border border-gray-300 rounded-md bg-gray-50",children:[e.jsx("div",{className:"flex items-center space-x-2 mb-2",children:e.jsxs("span",{className:"text-xs text-gray-600",children:["(",S.length," tags)",S.length>0&&` P. ${S.map(T=>T.page).filter((T,X,le)=>le.indexOf(T)===X).sort((T,X)=>T-X).join(", ")}`]})}),e.jsx("div",{className:"flex flex-wrap gap-1",children:S.map(T=>e.jsxs("div",{className:`inline-flex items-center bg-gray-200 text-gray-700 rounded text-xs font-mono overflow-hidden ${T.id===t.id?"ring-1 ring-blue-400":""}`,children:[e.jsxs("span",{onClick:X=>{X.stopPropagation(),h(T)},className:"px-2 py-1 cursor-pointer hover:bg-slate-500/50 transition-colors",title:`태그로 이동: ${T.text}`,children:[T.text," ",e.jsxs("span",{className:"text-gray-600",children:["P.",T.page]})]}),T.id!==t.id&&e.jsx("button",{onClick:X=>{X.stopPropagation(),z(Z.id,{...Z,tagIds:Z.tagIds.filter(le=>le!==T.id)})},className:"px-1 py-1 text-red-400 hover:text-red-300 hover:bg-red-900/30 transition-colors",title:`루프에서 ${T.text} 제거`,children:"✕"})]},T.id))})]})]},Z.id)})})})()]}),e.jsxs("div",{className:"flex items-center space-x-1 flex-shrink-0",children:[e.jsxs("span",{className:"text-xs text-gray-600",children:["페이지 ",t.page]}),e.jsx(pn,{onClick:()=>ie(!0)}),e.jsx(en,{onClick:()=>k(t.id)})]})]}),P&&Ie&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-gray-200/50 space-y-1 text-xs text-gray-700",children:[ke.map($=>{const Z=fe.get($.to);return Z?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{className:"text-gray-700 text-xs",children:"대상"}),ae(Z.id,Z.text)]}),e.jsx(kt,{onClick:()=>p($.id)})]},$.id):null}),Ae.map($=>{const Z=fe.get($.from);return Z?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{className:"text-gray-700 text-xs",children:"출처"}),ae(Z.id,Z.text)]}),e.jsx(kt,{onClick:()=>p($.id)})]},$.id):null}),Re&&fe.get(Re.to)&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{title:"설치",children:"📌"}),e.jsx("span",{className:"text-gray-600",children:"설치 위치:"}),ae(Re.to,fe.get(Re.to).text)]}),e.jsx(kt,{onClick:()=>p(Re.id)})]}),Be.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"설치된 계기:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:Be.map($=>{const Z=fe.get($.from);return Z?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:ae(Z.id,Z.text)}),e.jsx(kt,{onClick:()=>p($.id)})]},$.id):null})})]}),ze.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"관련 텍스트:"}),e.jsx("div",{className:"pl-3 space-y-1 mt-1",children:ze.map($=>{const Z=Oe.get($.to);return Z?e.jsx(Un,{item:Z,relId:$.id,onDeleteRelationship:p,onDeleteItem:L,onUpdateItemText:U},$.id):null})})]}),ve.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"노트:"}),e.jsx("div",{className:"pl-3 space-y-1 mt-1",children:ve.map($=>{const Z=fe.get($.to);if(!Z)return null;const Ce=m.filter(T=>T.from===Z.id&&T.type===ne.Description).map(T=>c.find(X=>X.id===T.to)).filter(Boolean),S=I.has(Z.id);return e.jsxs("div",{className:"border border-gray-300 rounded-md bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between p-2",children:[e.jsxs("button",{onClick:T=>{T.stopPropagation(),ge.current=!0;const X=new Set(I);S?X.delete(Z.id):X.add(Z.id),g(X),setTimeout(()=>{ge.current=!1},50)},className:"flex items-center space-x-1.5 text-left flex-grow cursor-pointer",children:[e.jsx("span",{title:"노트",children:"📝"}),e.jsx("span",{className:"text-sky-400 hover:text-sky-300 font-mono",children:Z.text}),Ce.length>0&&e.jsxs("span",{className:"text-gray-600 text-xs",children:["(",Ce.length,") ",S?"▼":"▶"]})]}),e.jsx(kt,{onClick:()=>p($.id)})]}),S&&Ce.length>0&&e.jsx("div",{className:"px-3 pb-2 border-t border-gray-300",children:e.jsx("div",{className:"space-y-1 mt-2",children:Ce.map(T=>{const X=m.find(Le=>Le.from===Z.id&&Le.to===T.id&&Le.type===ne.Description),le=G.has(T.id);return e.jsxs("div",{className:"border border-gray-300 rounded-md bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between p-2",children:[e.jsxs("button",{onClick:Le=>{Le.stopPropagation();const He=new Set(G);le?He.delete(T.id):He.add(T.id),F(He)},className:"flex items-center space-x-1.5 text-purple-600 hover:text-purple-700 text-xs cursor-pointer",children:[e.jsx("span",{children:le?"📖":"📄"}),e.jsxs("span",{children:[T.metadata.type," ",T.metadata.number]}),e.jsx("span",{className:"text-gray-600",children:le?"▼":"▶"})]}),X&&e.jsx(kt,{onClick:()=>p(X.id)})]}),le&&e.jsxs("div",{className:"px-3 pb-3 border-t border-gray-300",children:[e.jsx("div",{className:"text-xs text-gray-700 mt-2 leading-relaxed",children:T.text}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["페이지 ",T.page," • ",T.metadata.scope]})]})]},T.id)})})})]},$.id)})})]}),Pe.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"노트 대상:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:Pe.map($=>{const Z=fe.get($.from);return Z?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:ae(Z.id,Z.text)}),e.jsx(kt,{onClick:()=>p($.id)})]},$.id):null})})]}),$e.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"설명:"}),e.jsx("div",{className:"pl-3 space-y-1 mt-1",children:$e.map($=>{const Z=c.find(S=>S.id===$.to),Ce=G.has(Z==null?void 0:Z.id);return Z?e.jsxs("div",{className:"border border-gray-300 rounded-md bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between p-2",children:[e.jsxs("button",{onClick:S=>{S.stopPropagation(),ge.current=!0;const T=new Set(G);Ce?T.delete(Z.id):T.add(Z.id),F(T),setTimeout(()=>{ge.current=!1},50)},className:"flex items-center space-x-1.5 text-purple-600 hover:text-purple-700 text-xs cursor-pointer bg-transparent border-none",children:[e.jsx("span",{children:Ce?"📖":"📄"}),e.jsxs("span",{children:[Z.metadata.type," ",Z.metadata.number]}),e.jsx("span",{className:"text-gray-600",children:Ce?"▼":"▶"})]}),e.jsx(kt,{onClick:()=>p($.id)})]}),Ce&&e.jsxs("div",{className:"px-3 pb-3 border-t border-gray-300",children:[e.jsx("div",{className:"text-xs text-gray-700 mt-2 leading-relaxed",children:Z.text}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["페이지 ",Z.page," • ",Z.metadata.scope]})]})]},$.id):null})})]}),Se.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"설명 출처:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:Se.map($=>{const Z=fe.get($.from);return Z?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:ae(Z.id,Z.text)}),e.jsx(kt,{onClick:()=>p($.id)})]},$.id):null})})]})]})]})}),Xn=({tags:t,setTags:o,rawTextItems:N,descriptions:h,loops:m,setLoops:x,relationships:j,setRelationships:c,detectedLines:d=[],appSettings:v={instrumentMappings:{}},currentPage:p,setCurrentPage:k,selectedTagIds:w,setSelectedTagIds:L,selectedDescriptionIds:U,setSelectedDescriptionIds:z,tagSelectionSource:P,onDeleteTags:W,onUpdateTagText:ie,onDeleteDescriptions:de,onUpdateDescription:he,onDeleteRawTextItems:G,onUpdateRawTextItemText:F,onAutoLinkDescriptions:I,onAutoLinkNotesAndHolds:g,onAutoGenerateLoops:K,onManualCreateLoop:V,onDeleteLoops:ue,onUpdateLoop:ge,showConfirmation:Ee,onPingTag:se,onPingDescription:fe,onPingRelationship:Oe,visibilitySettings:Xe,updateVisibilitySettings:Ue,toggleTagVisibility:ce,toggleRelationshipVisibility:ae,toggleAllTags:we,toggleAllRelationships:ke})=>{const[Ae,Re]=s.useState(!0),[Be,ze]=s.useState(!0),[ve,Pe]=s.useState(""),[$e,Se]=s.useState(""),[Ie,$]=s.useState("tags"),[Z,Ce]=s.useState(null),[S,T]=s.useState(""),[X,le]=s.useState("All"),[Le,He]=s.useState("All"),[Te,Fe]=s.useState("default"),[Ye,lt]=s.useState(()=>{const l=localStorage.getItem("sidebarWidth");return l?parseInt(l):320}),[Je,It]=s.useState(!1);s.useEffect(()=>{Te==="instrument-number-function"&&X!==b.Instrument&&Fe("default")},[X,Te]);const[Nt,dt]=s.useState(null),[wt,ct]=s.useState(""),[Qe,nt]=s.useState({type:"Note",scope:"Installation",number:1}),[mt,At]=s.useState({viewOptions:!0}),[We,Ge]=s.useState({start:0,end:100}),st=s.useRef(null),ht=s.useRef(null),ot=s.useRef(-1),et=s.useRef(!1);s.useCallback(l=>{At(D=>({...D,[l]:!D[l]}))},[]);const ft=s.useCallback(l=>{c(D=>D.filter(R=>R.id!==l))},[c]),je=s.useCallback(l=>{W([l])},[W]),Dt=s.useCallback(l=>{G([l])},[G]),Mt=s.useCallback(l=>{o(D=>D.map(R=>R.id===l?{...R,isReviewed:!R.isReviewed}:R))},[o]),Ot=s.useCallback(l=>{const D=m.find(R=>R.id===l);D&&(Ce(l),T(D.name||D.id))},[m]),Et=s.useCallback(()=>{Z&&S.trim()&&(ge(Z,{id:S.trim(),name:S.trim()}),Ce(null),T(""))},[Z,S,ge]),Ct=s.useCallback(()=>{Ce(null),T("")},[]),Lt=s.useCallback(l=>{It(!0),l.preventDefault()},[]),ut=s.useCallback(l=>{if(!Je)return;const D=l.clientX;D>=280&&D<=600&&(lt(D),localStorage.setItem("sidebarWidth",D.toString()))},[Je]),pt=s.useCallback(()=>{It(!1)},[]);s.useEffect(()=>(Je&&(document.addEventListener("mousemove",ut),document.addEventListener("mouseup",pt),document.body.style.cursor="col-resize",document.body.style.userSelect="none"),()=>{document.removeEventListener("mousemove",ut),document.removeEventListener("mouseup",pt),document.body.style.cursor="",document.body.style.userSelect=""}),[Je,ut,pt]);const De=s.useMemo(()=>{const D=t.filter(R=>!Ae||R.page===p).filter(R=>X==="All"||R.category===X).filter(R=>Le==="All"?!0:Le==="Reviewed"?R.isReviewed===!0:Le==="NotReviewed"?R.isReviewed!==!0:!0).filter(R=>R.text.toLowerCase().includes(ve.toLowerCase()));switch(Te){case"length-asc":return[...D].sort((R,q)=>R.text.length-q.text.length);case"length-desc":return[...D].sort((R,q)=>q.text.length-R.text.length);case"pos-top-bottom":return[...D].sort((R,q)=>{if(R.page!==q.page)return R.page-q.page;const r=q.bbox.y2-R.bbox.y2;return Math.abs(r)<1?R.bbox.x1-q.bbox.x1:r});case"pos-left-right":return[...D].sort((R,q)=>{if(R.page!==q.page)return R.page-q.page;const r=R.bbox.x1-q.bbox.x1;return Math.abs(r)<1?q.bbox.y2-R.bbox.y2:r});case"instrument-number-function":return[...D].sort((R,q)=>{if(R.page!==q.page)return R.page-q.page;const r=Q=>{const re=Q.trim(),pe=re.match(/^([A-Z]{2,4})-?(\d+)[\s]*([A-Z]*)$/);if(pe)return{function:pe[1].trim(),number:parseInt(pe[2]),suffix:pe[3].trim()};const be=re.match(/^([A-Z]{2,4})(\d+)([A-Z]*)$/);return be?{function:be[1].trim(),number:parseInt(be[2]),suffix:be[3].trim()}:{function:Q,number:99999,suffix:""}},O=r(R.text),oe=r(q.text);return O.number!==oe.number?O.number-oe.number:O.function!==oe.function?O.function.localeCompare(oe.function):O.suffix.localeCompare(oe.suffix)});case"default":default:return[...D].sort((R,q)=>R.page!==q.page?R.page-q.page:R.text.localeCompare(q.text))}},[t,Ae,p,X,Le,ve,Te]),Ne=s.useMemo(()=>{if(De.length<=100)return De;if(w.length===1&&!et.current){const R=De.findIndex(q=>q.id===w[0]);if(R!==-1){const r=Math.max(0,R-30),O=Math.min(De.length,R+60);(R<We.start||R>=We.end)&&setTimeout(()=>{Ge({start:r,end:O})},10)}}const l=Math.max(0,Math.min(We.start,De.length)),D=Math.max(l,Math.min(We.end,De.length));return De.slice(l,D)},[De,We,w]),tt=s.useMemo(()=>h.filter(l=>!Ae||l.page===p),[h,Ae,p]);s.useEffect(()=>{u.current&&(clearTimeout(u.current),u.current=null),C.current=!1,A.current=0,Ge({start:0,end:100})},[Ae,X,ve]),s.useEffect(()=>()=>{u.current&&clearTimeout(u.current)},[]);const St=s.useMemo(()=>m.filter(l=>!Ae||l.tagIds.some(D=>{const R=t.find(q=>q.id===D);return R&&R.page===p})),[m,Ae,p,t]),Pt=s.useMemo(()=>Ae?j.filter(l=>{const D=t.find(pe=>pe.id===l.from),R=t.find(pe=>pe.id===l.to),q=h.find(pe=>pe.id===l.from),r=h.find(pe=>pe.id===l.to),O=N.find(pe=>pe.id===l.from),oe=N.find(pe=>pe.id===l.to),Q=(D==null?void 0:D.page)||(q==null?void 0:q.page)||(O==null?void 0:O.page),re=(R==null?void 0:R.page)||(r==null?void 0:r.page)||(oe==null?void 0:oe.page);return!Ae||Q===p||re===p}):j,[j,Ae,p,t,h,N]);s.useEffect(()=>{if(P==="pdf"&&w.length===1&&Ie==="tags"&&st.current){const l=w[0];et.current=!0,setTimeout(()=>{const D=st.current.querySelector(`[data-tag-id='${l}']`);D&&(D.scrollIntoView({behavior:"auto",block:"center"}),setTimeout(()=>{et.current=!1},100))},50)}},[w,P,Ie,De]),s.useEffect(()=>{if(Ie==="descriptions"&&U.length===1&&ht.current){const l=U[0];et.current=!0;const D=ht.current.querySelector(`[data-description-id='${l}']`);D&&(D.scrollIntoView({behavior:"auto",block:"center"}),setTimeout(()=>{et.current=!1},100))}},[U,Ie,tt]);const Ht=s.useCallback((l,D,R)=>{const q=R.ctrlKey||R.metaKey;if(R.shiftKey&&ot.current!==-1){const O=Math.min(ot.current,D),oe=Math.max(ot.current,D),Q=De.slice(O,oe+1).map(re=>re.id);L(q?re=>Array.from(new Set([...re,...Q])):Q)}else q?(L(O=>O.includes(l.id)?O.filter(oe=>oe!==l.id):[...O,l.id]),ot.current=D):(k(l.page),L([l.id]),ot.current=D,se(l.id))},[De,w,L,k,se]),gt=s.useCallback(l=>{Ie!=="tags"&&$("tags");const D=!Ae||l.page===p,R=X==="All"||l.category===X,q=l.text.toLowerCase().includes(ve.toLowerCase());D||Re(!1),R||le("All"),!q&&ve&&Pe(""),k(l.page),L([l.id]),se(l.id),setTimeout(()=>{if(st.current){et.current=!0;const r=st.current.querySelector(`[data-tag-id='${l.id}']`);r&&(r.scrollIntoView({behavior:"auto",block:"center"}),setTimeout(()=>{et.current=!1},100))}},50)},[k,L,Ie,$,t,Ae,p,X,ve,Re,le,Pe,se]),ye=s.useCallback(()=>{w.length>0&&(W(w),L([]),ot.current=-1)},[w,W,L]),i=s.useCallback(()=>{const l=v.instrumentMappings||{},D=v.loopRules||{};zn(t,j,N,h,[],m,[],d,!0,l,D)},[t,j,N,h,m,d,v]),a=s.useCallback(l=>{z([l.id]),l.page!==p&&k(l.page),fe(l.id)},[p,k,z,fe]),u=s.useRef(null),A=s.useRef(0),C=s.useRef(!1),M=s.useCallback(l=>{w.length>1||De.length<=100||et.current||(u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{const{scrollTop:D,clientHeight:R}=l.target,q=90,r=30,O=Math.floor(D/q),oe=Math.ceil(R/q),Q=Math.max(0,O-r),re=Math.min(De.length,O+oe+r);Ge({start:Q,end:re}),u.current=null},50))},[De.length,w.length]),Y=s.useCallback(({relationships:l})=>{const[D,R]=s.useState(""),[q,r]=s.useState("All"),O=s.useMemo(()=>({tags:new Map(t.map(n=>[n.id,n])),descriptions:new Map(h.map(n=>[n.id,n])),rawTextItems:new Map(N.map(n=>[n.id,n]))}),[t,h,N]),oe=s.useCallback(n=>O.tags.get(n)||O.descriptions.get(n)||O.rawTextItems.get(n),[O]),Q=s.useCallback(n=>n&&n.text?n.text:"Unknown",[]),re=s.useMemo(()=>q==="All"?l:l.filter(n=>n.type===q),[l,q]),pe=s.useMemo(()=>{if(!D)return re;const n=D.toLowerCase();return re.filter(y=>{const E=oe(y.from),f=oe(y.to),H=Q(E).toLowerCase(),B=Q(f).toLowerCase();return H.includes(n)||B.includes(n)})},[D,re,oe,Q]),be=s.useMemo(()=>{const n={};return Object.values(ne).forEach(y=>{n[y]=l.filter(E=>E.type===y).length}),n.All=l.length,n},[l]),rt=s.useCallback(n=>{const y=oe(n.from),E=oe(n.to);if(y&&E){const f=(y==null?void 0:y.page)||(E==null?void 0:E.page);f&&f!==p&&k(f),Oe(n.id),O.tags.has(n.from)&&se(n.from),O.tags.has(n.to)&&se(n.to),O.descriptions.has(n.from)&&fe(n.from),O.descriptions.has(n.to)&&fe(n.to)}},[oe,p,k,O,se,fe,Oe]);return e.jsxs("div",{className:"flex-grow flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-2 border-b border-gray-200 flex-shrink-0 space-y-2",children:[e.jsx("input",{type:"text",placeholder:"관계 검색...",value:D,onChange:n=>R(n.target.value),className:"w-full bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm text-gray-900 focus:ring-sky-500 focus:border-sky-500"}),e.jsx("div",{className:"flex flex-wrap gap-1 text-xs",children:["All",...Object.values(ne)].map(n=>e.jsxs("button",{onClick:()=>r(n),className:`px-2 py-1 rounded font-medium ${q===n?"bg-sky-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:[n," (",be[n]||0,")"]},n))})]}),e.jsxs("ul",{className:"flex-grow overflow-y-auto p-2 space-y-2",children:[pe.length===0&&e.jsx("li",{className:"text-center text-gray-600 py-4",children:"관계를 찾을 수 없습니다."}),pe.map(n=>{const y=oe(n.from),E=oe(n.to);if(!y||!E)return null;const f=te=>{const xe=Q(te),me=()=>{O.tags.has(te.id)?gt(te):O.descriptions.has(te.id)&&(fe(te.id),k(te.page),k(te.page))};return e.jsx("span",{onClick:me,className:"font-mono text-sky-600 hover:underline cursor-pointer",children:xe})},H=te=>{switch(te){case ne.Connection:return{icon:"⟶",title:"Connection"};case ne.Installation:return{icon:"📌",title:"Installation"};case ne.Annotation:return{icon:"📝",title:"Annotation"};case ne.Note:return{icon:"🏷️",title:"Note"};case ne.Description:return{icon:"📄",title:"Description"};default:return{icon:"🔗",title:"Unknown"}}},{icon:B,title:ee}=H(n.type);return e.jsxs("li",{className:"p-2 bg-gray-100 rounded-md text-sm text-gray-700 flex items-center justify-between hover:bg-gray-200 cursor-pointer transition-colors",onClick:()=>rt(n),title:`PDF에서 강조 표시: ${ee}`,children:[e.jsxs("div",{className:"flex items-center space-x-2 flex-grow",children:[e.jsx("span",{className:"text-xs text-gray-500 font-medium",children:n.type}),e.jsx("span",{className:"text-gray-700 text-xs",children:"출처"}),f(y),e.jsx("span",{className:"text-gray-700 text-xs",children:"대상"}),f(E)]}),e.jsx(kt,{onClick:()=>{ft(n.id)}})]},n.id)})]})]})},[t,h,N,p,k,se,fe,Oe,gt,ft]),_=["All",b.Line,b.Instrument,b.NotesAndHolds,b.DrawingNumber],J=s.useMemo(()=>t.filter(l=>!Ae||l.page===p).length,[t,Ae,p]);return e.jsxs("aside",{className:"h-full bg-white border-r border-gray-200 flex flex-col flex-shrink-0 relative",style:{width:`${Ye}px`},children:[e.jsxs("div",{className:"border-b border-gray-200 flex text-xs",children:[e.jsxs("button",{onClick:()=>$("tags"),className:`flex-1 py-2 px-1 font-semibold ${Ie==="tags"?"bg-gray-100 text-sky-600":"text-gray-700"}`,children:["태그 (",J,")"]}),e.jsxs("button",{onClick:()=>$("descriptions"),className:`flex-1 py-2 px-1 font-semibold ${Ie==="descriptions"?"bg-gray-100 text-sky-600":"text-gray-700"}`,children:["노트 (",tt.length,")"]}),e.jsxs("button",{onClick:()=>$("loops"),className:`flex-1 py-2 px-1 font-semibold ${Ie==="loops"?"bg-gray-100 text-sky-600":"text-gray-700"}`,children:["루프 (",St.length,")"]}),e.jsxs("button",{onClick:()=>$("relationships"),className:`flex-1 py-2 px-1 font-semibold ${Ie==="relationships"?"bg-gray-100 text-sky-600":"text-gray-700"}`,children:["관계 (",Pt.length,")"]})]}),Ie==="tags"&&e.jsxs("div",{className:"flex-grow flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-3 space-y-2 border-b border-gray-200 flex-shrink-0",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"태그 검색...",value:ve,onChange:l=>Pe(l.target.value),className:"w-full bg-white border border-gray-300 rounded-md px-2 py-1.5 pr-8 text-sm text-gray-900 focus:ring-sky-500 focus:border-sky-500"}),ve&&e.jsx("button",{onClick:()=>Pe(""),className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors p-0.5 rounded",title:"검색 지우기",children:e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("hr",{className:"border-gray-200"}),e.jsx("div",{className:"border-b border-gray-200 flex text-xs",children:_.map((l,D)=>{const R=t.filter(oe=>!Ae||oe.page===p),q=l==="All"?R.length:R.filter(oe=>oe.category===l).length,r=X===l,O=l==="Equipment"?"장비":l==="Instrument"?"계기":l==="DrawingNumber"?"도면번호":l==="NotesAndHolds"?"노트":l==="SpecialItem"?"특수":l==="All"?"전체":l;return e.jsx("button",{onClick:()=>le(l),className:`flex-1 py-1.5 px-1 font-semibold text-center border-r border-gray-300 last:border-r-0 ${r?"bg-gray-100 text-sky-600":"text-gray-700"}`,disabled:q===0&&l!=="All",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-xs leading-tight text-gray-700",children:O}),e.jsxs("span",{className:"text-xs text-gray-600 leading-tight",children:["(",q,")"]})]})},l)})})]}),w.length>1&&e.jsx("div",{className:"p-2 flex-shrink-0",children:e.jsxs("button",{onClick:ye,className:"w-full flex items-center justify-center space-x-2 bg-red-600 hover:bg-red-700 text-white font-semibold py-1.5 px-2 rounded-md transition-colors text-sm",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),e.jsxs("span",{children:["선택한 항목 삭제 (",w.length,")"]})]})}),e.jsxs("ul",{ref:st,className:"flex-grow overflow-y-auto p-2 divide-y divide-gray-200",onScroll:M,children:[De.length>100&&e.jsx("div",{style:{height:`${We.start*90}px`}}),Ne.map((l,D)=>{const R=De.length>100?We.start+D:D;return e.jsx(Gn,{tag:l,isSelected:w.includes(l.id),onItemClick:q=>Ht(l,R,q),onGoToTag:gt,relationships:j,allTags:t,allRawTextItems:N,descriptions:h,onToggleReviewStatus:Mt,onDeleteRelationship:ft,onDeleteTag:je,onUpdateTagText:ie,onDeleteItem:Dt,onUpdateItemText:F,loops:m,onUpdateLoop:ge,showDetails:Be},l.id)}),De.length>100&&e.jsx("div",{style:{height:`${Math.max(0,(De.length-We.end)*90)}px`}})]})]}),Ie==="descriptions"&&e.jsxs("div",{className:"flex-grow flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-3 border-b border-gray-200",children:e.jsx("div",{className:"text-xs text-gray-600 mb-2",children:"Press 'N' to create descriptions from selected items"})}),e.jsx("div",{ref:ht,className:"flex-grow overflow-y-auto p-3 space-y-2",children:tt.length===0?e.jsxs("div",{className:"text-center text-gray-500 mt-8",children:[e.jsx("div",{className:"text-lg mb-2",children:"📝"}),e.jsx("div",{className:"text-sm text-gray-600",children:Ae&&h.length>0?`${p} 페이지에 설명이 없습니다`:"아직 설명이 없습니다"}),e.jsx("div",{className:"text-xs mt-1",children:"Select items and press 'N' to create"})]}):tt.map(l=>{const D=U.includes(l.id),R=Nt===l.id,q=j.filter(r=>r.to===l.id&&r.type===ne.Description).map(r=>t.find(O=>O.id===r.from)).filter(Boolean);return e.jsxs("div",{"data-description-id":l.id,className:`group border rounded-lg p-3 hover:bg-gray-100 transition-colors ${D?"bg-purple-100 border-purple-400":"bg-gray-50 border-gray-300"}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("div",{className:"text-xs text-gray-600",children:[l.metadata.type," ",l.metadata.number," - ",l.metadata.scope]})}),q.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1",children:q.map(r=>e.jsxs("span",{onClick:O=>{O.stopPropagation(),se(r.id)},className:"inline-flex items-center space-x-1 px-2 py-0.5 bg-sky-600/30 text-sky-300 rounded text-xs border border-sky-600/50 hover:bg-sky-500/40 hover:text-sky-200 cursor-pointer transition-colors",title:`Click to focus on note tag: ${r.text}`,children:[e.jsx("span",{children:"📝"}),e.jsx("span",{className:"font-mono text-gray-700",children:r.text})]},r.id))})]}),e.jsxs("div",{className:"flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx(Kt,{onClick:()=>{R||(dt(l.id),ct(l.text),nt(l.metadata))},title:"Edit description"}),e.jsx(en,{onClick:()=>de([l.id])})]})]}),R?e.jsxs("div",{className:"space-y-2",children:[e.jsx("textarea",{value:wt,onChange:r=>ct(r.target.value),className:"w-full bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900 resize-none",rows:3,placeholder:"Enter description text...",autoFocus:!0}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-xs",children:[e.jsxs("select",{value:Qe.type,onChange:r=>nt({...Qe,type:r.target.value}),className:"bg-white border border-gray-300 rounded px-2 py-1 text-gray-900",children:[e.jsx("option",{value:"Note",children:"노트"}),e.jsx("option",{value:"Hold",children:"홀드"})]}),e.jsxs("select",{value:Qe.scope,onChange:r=>nt({...Qe,scope:r.target.value}),className:"bg-white border border-gray-300 rounded px-2 py-1 text-gray-900",children:[e.jsx("option",{value:"General",children:"일반"}),e.jsx("option",{value:"Specific",children:"특정"})]}),e.jsx("input",{type:"number",min:"1",value:Qe.number,onChange:r=>nt({...Qe,number:parseInt(r.target.value)||1}),className:"bg-white border border-gray-300 rounded px-2 py-1 text-gray-900"})]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Page ",l.page," • ",l.sourceItems.length," source items"]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(Qt,{onClick:()=>{dt(null),ct(""),nt({})}}),e.jsx(Jt,{onClick:()=>{he(l.id,wt,Qe),dt(null),ct(""),nt({})}})]})]}):e.jsxs("div",{className:"cursor-pointer",onClick:()=>a(l),children:[e.jsx("div",{className:"text-xs text-gray-700 leading-relaxed mb-2",children:l.text}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Page ",l.page," • ",l.sourceItems.length," source items"]})]})]},l.id)})})]}),Ie==="loops"&&e.jsxs("div",{className:"flex-grow flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-3 space-y-2 border-b border-gray-200",children:[e.jsx("input",{type:"text",placeholder:"루프 검색...",value:$e,onChange:l=>Se(l.target.value),className:"w-full bg-slate-900 border border-gray-300 rounded-md px-2 py-1.5 text-sm focus:ring-sky-500 focus:border-sky-500"}),e.jsx("div",{className:"text-xs text-gray-600",children:"Press 'L' to create loops from selected instrument tags"})]}),e.jsx("div",{className:"flex-grow overflow-y-auto p-3 space-y-2",children:St.length===0?e.jsxs("div",{className:"text-center text-gray-500 mt-8",children:[e.jsx("div",{className:"text-lg mb-2",children:"🔗"}),e.jsx("div",{className:"text-sm",children:"아직 생성된 루프가 없습니다"}),e.jsx("div",{className:"text-xs mt-1",children:"Select instrument tags and press 'L' to create"})]}):St.filter(l=>$e?(l.name||l.id).toLowerCase().includes($e.toLowerCase()):!0).sort((l,D)=>{const R=l.name||l.id,q=D.name||D.id;return R.localeCompare(q)}).map(l=>{const D=l.tagIds.map(r=>t.find(O=>O.id===r)).filter(Boolean),R=()=>D.length===0?null:D.reduce((r,O)=>O.bbox.y1<r.bbox.y1||O.bbox.y1===r.bbox.y1&&O.bbox.x1<r.bbox.x1?O:r),q=()=>{L(l.tagIds);const r=R();r&&se(r.id)};return e.jsxs("div",{className:"group border border-gray-300 rounded-lg p-3 bg-slate-700/30 cursor-pointer hover:bg-slate-600/30 transition-colors",onClick:q,title:"Click to select all tags in this loop",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"flex items-center space-x-2 flex-grow",children:Z===l.id?e.jsxs("div",{className:"flex items-center space-x-2 flex-grow",children:[e.jsx("input",{type:"text",value:S,onChange:r=>{r.stopPropagation(),T(r.target.value)},onKeyDown:r=>{r.stopPropagation(),r.key==="Enter"?Et():r.key==="Escape"&&Ct()},className:"bg-slate-800 border border-gray-300 rounded px-2 py-1 text-sky-300 font-mono font-semibold text-sm flex-grow focus:ring-sky-500 focus:border-sky-500",autoFocus:!0,onClick:r=>r.stopPropagation()}),e.jsx(Jt,{onClick:Et}),e.jsx(Qt,{onClick:Ct})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-sky-600 font-mono font-semibold text-sm",children:l.name||l.id}),e.jsxs("span",{className:"text-xs text-gray-600",children:["(",D.length," tags)",D.length>0&&` P. ${D.map(r=>r.page).filter((r,O,oe)=>oe.indexOf(r)===O).sort((r,O)=>r-O).join(", ")}`]}),e.jsx(Kt,{onClick:()=>Ot(l.id),title:"Edit loop name"})]})}),Z!==l.id&&e.jsx("button",{onClick:r=>{r.stopPropagation(),ue([l.id])},className:"text-red-400 hover:text-red-300 p-1",title:"Delete loop",children:"✕"})]}),e.jsx("div",{className:"flex flex-wrap gap-1",children:D.map(r=>e.jsxs("div",{className:"inline-flex items-center bg-gray-200 text-gray-700 rounded text-xs font-mono overflow-hidden",children:[e.jsxs("span",{onClick:O=>{O.stopPropagation(),se(r.id)},className:"px-2 py-1 cursor-pointer hover:bg-slate-500/50 transition-colors",title:`Click to center on tag: ${r.text}`,children:[r.text," ",e.jsxs("span",{className:"text-gray-600",children:["P.",r.page]})]}),e.jsx("button",{onClick:O=>{O.stopPropagation(),ge(l.id,{...l,tagIds:l.tagIds.filter(oe=>oe!==r.id)})},className:"px-1 py-1 text-red-400 hover:text-red-300 hover:bg-red-900/30 transition-colors",title:`Remove ${r.text} from loop`,children:"✕"})]},r.id))})]},l.id)})})]}),Ie==="relationships"&&e.jsx(Y,{relationships:Pt}),e.jsx("div",{className:"p-4 border-t border-gray-200 flex-shrink-0",children:e.jsxs("button",{onClick:i,className:"w-full flex items-center justify-center space-x-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded transition-colors",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z",clipRule:"evenodd"})}),e.jsx("span",{children:"엑셀로 내보내기"})]})}),e.jsx("div",{className:`absolute top-0 right-0 w-1 h-full cursor-col-resize group hover:bg-sky-500/50 transition-colors ${Je?"bg-sky-500":"bg-transparent"}`,onMouseDown:Lt,title:"Drag to resize sidebar",children:e.jsx("div",{className:"absolute top-1/2 right-0 transform -translate-y-1/2 translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsxs("div",{className:"flex flex-col items-center justify-center w-3 h-8 bg-slate-700 border border-gray-300 rounded-sm",children:[e.jsx("div",{className:"w-0.5 h-1 bg-slate-400 mb-0.5"}),e.jsx("div",{className:"w-0.5 h-1 bg-slate-400 mb-0.5"}),e.jsx("div",{className:"w-0.5 h-1 bg-slate-400"})]})})})]})},Zn=({selectedTagIds:t,setSelectedTagIds:o,allTags:N,relationships:h,onDeselect:m,onClear:x,rawTextItems:j,selectedRawTextItemIds:c,onDeselectRawTextItem:d,onCreateTag:v,manualCreationData:p,onManualTagCreate:k,onClearManualCreation:w})=>{const[L,U]=s.useState(""),[z,P]=s.useState(!1);s.useEffect(()=>{p&&U("")},[p]);const W=t.length>0,ie=c.length>0;if(p){const de=he=>{L.trim()?k({text:L.trim(),category:he}):alert("태그에 텍스트를 입력해주세요.")};return e.jsx("div",{className:"absolute bottom-5 left-1/2 -translate-x-1/2 w-full max-w-3xl z-20 px-4 animate-fade-in-up",children:e.jsxs("div",{className:"bg-white/95 backdrop-blur-lg border border-gray-200 rounded-xl shadow-2xl p-3",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 px-1",children:[e.jsx("h3",{className:"font-bold text-md text-gray-900",children:"수동으로 태그 생성"}),e.jsx("button",{onClick:w,className:"text-sm font-semibold text-sky-400 hover:text-sky-300 transition-colors",children:"취소"})]}),e.jsx("div",{className:"mb-3",children:e.jsx("input",{type:"text",placeholder:"태그 텍스트 입력...",value:L,onChange:he=>U(he.target.value),className:"w-full bg-white border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-sky-500 focus:border-sky-500",autoFocus:!0})}),e.jsxs("div",{className:"flex items-center justify-between border-t border-slate-700 pt-2",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700",children:"카테고리 선택:"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("button",{onClick:()=>de(b.Uncategorized),className:"px-3 py-1.5 text-sm font-semibold text-gray-900 bg-orange-600 rounded-md hover:bg-orange-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"1"}),e.jsx("span",{children:"장비"})]}),e.jsxs("button",{onClick:()=>de(b.Line),className:"px-3 py-1.5 text-sm font-semibold text-gray-900 bg-rose-600 rounded-md hover:bg-rose-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"2"}),e.jsx("span",{children:"라인"})]}),e.jsxs("button",{onClick:()=>de(b.Uncategorized),className:"px-3 py-1.5 text-sm font-semibold text-gray-900 bg-purple-600 rounded-md hover:bg-purple-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"3"}),e.jsx("span",{children:"특수 항목"})]}),e.jsxs("button",{onClick:()=>de(b.Instrument),className:"px-3 py-1.5 text-sm font-semibold text-gray-900 bg-amber-500 rounded-md hover:bg-amber-600 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"4"}),e.jsx("span",{children:"계기"})]}),e.jsxs("button",{onClick:()=>de(b.NotesAndHolds),className:"px-3 py-1.5 text-sm font-semibold text-gray-900 bg-teal-600 rounded-md hover:bg-teal-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"5"}),e.jsx("span",{children:"노트/홀드"})]}),e.jsx("button",{onClick:()=>de(b.DrawingNumber),className:"px-3 py-1.5 text-sm font-semibold text-gray-900 bg-indigo-600 rounded-md hover:bg-indigo-700 transition-colors",children:"도면 번호"})]})]})]})})}return!W&&!ie?null:e.jsx("div",{className:"absolute bottom-5 left-1/2 -translate-x-1/2 w-full max-w-4xl z-20 px-4 animate-fade-in-up",children:e.jsx("div",{className:"bg-white/95 backdrop-blur-lg border border-gray-200 rounded-xl shadow-2xl p-3",children:e.jsxs("div",{className:"flex flex-col space-y-3 max-h-72 overflow-y-auto pr-1",children:[ie&&(()=>{let de=c.map(F=>j.find(I=>I.id===F)).filter(Boolean);z&&(de=[...de].sort((F,I)=>F.text.localeCompare(I.text)));const he=h.find(F=>F.type===ne.Annotation&&c.includes(F.to));let G=null;return he&&(G=N.find(F=>F.id===he.from)),e.jsxs("div",{className:W?"pb-3 mb-3 border-b border-slate-700":"",children:[G&&e.jsx("div",{className:"mb-2 px-1 py-1 bg-amber-500/10 rounded-md border border-amber-500/30",children:e.jsxs("p",{className:"text-xs text-amber-400",children:["📎 ",G.text," 설명 (",de.length,"줄)"]})}),e.jsxs("div",{className:"flex justify-between items-center mb-2 px-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("h3",{className:"font-bold text-md text-gray-900",children:[de.length,"개의 텍스트 선택됨"]}),e.jsx("button",{onClick:()=>P(!z),className:`p-1.5 rounded-md transition-colors ${z?"bg-sky-600 text-gray-900 hover:bg-sky-500":"bg-gray-200 text-gray-600 hover:bg-gray-300 hover:text-gray-900"}`,title:`정렬: ${z?"가나다순":"선택 순서"}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"})})})]}),e.jsx("button",{onClick:x,className:"text-sm font-semibold text-sky-400 hover:text-sky-300 transition-colors",children:"선택 취소"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 max-h-20 overflow-y-auto pr-2 mb-3",children:de.map(F=>e.jsxs("div",{className:"flex items-center bg-gray-200 rounded-full py-1 pl-3 pr-2 text-sm text-gray-900",children:[e.jsx("span",{className:"font-mono text-gray-900 mr-2",children:F.text}),e.jsx("button",{onClick:()=>d(F.id),className:"w-5 h-5 flex items-center justify-center rounded-full bg-gray-300 hover:bg-red-500 transition-colors","aria-label":`Deselect ${F.text}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]},F.id))})]})})(),W&&(()=>{let de=t.map(g=>N.find(K=>K.id===g)).filter(g=>!!g);if(z){const g={[b.Line]:0,[b.Instrument]:1,[b.DrawingNumber]:2,[b.NotesAndHolds]:3,[b.Uncategorized]:4};de=[...de].sort((K,V)=>{const ue=g[K.category]??99,ge=g[V.category]??99;return ue!==ge?ue-ge:K.text.localeCompare(V.text)})}const he=t.length===1?N.find(g=>g.id===t[0]):null;let G=[];he&&he.category===b.Line&&(G=h.filter(g=>g.type===ne.Installation&&g.to===he.id).map(g=>N.find(K=>K.id===g.from)).filter(Boolean));const F=g=>{t.includes(g)||o(K=>[...K,g])},I=()=>{const g=G.map(K=>K.id);o(K=>[...new Set([...K,...g])])};return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 px-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("h3",{className:"font-bold text-md text-gray-900",children:[de.length,"개의 태그 선택됨"]}),e.jsx("button",{onClick:()=>P(!z),className:`p-1.5 rounded-md transition-colors ${z?"bg-sky-600 text-gray-900 hover:bg-sky-500":"bg-gray-200 text-gray-600 hover:bg-gray-300 hover:text-gray-900"}`,title:`정렬: ${z?"가나다순":"선택 순서"}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"})})})]}),e.jsx("button",{onClick:x,className:"text-sm font-semibold text-sky-400 hover:text-sky-300 transition-colors",children:"Clear Selection"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 max-h-28 overflow-y-auto pr-2",children:de.map(g=>e.jsxs("div",{className:"flex items-center bg-gray-200 rounded-full py-1 pl-3 pr-2 text-sm text-gray-900",children:[e.jsx("span",{className:"font-mono text-gray-900 mr-2",children:g.text}),e.jsx("button",{onClick:()=>m(g.id),className:"w-5 h-5 flex items-center justify-center rounded-full bg-gray-300 hover:bg-red-500 transition-colors","aria-label":`Deselect ${g.text}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]},g.id))}),G.length>0&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-slate-700",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 px-1",children:[e.jsxs("h4",{className:"font-semibold text-sm text-gray-900",children:["설치된 계기 (",G.length,")"]}),e.jsx("button",{onClick:I,className:"text-sm font-semibold text-sky-400 hover:text-sky-300 transition-colors",children:"모두 선택"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 max-h-28 overflow-y-auto pr-2",children:G.map(g=>{const K=t.includes(g.id);return e.jsxs("div",{className:`flex items-center rounded-full py-1 pl-3 pr-2 text-sm text-gray-900 transition-colors ${K?"bg-gray-300":"bg-gray-200"}`,children:[e.jsx("span",{className:`font-mono mr-2 ${K?"text-gray-500":"text-gray-900"}`,children:g.text}),!K&&e.jsx("button",{onClick:()=>F(g.id),className:"w-5 h-5 flex items-center justify-center rounded-full bg-gray-300 hover:bg-sky-500 transition-colors","aria-label":`Select ${g.text}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z",clipRule:"evenodd"})})})]},g.id)})})]})]})})()]})})})},Rt=at.memo(({onClick:t})=>e.jsx("button",{onClick:o=>{o.stopPropagation(),t()},className:"p-0.5 rounded-full text-slate-500 hover:bg-red-500/20 hover:text-red-400 transition-colors",title:"Delete relationship",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})),an=at.memo(({onClick:t,title:o="Edit"})=>e.jsx("button",{onClick:N=>{N.stopPropagation(),t()},className:"p-1 rounded-full text-slate-500 hover:bg-sky-500/20 hover:text-sky-400 transition-colors opacity-0 group-hover:opacity-100",title:o,children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:[e.jsx("path",{d:"M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"}),e.jsx("path",{d:"M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"})]})})),ln=at.memo(({onClick:t})=>e.jsx("button",{onClick:o=>{o.stopPropagation(),t()},className:"p-1 rounded-full text-slate-500 hover:bg-red-500/20 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100",title:"Delete",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})),_n=({pdfDoc:t,tags:o,setTags:N,relationships:h,setRelationships:m,rawTextItems:x,descriptions:j,setDescriptions:c,detectedLines:d,loops:v,setLoops:p,appSettings:k,onCreateTag:w,onCreateManualTag:L,onCreateDescription:U,onCreateHoldDescription:z,onDeleteTags:P,onUpdateTagText:W,onDeleteDescriptions:ie,onUpdateDescription:de,onMergeRawTextItems:he,onDeleteRawTextItems:G,onUpdateRawTextItemText:F,onAutoLinkDescriptions:I,onAutoLinkNotesAndHolds:g,onAutoGenerateLoops:K,onManualCreateLoop:V,onDeleteLoops:ue,onUpdateLoop:ge,showConfirmation:Ee,currentPage:se,setCurrentPage:fe,scale:Oe,setScale:Xe,mode:Ue,setMode:ce,relationshipStartTag:ae,setRelationshipStartTag:we,visibilitySettings:ke,updateVisibilitySettings:Ae,toggleTagVisibility:Re,toggleRelationshipVisibility:Be,toggleAllTags:ze,toggleAllRelationships:ve,isSidePanelVisible:Pe,showAutoLinkRanges:$e,tolerances:Se,colorSettings:Ie,showAllRelationships:$,setShowAllRelationships:Z,showOnlySelectedRelationships:Ce,setShowOnlySelectedRelationships:S})=>{var Ht,gt;const[T,X]=s.useState([]),[le,Le]=s.useState([]),[He,Te]=s.useState([]),[Fe,Ye]=s.useState(null),[lt,Je]=s.useState(null),[It,Nt]=s.useState(null),[dt,wt]=s.useState(null),[ct,Qe]=s.useState(null),[nt,mt]=s.useState(null),[At,We]=s.useState(!1),[Ge,st]=s.useState(""),[ht,ot]=s.useState(new Set),[et,ft]=s.useState(!1),je=et?o.find(ye=>ye.id===T[0]):null;at.useEffect(()=>{if(!Pe&&T.length===1){const i=setTimeout(()=>{ft(!0)},50);return()=>clearTimeout(i)}else ft(!1)},[Pe,T.length]);const Dt=ye=>{X(i=>i.filter(a=>a!==ye)),T.length<=1&&Ye(null)},Mt=ye=>{Le(i=>i.filter(a=>a!==ye))},Ot=()=>{X([]),Le([]),Te([]),Ye(null)},Et=(ye,i)=>{Je({bbox:ye,page:i})},Ct=({text:ye,category:i})=>{lt&&(L({...lt,text:ye,category:i}),Je(null))},Lt=()=>{Je(null)},ut=ye=>{We(!0),st(ye.text)},pt=()=>{Ge.trim()&&Ge!==je.text&&je&&W(je.id,Ge.trim()),We(!1),st("")},De=()=>{We(!1),st("")},Ne=ye=>{m(i=>i.filter(a=>a.id!==ye))},tt=s.useCallback(ye=>{const i=o.find(a=>a.id===ye);i&&i.page!==se&&fe(i.page),Nt(ye),setTimeout(()=>Nt(null),2e3),mt({tagId:ye,timestamp:Date.now()}),setTimeout(()=>mt(null),100)},[o,se,fe]),St=s.useCallback(ye=>{const i=j.find(a=>a.id===ye);i&&i.page!==se&&fe(i.page),wt(ye),setTimeout(()=>wt(null),2e3),i&&(mt({descriptionId:ye,timestamp:Date.now()}),setTimeout(()=>mt(null),100))},[j,se,fe]),Pt=s.useCallback(ye=>{const i=h.find(a=>a.id===ye);if(i){const a=o.find(C=>C.id===i.from)||x.find(C=>C.id===i.from),u=o.find(C=>C.id===i.to)||x.find(C=>C.id===i.to),A=(a==null?void 0:a.page)||(u==null?void 0:u.page);A&&A!==se&&fe(A)}Qe(ye),setTimeout(()=>Qe(null),2e3)},[h,se,fe]);return e.jsxs("div",{className:"flex h-full bg-gray-50 relative",children:[Pe&&e.jsx(Xn,{tags:o,setTags:N,rawTextItems:x,descriptions:j,loops:v,setLoops:p,detectedLines:d,appSettings:k,currentPage:se,setCurrentPage:fe,selectedTagIds:T,setSelectedTagIds:ye=>{X(ye),Ye("panel")},tagSelectionSource:Fe,selectedDescriptionIds:He,setSelectedDescriptionIds:Te,relationships:h,setRelationships:m,onDeleteTags:P,onUpdateTagText:W,onDeleteDescriptions:ie,onUpdateDescription:de,onDeleteRawTextItems:G,onUpdateRawTextItemText:F,onAutoLinkDescriptions:I,onAutoLinkNotesAndHolds:g,onAutoGenerateLoops:K,onManualCreateLoop:V,onDeleteLoops:ue,onUpdateLoop:ge,showConfirmation:Ee,onPingTag:tt,onPingDescription:St,onPingRelationship:Pt,visibilitySettings:ke,updateVisibilitySettings:Ae,toggleTagVisibility:Re,toggleRelationshipVisibility:Be,toggleAllTags:ze,toggleAllRelationships:ve}),e.jsx("div",{className:"flex-grow h-full overflow-auto bg-gray-100",children:e.jsx($n,{pdfDoc:t,tags:o,setTags:N,relationships:h,setRelationships:m,currentPage:se,setCurrentPage:fe,selectedTagIds:T,setSelectedTagIds:ye=>{X(ye),Ye("pdf")},selectedDescriptionIds:He,setSelectedDescriptionIds:Te,rawTextItems:x,descriptions:j,onCreateTag:w,onCreateDescription:U,onCreateHoldDescription:z,selectedRawTextItemIds:le,setSelectedRawTextItemIds:Le,onDeleteTags:P,onMergeRawTextItems:he,onManualCreateLoop:V,onManualAreaSelect:Et,onOPCTagClick:()=>{},onUpdateTagText:W,onUpdateRawTextItemText:F,scale:Oe,setScale:Xe,mode:Ue,setMode:ce,relationshipStartTag:ae,setRelationshipStartTag:we,visibilitySettings:ke,updateVisibilitySettings:Ae,pingedTagId:It,pingedDescriptionId:dt,pingedRelationshipId:ct,colorSettings:Ie,scrollToCenter:nt,setScrollToCenter:mt,showAutoLinkRanges:$e,tolerances:Se,showAllRelationships:$,setShowAllRelationships:Z,showOnlySelectedRelationships:Ce,setShowOnlySelectedRelationships:S,detectedLines:d,appSettings:k})}),e.jsx(Zn,{selectedTagIds:T,setSelectedTagIds:X,allTags:o,relationships:h,onDeselect:Dt,onClear:Ot,rawTextItems:x,selectedRawTextItemIds:le,onDeselectRawTextItem:Mt,onCreateTag:w,manualCreationData:lt,onManualTagCreate:Ct,onClearManualCreation:Lt}),et&&je&&e.jsx("div",{className:"fixed left-4 top-20 w-80 bg-white border border-gray-200 rounded-lg shadow-xl z-40 max-h-96 overflow-y-auto transition-opacity duration-150",style:{transform:"translateZ(0)"},children:e.jsxs("div",{className:"group p-2 rounded-md hover:bg-gray-100",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-grow mr-2",children:[e.jsxs("div",{className:"flex items-center space-x-2 flex-grow min-w-0",children:[e.jsx("input",{type:"checkbox",checked:je.isReviewed||!1,onChange:ye=>{ye.stopPropagation(),N(i=>i.map(a=>a.id===je.id?{...a,isReviewed:!a.isReviewed}:a))},className:"w-4 h-4 text-sky-600 bg-white border-gray-400 rounded focus:ring-sky-500 focus:ring-2",title:"Mark as reviewed"}),e.jsx("span",{className:`inline-flex items-center justify-center w-5 h-5 rounded text-xs font-bold text-gray-900 ${((Ht=qt[je.category])==null?void 0:Ht.bg)||"bg-gray-200"} ${((gt=qt[je.category])==null?void 0:gt.border)||"border-gray-400"} border flex-shrink-0`,children:je.category===b.Line?"L":je.category===b.Instrument?"I":je.category===b.DrawingNumber?"D":je.category===b.NotesAndHolds?"N":"U"}),At?e.jsx("div",{className:"flex items-center space-x-1 flex-grow",children:e.jsx("input",{type:"text",value:Ge,onChange:ye=>st(ye.target.value),onKeyDown:ye=>{ye.key==="Enter"&&pt(),ye.key==="Escape"&&De()},onBlur:pt,autoFocus:!0,className:"font-mono text-sm text-gray-900 bg-gray-100 border border-sky-500 rounded px-1 flex-grow"})}):e.jsx("span",{className:"font-mono text-sm text-gray-900 truncate",children:je.text})]}),je.category===b.Instrument&&(()=>{const ye=(v==null?void 0:v.filter(i=>i.tagIds.includes(je.id)))||[];return ye.length>0&&e.jsx("div",{className:"mt-1",children:ye.map(i=>e.jsx("div",{className:"mb-1",children:e.jsxs("span",{className:"text-xs text-blue-400 font-mono ml-8",children:["Loop: ",i.name||i.id]})},i.id))})})()]}),e.jsxs("div",{className:"flex items-center space-x-1 flex-shrink-0",children:[e.jsxs("span",{className:"text-xs text-gray-600",children:["P. ",je.page]}),e.jsx(an,{onClick:()=>ut(je),title:"Edit tag text"}),e.jsx(ln,{onClick:()=>{confirm(`Delete tag "${je.text}"?`)&&(P([je.id]),X([]))}}),e.jsx("button",{onClick:()=>X([]),className:"text-gray-600 hover:text-gray-900 transition-colors p-1 rounded hover:bg-gray-100 ml-2",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}),(()=>{const ye=h.filter(r=>r.from===je.id&&r.type==="Connection"),i=h.filter(r=>r.to===je.id&&r.type==="Connection"),a=h.find(r=>r.from===je.id&&r.type==="Installation"),u=h.filter(r=>r.to===je.id&&r.type==="Installation"),A=h.filter(r=>(r.from===je.id||r.to===je.id)&&r.type==="Annotation"),C=h.filter(r=>r.from===je.id&&r.type==="Note"),M=h.filter(r=>r.to===je.id&&r.type==="Note"),Y=h.filter(r=>r.from===je.id&&r.type==="Description"),_=h.filter(r=>r.to===je.id&&r.type==="Description"),l=(()=>{if(!je||je.category!==b.Instrument)return null;const r=o.filter(re=>re.category===b.Line&&re.page===je.page);if(r.length===0)return null;const O=(re,pe)=>{const be=(re.bbox.x1+re.bbox.x2)/2,rt=(re.bbox.y1+re.bbox.y2)/2,n=(pe.bbox.x1+pe.bbox.x2)/2,y=(pe.bbox.y1+pe.bbox.y2)/2,E=n-be,f=y-rt;return Math.sqrt(E*E+f*f)};let oe=null,Q=1/0;for(const re of r){const pe=O(je,re);pe<Q&&(Q=pe,oe=re)}return oe})(),D=ye.length>0||i.length>0||a||u.length>0||A.length>0||C.length>0||M.length>0||Y.length>0||_.length>0||l!==null,R=(r,O)=>e.jsx("button",{onClick:oe=>{oe.stopPropagation();const Q=o.find(re=>re.id===r);Q&&(X([Q.id]),fe(Q.page),Ye("panel"),tt(Q.id))},className:"text-sky-400 hover:text-sky-300 font-mono cursor-pointer",children:O},r),q=new Map(o.map(r=>[r.id,r]));return(D||l)&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-gray-300/50 space-y-1 text-xs text-gray-600",children:[ye.map(r=>{const O=q.get(r.to);return O?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{className:"text-gray-600 text-xs",children:"To"}),R(O.id,O.text)]}),e.jsx(Rt,{onClick:()=>Ne(r.id)})]},r.id):null}),i.map(r=>{const O=q.get(r.from);return O?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{className:"text-gray-600 text-xs",children:"From"}),R(O.id,O.text)]}),e.jsx(Rt,{onClick:()=>Ne(r.id)})]},r.id):null}),a&&q.get(a.to)&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{title:"Installation",children:"📌"}),e.jsx("span",{className:"text-gray-600",children:"Installed on:"}),R(a.to,q.get(a.to).text)]}),e.jsx(Rt,{onClick:()=>Ne(a.id)})]}),u.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"Installed Instruments:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:u.map(r=>{const O=q.get(r.from);return O?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:R(O.id,O.text)}),e.jsx(Rt,{onClick:()=>Ne(r.id)})]},r.id):null})})]}),A.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Related Text:"}),e.jsx("div",{className:"pl-3 space-y-1 mt-1",children:A.map(r=>{const O=r.from===je.id?r.to:r.from,oe=x.find(re=>re.id===O),Q=ht.has(O);return oe?e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3 text-slate-500 flex-shrink-0",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z",clipRule:"evenodd"})}),Q?e.jsx("input",{type:"text",defaultValue:oe.text,onBlur:re=>{re.target.value.trim()!==oe.text&&F(O,re.target.value.trim()),ot(pe=>{const be=new Set(pe);return be.delete(O),be})},onKeyDown:re=>{re.key==="Enter"&&re.target.blur(),re.key==="Escape"&&ot(pe=>{const be=new Set(pe);return be.delete(O),be})},autoFocus:!0,className:"text-gray-700 font-mono bg-gray-100 border border-sky-500 rounded px-1 flex-grow text-xs"}):e.jsxs("span",{className:"text-gray-700 font-mono truncate max-w-[180px]",children:['"',oe.text,'"']})]}),e.jsxs("div",{className:"flex items-center flex-shrink-0",children:[e.jsx(an,{onClick:()=>{ot(re=>{const pe=new Set(re);return pe.add(O),pe})}}),e.jsx(ln,{onClick:()=>G([O])}),e.jsx(Rt,{onClick:()=>Ne(r.id)})]})]},r.id):null})})]}),l&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"Connected Line:"}),e.jsx("div",{className:"pl-3 mt-1",children:e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{title:"Line",children:"📐"}),e.jsx("button",{onClick:r=>{r.stopPropagation(),X([l.id]),Ye("panel"),tt(l.id)},className:"text-sky-400 hover:text-sky-300 font-mono cursor-pointer",children:l.text})]})})]}),C.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"Notes:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:C.map(r=>{const O=q.get(r.to);return O?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{title:"Note",children:"📝"}),R(O.id,O.text)]}),e.jsx(Rt,{onClick:()=>Ne(r.id)})]},r.id):null})})]}),M.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Note for:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:M.map(r=>{const O=q.get(r.from);return O?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:R(O.id,O.text)}),e.jsx(Rt,{onClick:()=>Ne(r.id)})]},r.id):null})})]}),(Y.length>0||_.length>0)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Descriptions:"}),e.jsxs("div",{className:"pl-3 space-y-0.5 mt-1",children:[Y.map(r=>{const O=j.find(oe=>oe.id===r.to);return O?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-purple-300",children:["📄 ",O.metadata.type," ",O.metadata.number]}),e.jsx(Rt,{onClick:()=>Ne(r.id)})]},r.id):null}),_.map(r=>{const O=j.find(oe=>oe.id===r.from);return O?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-purple-300",children:["📄 ",O.metadata.type," ",O.metadata.number]}),e.jsx(Rt,{onClick:()=>Ne(r.id)})]},r.id):null})]})]})]})})()]})})]})},Yn=({hasData:t,onOpenSettings:o,pdfDoc:N,currentPage:h,setCurrentPage:m,onToggleSidePanel:x})=>e.jsx("header",{className:"relative flex-shrink-0 bg-white border-b border-gray-200 p-2 z-50",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-2 justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("img",{src:"/gs-logo.png",alt:"GS Logo",className:"h-6 w-6 lg:h-8 lg:w-8 object-contain"}),e.jsx("h1",{className:"text-lg lg:text-xl font-bold text-gray-900 tracking-tight hidden sm:inline",children:"계장태그 추출기"}),e.jsx("h1",{className:"text-lg font-bold text-gray-900 tracking-tight sm:hidden",children:"태그추출기"}),t&&e.jsx("button",{onClick:x,className:"p-1.5 rounded-md text-gray-600 hover:bg-gray-100 hover:text-gray-900 transition-colors",title:"사이드 패널 토글 (S)",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 lg:h-5 lg:w-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"9",y1:"3",x2:"9",y2:"21"})]})})]}),t&&N&&e.jsxs("div",{className:"bg-white p-1 rounded-xl shadow-lg flex items-center gap-2 border border-gray-200",children:[e.jsx("button",{onClick:()=>m(Math.max(1,h-1)),disabled:h===1,className:"px-2 py-1 bg-gray-200 rounded disabled:opacity-50 hover:bg-gray-300 transition-colors text-sm text-gray-900",children:"←"}),e.jsxs("span",{className:"text-sm whitespace-nowrap text-gray-700",children:["페이지 ",h,"/",N.numPages]}),e.jsx("button",{onClick:()=>m(Math.min(N.numPages,h+1)),disabled:h===N.numPages,className:"px-2 py-1 bg-gray-200 rounded disabled:opacity-50 hover:bg-gray-300 transition-colors text-sm text-gray-900",children:"→"})]}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("button",{onClick:o,className:"p-2 text-sm font-semibold text-white bg-gray-600 rounded-md hover:bg-gray-700 transition-colors",title:"설정",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.532 1.532 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z",clipRule:"evenodd"})})})})]})});function cn(t){if(!t)return"";const o=/^(\d+(?:\/\d+)?)"?-([A-Z]{1,4})-(\d{3,})(?:-([A-Z0-9]+))?$/i,N=/^(\d+)"?-(\d{4})-([A-Z])-(\d{3})-([A-Z0-9-]+)$/i,h=/^(\d+(?:\/\d+)?)"?-([A-Z]{2,})-(\d+)$/i;if(o.test(t))return'\\d+(?:[/\\d]+)?"?-[A-Z]{1,4}-\\d{3,}(?:-[A-Z0-9]+)?';if(N.test(t))return'\\d+"?-\\d{4}-[A-Z]-\\d{3}-[A-Z0-9-]+';if(h.test(t))return'\\d+(?:[/\\d]+)?"?-[A-Z]{2,}-\\d+';const m=t.split(/[-"]/);let x="";for(let j=0;j<m.length;j++){const c=m[j];c&&(j>0&&(x+="-"),/^\d+$/.test(c)?x+=`\\d{${c.length}}`:/^\d+\/\d+$/.test(c)?x+="\\d+/\\d+":/^[A-Z]+$/i.test(c)?x+=`[A-Z]{${c.length}}`:/^[A-Z0-9]+$/i.test(c)?x+="[A-Z0-9]+":x+="[A-Z0-9-]+")}return t.includes('"')&&(x=x.replace(/^(\\d[^-]*)/,'$1"?')),x||'\\d+(?:[/\\d]+)?"?-[A-Z]{1,4}-\\d{3,}'}function qn(t){if(!t)return{func:"",num:""};const o=t.trim().replace(/\s+/g," "),N=/^([A-Z]{2,5})[-\s]?(\d{3,4}[A-Z]?)$/i,h=/^([A-Z]{2,5})\s+(\d{3,4}[A-Z]?)$/i,m=/^([A-Z]{2,6})[-\s]?(\d{3,4}[A-Z]?)$/i,x=o.match(N)||o.match(h)||o.match(m);if(x){const j=x[1],c=x[2],d=j.length<=3?"[A-Z]{2,3}":`[A-Z]{${Math.min(j.length-1,2)},${Math.min(j.length+1,6)}}`,v=/[A-Z]$/.test(c),p=c.replace(/[A-Z]/g,"").length,k=v?`\\d{${p}}[A-Z]?`:`\\d{${Math.max(3,p)},${Math.max(4,p)}}`;return{func:d,num:k}}return{func:"[A-Z]{2,4}",num:"\\d{3,4}(?:\\s?[A-Z])?"}}function dn(t){if(!t)return"";const o=/^[A-Z0-9]+(-[A-Z0-9]+){2,}$/i,N=/^P&ID-\d+-REV-[A-Z]$/i,h=/^[0-9]{3,}[A-Z]{2,}-[0-9]{4}-[A-Z]{2,}-[A-Z]-[0-9]{3,}$/i;if(N.test(t))return"P&ID-\\d+-REV-[A-Z]";if(h.test(t))return"\\d{3,}[A-Z]{2,}-\\d{4}-[A-Z]{2,}-[A-Z]-\\d{3,}";if(o.test(t)){const m=t.split("-"),x=Math.max(3,m.length-1),j=m.length+2,d=/[A-Z]/i.test(t)?"[A-Z0-9]+":"\\d+";let v=d;for(let p=1;p<x;p++)v+=`(-${d})`;for(let p=x;p<j;p++)v+=`(-${d})?`;return v}return"[A-Z0-9][A-Z0-9\\-]{10,}"}function un(t,o,N){const h={};if(t){const m=t.split(",").map(x=>x.trim()).filter(Boolean);if(m.length===1)h.line=cn(m[0]);else if(m.length>1){const x=m.map(cn).filter(Boolean);x.length>0&&(h.line=x.length===1?x[0]:`(${x.join("|")})`)}}if(o){const m=o.split(",").map(x=>x.trim()).filter(Boolean);if(m.length>0){const x=m.map(qn),j=[...new Set(x.map(d=>d.func).filter(Boolean))],c=[...new Set(x.map(d=>d.num).filter(Boolean))];h.instrument={func:j.length===1?j[0]:`(${j.join("|")})`,num:c.length===1?c[0]:`(${c.join("|")})`}}}if(N){const m=N.split(",").map(x=>x.trim()).filter(Boolean);if(m.length===1)h.drawing=dn(m[0]);else if(m.length>1){const x=m.map(dn).filter(Boolean);x.length>0&&(h.drawing=x.length===1?x[0]:`(${x.join("|")})`)}}return h}const gn="https://api.openai.com/v1/chat/completions",Kn="gpt-4-turbo-preview";async function Jn(t,o,N,h){var j,c,d;if(!t)throw new Error("OpenAI API key is required");const m=`You are an expert regex pattern generator specialized in P&ID (Piping and Instrumentation Diagram) tag recognition across multiple industries and standards.

COMPREHENSIVE P&ID PATTERN RULES:

1. LINE NUMBERS (Process/Piping Lines):
Common formats across industries:
- Size-Service-Number: "8"-PL-30001", "1/2"-WS-10001", "DN100-CW-2001"
- Size-Number-Service-Details: "42"-7300-P-037-11051XR-PP", "12"-1234-HC-567-A1B"
- Complex with specifications: "8"-PL-30001-C1C-INS", "3"-GL-30401-N1E-H2B3"
- With material codes: "4"-SS-304L-PL-1001", "6"-CS-A106B-ST-2002"
- International formats: "100-L-12345-CS", "DN150-W-67890-SS316"

Size variations: 1/8", 1/4", 1/2", 3/4", 1", 2", 3", 4", 6", 8", 10", 12", 14", 16", 18", 20", 24", 30", 36", 42", 48"
Or metric: DN15, DN20, DN25, DN32, DN40, DN50, DN65, DN80, DN100, DN150, DN200, DN250, DN300

Service codes: PL, GL, WS, ST, CW, CHW, RW, CS, SS, HC, LC, AC, NG, FG, IA, N2, H2, O2, AR, HE

Key characteristics:
- Usually contains size (with quotes " or DN prefix)
- Multiple hyphen-separated segments (minimum 3)
- May include material specs, insulation codes, tracing info

2. INSTRUMENT TAGS (ISA Standard):
Format: [Function Letters][Loop Number][Suffix]

Function Letters (First letter + modifiers):
First Letter (Measured Variable):
- A (Analysis), B (Burner), C (Conductivity), D (Density), E (Voltage)
- F (Flow), G (Gauging), H (Hand/Manual), I (Current), J (Power)
- K (Time/Schedule), L (Level), M (Moisture), N (User Choice), O (User Choice)
- P (Pressure), Q (Quantity), R (Radiation), S (Speed), T (Temperature)
- U (Multi-variable), V (Vibration), W (Weight), X (Unclassified), Y (Event), Z (Position)

Succeeding Letters:
- A (Alarm), B (User Choice), C (Control), D (Differential), E (Element)
- F (Ratio), G (Glass/Gauge), H (High), I (Indicate), J (Scan), K (Control Station)
- L (Light/Low), M (Momentary), N (User Choice), O (Orifice), P (Point/Test)
- Q (Integrate), R (Record), S (Switch), T (Transmit), U (Multifunction)
- V (Valve), W (Well), X (Unclassified), Y (Relay), Z (Driver/Actuator)

Common combinations:
- FT, FE, FI, FIC, FICA, FCV, FV, FSL, FSH (Flow)
- PT, PE, PI, PIC, PCV, PSV, PSL, PSH, PDI, PDT (Pressure)
- LT, LE, LI, LIC, LCV, LSL, LSH, LAL, LAH (Level)
- TT, TE, TI, TIC, TCV, TSL, TSH, TW, TR (Temperature)
- XV, HV, HCV, HS, HIC, XCV (Valves/Hand)

Loop numbers: 001-9999, may include area prefix (11-FT-101, 2-PT-2001)
Suffixes: A, B, C (for multiple devices in same loop)

3. DRAWING NUMBERS:
Various company standards:
- Project-Area-Type-Sequential: "00342GS-7300-PRP-D-105"
- Simple sequential: "P&ID-001", "PID-2023-001-REV-A"
- Complex hierarchical: "PRJ-UNIT-DISC-TYPE-SHEET": "ABC-U01-PROC-PID-001"
- With revision: "DWG-12345-R1", "SK-67890-REV-B", "P123-456-789-R0"
- ISO format: "XXXX-YY-ZZ-NNNN" where X=project, Y=area, Z=type, N=number
- Company specific: "CLIENT-PLANT-AREA-DOC-NUMBER"

Common prefixes: P&ID, PID, PFD, DWG, SK, ISO, GA, PROC, INST, LOOP
Common suffixes: REV-X, R0/R1/R2, -SH1/-SH2 (sheet numbers)

REGEX GENERATION RULES:
- Be flexible enough to catch variations but specific enough to avoid false positives
- Use character classes for variable parts: [A-Z], \\d, [A-Z0-9]
- Use quantifiers appropriately: {2,4} for 2-4 chars, + for one or more, * for zero or more
- Account for optional parts with ?: (...)? for optional groups
- Consider word boundaries \\b when needed to avoid partial matches
- For hyphens in patterns, remember they're literal characters not ranges

Return ONLY a JSON object with the regex patterns, no explanation or markdown. Use double backslashes for regex escapes.`,x=`Generate regex patterns for these P&ID samples. Analyze the structure and create patterns that will match similar formats:

${o?`Line Sample(s): "${o}"
Analyze: Look for size indicators (numbers with " or DN prefix), service codes (2-4 letters), sequential numbers, and any suffixes. The pattern should match lines with similar structure but different values.`:"Line Sample: (not provided)"}

${N?`Instrument Sample(s): "${N}"
Analyze: Identify the function code (2-6 uppercase letters indicating instrument type), loop number (typically 3-4 digits, may have area prefix), and any suffix letters. Consider ISA naming standards.`:"Instrument Sample: (not provided)"}

${h?`Drawing Number Sample(s): "${h}"
Analyze: Identify the document structure - project codes, area/unit identifiers, document type, sequential numbers, and revision indicators. Look for consistent separator patterns.`:"Drawing Number Sample: (not provided)"}

IMPORTANT PATTERN REQUIREMENTS:
- For lines: Must handle size variations (fractional, whole numbers, DN format), flexible service codes, variable segment counts
- For instruments: Separate patterns for function code (letters) and tag number (digits with optional suffix)
- For drawings: Flexible enough for various company standards but specific enough to avoid false matches
- All patterns should use proper escaping (double backslashes) and be tested against the provided samples

Return a JSON object with this exact structure:
{
  "line": "regex_pattern or null",
  "instrument": {
    "func": "function_code_pattern or null",
    "num": "tag_number_pattern or null"
  },
  "drawing": "drawing_number_pattern or null"
}

Examples of good patterns:
- Line: "(?:\\d+(?:[/\\d]+)?\\"|DN\\d+)-[A-Z]{2,4}-\\d{3,}(?:-[A-Z0-9]+)*"
- Instrument func: "[A-Z]{2,5}"
- Instrument num: "\\d{3,4}[A-Z]?"
- Drawing: "[A-Z0-9]{3,}-\\d{4}-[A-Z]{2,}-[A-Z]-\\d{3,}"

Return null for any pattern not requested. Ensure all backslashes are doubled for JSON.`;try{const v=await fetch(gn,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:Kn,messages:[{role:"system",content:m},{role:"user",content:x}],temperature:.2,max_tokens:500,response_format:{type:"json_object"}})});if(!v.ok){const U=await v.text();throw v.status===401?new Error("Invalid API key. Please check your OpenAI API key."):v.status===429?new Error("Rate limit exceeded. Please try again later."):v.status===400?new Error("Invalid request. Please check your input samples."):new Error(`API request failed: ${v.status} ${v.statusText}`)}const k=((d=(c=(j=(await v.json()).choices)==null?void 0:j[0])==null?void 0:c.message)==null?void 0:d.content)||"";if(!k)throw new Error("Empty response from OpenAI API");let w;try{w=JSON.parse(k)}catch{const U=k.match(/\{[\s\S]*\}/);if(U)w=JSON.parse(U[0]);else throw new Error("Invalid response format from OpenAI API")}const L={};return w.line&&o&&(L.line=w.line),w.instrument&&N&&(L.instrument={func:w.instrument.func||"[A-Z]{2,4}",num:w.instrument.num||"\\d{3,4}(?:\\s?[A-Z])?"}),w.drawing&&h&&(L.drawing=w.drawing),L}catch(v){throw v}}async function Qn(t){if(!t)return!1;try{return(await fetch(gn,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"user",content:'Say "OK"'}],max_tokens:5})})).ok}catch{return!1}}function es(t){t?localStorage.setItem("openai_api_key",t):localStorage.removeItem("openai_api_key")}function ts(){return localStorage.getItem("openai_api_key")}const ns=({patterns:t,tolerances:o,appSettings:N,colorSettings:h,onSaveOnly:m,onSaveAndRescan:x,onClose:j})=>{var $,Z,Ce;const[c,d]=s.useState(t),[v,p]=s.useState(o),[k,w]=s.useState(N),[L,U]=s.useState(h||Ke),[z,P]=s.useState(N.instrumentMappings||_e.instrumentMappings||{}),[W,ie]=s.useState(N.loopRules||_e.loopRules||{}),[de,he]=s.useState(!1),[G,F]=s.useState("patterns"),I=S=>{F(S),K(""),ue("")},[g,K]=s.useState(""),[V,ue]=s.useState(""),[ge,Ee]=s.useState(""),[se,fe]=s.useState(""),[Oe,Xe]=s.useState(""),[Ue,ce]=s.useState(!1),[ae,we]=s.useState(ts()||""),[ke,Ae]=s.useState(!1),[Re,Be]=s.useState(null);s.useEffect(()=>{const S=T=>{T.key==="Escape"&&j()};return window.addEventListener("keydown",S),()=>window.removeEventListener("keydown",S)},[j]);const ze=()=>{const S={...k,instrumentMappings:z,loopRules:W};m(c,v,S,L)},ve=()=>{const S={...k,instrumentMappings:z,loopRules:W};x(c,v,S,L,G)},Pe=()=>{d(Tt),p(Vt),w({..._e,drawingSearchArea:_e.drawingSearchArea??{unit:"percent",enabled:!0,top:5,right:95,bottom:20,left:5,showOverlay:!1},sheetNoPattern:_e.sheetNoPattern??"^\\d{3}$",combineDrawingAndSheet:_e.combineDrawingAndSheet??!0}),ie(_e.loopRules||{}),P(_e.instrumentMappings||{}),K(""),ue("")},$e=(S,T)=>{d(X=>({...X,[S]:T}))},Se=(S,T)=>{d(X=>({...X,[b.Instrument]:{...X[b.Instrument],[S]:T}}))},Ie={[b.Line]:{description:"배관 라인 태그를 매칭하기 위한 정규식 패턴입니다."},[b.Instrument]:{description:"기능 코드와 번호로 구성된 계기 태그를 매칭하기 위한 두 부분 패턴입니다."},[b.DrawingNumber]:{description:"도면 번호를 식별하기 위한 패턴입니다. 페이지당 하나만 선택되며, 우하단에서 선택됩니다."},[b.NotesAndHolds]:{description:"노트 및 홀드 주석을 매칭하기 위한 패턴입니다."}};return v[b.Instrument],e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in-up",style:{animationDuration:"0.2s"},onClick:j,children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl shadow-2xl w-full max-w-7xl text-gray-900",onClick:S=>S.stopPropagation(),children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900",children:"설정"}),e.jsx("button",{onClick:j,className:"p-1 rounded-full text-gray-600 hover:bg-gray-100",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("button",{onClick:()=>I("patterns"),className:`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors ${G==="patterns"?"bg-gray-200 text-gray-900":"bg-transparent text-gray-600 hover:text-gray-900 hover:bg-gray-100"}`,children:"패턴 설정"}),e.jsx("button",{onClick:()=>I("instruments"),className:`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors ${G==="instruments"?"bg-gray-200 text-gray-900":"bg-transparent text-gray-600 hover:text-gray-900 hover:bg-gray-100"}`,children:"계기 타입"}),e.jsx("button",{onClick:()=>I("loops"),className:`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors ${G==="loops"?"bg-gray-200 text-gray-900":"bg-transparent text-gray-600 hover:text-gray-900 hover:bg-gray-100"}`,children:"Loop Number"})]})]}),e.jsx("div",{className:"p-6 space-y-4 max-h-[70vh] overflow-y-auto",children:G==="patterns"?e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"lg:col-span-2",children:[e.jsx("div",{className:"flex items-center gap-2 mb-4",children:e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"정규식 패턴"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"p-3 bg-gray-100 rounded-lg",children:[e.jsx("h4",{className:"text-sm font-semibold mb-3 text-gray-800",children:"라인"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"pattern-Line",className:"block text-xs font-medium text-gray-700 mb-1",children:"라인"}),e.jsx("input",{id:"pattern-Line",type:"text",value:c[b.Line],onChange:S=>$e(b.Line,S.target.value),className:"w-full bg-white border border-gray-300 rounded-md p-2 text-sm font-mono text-gray-900 focus:ring-sky-500 focus:border-sky-500",placeholder:"라인을 위한 정규식 패턴 입력..."}),e.jsx("div",{className:"mt-1 text-xs text-gray-600",children:e.jsx("p",{children:Ie[b.Line].description})})]})]})}),e.jsxs("div",{className:"space-y-4",children:[(()=>{var T,X;const S=Ie[b.Instrument];return e.jsxs("div",{className:"p-3 bg-white border border-gray-300 rounded-lg",children:[e.jsx("label",{className:"block text-sm font-semibold mb-2 text-gray-800",children:"계기"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"pattern-inst-func",className:"block text-xs font-medium text-gray-600 mb-1",children:"기능 부분"}),e.jsx("input",{id:"pattern-inst-func",type:"text",value:((T=c[b.Instrument])==null?void 0:T.func)||"",onChange:le=>Se("func",le.target.value),className:"w-full bg-white border border-gray-300 rounded-md p-2 text-sm font-mono text-gray-900 focus:ring-sky-500 focus:border-sky-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"pattern-inst-num",className:"block text-xs font-medium text-gray-600 mb-1",children:"번호 부분"}),e.jsx("input",{id:"pattern-inst-num",type:"text",value:((X=c[b.Instrument])==null?void 0:X.num)||"",onChange:le=>Se("num",le.target.value),className:"w-full bg-white border border-gray-300 rounded-md p-2 text-sm font-mono text-gray-900 focus:ring-sky-500 focus:border-sky-500"})]})]}),S&&e.jsx("div",{className:"mt-3 text-xs text-gray-600",children:e.jsx("p",{children:S.description})})]},b.Instrument)})(),(()=>{const S=Ie[b.NotesAndHolds];return e.jsxs("div",{className:"p-3 bg-white border border-gray-300 rounded-lg",children:[e.jsx("label",{htmlFor:`pattern-${b.NotesAndHolds}`,className:"block text-sm font-semibold mb-2 text-gray-800",children:"노트 및 홀드"}),e.jsx("input",{id:`pattern-${b.NotesAndHolds}`,type:"text",value:c[b.NotesAndHolds],onChange:T=>$e(b.NotesAndHolds,T.target.value),className:"w-full bg-white border border-gray-300 rounded-md p-3 text-sm font-mono text-gray-900 focus:ring-sky-500 focus:border-sky-500",placeholder:"노트 및 홀드를 위한 정규식 패턴 입력..."}),S&&e.jsx("div",{className:"mt-2 text-xs text-gray-600",children:e.jsx("p",{children:S.description})})]},b.NotesAndHolds)})(),(()=>{const S=Ie[b.DrawingNumber];return e.jsxs("div",{className:"p-3 bg-white border border-gray-300 rounded-lg",children:[e.jsx("label",{htmlFor:`pattern-${b.DrawingNumber}`,className:"block text-sm font-semibold mb-2 text-gray-800",children:"Drawing Number"}),e.jsx("input",{id:`pattern-${b.DrawingNumber}`,type:"text",value:c[b.DrawingNumber],onChange:T=>$e(b.DrawingNumber,T.target.value),className:"w-full bg-white border border-gray-300 rounded-md p-3 text-sm font-mono text-gray-900 focus:ring-sky-500 focus:border-sky-500",placeholder:"Enter regex pattern for Drawing Number..."}),S&&e.jsx("div",{className:"mt-2 text-xs text-gray-600",children:e.jsx("p",{children:S.description})})]},b.DrawingNumber)})()]})]})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"p-4 bg-gray-100 rounded-lg",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-800 mb-4",children:"정규식 생성"}),e.jsx("p",{className:"text-xs text-gray-600 mb-4",children:"실제 P&ID 예시 데이터를 입력하면 AI가 적합한 정규식을 생성합니다."}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"라인 넘버 예시"}),e.jsx("input",{type:"text",value:ge,onChange:S=>Ee(S.target.value),className:"w-full bg-white border border-gray-300 rounded px-2 py-1.5 text-xs font-mono text-gray-900",placeholder:'42"-7300-P-037-11051XR-PP'})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"계기 태그 예시"}),e.jsx("input",{type:"text",value:se,onChange:S=>fe(S.target.value),className:"w-full bg-white border border-gray-300 rounded px-2 py-1.5 text-xs font-mono text-gray-900",placeholder:"TT-205, FIC-301A, PSV-102"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Drawing Number 예시"}),e.jsx("input",{type:"text",value:Oe,onChange:S=>Xe(S.target.value),className:"w-full bg-white border border-gray-300 rounded px-2 py-1.5 text-xs font-mono text-gray-900",placeholder:"00342GS-7300-PRP-D-105"})]})]}),e.jsxs("div",{className:"mt-4 p-3 bg-gray-50 border border-gray-200 rounded",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:"OpenAI API Key (ChatGPT)"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:ke?"text":"password",value:ae,onChange:S=>{we(S.target.value),es(S.target.value),Be(null)},className:"w-full bg-white border border-gray-300 rounded px-2 py-1.5 text-xs font-mono text-gray-900 pr-20",placeholder:"sk-..."}),e.jsxs("div",{className:"absolute right-1 top-1/2 -translate-y-1/2 flex gap-1",children:[e.jsx("button",{onClick:()=>Ae(!ke),className:"p-1 text-gray-500 hover:text-gray-700",type:"button",children:ke?e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"})}):e.jsxs("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]})}),e.jsx("button",{onClick:async()=>{if(ae){const S=await Qn(ae);Be(S),alert(S?"API 키가 유효합니다.":"API 키가 유효하지 않습니다.")}},className:"px-2 py-0.5 text-xs bg-gray-200 hover:bg-gray-300 rounded",type:"button",children:"테스트"})]})]}),Re!==null&&e.jsx("p",{className:`text-xs mt-1 ${Re?"text-green-600":"text-red-600"}`,children:Re?"✓ API 키 유효함":"✗ API 키 유효하지 않음"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["ChatGPT를 사용하여 더 정확한 정규식을 생성합니다."," ",e.jsx("a",{href:"https://platform.openai.com/api-keys",target:"_blank",rel:"noopener noreferrer",className:"text-sky-600 hover:text-sky-700 underline",children:"API 키 받기"})]})]}),e.jsx("button",{onClick:async()=>{ce(!0);try{let S;if(ae)try{S=await Jn(ae,ge,se,Oe)}catch(T){S=un(ge,se,Oe),alert(`ChatGPT API 실패: ${T.message}
규칙 기반 생성을 사용합니다.`)}else S=un(ge,se,Oe);S.line&&ge&&$e(b.Line,S.line),S.instrument&&se&&(Se("func",S.instrument.func),Se("num",S.instrument.num)),S.drawing&&Oe&&$e(b.DrawingNumber,S.drawing),alert(ae?"ChatGPT로 정규식이 생성되었습니다.":"규칙 기반으로 정규식이 생성되었습니다.")}catch(S){alert(`정규식 생성 실패: ${S.message}`)}finally{ce(!1)}},disabled:Ue||!ge&&!se&&!Oe,className:`
                    w-full mt-4 px-4 py-2 text-sm font-semibold rounded-md transition-colors
                    ${Ue||!ge&&!se&&!Oe?"bg-gray-300 text-gray-500 cursor-not-allowed":ae?"bg-violet-600 text-white hover:bg-violet-700":"bg-sky-600 text-white hover:bg-sky-700"}
                  `,children:Ue?"생성 중...":ae?"ChatGPT로 정규식 생성":"규칙 기반 정규식 생성"}),e.jsxs("div",{className:"mt-4 p-3 bg-blue-50 border border-blue-200 rounded text-xs",children:[e.jsx("p",{className:"text-blue-800 font-semibold mb-1",children:"팁:"}),e.jsxs("ul",{className:"text-blue-700 space-y-1",children:[e.jsx("li",{children:"• 실제 사용 중인 태그 예시를 입력하세요"}),e.jsx("li",{children:"• 여러 개의 예시는 쉼표로 구분합니다"}),e.jsx("li",{children:"• 생성된 패턴은 수동 조정 가능합니다"})]})]})]})}),e.jsxs("div",{className:"lg:col-span-3 p-3 bg-white border border-gray-300 rounded-lg",children:[e.jsx("h4",{className:"text-sm font-semibold mb-3 text-gray-800",children:"P&ID No. & Sheet No. 검색 영역"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 mb-3",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:(($=k==null?void 0:k.drawingSearchArea)==null?void 0:$.enabled)??!0,onChange:S=>w(T=>({...T,drawingSearchArea:{...(T==null?void 0:T.drawingSearchArea)??{},enabled:S.target.checked}}))}),"영역 사용"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:["단위:",e.jsxs("select",{value:((Z=k==null?void 0:k.drawingSearchArea)==null?void 0:Z.unit)??"percent",onChange:S=>w(T=>({...T,drawingSearchArea:{...(T==null?void 0:T.drawingSearchArea)??{},unit:S.target.value}})),className:"border rounded px-2 py-1",children:[e.jsx("option",{value:"percent",children:"%"}),e.jsx("option",{value:"px",children:"px"})]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:((Ce=k==null?void 0:k.drawingSearchArea)==null?void 0:Ce.showOverlay)??!1,onChange:S=>w(T=>({...T,drawingSearchArea:{...(T==null?void 0:T.drawingSearchArea)??{},showOverlay:S.target.checked}}))}),"뷰어에 영역 표시(점선)"]})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2 mb-3",children:["top","right","bottom","left"].map(S=>{var T;return e.jsxs("label",{className:"text-sm",children:[S.toUpperCase(),e.jsx("input",{type:"number",value:((T=k==null?void 0:k.drawingSearchArea)==null?void 0:T[S])??(S==="right"||S==="bottom"?95:5),onChange:X=>w(le=>({...le,drawingSearchArea:{...(le==null?void 0:le.drawingSearchArea)??{},[S]:Number(X.target.value)}})),className:"w-full bg-white border border-gray-300 rounded-md p-2 text-sm"})]},S)})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[e.jsxs("label",{className:"text-sm",children:["Sheet No. 패턴 (정규식)",e.jsx("input",{type:"text",value:(k==null?void 0:k.sheetNoPattern)??"^\\d{3}$",onChange:S=>w(T=>({...T,sheetNoPattern:S.target.value})),className:"w-full bg-white border border-gray-300 rounded-md p-2 text-sm font-mono",placeholder:"예: ^\\\\d{3}$"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:(k==null?void 0:k.combineDrawingAndSheet)??!0,onChange:S=>w(T=>({...T,combineDrawingAndSheet:S.target.checked}))}),"도면번호와 시트번호 결합 저장 (예: EB-114739-001)"]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 mt-2",children:e.jsxs("label",{className:"text-sm",children:["Sheet No. 탐색 허용 오차 (px, 좌/우 전용)",e.jsx("input",{type:"number",min:0,value:Number.isFinite(k==null?void 0:k.sheetNoTolerancePx)?k==null?void 0:k.sheetNoTolerancePx:60,onChange:S=>{const T=Math.max(0,Number(S.target.value||0));w(X=>({...X,sheetNoTolerancePx:T}))},className:"w-full bg-white border border-gray-300 rounded-md p-2 text-sm",placeholder:"예: 60"})]})}),e.jsxs("p",{className:"mt-2 text-xs text-gray-500",children:["* 영역 단위가 ",e.jsx("b",{children:"%"}),"인 경우 페이지 폭/높이 대비 상대값입니다. (top/bottom/right/left)"]})]})]}):G==="instruments"?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"border border-gray-300 rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"계기 타입 및 I/O 타입 설정"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"인식된 계기 태그 패턴에 대한 기본 계기 타입과 I/O 타입을 설정하세요."}),e.jsxs("div",{className:"mb-4 p-3 bg-gray-100 rounded",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-2",children:"새 매핑 추가"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx("input",{type:"text",placeholder:"패턴 (예: PT)",className:"bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900",id:"new-pattern"}),e.jsx("input",{type:"text",placeholder:"계기 타입",className:"bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900",id:"new-instrument-type"}),e.jsxs("select",{className:"bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900",id:"new-io-type",defaultValue:"",children:[e.jsx("option",{value:"",disabled:!0,children:"I/O 타입 선택"}),e.jsx("option",{value:"AI",children:"AI (Analog Input)"}),e.jsx("option",{value:"AO",children:"AO (Analog Output)"}),e.jsx("option",{value:"DI",children:"DI (Digital Input)"}),e.jsx("option",{value:"DO",children:"DO (Digital Output)"}),e.jsx("option",{value:"Local",children:"Local"})]}),e.jsx("button",{onClick:()=>{var le,Le,He;const S=(le=document.getElementById("new-pattern"))==null?void 0:le.value.toUpperCase(),T=(Le=document.getElementById("new-instrument-type"))==null?void 0:Le.value,X=(He=document.getElementById("new-io-type"))==null?void 0:He.value;S&&T&&X&&(P(Te=>({...Te,[S]:{instrumentType:T,ioType:X}})),document.getElementById("new-pattern").value="",document.getElementById("new-instrument-type").value="",document.getElementById("new-io-type").value="")},className:"bg-sky-600 hover:bg-sky-700 text-white font-semibold px-2 py-1 rounded text-sm",children:"추가"})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700",children:"현재 매핑"}),e.jsxs("div",{className:"relative w-48",children:[e.jsx("input",{type:"text",placeholder:"계기 검색...",value:g,onChange:S=>K(S.target.value),className:"w-full bg-white border border-gray-300 rounded-md px-2 py-1 pr-8 text-sm text-gray-900 focus:ring-sky-500 focus:border-sky-500"}),g&&e.jsx("button",{onClick:()=>K(""),className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors p-0.5 rounded",title:"검색 지우기",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18L18 6M6 6l12 12"})})})]})]}),e.jsx("div",{className:"h-96 overflow-y-auto bg-gray-50 border border-gray-200 rounded",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"sticky top-0 bg-gray-100",children:e.jsxs("tr",{className:"border-b border-gray-300",children:[e.jsx("th",{className:"text-left py-2 px-2 text-gray-700",children:"패턴"}),e.jsx("th",{className:"text-left py-2 px-2 text-gray-700",children:"계기 타입"}),e.jsx("th",{className:"text-left py-2 px-2 text-gray-700",children:"I/O 타입"}),e.jsx("th",{className:"py-2 px-2"})]})}),e.jsx("tbody",{children:(()=>{const S=Object.entries(z).filter(([T,X])=>{const le=g.toLowerCase();return T.toLowerCase().includes(le)||X.instrumentType.toLowerCase().includes(le)||X.ioType.toLowerCase().includes(le)}).sort();return S.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-8 text-center text-gray-500",children:"검색 결과가 없습니다"})}):S.map(([T,X])=>e.jsxs("tr",{className:"border-b border-gray-200 hover:bg-gray-50",children:[e.jsx("td",{className:"py-2 px-2 font-mono text-gray-900",children:T}),e.jsx("td",{className:"py-2 px-2",children:e.jsx("input",{type:"text",value:X.instrumentType,onChange:le=>{P(Le=>({...Le,[T]:{...Le[T],instrumentType:le.target.value}}))},className:"bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900 w-full"})}),e.jsx("td",{className:"py-2 px-2",children:e.jsxs("select",{value:X.ioType,onChange:le=>{P(Le=>({...Le,[T]:{...Le[T],ioType:le.target.value}}))},className:"bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900 w-full",children:[e.jsx("option",{value:"AI",children:"AI (Analog Input)"}),e.jsx("option",{value:"AO",children:"AO (Analog Output)"}),e.jsx("option",{value:"DI",children:"DI (Digital Input)"}),e.jsx("option",{value:"DO",children:"DO (Digital Output)"}),e.jsx("option",{value:"Local",children:"Local"})]})}),e.jsx("td",{className:"py-2 px-2",children:e.jsx("button",{onClick:()=>{const le={...z};delete le[T],P(le)},className:"text-red-400 hover:text-red-300",title:"삭제",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})})]},T))})()})]})})]})]}):G==="loops"?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"border border-gray-300 rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Loop Number 추출 규칙"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"각 계기 태그 패턴에 대한 Loop Number 추출 규칙을 설정하세요. 예: FXI, FXLL, FXT → FX, TT-205 → T-205"}),e.jsxs("div",{className:"mb-4 p-3 bg-gray-100 rounded",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-2",children:"새 규칙 추가"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx("input",{type:"text",placeholder:"태그 패턴 (예: FXI, FXT)",className:"bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900",id:"new-loop-pattern"}),e.jsx("input",{type:"text",placeholder:"Loop 추출 규칙 (예: FX)",className:"bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900",id:"new-loop-rule"}),e.jsx("button",{onClick:()=>{var X,le;const S=(X=document.getElementById("new-loop-pattern"))==null?void 0:X.value.toUpperCase(),T=(le=document.getElementById("new-loop-rule"))==null?void 0:le.value.toUpperCase();S&&T&&(S.split(",").map(He=>He.trim()).filter(He=>He).forEach(He=>{ie(Te=>({...Te,[He]:T}))}),document.getElementById("new-loop-pattern").value="",document.getElementById("new-loop-rule").value="")},className:"bg-sky-600 hover:bg-sky-700 text-white font-semibold px-2 py-1 rounded text-sm",children:"추가"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"여러 패턴을 쉼표로 구분하여 같은 규칙을 적용할 수 있습니다."})]}),e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-1",children:"기본 규칙 안내"}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"아래 기본 규칙이 자동으로 적용됩니다. 필요시 수정하거나 추가 규칙을 만들 수 있습니다."}),e.jsx("p",{className:"text-xs text-gray-500",children:"※ 규칙에 없는 태그: 첫 번째 문자 + 숫자 (TT-205 → T-205)"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700",children:"현재 규칙"}),e.jsxs("span",{className:"text-xs text-gray-500",children:["(기본 ",Object.keys(_e.loopRules||{}).length,"개 + 사용자 ",Object.keys(W).length-Object.keys(_e.loopRules||{}).length,"개)"]})]}),e.jsxs("div",{className:"relative w-48",children:[e.jsx("input",{type:"text",placeholder:"Loop 규칙 검색...",value:V,onChange:S=>ue(S.target.value),className:"w-full bg-white border border-gray-300 rounded-md px-2 py-1 pr-8 text-sm text-gray-900 focus:ring-sky-500 focus:border-sky-500"}),V&&e.jsx("button",{onClick:()=>ue(""),className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors p-0.5 rounded",title:"검색 지우기",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18L18 6M6 6l12 12"})})})]})]}),e.jsx("div",{className:"h-96 overflow-y-auto bg-gray-50 border border-gray-200 rounded",children:Object.keys(W).length===0?e.jsx("p",{className:"text-sm text-gray-500 py-2 px-4",children:"규칙을 불러오는 중..."}):e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"sticky top-0 bg-gray-100",children:e.jsxs("tr",{className:"border-b border-gray-300",children:[e.jsx("th",{className:"text-left py-2 px-2 text-gray-700",children:"태그 패턴"}),e.jsx("th",{className:"text-left py-2 px-2 text-gray-700",children:"Loop 추출 규칙"}),e.jsx("th",{className:"text-left py-2 px-2 text-gray-700",children:"예시"}),e.jsx("th",{className:"py-2 px-2"})]})}),e.jsx("tbody",{children:(()=>{const S=Object.entries(W).filter(([T,X])=>{const le=V.toLowerCase(),Le=`${T}-123 → ${X}-123`;return T.toLowerCase().includes(le)||String(X).toLowerCase().includes(le)||Le.toLowerCase().includes(le)}).sort((T,X)=>{const le=String(T[1]||T[0][0]),Le=String(X[1]||X[0][0]);return le!==Le?le.localeCompare(Le):T[0].localeCompare(X[0])});return S.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-8 text-center text-gray-500",children:"검색 결과가 없습니다"})}):S.map(([T,X])=>{const le=_e.loopRules&&_e.loopRules[T]===X,Le="205",He=`${T}-${Le} → ${X}-${Le}`;return e.jsxs("tr",{className:`border-b border-gray-200 hover:bg-gray-50 ${le?"bg-gray-50":""}`,children:[e.jsxs("td",{className:"py-2 px-2",children:[e.jsx("span",{className:"font-mono text-gray-900",children:T}),le&&e.jsx("span",{className:"ml-2 text-xs text-blue-600 font-normal",children:"기본"})]}),e.jsx("td",{className:"py-2 px-2",children:e.jsx("input",{type:"text",value:X,onChange:Te=>{ie(Fe=>({...Fe,[T]:Te.target.value.toUpperCase()}))},className:"bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900 font-mono w-20"})}),e.jsx("td",{className:"py-2 px-2 text-gray-500 text-xs",children:He}),e.jsx("td",{className:"py-2 px-2",children:e.jsx("button",{onClick:()=>{const Te={...W};delete Te[T],ie(Te)},className:"text-red-400 hover:text-red-300",title:"삭제",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})})]},T)})})()})]})})]})]})}):null}),e.jsxs("div",{className:"p-4 border-t border-gray-200 flex justify-between items-center",children:[e.jsx("button",{onClick:Pe,className:"px-4 py-2 text-sm font-semibold text-white bg-gray-600 rounded-md hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-white",children:"기본값으로 재설정"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:j,className:"px-4 py-2 text-sm font-semibold text-gray-700 bg-transparent rounded-md hover:bg-gray-100 transition-colors",children:"취소"}),e.jsx("button",{onClick:ze,className:"px-4 py-2 text-sm font-semibold text-white bg-sky-600 rounded-md hover:bg-sky-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 focus:ring-offset-white",children:"저장"}),e.jsx("button",{onClick:ve,className:"px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-white",children:"저장 및 다시 스캔"})]})]})]})})};class zt extends s.Component{constructor(o){super(o),this.handleRetry=()=>{this.setState({hasError:!1,error:void 0,errorInfo:void 0})},this.handleReload=()=>{window.location.reload()},this.state={hasError:!1}}static getDerivedStateFromError(o){return{hasError:!0,error:o}}componentDidCatch(o,N){this.setState({error:o,errorInfo:N})}render(){return this.state.hasError?this.props.fallback?this.props.fallback:e.jsx("div",{className:"flex items-center justify-center min-h-screen p-4 bg-gray-50",children:e.jsxs("div",{className:"bg-red-50 border border-red-300 rounded-lg p-6 max-w-lg w-full",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx("svg",{className:"w-6 h-6 text-red-500 mr-3",fill:"none",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("h2",{className:"text-xl font-bold text-red-600",children:"Application Error"})]}),e.jsx("p",{className:"text-red-600 mb-4",children:"Something went wrong while running the application. This error has been logged."}),!1,e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsx("button",{onClick:this.handleRetry,className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-white",children:"Try Again"}),e.jsx("button",{onClick:this.handleReload,className:"px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-white",children:"Reload Page"})]})]})}):this.props.children}}const xn=(t,o,N)=>!N||o===b.NotesAndHolds?t:t.replace(/\s+/g,""),Ft=(t,o=0,N=0,h=null,m=0)=>{const{transform:x,width:j,height:c}=t,[d,v,,,p,k]=x,w=p,L=k,U=Math.atan2(v,d),z=c*.2,P=[{x:0,y:-z},{x:j,y:-z},{x:j,y:c},{x:0,y:c}],W=Math.cos(U),ie=Math.sin(U),de=P.map(I=>({x:I.x*W-I.y*ie+w-o,y:I.x*ie+I.y*W+L-N})),he=de.map(I=>I.x),G=de.map(I=>I.y),F={x1:Math.min(...he),y1:Math.min(...G),x2:Math.max(...he),y2:Math.max(...G)};if(h&&m===90){const I=h.viewBox||[0,0,h.width,h.height];return I[2],I[3],{x1:F.y1,y1:F.x1,x2:F.y2,y2:F.x2}}else if(h&&m===270){const I=h.viewBox||[0,0,h.width,h.height],g=I[2],K=I[3];return{x1:K-F.y2,y1:g-F.x2,x2:K-F.y1,y2:g-F.x1}}else if(h&&m===180){const I=h.width,g=h.height;return{x1:I-F.x2,y1:g-F.y2,x2:I-F.x1,y2:g-F.y1}}else if(h){const I=h.height;return{x1:F.x1,y1:I-F.y2,x2:F.x2,y2:I-F.y1}}return F},ss=(t,o)=>{const{width:N,height:h}=t;switch(o){case 0:return{x:N,y:h};case 90:return{x:0,y:h};case 180:return{x:0,y:0};case 270:return{x:h,y:0};default:return{x:N,y:h}}},yn=async(t,o,N,h,m={autoRemoveWhitespace:!0})=>{const x=await t.getPage(o),j=await x.getTextContent(),c=x.getViewport({scale:1}),d=c.rotation||0,v=c.viewBox?c.viewBox[0]:0,p=c.viewBox?c.viewBox[1]:0,k=[],w=[],L=j.items.filter(G=>"str"in G&&G.str.trim()!==""),U=new Set,z=L.filter(G=>G.str.includes("-")&&G.str.length>10);if(z.length>0&&z.forEach((G,F)=>{}),N[b.Instrument]&&N[b.Instrument].func&&N[b.Instrument].num)try{const G=new RegExp(`^${N[b.Instrument].func}$`),F=new RegExp(`^${N[b.Instrument].num}$`),I=h[b.Instrument],g=[],K=[];L.forEach((V,ue)=>{if(G.test(V.str)){const ge=Ft(V,v,p,c,d);if(g.push({item:V,index:ue,bbox:ge}),V.str==="TXT"){const Ee={x:(ge.x1+ge.x2)/2,y:(ge.y1+ge.y2)/2}}}else if(F.test(V.str)){const ge=Ft(V,v,p,c,d);if(K.push({item:V,index:ue,bbox:ge}),V.str==="596B"){const Ee={x:(ge.x1+ge.x2)/2,y:(ge.y1+ge.y2)/2}}}else V.str==="TXT"||V.str});for(const V of g){if(U.has(V.index)||V.item.str.toUpperCase()==="FF")continue;let ue=null,ge=1/0;const Ee={x:(V.bbox.x1+V.bbox.x2)/2,y:(V.bbox.y1+V.bbox.y2)/2};V.item.str;for(const se of K){if(U.has(se.index))continue;const fe={x:(se.bbox.x1+se.bbox.x2)/2,y:(se.bbox.y1+se.bbox.y2)/2};V.item.str==="TXT"&&se.item.str;const Oe=Ee.y<fe.y;if(V.item.str==="TXT"&&se.item.str,!Oe){V.item.str==="TXT"&&se.item.str;continue}const Xe=Math.abs(Ee.x-fe.x),Ue=Math.abs(Ee.y-fe.y);if(V.item.str==="TXT"&&se.item.str,Xe<=I.horizontal&&Ue<=I.vertical){const ce=Xe*Xe+Ue*Ue;V.item.str==="TXT"&&se.item.str,ce<ge&&(ge=ce,ue=se,V.item.str==="TXT"&&se.item.str)}else V.item.str==="TXT"&&se.item.str}if(ue){const se=`${V.item.str}-${ue.item.str}`,fe=xn(se,b.Instrument,m.autoRemoveWhitespace),Oe={x1:Math.min(V.bbox.x1,ue.bbox.x1),y1:Math.min(V.bbox.y1,ue.bbox.y1),x2:Math.max(V.bbox.x2,ue.bbox.x2),y2:Math.max(V.bbox.y2,ue.bbox.y2)};k.push({id:Me(),text:fe,page:o,bbox:Oe,category:b.Instrument,sourceItems:[{...V.item,id:Me(),bbox:V.bbox,page:o},{...ue.item,id:Me(),bbox:ue.bbox,page:o}]}),U.add(V.index),U.add(ue.index)}}}catch{}const P=N.Line||N[b.Line]||Tt[b.Line],W=[{category:b.Line,regex:P},{category:b.NotesAndHolds,regex:N[b.NotesAndHolds]}],ie=L.filter(G=>G.str.includes('"-')&&!U.has(L.indexOf(G)));ie.length>0&&ie.slice(0,5).forEach(G=>{});for(let G=0;G<L.length;G++){if(U.has(G))continue;const F=L[G];let I=!1;for(const g of W)if(g.regex)try{const K=new RegExp(g.regex,"gi"),V=F.str.match(K);if(g.category===b.Line&&F.str.includes('"-'),V){I=!0;for(const ue of V){if(ue.toUpperCase().startsWith("FF"))continue;const ge=xn(ue,g.category,m.autoRemoveWhitespace);k.push({id:Me(),text:ge,page:o,bbox:Ft(F,v,p,c,d),category:g.category})}}}catch{}I&&U.add(G)}const de=N[b.DrawingNumber];if(de)try{const G=new RegExp(de,"i"),F=ss(c,d),I=m==null?void 0:m.drawingSearchArea,g=new RegExp((m==null?void 0:m.sheetNoPattern)??"^\\d{3}$","i"),K=(m==null?void 0:m.combineDrawingAndSheet)??!0,V=(ce,ae,we)=>ae==="percent"?ce/100*we:ce,ue=(ce,ae)=>{const we=(ce.x1+ce.x2)/2,ke=(ce.y1+ce.y2)/2;return we>=ae.x1&&we<=ae.x2&&ke>=ae.y2&&ke<=ae.y1},ge=(ce,ae)=>ae?{x1:Math.min(ce.x1,ae.x1),y1:Math.min(ce.y1,ae.y1),x2:Math.max(ce.x2,ae.x2),y2:Math.max(ce.y2,ae.y2)}:ce;let Ee=null;if(I!=null&&I.enabled){const ce=I.unit??"percent",ae=c.width,we=c.height,ke=V(I.left??5,ce,ae),Ae=V(I.right??95,ce,ae),Re=V(I.top??5,ce,we),Be=V(I.bottom??20,ce,we);Ee={x1:ke,x2:Ae,y1:Be,y2:Re}}const se=L.filter(ce=>ce.str.includes("-")&&ce.str.length>10);se.length>0&&se.forEach(ce=>{const ae=ce.str.match(G)});let fe=null;const Oe=[];for(let ce=0;ce<L.length;ce++){if(U.has(ce))continue;const ae=L[ce],we=ae.str.match(G);if(!we)continue;const ke=Ft(ae,v,p,c,d);if(Ee&&!ue(ke,Ee))continue;const Ae=F.x-ke.x2;let Re;switch(d){case 0:case 90:Re=Math.max(ke.y1,ke.y2);break;case 180:case 270:Re=Math.min(ke.y1,ke.y2);break;default:Re=Math.max(ke.y1,ke.y2);break}const Be=F.y-Re,ze=Ae*Ae+Be*Be;Oe.push({item:ae,index:ce,bbox:ke,text:we[0],distance:Math.sqrt(ze),distanceSq:ze,dx:Ae,dy:Be,targetY:Re,isSelected:!1})}const Xe=ce=>{var ke;let ae=0;const we=ce.text;return we.startsWith("-")||(ae+=1e3),/^[A-Z0-9]/i.test(we)&&(ae+=500),/^[0-9]{5}[A-Z]/.test(we)&&(ae+=300),((ke=we.match(/-/g))==null?void 0:ke.length)>=3&&(ae+=200),we.length>15&&(ae+=100),ae-=Math.sqrt(ce.distanceSq)*.1,ae};Oe.forEach(ce=>ce.score=Xe(ce));const Ue=[...Oe].sort((ce,ae)=>ae.score-ce.score);if(Ue.length>0&&(fe=Ue[0]),fe){Oe.forEach(ve=>{ve.isSelected=ve.index===fe.index});const ce=Math.max(0,(m==null?void 0:m.sheetNoTolerancePx)??40),ae=.5,we=(ve,Pe)=>{const $e=ve.y2-ve.y1,Se=Pe.y2-Pe.y1;return Math.min(ve.y2,Pe.y2)-Math.max(ve.y1,Pe.y1)>Math.min($e,Se)*ae},ke=L.filter(ve=>ve!==fe.item).map(ve=>({t:ve,b:Ft(ve,v,p,c,d)})).filter(({b:ve})=>we(fe.bbox,ve)).map(({t:ve,b:Pe})=>{const $e=(ve.str||"").trim();if(!g.test($e))return null;const Se=Pe.x1-fe.bbox.x2;return Se<0||Se>ce?null:{item:ve,bbox:Pe,text:$e,dist:Se}}).filter(Boolean).sort((ve,Pe)=>ve.dist-Pe.dist),Ae=ke.length>0?ke[0]:null,Re=fe.text.trim();let Be=Re;const ze={page:o};if(Ae){const ve=Ae.bbox;ze.sheet=Ae.text,K&&(Be=`${Re}-${ze.sheet}`),k.push({id:Me(),text:Be,page:o,bbox:ge(fe.bbox,ve),category:b.DrawingNumber,metadata:ze})}else k.push({id:Me(),text:Be,page:o,bbox:fe.bbox,category:b.DrawingNumber,metadata:ze});U.add(fe.index)}}catch{}for(let G=0;G<L.length;G++){if(U.has(G))continue;const F=L[G],I=Ft(F,v,p,c,d);w.push({id:Me(),text:F.str,page:o,bbox:I})}const he=k.filter(G=>G.category===b.Line);return k.filter(G=>G.category===b.Instrument),he.length>0,{tags:k,rawTextItems:w}},os=(t,o,N)=>{const h=t.filter(L=>L.page===o);if(h.length===0)return[];const m=N.width,x=N.height,j=m*.45,c=/^(?:NOTE\s*)?(\d+)[.:)]?\s*(.*)/i,d=[...h].sort((L,U)=>{const z=L.bbox.y1-U.bbox.y1;return Math.abs(z)<5?L.bbox.x1-U.bbox.x1:z}),v=[];for(let L=0;L<d.length;L++){const U=d[L],P=U.text.trim().match(c);if(P&&U.bbox.x1>=j){const W=parseInt(P[1],10),ie=P[2]?P[2].trim():"";v.push({number:W,initialText:ie,startItem:U,startIndex:L,items:[U],text:ie})}}if(v.length===0)return[];const p=[],k=200,w=m*.3;for(let L=0;L<v.length;L++){const U=v[L],z=v[L+1]||null;U.startItem.bbox.y1;const P=z?z.startItem.bbox.y1:x,W=[U.startItem];let ie=U.initialText,de=U.startItem.bbox.y2;for(let G=U.startIndex+1;G<d.length;G++){const F=d[G];if(F.bbox.y1>=P)break;const I=F.text.trim();if(!I)continue;if(c.test(I)&&F.bbox.x1>=j)break;const g=Math.max(0,F.bbox.y1-de),K=F.bbox.x1>=w,V=g<=k||F.bbox.y1<de+20;if(K&&V)ie.length>0?ie+=" "+I:ie=I,W.push(F),de=Math.max(de,F.bbox.y2);else if(K){if(!V&&g>k*1.5)break}}const he={x1:Math.min(...W.map(G=>G.bbox.x1)),y1:Math.min(...W.map(G=>G.bbox.y1)),x2:Math.max(...W.map(G=>G.bbox.x2)),y2:Math.max(...W.map(G=>G.bbox.y2))};p.push({number:U.number,text:ie,items:W,bbox:he,page:o})}return p.forEach(L=>{L.items&&L.items.length,L.text.substring(0,80)}),p.length>0&&(p.reduce((U,z)=>U+(z.items?z.items.length:1),0)/p.length).toFixed(1),p};function rs(t,o,N){if(t.length===0)return 0;const h=Math.log(t.length+1)*15,m=t.reduce((w,L)=>w+L.distance,0)/t.length,x=Math.max(0,30-m/10),d=new Set(t.map(w=>w.note.id)).size/Math.max(1,N.length)*30,v=new Set(t.map(w=>w.instrument.page)).size,p=Math.min(v*8,25);return h+x+d+p+25}function is(t){if(t.length===0)return{width:30,height:15,diagonal:33.5};let o=0,N=0;for(const j of t){const c=j.bbox.x2-j.bbox.x1,d=j.bbox.y2-j.bbox.y1;o+=c,N+=d}const h=o/t.length,m=N/t.length,x=Math.sqrt(h*h+m*m);return{width:h,height:m,diagonal:x}}async function as(t,o,N,h){const m=[],x=c=>{const d=c.toLowerCase();return d.includes("note")?"Note":d.includes("hold")?"Hold":null};for(const c of h){const d=t.filter(p=>p.page===c),v=o.filter(p=>p.page===c&&x(p.text)==="Note");for(const p of v){let k=null;const w=p.bbox.x2-p.bbox.x1,L=p.bbox.y2-p.bbox.y1,z=Math.sqrt(w*w+L*L)*N;for(const P of d){const W=Math.abs((P.bbox.x1+P.bbox.x2)/2-(p.bbox.x1+p.bbox.x2)/2),ie=Math.abs((P.bbox.y1+P.bbox.y2)/2-(p.bbox.y1+p.bbox.y2)/2),de=Math.sqrt(W*W+ie*ie);de<=z&&(!k||de<k.distance)&&(k={instrument:P,distance:de})}k&&m.push({instrument:k.instrument,note:p,distance:k.distance})}}const j=rs(m,t,o);return{connections:m,quality:j}}async function ls(t,o,N,h){const m=[4,5,6],x=is(o),j=N.numPages;let c;j<=3?c=Math.min(2,j):j<=10?c=Math.floor(j/2):c=Math.floor(j*.4);const v=(await Promise.all(m.map(async(z,P)=>{h&&h(P/m.length*100,`박스 크기 ${z}배 테스트 중...`);const{connections:W,quality:ie}=await as(t.filter(he=>he.page===c),o.filter(he=>he.page===c),z,[c]);return{distance:x.diagonal*z,quality:ie,connections:W,multiplier:z}}))).reduce((z,P)=>P.quality>z.quality?P:z),p=new Map;p.set(c,v.connections.length);const k=v.connections.length>0?v.connections.reduce((z,P)=>z+P.distance,0)/v.connections.length:0,w=new Set(v.connections.map(z=>z.note.id)),L=o.filter(z=>z.page===c&&z.text.toLowerCase().includes("note")),U=L.length>0?w.size/L.length:0;return{distance:v.distance,score:v.quality,connectionCount:v.connections.length,details:{testedPages:[c],connectionsByPage:p,avgProximity:k,coverageRate:U*100}}}function cs(t,o,N){const h=[],m=new Set,x=d=>{const v=d.toLowerCase();return v.includes("note")?"Note":v.includes("hold")?"Hold":null},j=o.filter(d=>x(d.text)==="Note"),c=(d,v,p)=>{const k=Math.max(p.x1,Math.min(d.x,p.x2)),w=Math.max(p.y1,Math.min(d.y,p.y2)),L=d.x-k,U=d.y-w,z=Math.sqrt(L*L+U*U);return{intersects:z<=v,distance:z}};for(const d of t){const v={x:(d.bbox.x1+d.bbox.x2)/2,y:(d.bbox.y1+d.bbox.y2)/2},p=d.bbox.x2-d.bbox.x1,k=d.bbox.y2-d.bbox.y1,w=Math.sqrt(p*p+k*k)/2*3,L=j.filter(z=>z.page===d.page);let U=null;for(const z of L){const{intersects:P,distance:W}=c(v,w,z.bbox);P&&(!U||W<U.distance)&&(U={noteTag:z,distance:W})}if(U){const z=`${d.id}-${U.noteTag.id}`;m.has(z)||(h.push({id:Me(),from:d.id,to:U.noteTag.id,type:ne.Note}),m.add(z))}}return h}const mn={numberPattern:/^(\d+)\s*[-.]?\s*(.*)$/,standaloneNumberPattern:/^(\d+)\s*[-.]?\s*$/,minXPosition:.35,alignmentTolerance:60,minAlignedNotes:1,maxYGap:400,maxHorizontalGap:250,maxLineGap:60};function bn(t,o,N){const h=[],m=N*o.minXPosition,x=new Set,j=[...t].sort((v,p)=>v.bbox.y1-p.bbox.y1),c=j.filter(v=>v.bbox.x1>=m),d=[];for(let v=0;v<c.length;v++){const p=c[v],k=p.text.match(/^[\(\[]?(\d+)[\)\]]?\s*[-.:]?\s*(.*)$/);if(k){const w=k[1],L=k[2],U=p.text.match(/^[\(\[]?\d+[\)\]]?\s*[-.:]/),z=L.trim().length===0,P=p.text.match(/^[\(\[]?\d+[\)\]]/);if(U||z||P){const W=j.findIndex(ie=>ie===p);d.push({item:p,number:w,index:W})}}}for(let v=0;v<d.length;v++){const p=d[v],k=v<d.length-1?d[v+1].index:j.length,w=[p.item];x.add(p.item);const L=p.item.text.match(/^[\(\[]?\d+[\)\]]?\s*[-.:]?\s*(.*)$/);let U=L&&L[1]&&L[1].trim()?L[1].trim():"";const z=U.length===0;let P=p.item.bbox.x1,W=p.item.bbox.x2,ie=!z,de=0;const he=3;for(let G=p.index+1;G<k;G++){const F=j[G];if(x.has(F))continue;const I=w[w.length-1],g=F.bbox.y1-I.bbox.y2;if(g>o.maxYGap)break;const K=G<k;!ie&&F.text.trim().length>0&&(P=Math.min(P,F.bbox.x1),W=Math.max(W,F.bbox.x2),ie=!0);const V=ie?F.bbox.x1>=P-10&&F.bbox.x1<=W+10:!0,ue=Math.abs(F.bbox.y1-p.item.bbox.y1)<5&&F.bbox.x1>p.item.bbox.x2,ge=z&&U.length===0&&G===p.index+1,Ee=F.text.match(/^[A-Z]{4,}[:\s]/)||F.text.match(/^FIGURE\s+\d+/i)||F.text.match(/^TABLE\s+\d+/i);let se=!1;if(!Ee){if(K&&!Ee&&V){const fe=F.text.match(/^[\(\[]?\d+[\)\]]?\s*[-.:]?\s/);F.bbox.x1>=m*.3,fe?F.bbox.x1>=m*.5&&V&&(se=!0):(se=!0,F.bbox.x1<m*.2&&F.bbox.x1<p.item.bbox.x1-400&&(se=!1))}if(ue||ge?se=!0:!V&&ie&&(se=!1),se){if(g>o.maxLineGap*2.5&&!ue&&!ge){if(de++,de>he)break}else de=0;w.push(F),x.add(F),U&&(U+=" "),U+=F.text.trim()}else if(g>o.maxLineGap*4)break}}if(U||w.length>1){const G={x1:Math.min(...w.map(F=>F.bbox.x1)),y1:Math.min(...w.map(F=>F.bbox.y1)),x2:Math.max(...w.map(F=>F.bbox.x2)),y2:Math.max(...w.map(F=>F.bbox.y2))};h.push({number:p.number,text:U,bbox:G,items:w}),U.length>80&&U.substring(0,80)+""}}for(const v of c){if(x.has(v))continue;const p=v.text.match(/^[\(\[]?(\d+)[\)\]]?\s*[-.:]?\s+(.+)$/);p&&p[2].length>3&&(x.add(v),h.find(w=>w.number===p[1])||h.push({number:p[1],text:p[2],bbox:v.bbox,items:[v]}))}return h}function ds(t,o){const N=new Map;for(const h of t){const m=h.bbox.x1;let x=!1;for(const[j,c]of N.entries())if(Math.abs(m-j)<=o){c.push(h),x=!0;break}x||N.set(m,[h])}return N}function us(t,o,N){if(t.length===0)return 0;const h=Math.min(t.length*10,30),x=Math.max(...Array.from(o.values()).map(w=>w.length))/Math.max(1,t.length)*30,j=t.map(w=>parseInt(w.number)).sort((w,L)=>w-L);let c=0;for(let w=1;w<j.length;w++)j[w]===j[w-1]+1&&c++;const d=c/Math.max(1,j.length-1)*20,v=[...t].sort((w,L)=>w.bbox.y1-L.bbox.y1),p=[];for(let w=1;w<v.length;w++)p.push(v[w].bbox.y1-v[w-1].bbox.y2);let k=0;if(p.length>0){const w=p.reduce((z,P)=>z+P,0)/p.length,L=p.reduce((z,P)=>z+Math.pow(P-w,2),0)/p.length,U=Math.sqrt(L);k=Math.max(0,20-U/w*20)}return h+x+d+k}async function xs(t,o,N,h){const m=[],x=new Map;for(const c of h){const d=t.filter(p=>p.page===c),v=bn(d,o,N);if(v.length>0){const p=ds(v,o.alignmentTolerance);m.push(...v.map(k=>({...k,page:c})));for(const[k,w]of p.entries()){const L=Array.from(x.keys()).find(U=>Math.abs(U-k)<=o.alignmentTolerance);L!==void 0?x.get(L).push(...w):x.set(k,w)}}}const j=us(m,x);return{notes:m,score:j,alignmentGroups:x}}function ms(t,o,N,h){const m=[],x=new Map,j=new Map;for(const c of t)if(c.text.toUpperCase().includes("NOTE")){const d=j.get(c.page)||[];d.push(c),j.set(c.page,d)}for(const[c,d]of j.entries()){const v=o.filter(k=>k.page===c),p=bn(v,N,h);for(const k of d){const w=k.text.match(/NOTE\s*(\d+)/i);if(!w){if(d.length===1&&p.length>0){for(const z of p){for(const ie of z.items)m.push({id:Me(),from:k.id,to:ie.id,type:ne.Annotation});const P=x.get(k.id)||"",W=P?P+`
`+z.text:z.text;x.set(k.id,W)}p.reduce((z,P)=>z+P.items.length,0)}continue}const L=w[1],U=p.find(z=>z.number===L);if(U&&U.items.length>0){for(const z of U.items)m.push({id:Me(),from:k.id,to:z.id,type:ne.Annotation});x.set(k.id,U.text),U.text.length>60?U.text.substring(0,60)+"":U.text}}}return{relationships:m,noteDescriptions:x}}async function hs(t,o,N){const h=[{minXPosition:.45,alignmentTolerance:40,maxYGap:300,maxHorizontalGap:200,maxLineGap:50},{minXPosition:.5,alignmentTolerance:35,maxYGap:280,maxHorizontalGap:180,maxLineGap:45},{minXPosition:.4,alignmentTolerance:45,maxYGap:350,maxHorizontalGap:220,maxLineGap:55},{minXPosition:.55,alignmentTolerance:30,maxYGap:250,maxHorizontalGap:150,maxLineGap:40},{minXPosition:.35,alignmentTolerance:50,maxYGap:400,maxHorizontalGap:250,maxLineGap:60}],j=(await o.getPage(1)).getViewport({scale:1}).width,c=o.numPages,d=[],v=Math.min(5,Math.max(3,Math.floor(c*.3))),p=Math.min(2,Math.floor(c*.1));for(let w=0;w<v;w++){const L=p+Math.floor(w*(c-p)/v);d.push(Math.min(L+1,c))}let k={pattern:mn,score:0,detectedNotes:[],alignmentGroups:new Map};for(let w=0;w<h.length;w++){N&&N(w/h.length*100,`빠른 테스트 ${w+1}/${h.length}`);const L={...mn,...h[w]},{notes:U,score:z,alignmentGroups:P}=await xs(t,L,j,d);z>k.score&&(k={pattern:L,score:z,detectedNotes:U.map(W=>({number:W.number,text:W.text,bbox:W.bbox,page:W.page})),alignmentGroups:P})}return k}const fs={verticalRange:{min:5,max:30,step:5},horizontalRange:{min:5,max:40,step:5},autoLinkRange:{min:20,max:50,step:10},maxPagesToTest:3,minConfidenceScore:.7};function ps(t){const o=t.filter(v=>v.category===b.Instrument);if(o.length===0)return 0;const N=Math.log(o.length+1)*10,m=o.filter(v=>/^[A-Z]{2,4}[-\s]?\d{3,4}[A-Z]?$/i.test(v.text)).length/o.length*30,x=new Set(o.map(v=>v.page)).size,j=Math.min(x*5,20),c=o.length/x,d=c>100?Math.max(0,20-(c-100)*.2):20;return N+m+j+d}async function Nn(t,o,N,h,m){const x=[];for(const c of o)try{const{tags:d}=await yn(t,c,N,h,m);x.push(...d)}catch{}const j=ps(x);return{tags:x,quality:j}}async function gs(t,o,N,h,m={},x){const j={...fs,...m},c=t.numPages,d=[],v=c>5?3:1;if(c<=3)for(let P=1;P<=c;P++)d.push(P);else if(c<=10){const P=Math.floor(c/2);d.push(P),P-1>=v&&d.push(P-1),P+1<=c&&d.push(P+1),d.sort((W,ie)=>W-ie)}else{const P=Math.floor(c*.2),W=Math.floor(c*.8),ie=W-P,de=Math.max(1,Math.floor(ie/j.maxPagesToTest));for(let he=P;he<=W&&d.length<j.maxPagesToTest;he+=de)he>v&&d.push(he)}d.length===0&&d.push(Math.max(1,Math.floor(c/2)));const p=Math.floor((j.verticalRange.max-j.verticalRange.min)/j.verticalRange.step)+1,k=Math.floor((j.horizontalRange.max-j.horizontalRange.min)/j.horizontalRange.step)+1,w=Math.floor((j.autoLinkRange.max-j.autoLinkRange.min)/j.autoLinkRange.step)+1,L=p*k*w;let U=0,z={tolerances:N,score:0,tagCount:0,details:{vertical:N[b.Instrument].vertical,horizontal:N[b.Instrument].horizontal,autoLinkDistance:N[b.Instrument].autoLinkDistance,testedPages:d,tagsByPage:new Map}};for(let P=j.verticalRange.min;P<=j.verticalRange.max;P+=j.verticalRange.step)for(let W=j.horizontalRange.min;W<=j.horizontalRange.max;W+=j.horizontalRange.step)for(let ie=j.autoLinkRange.min;ie<=j.autoLinkRange.max;ie+=j.autoLinkRange.step){U++;const de=U/L*100;x&&x(de,`테스트 중: 수직:${P}px, 수평:${W}px, 링크:${ie}px`);const he={[b.Instrument]:{vertical:P,horizontal:W,autoLinkDistance:ie}},{tags:G,quality:F}=await Nn(t,d,o,he,h),I=G.filter(K=>K.category===b.Instrument),g=new Map;d.forEach(K=>{const V=I.filter(ue=>ue.page===K).length;g.set(K,V)}),F>z.score&&(z={tolerances:he,score:F,tagCount:I.length,details:{vertical:P,horizontal:W,autoLinkDistance:ie,testedPages:d,tagsByPage:g}})}return z}async function ys(t,o,N,h,m){const x=[{vertical:15,horizontal:20,autoLinkDistance:30},{vertical:10,horizontal:15,autoLinkDistance:25},{vertical:20,horizontal:25,autoLinkDistance:35},{vertical:12,horizontal:18,autoLinkDistance:30}],j=t.numPages;let c;j<=3?c=Math.min(2,j):j<=10?c=Math.floor(j/2):c=Math.floor(j*.4);const v=(await Promise.all(x.map(async(w,L)=>{m&&m(L/x.length*30,`사전 설정 테스트 ${L+1}/${x.length}`);const U={[b.Instrument]:w},{tags:z,quality:P}=await Nn(t,[c],o,U,h);return{values:w,quality:P,tags:z}}))).reduce((w,L)=>L.quality>w.quality?L:w),p={verticalRange:{min:Math.max(5,v.values.vertical-5),max:Math.min(30,v.values.vertical+5),step:2},horizontalRange:{min:Math.max(5,v.values.horizontal-5),max:Math.min(40,v.values.horizontal+5),step:2},autoLinkRange:{min:Math.max(20,v.values.autoLinkDistance-10),max:Math.min(50,v.values.autoLinkDistance+10),step:5},maxPagesToTest:Math.min(3,Math.max(1,t.numPages-3))};return m&&m(30,"파라미터 미세 조정 중..."),gs(t,o,N,h,p,m?(w,L)=>m(30+w*.7,L):void 0)}vn.workerSrc=new URL("/P-ID-Tag-Extractor/pdf.worker.min.mjs",import.meta.url).href;const bs=({isOpen:t,message:o,onConfirm:N,onCancel:h})=>t?e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 animate-fade-in-up",style:{animationDuration:"0.2s"},onClick:h,children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl shadow-2xl w-full max-w-md text-gray-900",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-bold mb-2 text-gray-900",children:"Confirm Action"}),e.jsx("div",{className:"text-gray-700 whitespace-pre-line",children:o})]}),e.jsxs("div",{className:"p-4 bg-gray-50 rounded-b-xl border-t border-gray-200 flex justify-end items-center space-x-2",children:[e.jsx("button",{onClick:h,className:"px-4 py-2 text-sm font-semibold text-gray-600 bg-transparent rounded-md hover:bg-gray-100 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:N,className:"px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-white",children:"Confirm"})]})]})}):null,Ns=()=>{const[t,o]=s.useState(null),[N,h]=s.useState(null),[m,x]=s.useState([]),[j,c]=s.useState([]),[d,v]=s.useState([]),[p,k]=s.useState([]),[w,L]=s.useState([]),[U]=s.useState([]),[z,P]=s.useState(!1),[W,ie]=s.useState({current:0,total:0}),[de,he]=s.useState(!1),[G,F]=s.useState(!1),[I,g]=s.useState({percent:0,message:""}),[K]=s.useState(()=>{const i=localStorage.getItem("pid-tagger-auto-optimize");return i!==null?i==="true":!0}),[V]=s.useState(()=>{const i=localStorage.getItem("pid-tagger-auto-optimize-notes");return i!==null?i==="true":!0}),[ue,ge]=s.useState({isOpen:!1,message:"",onConfirm:()=>{}}),[Ee,se]=s.useState(1),[fe,Oe]=s.useState(1.5),[Xe,Ue]=s.useState("select"),[ce,ae]=s.useState(null),[we,ke]=s.useState({tags:{line:!0,instrument:!0,drawingNumber:!0,notesAndHolds:!0},descriptions:!0,relationships:{connection:!0,installation:!0,annotation:!1,note:!1}}),Ae=Object.values(we.relationships).some(Boolean),Re=s.useCallback(i=>{ke(a=>({...a,relationships:{connection:i,installation:i,annotation:i,note:i}}))},[]),[Be,ze]=s.useState(!0),[ve,Pe]=s.useState(!1),[$e,Se]=s.useState(()=>localStorage.getItem("pid-tagger-showAllRelationships")!=="false"),[Ie,$]=s.useState(()=>localStorage.getItem("pid-tagger-showOnlySelectedRelationships")==="true"),[Z,Ce]=s.useState(()=>{try{const i=localStorage.getItem("pid-tagger-patterns");if(!i)return Tt;let a=JSON.parse(i);if(a.Line||(a.라인?(a.Line=a.라인,delete a.라인):a.Line=Tt.Line||Tt[b.Line],localStorage.setItem("pid-tagger-patterns",JSON.stringify(a))),typeof a=="object"&&a!==null&&!Array.isArray(a)){let u=!1;for(const A in Tt)a.hasOwnProperty(A)||(a[A]=Tt[A],u=!0);if(typeof a[b.Instrument]=="string"){const A=a[b.Instrument],C="\\s?",M=A.indexOf(C);M>-1?a[b.Instrument]={func:A.substring(0,M),num:A.substring(M+C.length)}:a[b.Instrument]={func:A,num:""},u=!0}return u&&localStorage.setItem("pid-tagger-patterns",JSON.stringify(a)),a}return Tt}catch{return Tt}}),[S,T]=s.useState(()=>{try{const i=localStorage.getItem("pid-tagger-tolerances");let a=i?JSON.parse(i):Vt;return typeof a=="object"&&a!==null&&!Array.isArray(a)?(a[b.Instrument]?a[b.Instrument].hasOwnProperty("autoLinkDistance")||(a[b.Instrument].autoLinkDistance=Vt[b.Instrument].autoLinkDistance):a[b.Instrument]={...Vt[b.Instrument]},a):Vt}catch{return Vt}}),[X,le]=s.useState(()=>{try{const i=localStorage.getItem("pid-tagger-app-settings");if(i){const a=JSON.parse(i);return{..._e,...a,autoGenerateLoops:!0,autoRemoveWhitespace:!0,hyphenSettings:{..._e.hyphenSettings,...a.hyphenSettings||{}},loopRules:{..._e.loopRules,...a.loopRules||{}},instrumentMappings:{..._e.instrumentMappings,...a.instrumentMappings||{}}}}return _e}catch{return _e}}),[Le,He]=s.useState(()=>{var i,a,u,A,C,M;try{const Y=localStorage.getItem("pid-tagger-color-settings");if(Y){const _=JSON.parse(Y);if(_.tags&&!_.entities)return{entities:{..._.tags,description:((i=_.relationships)==null?void 0:i.description)||Ke.entities.description},relationships:{connection:((a=_.relationships)==null?void 0:a.connection)||Ke.relationships.connection,installation:((u=_.relationships)==null?void 0:u.installation)||Ke.relationships.installation,annotation:((A=_.relationships)==null?void 0:A.annotation)||Ke.relationships.annotation,note:((C=_.relationships)==null?void 0:C.note)||Ke.relationships.note},highlights:{noteRelated:((M=_.relationships)==null?void 0:M.noteRelated)||Ke.highlights.noteRelated,selected:Ke.highlights.selected}};if(_.entities)return _}return Ke}catch{return Ke}});s.useEffect(()=>{try{localStorage.setItem("pid-tagger-patterns",JSON.stringify(Z))}catch{}},[Z]),s.useEffect(()=>{try{localStorage.setItem("pid-tagger-tolerances",JSON.stringify(S))}catch{}},[S]),s.useEffect(()=>{try{localStorage.setItem("pid-tagger-app-settings",JSON.stringify(X))}catch{}},[X]),s.useEffect(()=>{try{localStorage.setItem("pid-tagger-color-settings",JSON.stringify(Le))}catch{}},[Le]),s.useEffect(()=>{localStorage.setItem("pid-tagger-showAllRelationships",$e.toString())},[$e]),s.useEffect(()=>{localStorage.setItem("pid-tagger-showOnlySelectedRelationships",Ie.toString())},[Ie]),s.useEffect(()=>{const i=a=>{const u=a.target;u.tagName==="INPUT"||u.tagName==="TEXTAREA"||u.tagName==="SELECT"||(a.key.toLowerCase()==="s"?(a.preventDefault(),ze(A=>!A)):a.key.toLowerCase()==="v"&&(a.preventDefault(),window.dispatchEvent(new CustomEvent("toggleVisibilityPanel"))))};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[]);const Te=(i,a)=>{ge({isOpen:!0,message:i,onConfirm:a})},Fe=()=>{ge({isOpen:!1,message:"",onConfirm:()=>{}}),Pe(!1)},Ye=()=>{ue.onConfirm(),Fe()},lt=s.useCallback(async(i,a,u,A)=>{P(!0),x([]),c([]),v([]),L([]),ie({current:0,total:i.numPages}),se(1);try{let C=[],M=[];for(let _=1;_<=i.numPages;_++){const{tags:J,rawTextItems:l}=await yn(i,_,a,u,X);C=[...C,...J],M=[...M,...l],ie(D=>({...D,current:_}))}x(C),c(M),v([]);let Y=[];if(V){const _=C.filter(l=>l.category===b.Instrument),J=C.filter(l=>l.category===b.NotesAndHolds);if(_.length>0&&J.length>0){F(!0),g({percent:0,message:"노트 연결 최적화 중..."});try{const l=await ls(_,J,i,(R,q)=>{g({percent:R,message:q})});localStorage.setItem("pid-tagger-optimized-note-distance",l.distance.toString());const D=cs(_,J,l.distance);D.length>0&&(Y=[...Y,...D])}catch{}}if(J.length>0){g({percent:0,message:"노트 설명 패턴 최적화 중..."});try{const l=await hs(M,i,(D,R)=>{g({percent:D,message:R})});if(l.score>0){localStorage.setItem("pid-tagger-optimized-note-description-pattern",JSON.stringify(l.pattern));const q=(await i.getPage(1)).getViewport({scale:1}).width,{relationships:r}=ms(J,M,l.pattern,q);r.length>0&&(Y=[...Y,...r])}}catch{}}F(!1),v(Y)}(A!=null&&A.autoGenerateLoops||X.autoGenerateLoops)&&setTimeout(()=>{tt(C)},100)}catch{}finally{P(!1)}},[X,V]),Je=s.useCallback(async i=>{F(!0),g({percent:0,message:"최적화 시작 중..."});try{const a=await ys(i,Z,S,X,(u,A)=>{g({percent:u,message:A})});return T(a.tolerances),localStorage.setItem("pid-tagger-tolerances",JSON.stringify(a.tolerances)),g({percent:100,message:`✅ 최적 설정 발견: ${a.tagCount}개 태그 감지됨`}),setTimeout(()=>{F(!1),g({percent:0,message:""})},2e3),a.tolerances}catch{return F(!1),g({percent:0,message:"최적화 실패"}),S}},[Z,S,X,T]),It=s.useCallback(async i=>{o(i),P(!0),x([]),c([]),v([]),ie({current:0,total:0}),se(1);try{const a=await i.arrayBuffer(),A=await jn({data:a}).promise;h(A);let C=S;K&&(C=await Je(A)),await lt(A,Z,C,X)}catch{P(!1)}},[Z,S,X,lt,K,Je]),Nt=(i,a,u,A)=>{const C={...i,[b.Line]:i[b.Line]||i.Line||Tt[b.Line]};Ce(C),T(a);const M={...u,autoGenerateLoops:!0,autoRemoveWhitespace:!0};le(M),He(A),he(!1),localStorage.setItem("pid-tagger-patterns",JSON.stringify(C)),localStorage.setItem("pid-tagger-tolerances",JSON.stringify(a)),localStorage.setItem("pid-tagger-app-settings",JSON.stringify(M)),localStorage.setItem("pid-tagger-color-settings",JSON.stringify(A))},dt=async(i,a,u,A,C)=>{const M={...i,[b.Line]:i[b.Line]||i.Line||Tt[b.Line]};Ce(M),T(a);const Y={...u,autoGenerateLoops:!0,autoRemoveWhitespace:!0};le(Y),He(A),he(!1),localStorage.setItem("pid-tagger-patterns",JSON.stringify(M)),localStorage.setItem("pid-tagger-tolerances",JSON.stringify(a)),localStorage.setItem("pid-tagger-app-settings",JSON.stringify(Y)),localStorage.setItem("pid-tagger-color-settings",JSON.stringify(A)),C==="patterns"&&N&&(d.length>0||w.length>0||m.some(J=>J.isReviewed)||w.length>0?Te(`패턴 설정이 변경되어 PDF를 다시 스캔해야 합니다.

⚠️ Rescanning will delete all manually created content:

• Tag relationships (Connection, Installation, Note, etc.)
• Manually created loops
• Tag review status (✓ checkmarks)

✅ Note & Hold descriptions will be preserved.

💡 If you have important work, please Export your project as backup first.

Do you want to continue?`,()=>lt(N,M,a,u)):await lt(N,M,a,u))},wt=s.useCallback(i=>{ke(a=>({...a,...i,tags:i.tags?{...a.tags,...i.tags}:a.tags,relationships:i.relationships?{...a.relationships,...i.relationships}:a.relationships}))},[]),ct=s.useCallback(i=>{ke(a=>({...a,tags:{...a.tags,[i]:!a.tags[i]}}))},[]),Qe=s.useCallback(i=>{ke(a=>({...a,relationships:{...a.relationships,[i]:!a.relationships[i]}}))},[]),nt=s.useCallback(()=>{const a=!Object.values(we.tags).every(Boolean);ke(u=>({...u,tags:{line:a,instrument:a,drawingNumber:a,notesAndHolds:a},descriptions:a}))},[we.tags]),mt=s.useCallback(()=>{const a=!Object.values(we.relationships).every(Boolean);ke(u=>({...u,relationships:{connection:a,installation:a,annotation:a,note:a}}))},[we.relationships]),At=s.useCallback((i,a)=>{if(!i||i.length===0)return;const u=i[0].page;if(i.some(D=>D.page!==u))return;const A=[...i].sort((D,R)=>{const q=D.bbox.y1-R.bbox.y1;return Math.abs(q)>5?q:D.bbox.x1-R.bbox.x1}),M=(()=>{switch(a){case b.Line:return X.hyphenSettings.line;case b.Instrument:return X.hyphenSettings.instrument;case b.DrawingNumber:return X.hyphenSettings.drawingNumber;case b.NotesAndHolds:return X.hyphenSettings.notesAndHolds;default:return!1}})()?A.map(D=>D.text).join("-"):A.map(D=>D.text).join(""),Y=X.autoRemoveWhitespace&&a!==b.NotesAndHolds?M.replace(/\s+/g,""):M,_=i.reduce((D,R)=>({x1:Math.min(D.x1,R.bbox.x1),y1:Math.min(D.y1,R.bbox.y1),x2:Math.max(D.x2,R.bbox.x2),y2:Math.max(D.y2,R.bbox.y2)}),{x1:1/0,y1:1/0,x2:-1/0,y2:-1/0}),J={id:Me(),text:Y,page:u,bbox:_,category:a,sourceItems:i};x(D=>[...D,J]);const l=new Set(i.map(D=>D.id));c(D=>D.filter(R=>!l.has(R.id))),v(D=>D.filter(R=>!(R.type===ne.Annotation&&l.has(R.to))))},[X.autoRemoveWhitespace,X.hyphenSettings]),We=s.useCallback(i=>{const{text:a,bbox:u,page:A,category:C}=i;if(!a||!u||!A||!C)return;const M=X.autoRemoveWhitespace&&C!==b.NotesAndHolds?a.replace(/\s+/g,""):a,Y={id:Me(),text:M,page:A,bbox:u,category:C,sourceItems:[]};x(_=>[..._,Y])},[X.autoRemoveWhitespace]),Ge=s.useCallback(i=>{const a=new Set(i),u=m.filter(C=>a.has(C.id)),A=[];for(const C of u)if(C.sourceItems&&C.sourceItems.length>0){const M=C.sourceItems.map(Y=>({id:Me(),text:Y.text,page:C.page,bbox:Y.bbox}));A.push(...M)}else{const M={id:Me(),text:C.text,page:C.page,bbox:C.bbox};A.push(M)}x(C=>C.filter(M=>!a.has(M.id))),c(C=>[...C,...A]),v(C=>C.filter(M=>!a.has(M.from)&&!a.has(M.to)))},[m]),st=s.useCallback(i=>{if(!i||i.length<2)return;const a=j.filter(J=>i.includes(J.id));if(a.length<2)return;const u=a[0].page;if(a.some(J=>J.page!==u))return;const C=[...a].sort((J,l)=>{const D=J.bbox.y1-l.bbox.y1;return Math.abs(D)>5?D:J.bbox.x1-l.bbox.x1}).map(J=>J.text).join(" "),M=a.reduce((J,l)=>({x1:Math.min(J.x1,l.bbox.x1),y1:Math.min(J.y1,l.bbox.y1),x2:Math.max(J.x2,l.bbox.x2),y2:Math.max(J.y2,l.bbox.y2)}),{x1:1/0,y1:1/0,x2:-1/0,y2:-1/0}),Y={id:Me(),text:C,page:u,bbox:M},_=new Set(i);c(J=>[...J.filter(l=>!_.has(l.id)),Y]),v(J=>J.filter(l=>!_.has(l.to)))},[j]),ht=s.useCallback(i=>{const a=new Set(i);c(u=>u.filter(A=>!a.has(A.id))),v(u=>u.filter(A=>!a.has(A.to)))},[]),ot=s.useCallback((i,a)=>{x(u=>u.map(A=>A.id===i?{...A,text:a}:A))},[]),et=s.useCallback((i,a)=>{c(u=>u.map(A=>A.id===i?{...A,text:a}:A))},[]),ft=s.useCallback((i,a="Note")=>{if(!i||i.length===0)return;const u=[...i].sort((Q,re)=>Q.bbox.y1-re.bbox.y1),A=u.map(Q=>Q.text).join(" "),C={x1:Math.min(...u.map(Q=>Q.bbox.x1)),y1:Math.min(...u.map(Q=>Q.bbox.y1)),x2:Math.max(...u.map(Q=>Q.bbox.x2)),y2:Math.max(...u.map(Q=>Q.bbox.y2))},M=u[0].page,Y=a,_=p.filter(Q=>Q.metadata.type===Y&&Q.page===M).map(Q=>Q.metadata.number),J=_.length>0?Math.max(..._)+1:1,l={id:Me(),text:A,page:u[0].page,bbox:C,sourceItems:u,metadata:{type:Y,scope:"Specific",number:J}};k(Q=>[...Q,l]);const D=Q=>{const re=Q.match(/\d+/g);return re?re.map(pe=>parseInt(pe,10)):[]},R=Q=>{const re=Q.toLowerCase();return re.includes("note")?"Note":re.includes("hold")?"Hold":null},q=m.filter(Q=>Q.category===b.NotesAndHolds&&Q.page===M),r=[];for(const Q of q){const re=R(Q.text);if(!re||re!==Y)continue;D(Q.text).includes(J)&&(`${Q.id}${l.id}`,d.some(rt=>rt.from===Q.id&&rt.to===l.id&&rt.type===ne.Description)||r.push({id:Me(),from:Q.id,to:l.id,type:ne.Description}))}r.length>0&&v(Q=>[...Q,...r]);const O=i.filter(Q=>"category"in Q).map(Q=>Q.id);O.length>0&&x(Q=>Q.filter(re=>!O.includes(re.id)));const oe=i.filter(Q=>!("category"in Q)).map(Q=>Q.id);oe.length>0&&c(Q=>Q.filter(re=>!oe.includes(re.id)))},[p,m,d]),je=s.useCallback(i=>{ft(i,"Hold")},[ft]),Dt=s.useCallback(i=>{const a=new Set(i);p.filter(A=>a.has(A.id)).forEach(A=>{A.sourceItems.forEach(C=>{"category"in C?x(M=>M.some(_=>_.id===C.id)?M:[...M,C]):c(M=>M.some(_=>_.id===C.id)?M:[...M,C])})}),k(A=>A.filter(C=>!a.has(C.id))),v(A=>A.filter(C=>!a.has(C.from)&&!a.has(C.to)))},[p]),Mt=s.useCallback((i,a,u)=>{k(A=>{const C=A.find(Y=>Y.id===i);if(!C)return A;let M=u;if(C.metadata.type!==u.type){const Y=A.filter(J=>J.id!==i&&J.metadata.type===u.type&&J.page===C.page).map(J=>J.metadata.number),_=Y.length>0?Math.max(...Y)+1:1;M={...u,number:_}}return A.map(Y=>Y.id===i?{...Y,text:a,metadata:M}:Y)})},[]),Ot=i=>{if(!i||typeof i!="object")return!1;const a=["pdfFileName","exportDate","tags","relationships","rawTextItems"];for(const u of a)if(!(u in i))return!1;if(!Array.isArray(i.tags)||!Array.isArray(i.relationships)||!Array.isArray(i.rawTextItems)||i.descriptions&&!Array.isArray(i.descriptions))return!1;for(const u of i.tags)if(!u.id||!u.text||!u.page||!u.bbox||!u.category||!u.bbox.hasOwnProperty("x1")||!u.bbox.hasOwnProperty("y1")||!u.bbox.hasOwnProperty("x2")||!u.bbox.hasOwnProperty("y2"))return!1;for(const u of i.relationships)if(!u.id||!u.from||!u.to||!u.type||!Object.values(ne).includes(u.type))return!1;for(const u of i.rawTextItems)if(!u.id||!u.text||!u.page||!u.bbox)return!1;return!0},Et=i=>{const a=u=>u.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/javascript:/gi,"").replace(/on\w+="[^"]*"/gi,"");return{...i,pdfFileName:a(i.pdfFileName),tags:i.tags.map(u=>({...u,text:a(u.text)})),rawTextItems:i.rawTextItems.map(u=>({...u,text:a(u.text)})),descriptions:(i.descriptions||[]).map(u=>({...u,text:a(u.text)}))}},Ct=s.useCallback(i=>{var u,A,C;if(!Ot(i)){alert("프로젝트 파일 구조가 잘못되었거나 손상된 데이터입니다. 불러올 수 없습니다.");return}const a=Et(i);x(a.tags),v(a.relationships),c(a.rawTextItems),k(a.descriptions||[]),L([]),(u=a.settings)!=null&&u.patterns&&Ce(a.settings.patterns),(A=a.settings)!=null&&A.tolerances&&T(a.settings.tolerances),(C=a.settings)!=null&&C.appSettings&&le(a.settings.appSettings)},[]);s.useCallback(async i=>{if(!i||!t){alert("프로젝트 파일을 가져오기 전에 PDF 파일을 먼저 열어주세요.");return}const a=50*1024*1024;if(i.size>a){alert("프로젝트 파일이 너무 큽니다. 최대 파일 크기는 50MB입니다.");return}if(!i.name.toLowerCase().endsWith(".json")){alert("유효한 JSON 프로젝트 파일을 선택해주세요.");return}const u=new FileReader;u.onload=A=>{var C,M;try{const Y=(C=A.target)==null?void 0:C.result;if(!Y)throw new Error("File content is empty");if(Y.includes("<script>")||Y.includes("javascript:"))throw new Error("Project file contains potentially malicious content");const _=JSON.parse(Y);if(_.pdfFileName!==t.name){const J=((M=_.pdfFileName)==null?void 0:M.replace(/[<>]/g,""))||"Unknown";Te(`이 프로젝트 파일은 다른 PDF("${J}")용인 것 같습니다. 현재 "${t.name}"이(가) 열려 있습니다. 그래도 프로젝트 데이터를 불러오시겠습니까?`,()=>Ct(_))}else Ct(_)}catch(Y){let _="Could not load project. ";Y instanceof SyntaxError?_+="The file contains invalid JSON format.":Y.message.includes("malicious")?_+="The file contains potentially unsafe content.":_+="The file might be corrupted or in an invalid format.",alert(_)}},u.onerror=()=>{alert("파일 읽기 오류. 다시 시도해주세요.")},u.readAsText(i)},[t,Ct,Te]),s.useCallback(()=>{if(!t)return;const i={pdfFileName:t.name,exportDate:new Date().toISOString(),tags:m,relationships:d,rawTextItems:j,descriptions:p,loops:w,settings:{patterns:Z,tolerances:S,appSettings:X}},a=JSON.stringify(i,null,2),u=new Blob([a],{type:"application/json"}),A=URL.createObjectURL(u),C=document.createElement("a");C.href=A;const M=t.name.replace(/\.pdf$/i,"")+"-project.json";C.download=M,document.body.appendChild(C),C.click(),document.body.removeChild(C),URL.revokeObjectURL(A)},[t,m,d,j,Z,S]);const Lt=(i,a,u)=>{const A=[[u.x1,u.y1],[u.x2,u.y1],[u.x1,u.y2],[u.x2,u.y2],[(u.x1+u.x2)/2,(u.y1+u.y2)/2]];return Math.min(...A.map(([C,M])=>Math.sqrt((i-C)**2+(a-M)**2)))},ut=s.useCallback(()=>{var u;const i=(u=S[b.Instrument])==null?void 0:u.autoLinkDistance;if(typeof i!="number"){alert("자동 연결 거리가 설정되지 않았습니다. 설정을 확인해주세요.");return}Pe(!0),setTimeout(()=>{Te(`현재 거리 설정(${i}px)에 따라 모든 계기 태그에 대한 설명 연결을 자동으로 생성합니다. 많은 관계가 생성될 수 있습니다. 계속하시겠습니까?`,()=>{Pe(!1),a()})},500);const a=()=>{const A=m.filter(_=>_.category===b.Instrument),C=new Set(d.filter(_=>_.type===ne.Annotation).map(_=>_.to)),M=j.filter(_=>!C.has(_.id)),Y=[];for(const _ of M){if(C.has(_.id))continue;const J=A.filter(R=>R.page===_.page);let l=null,D=1/0;for(const R of J){const q={x:(R.bbox.x1+R.bbox.x2)/2,y:(R.bbox.y1+R.bbox.y2)/2},r=Lt(q.x,q.y,_.bbox);r<=i&&r<D&&(D=r,l=R)}l&&(Y.push({id:Me(),from:l.id,to:_.id,type:ne.Annotation}),C.add(_.id))}if(Y.length>0){const _=new Set(d.map(l=>`${l.from}-${l.to}-${l.type}`)),J=Y.filter(l=>!_.has(`${l.from}-${l.to}-${l.type}`));J.length>0?(v(l=>[...l,...J]),alert(`${J.length}개의 새 설명 연결이 생성되었습니다.`)):alert("새로운 설명 연결을 찾을 수 없습니다. 이미 존재할 수 있습니다.")}else alert("현재 설정으로 새 설명 연결을 찾을 수 없습니다.")};Te(`현재 거리 설정(${i}px)에 따라 모든 계기 태그에 대한 설명 연결을 자동으로 생성합니다. 많은 관계가 생성될 수 있습니다. 계속하시겠습니까?`,a)},[m,j,d,S,Te]);s.useCallback(()=>{const i=d.filter(a=>a.type!==ne.Note);v(i),alert("All NOTE connections have been cleared. Please re-run auto-link to create correct connections.")},[d,v]);const pt=s.useCallback(async()=>{const i=A=>{const C=A.toLowerCase();return C.includes("note")?"Note":C.includes("hold")?"Hold":null},a=A=>{const C=A.match(/\d+/g);return C?C.map(M=>parseInt(M,10)):[]};Te("유형과 번호 매칭을 기반으로 노트 & 홀드 태그와 해당 설명 간의 연결을 자동으로 생성합니다. 계속하시겠습니까?",async()=>{const A=m.filter(r=>r.category===b.NotesAndHolds),C=new Set(d.filter(r=>r.type===ne.Description).map(r=>`${r.from}-${r.to}`)),M=[];for(const r of A){const O=i(r.text);if(!O)continue;const oe=a(r.text);if(oe.length!==0)for(const Q of oe){const re=p.filter(pe=>pe.metadata.type===O&&pe.metadata.number===Q&&pe.metadata.scope==="Specific"&&pe.page===r.page);for(const pe of re){const be=`${r.id}-${pe.id}`;C.has(be)||(M.push({id:Me(),from:r.id,to:pe.id,type:ne.Description}),C.add(be))}}}if(M.length>0){const r=new Set(d.map(oe=>`${oe.from}-${oe.to}-${oe.type}`)),O=M.filter(oe=>!r.has(`${oe.from}-${oe.to}-${oe.type}`));O.length>0&&v(oe=>[...oe,...O])}if(!N){alert("PDF 문서가 로드되지 않았습니다.");return}let Y=[],_=[],J=[];for(let r=1;r<=N.numPages;r++)try{const oe=(await N.getPage(r)).getViewport({scale:1}),Q=os(j,r,oe);if(Q&&Q.length>0){Y.push(...Q);for(const re of Q)if(!p.find(be=>be.page===r&&be.metadata.type==="Note"&&be.metadata.number===re.number)){const be={id:Me(),text:re.text,page:re.page,bbox:re.bbox,sourceItems:re.items||[],metadata:{type:"Note",scope:"Specific",number:re.number}};_.push(be);const rt=m.filter(n=>n.category===b.NotesAndHolds&&n.page===r&&i(n.text)==="Note");for(const n of rt)a(n.text).includes(re.number)&&(d.some(f=>f.from===n.id&&f.type===ne.Description)||J.some(f=>f.from===n.id&&f.to===be.id)||J.push({id:Me(),from:n.id,to:be.id,type:ne.Description}))}}}catch{}const l=(r,O,oe,Q="")=>{const re=Math.max(oe.x1,Math.min(r.x,oe.x2)),pe=Math.max(oe.y1,Math.min(r.y,oe.y2)),be=r.x-re,rt=r.y-pe,n=be*be+rt*rt;return Math.sqrt(n)<=O},D=m.filter(r=>r.category===b.Instrument),R=[],q=new Set(d.filter(r=>r.type===ne.Note).map(r=>`${r.from}-${r.to}`));for(const r of D){const O={x:(r.bbox.x1+r.bbox.x2)/2,y:(r.bbox.y1+r.bbox.y2)/2},oe=r.bbox.x2-r.bbox.x1,Q=r.bbox.y2-r.bbox.y1,re=Math.sqrt(oe*oe+Q*Q)/2*3,pe=A.filter(be=>be.page===r.page&&i(be.text)==="Note");for(const be of pe)if(l(O,re,be.bbox,be.text)){const n=`${r.id}-${be.id}`;q.has(n)||(R.push({id:Me(),from:r.id,to:be.id,type:ne.Note}),q.add(n))}}if(_.length>0&&k(r=>[...r,..._]),J.length>0&&v(r=>[...r,...J]),R.length>0&&v(r=>[...r,...R]),Y.length>0||R.length>0){const r=[];Y.length>0&&r.push(`Extracted ${Y.length} note description(s)`),_.length>0&&r.push(`Created ${_.length} new description(s)`),R.length>0&&r.push(`Created ${R.length} instrument->note relationship(s)`),J.length>0&&r.push(`Created ${J.length} note->description relationship(s)`),alert(r.join(`
`))}else M.length>0?alert(`기존 설명과 함께 ${M.length}개의 새 노트 & 홀드 연결이 생성되었습니다.`):alert("현재 데이터로 새 노트 & 홀드 연결을 찾을 수 없습니다.")})},[m,p,d,Te,N,j]);s.useCallback(async()=>{Te("모든 자동 연결 기능을 순차적으로 실행합니다: 설명 및 노트 & 홀드. 계속하시겠습니까?",async()=>{try{await new Promise(i=>{(()=>{var _;const u=m.filter(J=>J.category===b.Instrument),A=(_=S[b.Instrument])==null?void 0:_.autoLinkDistance;if(typeof A!="number"||u.length===0){i();return}const C=new Set(d.filter(J=>J.type===ne.Annotation).map(J=>J.to)),M=[],Y=j.filter(J=>!C.has(J.id));for(const J of Y){if(C.has(J.id))continue;const l=u.filter(q=>q.page===J.page);let D=null,R=1/0;for(const q of l){const r={x:(q.bbox.x1+q.bbox.x2)/2,y:(q.bbox.y1+q.bbox.y2)/2},O=Lt(r.x,r.y,J.bbox);O<=A&&O<R&&(R=O,D=q)}D&&(M.push({id:Me(),from:D.id,to:J.id,type:ne.Annotation}),C.add(J.id))}M.length>0&&v(J=>[...J,...M]),i()})()}),await new Promise(i=>{(()=>{const u=m.filter(M=>M.category===b.NotesAndHolds),A=new Set(d.filter(M=>M.type===ne.Description).map(M=>`${M.from}-${M.to}`)),C=[];for(const M of u){const Y=M.text.toLowerCase(),_=Y.includes("note")?"Note":Y.includes("hold")?"Hold":null;if(!_)continue;const J=M.text.match(/\d+/g),l=J?J.map(D=>parseInt(D,10)):[];if(l.length!==0)for(const D of l){const R=p.filter(q=>q.metadata.type===_&&q.metadata.number===D&&q.metadata.scope==="Specific"&&q.page===M.page);for(const q of R){const r=`${M.id}-${q.id}`;A.has(r)||C.push({id:Me(),from:M.id,to:q.id,type:ne.Description})}}}C.length>0&&v(M=>[...M,...C]),i()})()}),alert("모든 자동 연결이 성공적으로 완료되었습니다!")}catch(i){alert("자동 연결 중 오류: "+i.message)}})},[m,j,p,d,S,Te]),s.useCallback(()=>{},[]),s.useCallback(async()=>{if(!N)return;const i=await Je(N);await lt(N,Z,i,X)},[N,Je,lt,Z,X]),s.useCallback(()=>{Te("라인 및 계기 태그에서 모든 공백을 제거하시겠습니까? 이 작업은 되돌릴 수 없습니다.",()=>{const i=m.map(u=>u.category===b.Line||u.category===b.Instrument?{...u,text:u.text.replace(/\s/g,"")}:u);x(i);const a=m.filter(u=>(u.category===b.Line||u.category===b.Instrument)&&u.text.includes(" ")).length;alert(`${a}개의 라인 및 계기 태그에서 공백이 제거되었습니다.`)})},[m,Te]);const De=s.useCallback(i=>{const a=i.trim(),u=a.match(/^([A-Z]{1,4})-?(\d+)[\s]*([A-Z]*)$/);if(u)return{function:u[1].trim(),number:parseInt(u[2]),suffix:u[3].trim()};const A=a.match(/^([A-Z]{1,4})(\d+)([A-Z]*)$/);return A?{function:A[1].trim(),number:parseInt(A[2]),suffix:A[3].trim()}:null},[]),Ne=s.useCallback(i=>{if(i.length===0)return null;const a=i[0],u=De(a.text);if(!u)return a.text.charAt(0)+"-000";let A=u.function;for(const C of i.slice(1)){const M=De(C.text);if(M&&M.number===u.number){let Y=0;for(;Y<A.length&&Y<M.function.length&&A[Y]===M.function[Y];)Y++;A=A.substring(0,Y)}}return A.length===0&&(A=u.function.charAt(0)),`${A}-${u.number}`},[De]),tt=s.useCallback(i=>{const a=i.filter(C=>C.category===b.Instrument);if(a.length===0)return;const u=new Map;for(const C of a){const M=De(C.text);if(!M)continue;const Y=`${M.function.charAt(0)}-${M.number}`;u.has(Y)||u.set(Y,[]),u.get(Y).push(C)}const A=[];u.forEach(C=>{if(C.length>1){const M=Ne(C);if(M){const Y={id:M,tagIds:C.map(_=>_.id),createdAt:new Date().toISOString(),isAutoGenerated:!0};A.push(Y)}}}),A.length>0&&L(C=>[...C,...A])},[De,Ne]),St=s.useCallback(i=>{const a=m.filter(u=>u.category===b.Instrument&&(i?u.page===i:!0));if(a.length===0){alert("루프를 생성할 계기 태그를 찾을 수 없습니다.");return}Te(`기능 접두사와 번호 매칭을 기반으로 ${a.length}개의 계기 태그에서 루프를 자동으로 생성합니다. 계속하시겠습니까?`,()=>{const u=new Map;for(const Y of a){const _=De(Y.text);if(!_)continue;const J=`${_.function.charAt(0)}-${_.number}`;u.has(J)||u.set(J,[]),u.get(J).push(Y)}const A=u,C=[],M=new Set(w.map(Y=>Y.id));for(const[Y,_]of A.entries())if(_.length>1){const J=Ne(_)||Y;if(M.has(J))continue;C.push({id:J,tagIds:_.map(l=>l.id),createdAt:new Date().toISOString(),isAutoGenerated:!0})}C.length>0?(L(Y=>[...Y,...C]),alert(`${C.reduce((Y,_)=>Y+_.tagIds.length,0)}개의 계기 태그로부터 ${C.length}개의 새 루프가 생성되었습니다.`)):alert("새 루프를 생성할 수 없습니다. 이미 존재하거나 일치하는 그룹을 찾을 수 없습니다.")})},[m,w,De,Ne,Te]),Pt=s.useCallback(i=>{const a=m.filter(M=>i.includes(M.id)&&M.category===b.Instrument);if(a.length<2){alert("루프를 생성하려면 최소 2개 이상의 계기 태그를 선택해주세요.");return}const u=Ne(a);if(!u){alert("선택한 태그에서 루프 ID를 생성할 수 없습니다.");return}if(w.find(M=>M.id===u)){alert(`Loop "${u}" already exists.`);return}const C={id:u,tagIds:a.map(M=>M.id),createdAt:new Date().toISOString(),isAutoGenerated:!1};L(M=>[...M,C]),alert(`Created loop "${u}" with ${a.length} instrument tags.`)},[m,w,Ne]),Ht=s.useCallback(i=>{L(a=>a.filter(u=>!i.includes(u.id)))},[]),gt=s.useCallback((i,a,u,A)=>{L(C=>C.map(Y=>Y.id===i?{...Y,name:a,tagIds:u}:Y).filter(Y=>Y.tagIds&&Y.tagIds.length>0))},[]),ye=()=>z?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-900",children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-10 w-10 text-sky-400",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),e.jsx("p",{className:"mt-4 text-lg",children:"Processing PDF..."}),e.jsxs("p",{className:"text-gray-600",children:["Page ",W.current," of ",W.total]})]}):t&&N?e.jsx(zt,{fallback:e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center text-red-600",children:[e.jsx("p",{className:"mb-4",children:"Error loading workspace. Please try refreshing the page."}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Reload"})]})}),children:e.jsx(_n,{pdfDoc:N,tags:m,setTags:x,relationships:d,setRelationships:v,rawTextItems:j,descriptions:p,setDescriptions:k,loops:w,setLoops:L,detectedLines:U,appSettings:X,onCreateTag:At,onCreateManualTag:We,onCreateDescription:ft,onCreateHoldDescription:je,onDeleteTags:Ge,onUpdateTagText:ot,onDeleteDescriptions:Dt,onUpdateDescription:Mt,onMergeRawTextItems:st,onDeleteRawTextItems:ht,onUpdateRawTextItemText:et,onAutoLinkDescriptions:ut,onAutoLinkNotesAndHolds:pt,onAutoGenerateLoops:St,onManualCreateLoop:Pt,onDeleteLoops:Ht,onUpdateLoop:gt,showConfirmation:Te,currentPage:Ee,setCurrentPage:se,scale:fe,setScale:Oe,mode:Xe,setMode:Ue,relationshipStartTag:ce,setRelationshipStartTag:ae,showRelationships:Ae,setShowRelationships:Re,visibilitySettings:we,updateVisibilitySettings:wt,showAutoLinkRanges:ve,tolerances:S,toggleTagVisibility:ct,toggleRelationshipVisibility:Qe,toggleAllTags:nt,toggleAllRelationships:mt,showAllRelationships:$e,setShowAllRelationships:Se,showOnlySelectedRelationships:Ie,setShowOnlySelectedRelationships:$,isSidePanelVisible:Be,colorSettings:Le})}):e.jsx(zt,{fallback:e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center text-red-300",children:[e.jsx("p",{className:"mb-4",children:"Error loading file upload. Please refresh the page."}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Reload"})]})}),children:e.jsx(Mn,{onFileSelect:It})});return e.jsxs("div",{className:"flex flex-col h-screen bg-gray-50 font-sans",children:[G&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6 max-w-md w-full mx-4 shadow-lg",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"자동 최적화"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:I.message}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-sky-500 h-2 rounded-full transition-all duration-300",style:{width:`${I.percent}%`}})}),e.jsxs("div",{className:"text-xs text-slate-400 text-right",children:[Math.round(I.percent),"%"]})]})]})}),e.jsx(zt,{fallback:e.jsx("div",{className:"h-16 bg-white border-b border-gray-200 flex items-center justify-center",children:e.jsx("p",{className:"text-red-300",children:"Error loading header"})}),children:e.jsx(Yn,{hasData:!!t,onOpenSettings:()=>he(!0),pdfDoc:N,currentPage:Ee,setCurrentPage:se,onToggleSidePanel:()=>ze(i=>!i)})}),e.jsx("main",{className:"flex-grow overflow-hidden",children:ye()}),de&&e.jsx(zt,{fallback:e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-lg",children:[e.jsx("p",{className:"text-red-300 mb-4",children:"Error loading settings modal"}),e.jsx("button",{onClick:()=>he(!1),className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Close"})]})}),children:e.jsx(ns,{patterns:Z,tolerances:S,appSettings:X,colorSettings:Le,onSaveOnly:Nt,onSaveAndRescan:dt,onClose:()=>he(!1)})}),e.jsx(bs,{isOpen:ue.isOpen,message:ue.message,onConfirm:Ye,onCancel:Fe})]})};An.createRoot(document.getElementById("root")).render(e.jsx(at.StrictMode,{children:e.jsx(zt,{children:e.jsx(Ns,{})})}));
