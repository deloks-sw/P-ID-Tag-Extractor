import{r as rn,g as an,a as mn}from"./vendor-B4QdQTOU.js";import{_ as hn,a as pn}from"./pdfjs-Cp9nfDvG.js";import{u as It,w as fn}from"./xlsx-DIVJSiuo.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const y of document.querySelectorAll('link[rel="modulepreload"]'))h(y);new MutationObserver(y=>{for(const x of y)if(x.type==="childList")for(const j of x.addedNodes)j.tagName==="LINK"&&j.rel==="modulepreload"&&h(j)}).observe(document,{childList:!0,subtree:!0});function w(y){const x={};return y.integrity&&(x.integrity=y.integrity),y.referrerPolicy&&(x.referrerPolicy=y.referrerPolicy),y.crossOrigin==="use-credentials"?x.credentials="include":y.crossOrigin==="anonymous"?x.credentials="omit":x.credentials="same-origin",x}function h(y){if(y.ep)return;y.ep=!0;const x=w(y);fetch(y.href,x)}})();var Ft={exports:{}},Dt={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Yt;function gn(){if(Yt)return Dt;Yt=1;var n=rn(),r=Symbol.for("react.element"),w=Symbol.for("react.fragment"),h=Object.prototype.hasOwnProperty,y=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,x={key:!0,ref:!0,__self:!0,__source:!0};function j(u,d,T){var f,M={},k=null,A=null;T!==void 0&&(k=""+T),d.key!==void 0&&(k=""+d.key),d.ref!==void 0&&(A=d.ref);for(f in d)h.call(d,f)&&!x.hasOwnProperty(f)&&(M[f]=d[f]);if(u&&u.defaultProps)for(f in d=u.defaultProps,d)M[f]===void 0&&(M[f]=d[f]);return{$$typeof:r,type:u,key:k,ref:A,props:M,_owner:y.current}}return Dt.Fragment=w,Dt.jsx=j,Dt.jsxs=j,Dt}var _t;function yn(){return _t||(_t=1,Ft.exports=gn()),Ft.exports}var e=yn(),o=rn();const Qe=an(o);var Ht={},qt;function bn(){if(qt)return Ht;qt=1;var n=mn();return Ht.createRoot=n.createRoot,Ht.hydrateRoot=n.hydrateRoot,Ht}var Nn=bn();const wn=an(Nn);let $t;const vn=new Uint8Array(16);function jn(){if(!$t&&($t=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!$t))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return $t(vn)}const Ge=[];for(let n=0;n<256;++n)Ge.push((n+256).toString(16).slice(1));function Tn(n,r=0){return Ge[n[r+0]]+Ge[n[r+1]]+Ge[n[r+2]]+Ge[n[r+3]]+"-"+Ge[n[r+4]]+Ge[n[r+5]]+"-"+Ge[n[r+6]]+Ge[n[r+7]]+"-"+Ge[n[r+8]]+Ge[n[r+9]]+"-"+Ge[n[r+10]]+Ge[n[r+11]]+Ge[n[r+12]]+Ge[n[r+13]]+Ge[n[r+14]]+Ge[n[r+15]]}const kn=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Kt={randomUUID:kn};function je(n,r,w){if(Kt.randomUUID&&!n)return Kt.randomUUID();n=n||{};const h=n.random||(n.rng||jn)();return h[6]=h[6]&15|64,h[8]=h[8]&63|128,Tn(h)}const Cn=({onFileSelect:n})=>{const[r,w]=o.useState(!1),h=o.useCallback(d=>{d.preventDefault(),d.stopPropagation(),w(!0)},[]),y=o.useCallback(d=>{d.preventDefault(),d.stopPropagation(),w(!1)},[]),x=o.useCallback(d=>{d.preventDefault(),d.stopPropagation()},[]),j=o.useCallback(d=>{d.preventDefault(),d.stopPropagation(),w(!1),d.dataTransfer.files&&d.dataTransfer.files.length>0&&(d.dataTransfer.files[0].type==="application/pdf"&&n(d.dataTransfer.files[0]),d.dataTransfer.clearData())},[n]),u=d=>{d.target.files&&d.target.files[0]&&n(d.target.files[0])};return e.jsx("div",{className:"flex items-center justify-center h-full p-8",children:e.jsxs("div",{className:`w-full max-w-2xl h-full max-h-[500px] border-2 border-dashed rounded-xl flex flex-col items-center justify-center text-center transition-colors ${r?"border-sky-400 bg-sky-50":"border-gray-300 bg-gray-50"}`,onDragEnter:h,onDragLeave:y,onDragOver:x,onDrop:j,children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:`h-16 w-16 mb-4 transition-colors ${r?"text-sky-400":"text-gray-500"}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 16a4 4 0 01-4-4V6a2 2 0 012-2h10a2 2 0 012 2v6a4 4 0 01-4 4H7z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 9v6m3-3H7"})]}),e.jsx("h2",{className:"text-2xl font-bold mb-2 text-gray-800",children:"P&ID 도면 업로드"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"PDF 파일을 여기에 끌어다 놓거나 클릭하여 선택하세요."}),e.jsx("label",{htmlFor:"file-upload",className:"cursor-pointer px-6 py-2.5 text-sm font-semibold text-white bg-sky-600 rounded-md hover:bg-sky-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 focus:ring-offset-white",children:"파일 선택"}),e.jsx("input",{id:"file-upload",type:"file",className:"hidden",accept:".pdf",onChange:u})]})})},N={Line:"Line",Instrument:"Instrument",DrawingNumber:"DrawingNumber",NotesAndHolds:"NotesAndHolds",Uncategorized:"Uncategorized"},te={Connection:"Connection",Installation:"Installation",Annotation:"Annotation",Note:"Note",Description:"Description"},yt={[N.Line]:'^.*".*-.*-.*$',[N.Instrument]:{func:"[A-Z]{2,4}",num:"\\d{3,4}(?:\\s?[A-Z])?"},[N.DrawingNumber]:"[A-Z0-9][A-Z0-9\\-]{10,}",[N.NotesAndHolds]:"^(NOTE|HOLD).*"},Et={[N.Instrument]:{vertical:15,horizontal:20,autoLinkDistance:30}},Je={autoGenerateLoops:!0,autoRemoveWhitespace:!0,hyphenSettings:{line:!1,instrument:!0,drawingNumber:!1,notesAndHolds:!1},loopRules:{TT:"T",TE:"T",TI:"T",TC:"T",TCV:"T",TSH:"T",TSL:"T",TIS:"T",TXT:"T",PT:"P",PE:"P",PI:"P",PC:"P",PCV:"P",PSH:"P",PSL:"P",PIT:"P",PDT:"P",PSV:"P",FT:"F",FE:"F",FI:"F",FC:"F",FCV:"F",FSH:"F",FSL:"F",FIT:"F",FIC:"F",FICA:"F",LT:"L",LE:"L",LI:"L",LC:"L",LCV:"L",LSH:"L",LSL:"L",LIT:"L",LIC:"L",AT:"A",AE:"A",AI:"A",AC:"A",AIC:"A",XV:"X",XCV:"X",HV:"H",HCV:"H",HS:"H",HC:"H",HIC:"H",ZT:"Z",ZI:"Z",ZS:"Z",VT:"V",VE:"V",VSH:"V"},instrumentMappings:{TE:{instrumentType:"TEMPERATURE ELEMENT",ioType:"AI"},TT:{instrumentType:"TEMPERATURE TRANSMITTER",ioType:"AI"},TC:{instrumentType:"TEMPERATURE CONTROLLER",ioType:"AO"},TI:{instrumentType:"TEMPERATURE INDICATOR",ioType:"Local"},TCV:{instrumentType:"TEMPERATURE CONTROL VALVE",ioType:"AO"},TSH:{instrumentType:"TEMPERATURE SWITCH HIGH",ioType:"DI"},TSL:{instrumentType:"TEMPERATURE SWITCH LOW",ioType:"DI"},TIS:{instrumentType:"TEMPERATURE INDICATOR WITH SWITCH",ioType:"DI"},TXT:{instrumentType:"TEMPERATURE SWITCH",ioType:"DI"},TIC:{instrumentType:"TEMPERATURE INDICATING CONTROLLER",ioType:"AO"},PE:{instrumentType:"PRESSURE ELEMENT",ioType:"AI"},PT:{instrumentType:"PRESSURE TRANSMITTER",ioType:"AI"},PI:{instrumentType:"PRESSURE INDICATOR",ioType:"Local"},PC:{instrumentType:"PRESSURE CONTROLLER",ioType:"AO"},PCV:{instrumentType:"PRESSURE CONTROL VALVE",ioType:"AO"},PSH:{instrumentType:"PRESSURE SWITCH HIGH",ioType:"DI"},PSL:{instrumentType:"PRESSURE SWITCH LOW",ioType:"DI"},PIT:{instrumentType:"PRESSURE INDICATING TRANSMITTER",ioType:"AI"},PIC:{instrumentType:"PRESSURE INDICATING CONTROLLER",ioType:"AO"},PY:{instrumentType:"PRESSURE CONVERTER/COMPUTER",ioType:"AI"},LE:{instrumentType:"LEVEL ELEMENT",ioType:"AI"},LT:{instrumentType:"LEVEL TRANSMITTER",ioType:"AI"},LI:{instrumentType:"LEVEL INDICATOR",ioType:"Local"},LC:{instrumentType:"LEVEL CONTROLLER",ioType:"AO"},LCV:{instrumentType:"LEVEL CONTROL VALVE",ioType:"AO"},LSH:{instrumentType:"LEVEL SWITCH HIGH",ioType:"DI"},LSL:{instrumentType:"LEVEL SWITCH LOW",ioType:"DI"},LIT:{instrumentType:"LEVEL INDICATING TRANSMITTER",ioType:"AI"},FE:{instrumentType:"FLOW ELEMENT",ioType:"AI"},FT:{instrumentType:"FLOW TRANSMITTER",ioType:"AI"},FI:{instrumentType:"FLOW INDICATOR",ioType:"Local"},FC:{instrumentType:"FLOW CONTROLLER",ioType:"AO"},FCV:{instrumentType:"FLOW CONTROL VALVE",ioType:"AO"},FSH:{instrumentType:"FLOW SWITCH HIGH",ioType:"DI"},FSL:{instrumentType:"FLOW SWITCH LOW",ioType:"DI"},FIT:{instrumentType:"FLOW INDICATING TRANSMITTER",ioType:"AI"},FDI:{instrumentType:"FLOW DIFFERENTIAL INDICATOR",ioType:"Local"},AE:{instrumentType:"ANALYSIS ELEMENT",ioType:"AI"},AT:{instrumentType:"ANALYSIS TRANSMITTER",ioType:"AI"},AI:{instrumentType:"ANALYSIS INDICATOR",ioType:"Local"},AC:{instrumentType:"ANALYSIS CONTROLLER",ioType:"AO"},HV:{instrumentType:"HAND VALVE",ioType:"Local"},HCV:{instrumentType:"HAND CONTROL VALVE",ioType:"Local"},PSV:{instrumentType:"PRESSURE SAFETY VALVE",ioType:"Local"},XV:{instrumentType:"ON/OFF VALVE",ioType:"DO"},XCV:{instrumentType:"ON/OFF CONTROL VALVE",ioType:"DO"},HS:{instrumentType:"HAND SWITCH",ioType:"DI"},HC:{instrumentType:"HAND CONTROLLER",ioType:"DO"},ZI:{instrumentType:"POSITION INDICATOR",ioType:"Local"},ZT:{instrumentType:"POSITION TRANSMITTER",ioType:"AI"},ZS:{instrumentType:"POSITION SWITCH",ioType:"DI"},VE:{instrumentType:"VIBRATION ELEMENT",ioType:"AI"},VT:{instrumentType:"VIBRATION TRANSMITTER",ioType:"AI"},VSH:{instrumentType:"VIBRATION SWITCH HIGH",ioType:"DI"},TG:{instrumentType:"TEMPERATURE GAUGE",ioType:"Local"},TV:{instrumentType:"TEMPERATURE VALVE",ioType:"AO"},TAG:{instrumentType:"TEMPERATURE ALARM GENERAL",ioType:"DO"},TXE:{instrumentType:"TEMPERATURE ELEMENT (STATUS)",ioType:"AI"},TXI:{instrumentType:"TEMPERATURE STATUS INDICATOR",ioType:"DI"},TXHH:{instrumentType:"TEMPERATURE ALARM VERY HIGH",ioType:"DO"},PG:{instrumentType:"PRESSURE GAUGE",ioType:"Local"},PDI:{instrumentType:"PRESSURE DIFFERENTIAL INDICATOR",ioType:"Local"},PDT:{instrumentType:"PRESSURE DIFFERENTIAL TRANSMITTER",ioType:"AI"},PDY:{instrumentType:"PRESSURE DIFFERENTIAL CONVERTER",ioType:"AI"},PV:{instrumentType:"PRESSURE VALVE",ioType:"AO"},PXI:{instrumentType:"PRESSURE STATUS INDICATOR",ioType:"DI"},PXT:{instrumentType:"PRESSURE STATUS TRANSMITTER",ioType:"AI"},PXLL:{instrumentType:"PRESSURE ALARM VERY LOW",ioType:"DO"},PDV:{instrumentType:"PRESSURE DIFFERENTIAL VALVE",ioType:"AO"},PDXI:{instrumentType:"PRESSURE DIFFERENTIAL STATUS INDICATOR",ioType:"DI"},PDXT:{instrumentType:"PRESSURE DIFFERENTIAL STATUS TRANSMITTER",ioType:"AI"},PDIC:{instrumentType:"PRESSURE DIFFERENTIAL INDICATING CONTROLLER",ioType:"AO"},FIC:{instrumentType:"FLOW INDICATING CONTROLLER",ioType:"AO"},FV:{instrumentType:"FLOW VALVE",ioType:"AO"},FY:{instrumentType:"FLOW CONVERTER/COMPUTER",ioType:"AI"},FXI:{instrumentType:"FLOW STATUS INDICATOR",ioType:"DI"},FXT:{instrumentType:"FLOW STATUS TRANSMITTER",ioType:"AI"},FXY:{instrumentType:"FLOW STATUS CONVERTER",ioType:"AI"},FXLL:{instrumentType:"FLOW ALARM VERY LOW",ioType:"DO"},LG:{instrumentType:"LEVEL GAUGE",ioType:"Local"},LIC:{instrumentType:"LEVEL INDICATING CONTROLLER",ioType:"AO"},LXI:{instrumentType:"LEVEL STATUS INDICATOR",ioType:"DI"},LXT:{instrumentType:"LEVEL STATUS TRANSMITTER",ioType:"AI"},LXHH:{instrumentType:"LEVEL ALARM VERY HIGH",ioType:"DO"},HIC:{instrumentType:"HAND INDICATING CONTROLLER",ioType:"AO"},HSW:{instrumentType:"HAND SWITCH",ioType:"DI"},ESD:{instrumentType:"EMERGENCY SHUTDOWN",ioType:"DI"},XPB:{instrumentType:"AUXILIARY PUSH BUTTON",ioType:"DI"}}},Wt={[N.Line]:{border:"border-rose-400",bg:"bg-rose-500/20",text:"text-rose-400"},[N.Instrument]:{border:"border-amber-400",bg:"bg-amber-500/20",text:"text-amber-400"},[N.DrawingNumber]:{border:"border-indigo-400",bg:"bg-indigo-500/20",text:"text-indigo-400"},[N.NotesAndHolds]:{border:"border-teal-400",bg:"bg-teal-500/20",text:"text-teal-400"},[N.Uncategorized]:{border:"border-slate-500",bg:"bg-slate-500/20",text:"text-slate-400"}},Xe={entities:{line:"#fb7185",instrument:"#fbbf24",drawingNumber:"#818cf8",notesAndHolds:"#14b8a6",uncategorized:"#94a3b8",description:"#a855f7"},relationships:{connection:"#38bdf8",installation:"#facc15",annotation:"#a78bfa",note:"#14b8a6"},highlights:{primary:"#ef4444",note:"#8b5cf6",description:"#a855f7",related:"#6366f1",noteRelated:"#6366f1",selected:"#ef4444"}},Vt=Qe.memo(({bbox:n,type:r,effect:w,isPinged:h=!1,isSelected:y=!1,isHighlighted:x=!1,isMultiSelection:j=!1,customColor:u,colorSettings:d})=>{const{x1:T,y1:f,x2:M,y2:k}=n,A=Math.min(T,M),z=Math.min(f,k),B=Math.abs(M-T),P=Math.abs(k-f),W={...Xe.highlights,...(d==null?void 0:d.highlights)||{}},re=u||W[r]||W.primary;if(!(h||y||x))return null;const U=()=>null,F=()=>{if(w!=="box"&&w!=="all")return null;const b=4,q=h?"ping-highlight-box":"";return e.jsx("rect",{x:A-b,y:z-b,width:B+b*2,height:P+b*2,fill:"none",stroke:re,strokeWidth:h?"3":"2",className:q,rx:"4"})},H=()=>w!=="outline"&&w!=="all"?null:e.jsx("rect",{x:A,y:z,width:B,height:P,fill:`${re}99`,stroke:re,strokeWidth:"2",rx:"2",className:x?"animate-pulse":""});return e.jsxs("g",{children:[F(),H(),U()]})}),Ln=(n,r,w)=>n?"arrows":w?"outline":"all",Sn=Qe.memo(({rel:n,start:r,end:w,strokeColor:h,marker:y,isPinged:x})=>{const j=x?"4":n.type===te.Note?"2.5":"2",u=x?"#ef4444":h,d=x?"none":n.type===te.Annotation||n.type===te.Note?"3 3":"none",T=n.type===te.Note;return e.jsxs("g",{children:[T&&!x&&e.jsx("line",{x1:r.x,y1:r.y,x2:w.x,y2:w.y,stroke:u,strokeWidth:"6",strokeOpacity:"0.15",strokeDasharray:"none",strokeLinecap:"round"}),e.jsx("line",{x1:r.x,y1:r.y,x2:w.x,y2:w.y,stroke:u,strokeWidth:j,strokeDasharray:d,markerEnd:y,className:x?"ping-highlight-line":T?"note-connection-line":"",strokeLinecap:T?"round":"butt"}),x&&e.jsx("line",{x1:r.x,y1:r.y,x2:w.x,y2:w.y,stroke:"#ef4444",strokeWidth:"8",strokeOpacity:"0.3",strokeDasharray:"none",className:"ping-highlight-line-glow"})]})}),An=({pdfDoc:n,tags:r,setTags:w,relationships:h,setRelationships:y,currentPage:x,setCurrentPage:j,selectedTagIds:u,setSelectedTagIds:d,selectedDescriptionIds:T,setSelectedDescriptionIds:f,rawTextItems:M,descriptions:k,onCreateTag:A,onCreateDescription:z,onCreateHoldDescription:B,selectedRawTextItemIds:P,setSelectedRawTextItemIds:W,onDeleteTags:se,onMergeRawTextItems:re,onManualCreateLoop:le,onManualAreaSelect:U,onUpdateTagText:F,onUpdateRawTextItemText:H,scale:b,setScale:q,mode:V,setMode:ie,relationshipStartTag:de,setRelationshipStartTag:ce,visibilitySettings:Y,updateVisibilitySettings:ae,pingedTagId:me,pingedDescriptionId:De,pingedRelationshipId:Le,colorSettings:ke,scrollToCenter:fe,setScrollToCenter:Ce,showAutoLinkRanges:$e,tolerances:Te,showAllRelationships:Me,setShowAllRelationships:it,showOnlySelectedRelationships:et,setShowOnlySelectedRelationships:Pe,onOPCTagClick:He,detectedLines:Re=[]})=>{const Fe=o.useRef(null),ge=o.useRef(null),g=o.useRef(null),L=o.useRef({x:0,y:0}),oe=o.useRef(!1),[_,ee]=o.useState(null),[Q,ye]=o.useState(0),[ve,Ve]=o.useState(!1),[he,at]=o.useState(null),[ut,tt]=o.useState(new Set),[Ze,Lt]=o.useState(new Set),[xt,pt]=o.useState(null),[lt,mt]=o.useState(null),[Be,nt]=o.useState(""),ht=o.useRef(null),st=o.useRef(null),[Ae,ct]=o.useState(null),[We,Nt]=o.useState(null),ot=o.useCallback(()=>{if(Ae){const{targetTagId:t,targetPage:s}=Ae;Nt({targetTagId:t,targetPage:s}),j(s),ct(null)}},[Ae,j,x]);o.useEffect(()=>{if(We&&x===We.targetPage&&_){const{targetTagId:t}=We;if(r.find(p=>p.id===t&&p.page===x)){const p=setTimeout(()=>{d([t]),Ye(new Set([t]));const i={tagId:t,timestamp:Date.now()};Ce(i),Nt(null),setTimeout(()=>{Ye(new Set)},2e3)},300);return()=>clearTimeout(p)}}},[x,We,_,r,d,Ce]);const[ze,Ye]=o.useState(new Set);o.useEffect(()=>{(xt||lt)&&ht.current&&(ht.current.focus(),ht.current.select())},[xt,lt]),o.useEffect(()=>{u.length>0?Ye(new Set(u)):Ye(new Set)},[u]),o.useEffect(()=>(st.current&&(clearTimeout(st.current),st.current=null),ze.size>0&&(st.current=setTimeout(()=>{Ye(new Set),st.current=null},3e3)),()=>{st.current&&(clearTimeout(st.current),st.current=null)}),[ze]);const xe=o.useCallback((t=!0)=>{t&&Be.trim()&&(xt?F(xt,Be.trim()):lt&&H(lt,Be.trim())),pt(null),mt(null),nt("")},[xt,lt,Be,F,H]);o.useCallback(t=>{t.key==="Enter"?(t.preventDefault(),xe(!0)):t.key==="Escape"&&(t.preventDefault(),xe(!1))},[xe]);const At=o.useMemo(()=>{const t=new Set(h.filter(s=>s.type===te.Note).map(s=>s.to));return new Set(h.filter(s=>s.type!==te.Annotation?!1:t.has(s.from)).map(s=>s.to))},[h]),Ne={entities:{...Xe.entities,...(ke==null?void 0:ke.entities)||{}},relationships:{...Xe.relationships,...(ke==null?void 0:ke.relationships)||{}},highlights:{...Xe.highlights,...(ke==null?void 0:ke.highlights)||{}}},ft=o.useCallback(t=>{switch(t){case N.Line:return Ne.entities.line;case N.Instrument:return Ne.entities.instrument;case N.DrawingNumber:return Ne.entities.drawingNumber;case N.NotesAndHolds:return Ne.entities.notesAndHolds;default:return Ne.entities.uncategorized}},[Ne]),Tt=o.useCallback(t=>{switch(t){case te.Connection:return Ne.relationships.connection;case te.Installation:return Ne.relationships.installation;case te.Annotation:return Ne.relationships.annotation;case te.Note:return Ne.relationships.note;default:return"#94a3b8"}},[Ne]),wt=o.useCallback(t=>{switch(t.category){case N.Line:return Y.tags.line;case N.Instrument:return Y.tags.instrument;case N.DrawingNumber:return Y.tags.drawingNumber;case N.NotesAndHolds:return Y.tags.notesAndHolds;default:return!0}},[Y.tags]),St=o.useCallback(t=>{switch(t.type){case te.Connection:return Y.relationships.connection;case te.Installation:return Y.relationships.installation;case te.Annotation:return Y.relationships.annotation;case te.Note:return Y.relationships.note;case te.Description:return!1;default:return!0}},[Y.relationships]),gt=o.useRef(!1),[dt,be]=o.useState(!1),Se=o.useRef({scrollX:0,scrollY:0,clientX:0,clientY:0}),Ee=o.useRef(null),rt=o.useRef(0),vt=o.useRef(Promise.resolve()),kt=o.useCallback(async t=>{if(!n)return;const s=++rt.current;return vt.current=vt.current.then(async()=>{if(rt.current===s){if(Ee.current){try{Ee.current.cancel()}catch{}Ee.current=null,await new Promise(p=>setTimeout(p,10))}try{const p=await n.getPage(t);if(rt.current!==s)return;const i=p.getViewport({scale:b}),v=Fe.current;if(!v)return;const C=v.getContext("2d");if(!C||(C.clearRect(0,0,v.width,v.height),v.height=i.height,v.width=i.width,C.clearRect(0,0,v.width,v.height),rt.current!==s))return;const $={canvasContext:C,viewport:i};Ee.current=p.render($),await Ee.current.promise,rt.current===s&&(ee(i),ye(i.rotation))}catch(p){p.name}finally{Ee.current&&(Ee.current=null)}}}),vt.current},[n,b]);o.useLayoutEffect(()=>(kt(x),()=>{if(rt.current++,Ee.current){try{Ee.current.cancel()}catch{}Ee.current=null}}),[x,kt,b]),o.useEffect(()=>{let t=new Set,s=new Set;if(u.length>0&&(s=new Set(h.filter(p=>p.type===te.Annotation&&u.includes(p.from)).map(p=>p.to)),u.length===1)){const p=r.find(i=>i.id===u[0]);p&&(p.category===N.Instrument||p.category===N.Line)&&(t=new Set(h.filter(i=>i.type===te.Installation&&i.to===p.id).map(i=>i.from)))}tt(t),Lt(s)},[u,h,r]),o.useEffect(()=>{if(fe&&_&&g.current){let t=fe.x,s=fe.y;if(fe.tagId&&(!fe.x||!fe.y)){const p=r.find(i=>i.id===fe.tagId);if(p){const{x1:i,y1:v,x2:C,y2:$}=p.bbox,J=(i+C)/2,I=(v+$)/2,ne=D(J,I);t=ne.x,s=ne.y}}else if(fe.descriptionId&&(!fe.x||!fe.y)){const p=k.find(i=>i.id===fe.descriptionId);if(p){const{x1:i,y1:v,x2:C,y2:$}=p.bbox,J=(i+C)/2,I=(v+$)/2,ne=D(J,I);t=ne.x,s=ne.y}}if(t!==void 0&&s!==void 0){const p=g.current,i=p.getBoundingClientRect(),v=t-i.width/2,C=s-i.height/2;p.scrollTo({left:Math.max(0,v),top:Math.max(0,C),behavior:"smooth"})}}},[fe,_,r,M]),o.useEffect(()=>{const t=s=>{const p=s.target;if(!(p.tagName==="INPUT"||p.tagName==="TEXTAREA"||p.tagName==="SELECT"))if(s.key==="1")P.length>0?(A(M.filter(i=>P.includes(i.id)),N.Line),W([])):(U(),setTimeout(()=>{const i=new CustomEvent("manualTagCreate",{detail:{category:N.Line}});window.dispatchEvent(i)},100)),s.preventDefault();else if(s.key==="2")P.length>0?(A(M.filter(i=>P.includes(i.id)),N.Line),W([])):(U(),setTimeout(()=>{const i=new CustomEvent("manualTagCreate",{detail:{category:N.Line}});window.dispatchEvent(i)},100)),s.preventDefault();else if(s.key==="3")P.length>0?(A(M.filter(i=>P.includes(i.id)),N.Instrument),W([])):(U(),setTimeout(()=>{const i=new CustomEvent("manualTagCreate",{detail:{category:N.Instrument}});window.dispatchEvent(i)},100)),s.preventDefault();else if(s.key==="4")P.length>0?(A(M.filter(i=>P.includes(i.id)),N.Instrument),W([])):(U(),setTimeout(()=>{const i=new CustomEvent("manualTagCreate",{detail:{category:N.Instrument}});window.dispatchEvent(i)},100)),s.preventDefault();else if(s.key==="5")P.length>0?(A(M.filter(i=>P.includes(i.id)),N.NotesAndHolds),W([])):(U(),setTimeout(()=>{const i=new CustomEvent("manualTagCreate",{detail:{category:N.NotesAndHolds}});window.dispatchEvent(i)},100)),s.preventDefault();else if(s.key==="6")P.length>0?W([]):(U(),setTimeout(()=>{window.dispatchEvent(event)},100)),s.preventDefault();else if(s.key==="Delete"||s.key==="Backspace")u.length>0&&(s.preventDefault(),se(u),d([]));else if(s.key==="F2"){if(u.length===1){const i=u[0],v=r.find(C=>C.id===i);v&&(pt(i),mt(null),nt(v.text))}else if(P.length===1){const i=P[0],v=M.find(C=>C.id===i);v&&(mt(i),pt(null),nt(v.text))}s.preventDefault()}else if(s.key.toLowerCase()==="c")if(u.length>=2){s.preventDefault();const i=u.map(C=>r.find($=>$.id===C)).filter(C=>!!C),v=[];for(let C=0;C<i.length-1;C++){const $=i[C],J=i[C+1];h.some(ne=>ne.from===$.id&&ne.to===J.id&&ne.type===te.Connection)||v.push({id:je(),from:$.id,to:J.id,type:te.Connection})}v.length>0&&y(C=>[...C,...v]),d([]),W([])}else V==="connect"?(ie("select"),ce(null)):(ie("connect"),u.length===1?(r.find(i=>i.id===u[0]),ce(u[0])):(ce(null),d([])),W([]));else if(s.key.toLowerCase()==="k")V==="manualCreate"?ie("select"):(ie("manualCreate"),ce(null),d([]),W([]));else if(s.key==="Escape")ie("select"),ce(null),d([]),W([]);else if(s.key.toLowerCase()==="m")P.length>=2?(re(P),W([])):alert("The 'M' hotkey merges multiple selected text items into one. Select at least 2 text items first.");else if(s.key.toLowerCase()==="n"){const i=r.filter($=>u.includes($.id)),v=M.filter($=>P.includes($.id)),C=[...i,...v];C.length>0?(z(C),d([]),W([])):alert("Select tags or text items first, then press 'N' to create a description.")}else if(s.key.toLowerCase()==="h"){const i=r.filter($=>u.includes($.id)),v=M.filter($=>P.includes($.id)),C=[...i,...v];C.length>0?(B(C),d([]),W([])):alert("Select tags or text items first, then press 'H' to create a hold description.")}else if(s.key.toLowerCase()==="r"&&V==="select"&&(u.length>0||P.length>0)){const i=[],v=r.filter(J=>u.includes(J.id)),C=[N.Instrument,N.Line],$=v.filter(J=>C.includes(J.category));if($.length>1){alert("Please select only one Equipment, Line, or Instrument tag at a time to create relationships.");return}if($.length===1){const J=$[0],I=v.filter(ne=>ne.category===N.NotesAndHolds);if(J.category===N.Instrument){const ne={x:(J.bbox.x1+J.bbox.x2)/2,y:(J.bbox.y1+J.bbox.y2)/2},pe=J.bbox.x2-J.bbox.x1,we=J.bbox.y2-J.bbox.y1,_e=Math.sqrt(pe*pe+we*we)/2*3,qe=(Ke,Ie,Ue)=>{const Oe=Math.max(Ue.x1,Math.min(Ke.x,Ue.x2)),Zt=Math.max(Ue.y1,Math.min(Ke.y,Ue.y2)),Rt=Ke.x-Oe,Pt=Ke.y-Zt;return Math.sqrt(Rt*Rt+Pt*Pt)<=Ie};for(const Ke of I)qe(ne,_e,Ke.bbox)&&i.push({id:je(),from:J.id,to:Ke.id,type:te.Note})}else for(const ne of I)i.push({id:je(),from:J.id,to:ne.id,type:te.Note});for(const ne of P)i.push({id:je(),from:J.id,to:ne,type:te.Annotation})}if(i.length>0){const J=new Set(h.map(ne=>`${ne.from}-${ne.to}-${ne.type}`)),I=i.filter(ne=>!J.has(`${ne.from}-${ne.to}-${ne.type}`));I.length>0&&y(ne=>[...ne,...I]),d([]),W([])}}else if(s.key.toLowerCase()==="i"&&V==="select"&&u.length>1){const i=r.filter($=>u.includes($.id)),v=i.filter($=>$.category===N.Instrument||$.category===N.Line),C=i.filter($=>$.category===N.Instrument);if(v.length===1&&C.length>=1){const $=v[0],J=C.map(pe=>({id:je(),from:pe.id,to:$.id,type:te.Installation})),I=new Set(h.map(pe=>`${pe.from}-${pe.to}-${pe.type}`)),ne=J.filter(pe=>!I.has(`${pe.from}-${pe.to}-${pe.type}`));ne.length>0&&y(pe=>[...pe,...ne]),d([])}}else if(s.key.toLowerCase()==="l"&&V==="select"&&u.length>=2)r.filter(v=>u.includes(v.id)&&v.category===N.Instrument).length>=2&&le&&(le(u),d([]));else if(s.key.toLowerCase()==="v"){const v=!Object.values(Y.relationships).every(Boolean);ae({relationships:{connection:v,installation:v,annotation:v,note:v}})}else s.key.toLowerCase()==="q"&&n?j(i=>Math.max(1,i-1)):s.key.toLowerCase()==="w"&&n&&j(i=>Math.min(n.numPages,i+1))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[V,u,r,h,y,d,M,P,A,z,B,W,se,re,le,ie,ce,b,n,j]),o.useEffect(()=>{const t=ge.current;if(!t)return;const s=p=>{if(p.ctrlKey||p.metaKey){p.preventDefault();const i=p.deltaY>0?-.25:.25;q(v=>Math.min(10,Math.max(.25,v+i)))}};return t.addEventListener("wheel",s,{passive:!1}),()=>{t.removeEventListener("wheel",s)}},[b]),o.useLayoutEffect(()=>{if(u.length===1&&g.current&&_){const t=u[0],s=r.find(p=>p.id===t);s&&s.page===x&&setTimeout(()=>{Ce({tagId:s.id,timestamp:Date.now()}),setTimeout(()=>Ce(null),100)},50)}},[u,x,_,r,b,Ce]),o.useLayoutEffect(()=>{if(T.length===1&&g.current&&_){const t=T[0],s=k.find(p=>p.id===t);s&&s.page===x&&setTimeout(()=>{Ce({descriptionId:s.id,timestamp:Date.now()}),setTimeout(()=>Ce(null),100)},50)}},[T,k,x,_,b,Ce]);const jt=(t,s)=>{t.stopPropagation(),oe.current=!0;const p=t.ctrlKey||t.metaKey,i=M.find(C=>C.id===s);i&&/[A-Z\d-]{5,}-[A-Z\d-]{5,}-\d{3,}/i.test(i.text);const v=h.find(C=>C.type===te.Annotation&&C.to===s);if(v&&!p){const C=v.from;if(r.find(J=>J.id===C)){const J=h.filter(I=>I.type===te.Annotation&&I.from===C).map(I=>I.to);W(J),d([C])}}else p?W(C=>C.includes(s)?C.filter($=>$!==s):[...C,s]):(W([s]),d([]))},ue=o.useMemo(()=>r.filter(t=>t.page===x),[r,x]),a=o.useMemo(()=>M.filter(t=>t.page===x),[M,x]),l=o.useMemo(()=>k.filter(t=>t.page===x),[k,x]),m=t=>{if(t.target.closest("[data-tag-id]")||t.target.closest("[data-raw-text-id]"))return;if(oe.current=!1,gt.current=!1,ct(null),V==="manualCreate"&&ge.current){const p=ge.current.getBoundingClientRect();L.current={x:t.clientX-p.left,y:t.clientY-p.top},Ve(!0),at({...L.current,width:0,height:0});return}const s=t.ctrlKey||t.metaKey;if(s&&V==="select"&&ge.current){const p=ge.current.getBoundingClientRect();L.current={x:t.clientX-p.left,y:t.clientY-p.top},Ve(!0),at({...L.current,width:0,height:0})}else!s&&V==="select"&&g.current&&(be(!0),Se.current={scrollX:g.current.scrollLeft,scrollY:g.current.scrollTop,clientX:t.clientX,clientY:t.clientY},t.preventDefault())},E=t=>{if((dt||ve)&&(gt.current=!0),dt&&g.current){const s=t.clientX-Se.current.clientX,p=t.clientY-Se.current.clientY;g.current.scrollLeft=Se.current.scrollX-s,g.current.scrollTop=Se.current.scrollY-p;return}if(ve&&ge.current){const s=ge.current.getBoundingClientRect(),p=t.clientX-s.left,i=t.clientY-s.top,v=Math.min(L.current.x,p),C=Math.min(L.current.y,i),$=Math.abs(L.current.x-p),J=Math.abs(L.current.y-i);at({x:v,y:C,width:$,height:J})}},S=t=>{if(oe.current){ve&&(Ve(!1),at(null));return}if(dt&&be(!1),!gt.current&&!ve&&(d([]),W([])),!ve||!he||!_){ve&&Ve(!1);return}if(V==="manualCreate"){if(Ve(!1),he.width>5&&he.height>5){const{x:i,y:v,width:C,height:$}=he,J={x1:i/b,y1:v/b,x2:(i+C)/b,y2:(v+$)/b};U(J,x)}at(null),ie("select");return}Ve(!1);const s=new Set;for(const i of ue){const{x1:v,y1:C,x2:$,y2:J}=i.bbox,I={x:v*b,y:C*b,width:($-v)*b,height:(J-C)*b};he.x<I.x+I.width&&he.x+he.width>I.x&&he.y<I.y+I.height&&he.y+he.height>I.y&&s.add(i.id)}s.size>0&&d(i=>Array.from(new Set([...i,...s])));const p=new Set;for(const i of a){const{x1:v,y1:C,x2:$,y2:J}=i.bbox,I={x:v*b,y:C*b,width:($-v)*b,height:(J-C)*b};he.x<I.x+I.width&&he.x+he.width>I.x&&he.y<I.y+I.height&&he.y+he.height>I.y&&p.add(i.id)}p.size>0&&W(i=>Array.from(new Set([...i,...p]))),at(null)},O=t=>{if(!_||!t||!t.bbox)return{x:0,y:0};const s=(t.bbox.x1+t.bbox.x2)/2,p=(t.bbox.y1+t.bbox.y2)/2;let i,v;switch(Q){case 90:i=p*b,v=s*b;break;case 180:i=s*b,v=p*b;break;case 270:i=s*b,v=p*b;break;default:i=s*b,v=p*b;break}return{x:i,y:v}},G=o.useMemo(()=>new Map(r.map(t=>[t.id,t])),[r]),Z=o.useMemo(()=>new Map(M.map(t=>[t.id,t])),[M]),K=o.useMemo(()=>{if(!Me)return[];const t=[];for(const s of h){if(s.type!==te.Connection&&s.type!==te.Installation||!St(s))continue;const p=G.get(s.from);if(!p||p.page!==x)continue;const i=G.get(s.to);if(!(!i||i.page!==x)){if(et&&u.length>0){const v=u.includes((p==null?void 0:p.id)||""),C=u.includes((i==null?void 0:i.id)||"");if(!v&&!C)continue}t.push({rel:s,fromTag:p,toItem:i,isAnnotation:!1})}}return t},[h,G,x,Y.relationships,Me,et,u]),c=t=>{var $,J,I,ne;if(!_)return{x:0,y:0};const s=Z.get(t);if(!s)return{x:0,y:0};const p=(((($=s.bbox)==null?void 0:$.x1)||0)+(((J=s.bbox)==null?void 0:J.x2)||0))/2,i=((((I=s.bbox)==null?void 0:I.y1)||0)+(((ne=s.bbox)==null?void 0:ne.y2)||0))/2;let v,C;switch(Q){case 90:v=i*b,C=p*b;break;case 180:v=(_.width/b-p)*b,C=(_.height/b-i)*b;break;case 270:v=p*b,C=i*b;break;default:v=p*b,C=i*b;break}return{x:v,y:C}},D=(t,s)=>{if(!_)return{x:0,y:0};let p,i;switch(Q){case 90:p=t*b,i=s*b;break;case 180:p=t*b,i=s*b;break;case 270:p=t*b,i=s*b;break;default:p=t*b,i=s*b;break}return{x:p,y:i}},R=(t,s,p,i)=>{if(!_)return{rectX:0,rectY:0,rectWidth:0,rectHeight:0};let v,C,$,J;switch(Q){case 90:v=t*b,C=s*b,$=(p-t)*b,J=(i-s)*b;break;case 180:v=t*b,C=s*b,$=(p-t)*b,J=(i-s)*b;break;case 270:v=t*b,C=s*b,$=(p-t)*b,J=(i-s)*b;break;default:v=t*b,C=s*b,$=(p-t)*b,J=(i-s)*b;break}return{rectX:v,rectY:C,rectWidth:$,rectHeight:J}},X=()=>{switch(V){case"connect":return"cursor-crosshair ring-2 ring-blue-500";case"manualCreate":return"cursor-crosshair ring-2 ring-green-500";default:return""}};return e.jsxs("div",{className:"relative h-full w-full",children:[e.jsx("div",{ref:g,className:`h-full w-full overflow-auto ${dt?"cursor-grabbing":"cursor-grab"}`,children:e.jsx("div",{className:"p-4 grid place-items-center min-h-full",children:e.jsxs("div",{ref:ge,className:`relative shadow-2xl ${X()}`,onMouseDown:m,onMouseMove:E,onMouseUp:S,onMouseLeave:S,children:[e.jsx("canvas",{ref:Fe}),_&&e.jsxs("svg",{className:"absolute top-0 left-0",width:_.width,height:_.height,style:{overflow:"visible"},children:[e.jsxs("defs",{children:[e.jsx("marker",{id:"arrowhead-connect",markerWidth:"10",markerHeight:"7",refX:"0",refY:"3.5",orient:"auto",children:e.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:Ne.relationships.connection})}),e.jsx("marker",{id:"arrowhead-install",markerWidth:"10",markerHeight:"7",refX:"0",refY:"3.5",orient:"auto",children:e.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:Ne.relationships.installation})})]}),Re.filter(t=>t.page===x).map((t,s)=>{const i=t.confidence?Math.max(1,t.confidence*3):2,v=t.type==="horizontal"?"#00ff00":"#0088ff";return e.jsx("line",{x1:t.start.x,y1:t.start.y,x2:t.end.x,y2:t.end.y,stroke:v,strokeWidth:i,strokeOpacity:.3,strokeLinecap:"round",pointerEvents:"none"},`detected-line-${s}`)}),a.map(t=>{const{x1:s,y1:p,x2:i,y2:v}=t.bbox,{rectX:C,rectY:$,rectWidth:J,rectHeight:I}=R(s,p,i,v),ne=P.includes(t.id),pe=Ze.has(t.id),we=At.has(t.id),_e=_?_.width/b:800,Ke=s>_e*.4&&!we&&!ne,Ie=ne&&P.length>1&&h.some(Oe=>Oe.type===te.Annotation&&P.includes(Oe.to)&&Oe.to===t.id),Ue=()=>Ke?{fill:"rgba(255, 255, 255, 0.003)",stroke:"transparent",strokeWidth:"0",strokeDasharray:"none"}:ne?Ie?{fill:"rgb(251 191 36 / 0.5)",stroke:"#fbbf24",strokeWidth:"2.5",strokeDasharray:"none"}:{fill:"rgb(56 189 248 / 0.5)",stroke:"#38bdf8",strokeWidth:"2.5",strokeDasharray:"none"}:pe?{fill:"rgb(139 69 255 / 0.6)",stroke:"#8b5cf6",strokeWidth:"2.5",strokeDasharray:"none"}:we?{fill:`${Ne.relationships.annotation}4D`,stroke:Ne.relationships.annotation,strokeWidth:"1.5",strokeDasharray:"none"}:{fill:"transparent",stroke:"#64748b",strokeWidth:"2",strokeDasharray:"3 3",className:"group-hover:stroke-sky-400 group-hover:fill-sky-400/30 transition-all"};return e.jsx("g",{"data-raw-text-id":t.id,onMouseDown:Oe=>jt(Oe,t.id),className:"cursor-pointer group",children:e.jsx("rect",{x:C,y:$,width:J,height:I,...Ue()})},t.id)}),K.map(({rel:t,fromTag:s,toItem:p,isAnnotation:i})=>{if(!s||!p)return null;const v=O(s);let C,$,J;i?(C=c(t.to),$=Tt(t.type),J=""):(C=O(p),$=Tt(t.type),t.type===te.Connection?J="url(#arrowhead-connect)":t.type===te.Installation?J="url(#arrowhead-install)":J="");const I=Le===t.id;return e.jsx(Sn,{rel:t,start:v,end:C,strokeColor:$,marker:J,isPinged:I},t.id)}),ue.map(t=>{const{x1:s,y1:p,x2:i,y2:v}=t.bbox;if(isNaN(s)||isNaN(p)||isNaN(i)||isNaN(v))return null;const{rectX:C,rectY:$,rectWidth:J,rectHeight:I}=R(s,p,i,v);if(isNaN(C)||isNaN($)||isNaN(J)||isNaN(I))return null;const ne=u.includes(t.id),pe=ze.has(t.id),we=t.id===de,_e=ut.has(t.id),qe=t.category===N.NotesAndHolds&&t.text.toUpperCase().includes("NOTE"),Ke=h.some(Oe=>Oe.type===te.Note&&Oe.to===t.id),Ie=h.some(Oe=>Oe.type===te.Note&&(Oe.from===t.id||Oe.to===t.id)),Ue=qe&&!Ke?!1:wt(t);return ft(t.category),e.jsxs("g",{"data-tag-id":t.id,onMouseDown:Oe=>{Oe.stopPropagation(),oe.current=!0,Oe.ctrlKey||Oe.metaKey?d(Rt=>Rt.includes(t.id)?Rt.filter(Pt=>Pt!==t.id):[...Rt,t.id]):(d([t.id]),W([]),f([]))},className:"cursor-pointer",children:[Ie&&Ue&&!qe&&e.jsxs(e.Fragment,{children:[e.jsx("rect",{x:C-4,y:$-4,width:J+8,height:I+8,stroke:Ne.relationships.note||"#14b8a6",strokeWidth:"2",fill:"none",opacity:"0.3",rx:"4",className:"animate-pulse"}),e.jsx("rect",{x:C-2,y:$-2,width:J+4,height:I+4,stroke:Ne.relationships.note||"#14b8a6",strokeWidth:"1",fill:`${Ne.relationships.note||"#14b8a6"}1A`,opacity:"0.5",rx:"2"})]}),e.jsx("rect",{x:C,y:$,width:J,height:I,stroke:Ue?ft(t.category):"transparent",strokeWidth:ne?"4":Ie?"3":"2",className:"transition-all duration-150",fill:Ue?ne?`${ft(t.category)}CC`:Ie&&!qe?`${ft(t.category)}59`:`${ft(t.category)}33`:"rgba(255, 255, 255, 0.003)",strokeDasharray:we?"4 2":"none",style:{pointerEvents:"all"}}),e.jsx(Vt,{bbox:{x1:C,y1:$,x2:C+J,y2:$+I},type:_e&&!pe?"related":"primary",effect:Ln(ne,!1,_e),isSelected:ne&&Ue,isHighlighted:pe&&Ue,isMultiSelection:u.length>1,colorSettings:Ne}),Ue&&!1]},t.id)}),u.map(t=>{const s=ue.find(qe=>qe.id===t);if(!s||s.category!==N.Instrument)return null;const{x1:p,y1:i,x2:v,y2:C}=s.bbox,{rectX:$,rectY:J,rectWidth:I,rectHeight:ne}=R(p,i,v,C),pe=$+I/2,we=J+ne/2,_e=Math.sqrt(I*I+ne*ne)/2*3;return e.jsx("circle",{cx:pe,cy:we,r:_e,fill:"none",stroke:"#fbbf24",strokeWidth:"1.5",strokeDasharray:"5 5",opacity:"0.6",pointerEvents:"none"},`circle-${t}`)}),me&&(()=>{const t=ue.find(ne=>ne.id===me);if(!t)return null;const{x1:s,y1:p,x2:i,y2:v}=t.bbox,{rectX:C,rectY:$,rectWidth:J,rectHeight:I}=R(s,p,i,v);return e.jsx(Vt,{bbox:{x1:C,y1:$,x2:C+J,y2:$+I},type:"primary",effect:"box",isPinged:!0,colorSettings:Ne})})(),Y.descriptions&&l.map(t=>{var pe,we,_e;const{x1:s,y1:p,x2:i,y2:v}=t.bbox,{rectX:C,rectY:$,rectWidth:J,rectHeight:I}=R(s,p,i,v),ne=T.includes(t.id);return e.jsx("g",{children:e.jsx("rect",{x:C,y:$,width:J,height:I,fill:ne?`${((pe=Ne.entities)==null?void 0:pe.description)||Xe.entities.description}4D`:`${((we=Ne.entities)==null?void 0:we.description)||Xe.entities.description}26`,stroke:((_e=Ne.entities)==null?void 0:_e.description)||Xe.entities.description,strokeWidth:"2",className:"cursor-pointer hover:opacity-80 transition-opacity",onClick:qe=>{qe.stopPropagation();const Ke=qe.ctrlKey||qe.metaKey;f(Ke?ne?Ie=>Ie.filter(Ue=>Ue!==t.id):Ie=>[...Ie,t.id]:[t.id])},rx:"3"})},t.id)}),De&&(()=>{const t=k.find(ne=>ne.id===De);if(!t||t.page!==x)return null;const{x1:s,y1:p,x2:i,y2:v}=t.bbox,{rectX:C,rectY:$,rectWidth:J,rectHeight:I}=R(s,p,i,v);return e.jsx(Vt,{bbox:{x1:C,y1:$,x2:C+J,y2:$+I},type:"description",effect:"box",isPinged:!0,colorSettings:Ne})})()]})]})})}),Ae&&e.jsx("div",{className:"fixed z-50 pointer-events-none",style:{left:Ae.x+10,top:Ae.y-10},children:e.jsxs("button",{onClick:ot,className:"pointer-events-auto bg-violet-600 hover:bg-violet-500 text-white px-3 py-2 rounded-lg shadow-lg flex items-center space-x-2 transition-all duration-200 animate-fade-in",children:[e.jsxs("span",{className:"text-sm font-medium",children:["Go to ",Ae.referenceText]}),e.jsxs("span",{className:"text-xs bg-white/20 px-1.5 py-0.5 rounded",children:["P",Ae.targetPage]}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 7l5 5m0 0l-5 5m5-5H6"})})]})})]})},Rn=Qe.memo(An,(n,r)=>n.currentPage===r.currentPage&&n.scale===r.scale&&n.mode===r.mode&&n.tags===r.tags&&n.relationships===r.relationships&&n.rawTextItems===r.rawTextItems&&n.descriptions===r.descriptions&&n.selectedTagIds===r.selectedTagIds&&n.selectedRawTextItemIds===r.selectedRawTextItemIds&&n.selectedDescriptionIds===r.selectedDescriptionIds&&n.visibilitySettings===r.visibilitySettings&&n.showAutoLinkRanges===r.showAutoLinkRanges),En=(n,r)=>{const w=(n.bbox.x1+n.bbox.x2)/2,h=(n.bbox.y1+n.bbox.y2)/2,y=(r.bbox.x1+r.bbox.x2)/2,x=(r.bbox.y1+r.bbox.y2)/2,j=y-w,u=x-h;return Math.sqrt(j*j+u*u)},In=(n,r)=>{if(!n||!r||r.length===0)return null;const w=r.filter(x=>x.page===n.page);if(w.length===0)return null;let h=null,y=1/0;return w.forEach(x=>{const j=En(n,x);j<y&&(y=j,h=x)}),h},Bt=(n,r={})=>{const w=n.match(/^([A-Z]+)[- ]?(\d+)/i);if(w){const h=w[1].toUpperCase();if(h==="FF")return"";let y;r[h]?y=r[h]:y=h[0];const x=w[2];return`${y}-${x}`}return""},Dn=(n,r={})=>{const w=n.match(/^([A-Z]+)[- ]?(\d+)/i);if(!w)return"";const h=w[1].toUpperCase();return h==="FF"?"":r[h]?r[h].instrumentType:""},Mn=(n,r={})=>{const w=n.match(/^([A-Z]+)[- ]?(\d+)/i);if(!w)return"";const h=w[1].toUpperCase();return h==="FF"?"":r[h]?r[h].ioType:""},On=(n,r,w,h=[],y=[],x=[],j=[],u=[],d=!1,T={},f={})=>{const M=n.filter(H=>H.category===N.Instrument),k=n.filter(H=>H.category===N.DrawingNumber),A=n.filter(H=>H.category===N.NotesAndHolds),z=n.filter(H=>H.category===N.Line),B=r.filter(H=>H.type===te.Annotation);A.filter(H=>H.text.includes("NOTE")),B.length>0&&B.slice(0,3).forEach(H=>{n.find(b=>b.id===H.from),w.find(b=>b.id===H.to)});const P=new Map(k.map(H=>[H.page,H.text])),W=new Map,se=new Map;d&&(r.filter(H=>H.type===te.Annotation).forEach(H=>{const b=A.find(V=>V.id===H.from),q=w.find(V=>V.id===H.to);if(b&&q){const V=se.get(b.id)||"",ie=V?V+" "+q.text:q.text;se.set(b.id,ie)}}),se.size>0&&se.forEach((H,b)=>{A.find(V=>V.id===b)&&H.length>60&&H.substring(0,60)+""})),r.filter(H=>H.type===te.Note).forEach(H=>{const b=n.find(V=>V.id===H.from),q=A.find(V=>V.id===H.to);if(b&&b.category===N.Instrument&&q){W.has(b.id)||W.set(b.id,[]);let V="";if(d){const ie=se.get(q.id);ie?V=ie:(V=q.text.replace(/^NOTE\s*\d+\s*:?\s*/i,"").trim(),V||(V=q.text))}else V=q.text.replace(/^NOTE\s*\d+\s*:?\s*/i,"").trim(),V||(V=q.text);V&&W.get(b.id).push(V)}});const re=new Map;M.forEach(H=>{const b=In(H,z);b&&re.set(H.id,b.text)});const le=M.sort((H,b)=>{if(H.page!==b.page)return H.page-b.page;const q=Bt(H.text,f),V=Bt(b.text,f);return q!==V?q.localeCompare(V):H.text.localeCompare(b.text)}).map((H,b)=>{const q=P.get(H.page)||"",V=Bt(H.text,f),ie=Dn(H.text,T),de=Mn(H.text,T),ce=re.get(H.id)||"",ae=(W.get(H.id)||[]).join("; ");return{"No.":b+1,"P&ID Number":q,"Loop Number":V,"Tag Number":H.text,"Line Number":ce,"Instrument Type":ie,"I/O Type":de,NOTE:ae}}),U=It.book_new(),F=It.json_to_sheet(le);if(It.book_append_sheet(U,F,"Instrument List"),u&&u.length>0){const H=u.map((q,V)=>({"No.":V+1,"Line ID":q.id||"","Start X":q.start?Math.round(q.start.x):"","Start Y":q.start?Math.round(q.start.y):"","End X":q.end?Math.round(q.end.x):"","End Y":q.end?Math.round(q.end.y):"",Type:q.type||"straight",Page:q.page||1,Source:q.source||"unknown",Length:q.start&&q.end?Math.round(Math.sqrt(Math.pow(q.end.x-q.start.x,2)+Math.pow(q.end.y-q.start.y,2))):""})),b=It.json_to_sheet(H);It.book_append_sheet(U,b,"Detected Lines")}fn(U,"P&ID_Instrument_List.xlsx")},bt=Qe.memo(({onClick:n})=>e.jsx("button",{onClick:r=>{r.stopPropagation(),n()},className:"ml-2 p-0.5 rounded-full text-gray-500 hover:bg-red-500/20 hover:text-red-400 transition-colors",title:"관계 삭제",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})),Xt=Qe.memo(({onClick:n})=>e.jsx("button",{onClick:r=>{r.stopPropagation(),n()},className:"p-1 rounded-full text-gray-500 hover:bg-red-500/20 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100",title:"태그 삭제",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})),zt=Qe.memo(({onClick:n,title:r="편집"})=>e.jsx("button",{onClick:w=>{w.stopPropagation(),n()},className:"p-1 rounded-full text-gray-500 hover:bg-sky-500/20 hover:text-sky-400 transition-colors opacity-0 group-hover:opacity-100",title:r,children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:[e.jsx("path",{d:"M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"}),e.jsx("path",{fillRule:"evenodd",d:"M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z",clipRule:"evenodd"})]})})),Ut=Qe.memo(({onClick:n,title:r="저장"})=>e.jsx("button",{onClick:w=>{w.stopPropagation(),n()},className:"p-1 rounded-full text-green-600 hover:text-green-700 transition-colors",title:r,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})),Gt=Qe.memo(({onClick:n,title:r="취소"})=>e.jsx("button",{onClick:w=>{w.stopPropagation(),n()},className:"p-1 rounded-full text-gray-600 hover:text-gray-700 transition-colors",title:r,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})),ln=zt,Pn=Qe.memo(({item:n,relId:r,onDeleteRelationship:w,onDeleteItem:h,onUpdateItemText:y})=>{const[x,j]=o.useState(!1),[u,d]=o.useState(n.text),T=o.useRef(null);o.useEffect(()=>{x&&T.current&&(T.current.focus(),T.current.select())},[x]),o.useEffect(()=>{d(n.text)},[n.text]);const f=()=>{const k=u.trim();k&&k!==n.text&&y(n.id,k),j(!1)},M=k=>{k.key==="Enter"?f():k.key==="Escape"&&(d(n.text),j(!1))};return e.jsxs("div",{className:"group flex items-center justify-between",onClick:k=>{x&&k.stopPropagation()},children:[e.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0",title:n.text,children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3 text-gray-500 flex-shrink-0",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z",clipRule:"evenodd"})}),x?e.jsx("input",{ref:T,type:"text",value:u,onChange:k=>d(k.target.value),onBlur:f,onKeyDown:M,onClick:k=>k.stopPropagation(),className:"font-mono text-sm text-gray-900 bg-gray-100 border border-sky-500 rounded px-1 w-full"}):e.jsx("span",{className:"text-gray-700 font-mono truncate max-w-[180px]",children:n.text})]}),e.jsxs("div",{className:"flex items-center flex-shrink-0",children:[e.jsx(ln,{onClick:()=>j(!0)}),e.jsx(Xt,{onClick:()=>h(n.id)}),e.jsx(bt,{onClick:()=>w(r)})]})]})}),Hn=Qe.memo(({tag:n,isSelected:r,onItemClick:w,onGoToTag:h,relationships:y,allTags:x,allRawTextItems:j,descriptions:u,loops:d,onToggleReviewStatus:T,onDeleteRelationship:f,onDeleteTag:M,onUpdateTagText:k,onDeleteItem:A,onUpdateItemText:z,onUpdateLoop:B,showDetails:P})=>{const[W,se]=o.useState(!1),[re,le]=o.useState(n.text),[U,F]=o.useState(new Set),[H,b]=o.useState(new Set),[q,V]=o.useState(new Set),ie=o.useRef(null),de=o.useRef(!1),ce=Wt[n.category],Y={[N.Line]:"L",[N.Instrument]:"I",[N.DrawingNumber]:"D",[N.NotesAndHolds]:"N",[N.Uncategorized]:"U"},ae=o.useMemo(()=>new Map(x.map(g=>[g.id,g])),[x]),me=o.useMemo(()=>new Map(j.map(g=>[g.id,g])),[j]);o.useEffect(()=>{W&&ie.current&&(ie.current.focus(),ie.current.select())},[W]),o.useEffect(()=>{le(n.text)},[n.text]);const De=()=>{const g=re.trim();g&&g!==n.text&&k(n.id,g),se(!1)},Le=g=>{g.key==="Enter"?De():g.key==="Escape"&&(le(n.text),se(!1))},ke=(g,L)=>{g.stopPropagation();const oe=ae.get(L)||x.find(_=>_.id===L);oe&&h(oe)},fe=(g,L)=>e.jsx("span",{onClick:oe=>ke(oe,g),className:"text-sky-600 hover:text-sky-700 hover:underline cursor-pointer font-mono",children:L}),Ce=o.useMemo(()=>{const g=x.filter(L=>L.page===n.page&&L.category===N.DrawingNumber);return g.length>0?g[0]:null},[x,n.page]),$e=y.filter(g=>g.from===n.id&&g.type===te.Connection),Te=y.filter(g=>g.to===n.id&&g.type===te.Connection),Me=y.find(g=>g.from===n.id&&g.type===te.Installation),it=y.filter(g=>g.to===n.id&&g.type===te.Installation),et=y.filter(g=>g.from===n.id&&g.type===te.Annotation),Pe=y.filter(g=>g.from===n.id&&g.type===te.Note),He=y.filter(g=>g.to===n.id&&g.type===te.Note),Re=y.filter(g=>g.from===n.id&&g.type===te.Description),Fe=y.filter(g=>g.to===n.id&&g.type===te.Description),ge=$e.length>0||Te.length>0||Me||it.length>0||et.length>0||Pe.length>0||He.length>0||Re.length>0||Fe.length>0;return e.jsxs("li",{"data-tag-id":n.id,onClick:g=>{W||w(g)},className:`group p-2 rounded-md cursor-pointer transition-colors ${r?"bg-red-500/20 ring-1 ring-red-500":"hover:bg-gray-100"}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-grow mr-2",children:[W?e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("input",{ref:ie,type:"text",value:re,onChange:g=>le(g.target.value),onKeyDown:Le,onClick:g=>g.stopPropagation(),className:"font-mono text-sm text-gray-900 bg-gray-100 border border-sky-500 rounded px-1 flex-grow"}),e.jsx(Ut,{onClick:De}),e.jsx(Gt,{onClick:()=>{le(n.text),se(!1)}})]}):e.jsx("div",{className:"flex items-center justify-between w-full",children:e.jsxs("div",{className:"flex items-center space-x-2 flex-grow min-w-0",children:[e.jsx("input",{type:"checkbox",checked:n.isReviewed||!1,onChange:g=>{g.stopPropagation(),T(n.id)},className:"w-4 h-4 text-sky-600 bg-white border-gray-400 rounded focus:ring-sky-500 focus:ring-2",title:"검토 완료 표시"}),e.jsx("span",{className:`inline-flex items-center justify-center w-5 h-5 rounded text-xs font-bold text-gray-900 ${ce.bg} ${ce.border} border flex-shrink-0`,title:n.category,children:Y[n.category]}),e.jsx("span",{className:"font-mono text-sm text-gray-900 truncate",children:n.text})]})}),n.category!==N.DrawingNumber&&Ce&&e.jsxs("div",{className:"text-xs text-gray-500 mt-0.5 font-mono",children:["DWG: ",Ce.text]}),n.category===N.Instrument&&P&&(()=>{const g=d.filter(L=>L.tagIds.includes(n.id));return g.length>0&&e.jsx("div",{className:"mt-1",children:g.map(L=>{const oe=q.has(L.id),_=L.tagIds.map(ee=>x.find(Q=>Q.id===ee)).filter(Boolean);return e.jsxs("div",{className:"mb-1",children:[e.jsxs("div",{className:"flex items-center justify-between cursor-pointer hover:bg-gray-100 rounded px-1 py-0.5 transition-colors",onClick:ee=>{ee.stopPropagation(),V(Q=>{const ye=new Set(Q);return ye.has(L.id)?ye.delete(L.id):ye.add(L.id),ye})},children:[e.jsxs("span",{className:"text-xs text-blue-400 font-mono",children:["루프: ",L.name||L.id]}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:`h-3 w-3 text-gray-600 transition-transform ${oe?"rotate-180":""}`,viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z",clipRule:"evenodd"})})]}),oe&&e.jsxs("div",{className:"mt-1 ml-2 p-2 border border-gray-300 rounded-md bg-gray-50",children:[e.jsx("div",{className:"flex items-center space-x-2 mb-2",children:e.jsxs("span",{className:"text-xs text-gray-600",children:["(",_.length," tags)",_.length>0&&` P. ${_.map(ee=>ee.page).filter((ee,Q,ye)=>ye.indexOf(ee)===Q).sort((ee,Q)=>ee-Q).join(", ")}`]})}),e.jsx("div",{className:"flex flex-wrap gap-1",children:_.map(ee=>e.jsxs("div",{className:`inline-flex items-center bg-gray-200 text-gray-700 rounded text-xs font-mono overflow-hidden ${ee.id===n.id?"ring-1 ring-blue-400":""}`,children:[e.jsxs("span",{onClick:Q=>{Q.stopPropagation(),h(ee)},className:"px-2 py-1 cursor-pointer hover:bg-slate-500/50 transition-colors",title:`태그로 이동: ${ee.text}`,children:[ee.text," ",e.jsxs("span",{className:"text-gray-600",children:["P.",ee.page]})]}),ee.id!==n.id&&e.jsx("button",{onClick:Q=>{Q.stopPropagation(),B(L.id,{...L,tagIds:L.tagIds.filter(ye=>ye!==ee.id)})},className:"px-1 py-1 text-red-400 hover:text-red-300 hover:bg-red-900/30 transition-colors",title:`루프에서 ${ee.text} 제거`,children:"✕"})]},ee.id))})]})]},L.id)})})})()]}),e.jsxs("div",{className:"flex items-center space-x-1 flex-shrink-0",children:[e.jsxs("span",{className:"text-xs text-gray-600",children:["페이지 ",n.page]}),e.jsx(ln,{onClick:()=>se(!0)}),e.jsx(Xt,{onClick:()=>M(n.id)})]})]}),P&&ge&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-gray-200/50 space-y-1 text-xs text-gray-700",children:[$e.map(g=>{const L=ae.get(g.to);return L?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{className:"text-gray-700 text-xs",children:"대상"}),fe(L.id,L.text)]}),e.jsx(bt,{onClick:()=>f(g.id)})]},g.id):null}),Te.map(g=>{const L=ae.get(g.from);return L?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{className:"text-gray-700 text-xs",children:"출처"}),fe(L.id,L.text)]}),e.jsx(bt,{onClick:()=>f(g.id)})]},g.id):null}),Me&&ae.get(Me.to)&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{title:"설치",children:"📌"}),e.jsx("span",{className:"text-gray-600",children:"설치 위치:"}),fe(Me.to,ae.get(Me.to).text)]}),e.jsx(bt,{onClick:()=>f(Me.id)})]}),it.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"설치된 계기:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:it.map(g=>{const L=ae.get(g.from);return L?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:fe(L.id,L.text)}),e.jsx(bt,{onClick:()=>f(g.id)})]},g.id):null})})]}),et.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"관련 텍스트:"}),e.jsx("div",{className:"pl-3 space-y-1 mt-1",children:et.map(g=>{const L=me.get(g.to);return L?e.jsx(Pn,{item:L,relId:g.id,onDeleteRelationship:f,onDeleteItem:A,onUpdateItemText:z},g.id):null})})]}),Pe.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"노트:"}),e.jsx("div",{className:"pl-3 space-y-1 mt-1",children:Pe.map(g=>{const L=ae.get(g.to);if(!L)return null;const oe=y.filter(ee=>ee.from===L.id&&ee.type===te.Description).map(ee=>u.find(Q=>Q.id===ee.to)).filter(Boolean),_=H.has(L.id);return e.jsxs("div",{className:"border border-gray-300 rounded-md bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between p-2",children:[e.jsxs("button",{onClick:ee=>{ee.stopPropagation(),de.current=!0;const Q=new Set(H);_?Q.delete(L.id):Q.add(L.id),b(Q),setTimeout(()=>{de.current=!1},50)},className:"flex items-center space-x-1.5 text-left flex-grow cursor-pointer",children:[e.jsx("span",{title:"노트",children:"📝"}),e.jsx("span",{className:"text-sky-400 hover:text-sky-300 font-mono",children:L.text}),oe.length>0&&e.jsxs("span",{className:"text-gray-600 text-xs",children:["(",oe.length,") ",_?"▼":"▶"]})]}),e.jsx(bt,{onClick:()=>f(g.id)})]}),_&&oe.length>0&&e.jsx("div",{className:"px-3 pb-2 border-t border-gray-300",children:e.jsx("div",{className:"space-y-1 mt-2",children:oe.map(ee=>{const Q=y.find(ve=>ve.from===L.id&&ve.to===ee.id&&ve.type===te.Description),ye=U.has(ee.id);return e.jsxs("div",{className:"border border-gray-300 rounded-md bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between p-2",children:[e.jsxs("button",{onClick:ve=>{ve.stopPropagation();const Ve=new Set(U);ye?Ve.delete(ee.id):Ve.add(ee.id),F(Ve)},className:"flex items-center space-x-1.5 text-purple-600 hover:text-purple-700 text-xs cursor-pointer",children:[e.jsx("span",{children:ye?"📖":"📄"}),e.jsxs("span",{children:[ee.metadata.type," ",ee.metadata.number]}),e.jsx("span",{className:"text-gray-600",children:ye?"▼":"▶"})]}),Q&&e.jsx(bt,{onClick:()=>f(Q.id)})]}),ye&&e.jsxs("div",{className:"px-3 pb-3 border-t border-gray-300",children:[e.jsx("div",{className:"text-xs text-gray-700 mt-2 leading-relaxed",children:ee.text}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["페이지 ",ee.page," • ",ee.metadata.scope]})]})]},ee.id)})})})]},g.id)})})]}),He.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"노트 대상:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:He.map(g=>{const L=ae.get(g.from);return L?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:fe(L.id,L.text)}),e.jsx(bt,{onClick:()=>f(g.id)})]},g.id):null})})]}),Re.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"설명:"}),e.jsx("div",{className:"pl-3 space-y-1 mt-1",children:Re.map(g=>{const L=u.find(_=>_.id===g.to),oe=U.has(L==null?void 0:L.id);return L?e.jsxs("div",{className:"border border-gray-300 rounded-md bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between p-2",children:[e.jsxs("button",{onClick:_=>{_.stopPropagation(),de.current=!0;const ee=new Set(U);oe?ee.delete(L.id):ee.add(L.id),F(ee),setTimeout(()=>{de.current=!1},50)},className:"flex items-center space-x-1.5 text-purple-600 hover:text-purple-700 text-xs cursor-pointer bg-transparent border-none",children:[e.jsx("span",{children:oe?"📖":"📄"}),e.jsxs("span",{children:[L.metadata.type," ",L.metadata.number]}),e.jsx("span",{className:"text-gray-600",children:oe?"▼":"▶"})]}),e.jsx(bt,{onClick:()=>f(g.id)})]}),oe&&e.jsxs("div",{className:"px-3 pb-3 border-t border-gray-300",children:[e.jsx("div",{className:"text-xs text-gray-700 mt-2 leading-relaxed",children:L.text}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["페이지 ",L.page," • ",L.metadata.scope]})]})]},g.id):null})})]}),Fe.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"설명 출처:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:Fe.map(g=>{const L=ae.get(g.from);return L?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:fe(L.id,L.text)}),e.jsx(bt,{onClick:()=>f(g.id)})]},g.id):null})})]})]})]})}),$n=({tags:n,setTags:r,rawTextItems:w,descriptions:h,loops:y,setLoops:x,relationships:j,setRelationships:u,detectedLines:d=[],appSettings:T={instrumentMappings:{}},currentPage:f,setCurrentPage:M,selectedTagIds:k,setSelectedTagIds:A,selectedDescriptionIds:z,setSelectedDescriptionIds:B,tagSelectionSource:P,onDeleteTags:W,onUpdateTagText:se,onDeleteDescriptions:re,onUpdateDescription:le,onDeleteRawTextItems:U,onUpdateRawTextItemText:F,onAutoLinkDescriptions:H,onAutoLinkNotesAndHolds:b,onAutoGenerateLoops:q,onManualCreateLoop:V,onDeleteLoops:ie,onUpdateLoop:de,showConfirmation:ce,onPingTag:Y,onPingDescription:ae,onPingRelationship:me,visibilitySettings:De,updateVisibilitySettings:Le,toggleTagVisibility:ke,toggleRelationshipVisibility:fe,toggleAllTags:Ce,toggleAllRelationships:$e})=>{const[Te,Me]=o.useState(!0),[it,et]=o.useState(!0),[Pe,He]=o.useState(""),[Re,Fe]=o.useState(""),[ge,g]=o.useState("tags"),[L,oe]=o.useState(null),[_,ee]=o.useState(""),[Q,ye]=o.useState("All"),[ve,Ve]=o.useState("All"),[he,at]=o.useState("default"),[ut,tt]=o.useState(()=>{const c=localStorage.getItem("sidebarWidth");return c?parseInt(c):320}),[Ze,Lt]=o.useState(!1);o.useEffect(()=>{he==="instrument-number-function"&&Q!==N.Instrument&&at("default")},[Q,he]);const[xt,pt]=o.useState(null),[lt,mt]=o.useState(""),[Be,nt]=o.useState({type:"Note",scope:"Installation",number:1}),[ht,st]=o.useState({viewOptions:!0}),[Ae,ct]=o.useState({start:0,end:100}),We=o.useRef(null),Nt=o.useRef(null),ot=o.useRef(-1),ze=o.useRef(!1);o.useCallback(c=>{st(D=>({...D,[c]:!D[c]}))},[]);const Ye=o.useCallback(c=>{u(D=>D.filter(R=>R.id!==c))},[u]),xe=o.useCallback(c=>{W([c])},[W]),At=o.useCallback(c=>{U([c])},[U]),Ne=o.useCallback(c=>{r(D=>D.map(R=>R.id===c?{...R,isReviewed:!R.isReviewed}:R))},[r]),ft=o.useCallback(c=>{const D=y.find(R=>R.id===c);D&&(oe(c),ee(D.name||D.id))},[y]),Tt=o.useCallback(()=>{L&&_.trim()&&(de(L,{id:_.trim(),name:_.trim()}),oe(null),ee(""))},[L,_,de]),wt=o.useCallback(()=>{oe(null),ee("")},[]),St=o.useCallback(c=>{Lt(!0),c.preventDefault()},[]),gt=o.useCallback(c=>{if(!Ze)return;const D=c.clientX;D>=280&&D<=600&&(tt(D),localStorage.setItem("sidebarWidth",D.toString()))},[Ze]),dt=o.useCallback(()=>{Lt(!1)},[]);o.useEffect(()=>(Ze&&(document.addEventListener("mousemove",gt),document.addEventListener("mouseup",dt),document.body.style.cursor="col-resize",document.body.style.userSelect="none"),()=>{document.removeEventListener("mousemove",gt),document.removeEventListener("mouseup",dt),document.body.style.cursor="",document.body.style.userSelect=""}),[Ze,gt,dt]);const be=o.useMemo(()=>{const D=n.filter(R=>!Te||R.page===f).filter(R=>Q==="All"||R.category===Q).filter(R=>ve==="All"?!0:ve==="Reviewed"?R.isReviewed===!0:ve==="NotReviewed"?R.isReviewed!==!0:!0).filter(R=>R.text.toLowerCase().includes(Pe.toLowerCase()));switch(he){case"length-asc":return[...D].sort((R,X)=>R.text.length-X.text.length);case"length-desc":return[...D].sort((R,X)=>X.text.length-R.text.length);case"pos-top-bottom":return[...D].sort((R,X)=>{if(R.page!==X.page)return R.page-X.page;const t=X.bbox.y2-R.bbox.y2;return Math.abs(t)<1?R.bbox.x1-X.bbox.x1:t});case"pos-left-right":return[...D].sort((R,X)=>{if(R.page!==X.page)return R.page-X.page;const t=R.bbox.x1-X.bbox.x1;return Math.abs(t)<1?X.bbox.y2-R.bbox.y2:t});case"instrument-number-function":return[...D].sort((R,X)=>{if(R.page!==X.page)return R.page-X.page;const t=i=>{const v=i.trim(),C=v.match(/^([A-Z]{2,4})-?(\d+)[\s]*([A-Z]*)$/);if(C)return{function:C[1].trim(),number:parseInt(C[2]),suffix:C[3].trim()};const $=v.match(/^([A-Z]{2,4})(\d+)([A-Z]*)$/);return $?{function:$[1].trim(),number:parseInt($[2]),suffix:$[3].trim()}:{function:i,number:99999,suffix:""}},s=t(R.text),p=t(X.text);return s.number!==p.number?s.number-p.number:s.function!==p.function?s.function.localeCompare(p.function):s.suffix.localeCompare(p.suffix)});case"default":default:return[...D].sort((R,X)=>R.page!==X.page?R.page-X.page:R.text.localeCompare(X.text))}},[n,Te,f,Q,ve,Pe,he]),Se=o.useMemo(()=>{if(be.length<=100)return be;if(k.length===1&&!ze.current){const R=be.findIndex(X=>X.id===k[0]);if(R!==-1){const t=Math.max(0,R-30),s=Math.min(be.length,R+60);(R<Ae.start||R>=Ae.end)&&setTimeout(()=>{ct({start:t,end:s})},10)}}const c=Math.max(0,Math.min(Ae.start,be.length)),D=Math.max(c,Math.min(Ae.end,be.length));return be.slice(c,D)},[be,Ae,k]),Ee=o.useMemo(()=>h.filter(c=>!Te||c.page===f),[h,Te,f]);o.useEffect(()=>{m.current&&(clearTimeout(m.current),m.current=null),S.current=!1,E.current=0,ct({start:0,end:100})},[Te,Q,Pe]),o.useEffect(()=>()=>{m.current&&clearTimeout(m.current)},[]);const rt=o.useMemo(()=>y.filter(c=>!Te||c.tagIds.some(D=>{const R=n.find(X=>X.id===D);return R&&R.page===f})),[y,Te,f,n]),vt=o.useMemo(()=>Te?j.filter(c=>{const D=n.find(C=>C.id===c.from),R=n.find(C=>C.id===c.to),X=h.find(C=>C.id===c.from),t=h.find(C=>C.id===c.to),s=w.find(C=>C.id===c.from),p=w.find(C=>C.id===c.to),i=(D==null?void 0:D.page)||(X==null?void 0:X.page)||(s==null?void 0:s.page),v=(R==null?void 0:R.page)||(t==null?void 0:t.page)||(p==null?void 0:p.page);return!Te||i===f||v===f}):j,[j,Te,f,n,h,w]);o.useEffect(()=>{if(P==="pdf"&&k.length===1&&ge==="tags"&&We.current){const c=k[0];ze.current=!0,setTimeout(()=>{const D=We.current.querySelector(`[data-tag-id='${c}']`);D&&(D.scrollIntoView({behavior:"auto",block:"center"}),setTimeout(()=>{ze.current=!1},100))},50)}},[k,P,ge,be]),o.useEffect(()=>{if(ge==="descriptions"&&z.length===1&&Nt.current){const c=z[0];ze.current=!0;const D=Nt.current.querySelector(`[data-description-id='${c}']`);D&&(D.scrollIntoView({behavior:"auto",block:"center"}),setTimeout(()=>{ze.current=!1},100))}},[z,ge,Ee]);const kt=o.useCallback((c,D,R)=>{const X=R.ctrlKey||R.metaKey;if(R.shiftKey&&ot.current!==-1){const s=Math.min(ot.current,D),p=Math.max(ot.current,D),i=be.slice(s,p+1).map(v=>v.id);A(X?v=>Array.from(new Set([...v,...i])):i)}else X?(A(s=>s.includes(c.id)?s.filter(p=>p!==c.id):[...s,c.id]),ot.current=D):(M(c.page),A([c.id]),ot.current=D,Y(c.id))},[be,k,A,M,Y]),jt=o.useCallback(c=>{ge!=="tags"&&g("tags");const D=!Te||c.page===f,R=Q==="All"||c.category===Q,X=c.text.toLowerCase().includes(Pe.toLowerCase());D||Me(!1),R||ye("All"),!X&&Pe&&He(""),M(c.page),A([c.id]),Y(c.id),setTimeout(()=>{if(We.current){ze.current=!0;const t=We.current.querySelector(`[data-tag-id='${c.id}']`);t&&(t.scrollIntoView({behavior:"auto",block:"center"}),setTimeout(()=>{ze.current=!1},100))}},50)},[M,A,ge,g,n,Te,f,Q,Pe,Me,ye,He,Y]),ue=o.useCallback(()=>{k.length>0&&(W(k),A([]),ot.current=-1)},[k,W,A]),a=o.useCallback(()=>{const c=T.instrumentMappings||{},D=T.loopRules||{};On(n,j,w,h,[],y,[],d,!0,c,D)},[n,j,w,h,y,d,T]),l=o.useCallback(c=>{B([c.id]),c.page!==f&&M(c.page),ae(c.id)},[f,M,B,ae]),m=o.useRef(null),E=o.useRef(0),S=o.useRef(!1),O=o.useCallback(c=>{k.length>1||be.length<=100||ze.current||(m.current&&clearTimeout(m.current),m.current=setTimeout(()=>{const{scrollTop:D,clientHeight:R}=c.target,X=90,t=30,s=Math.floor(D/X),p=Math.ceil(R/X),i=Math.max(0,s-t),v=Math.min(be.length,s+p+t);ct({start:i,end:v}),m.current=null},50))},[be.length,k.length]),G=o.useCallback(({relationships:c})=>{const[D,R]=o.useState(""),[X,t]=o.useState("All"),s=o.useMemo(()=>({tags:new Map(n.map(I=>[I.id,I])),descriptions:new Map(h.map(I=>[I.id,I])),rawTextItems:new Map(w.map(I=>[I.id,I]))}),[n,h,w]),p=o.useCallback(I=>s.tags.get(I)||s.descriptions.get(I)||s.rawTextItems.get(I),[s]),i=o.useCallback(I=>I&&I.text?I.text:"Unknown",[]),v=o.useMemo(()=>X==="All"?c:c.filter(I=>I.type===X),[c,X]),C=o.useMemo(()=>{if(!D)return v;const I=D.toLowerCase();return v.filter(ne=>{const pe=p(ne.from),we=p(ne.to),_e=i(pe).toLowerCase(),qe=i(we).toLowerCase();return _e.includes(I)||qe.includes(I)})},[D,v,p,i]),$=o.useMemo(()=>{const I={};return Object.values(te).forEach(ne=>{I[ne]=c.filter(pe=>pe.type===ne).length}),I.All=c.length,I},[c]),J=o.useCallback(I=>{const ne=p(I.from),pe=p(I.to);if(ne&&pe){const we=(ne==null?void 0:ne.page)||(pe==null?void 0:pe.page);we&&we!==f&&M(we),me(I.id),s.tags.has(I.from)&&Y(I.from),s.tags.has(I.to)&&Y(I.to),s.descriptions.has(I.from)&&ae(I.from),s.descriptions.has(I.to)&&ae(I.to)}},[p,f,M,s,Y,ae,me]);return e.jsxs("div",{className:"flex-grow flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-2 border-b border-gray-200 flex-shrink-0 space-y-2",children:[e.jsx("input",{type:"text",placeholder:"관계 검색...",value:D,onChange:I=>R(I.target.value),className:"w-full bg-white border border-gray-300 rounded-md px-2 py-1.5 text-sm text-gray-900 focus:ring-sky-500 focus:border-sky-500"}),e.jsx("div",{className:"flex flex-wrap gap-1 text-xs",children:["All",...Object.values(te)].map(I=>e.jsxs("button",{onClick:()=>t(I),className:`px-2 py-1 rounded font-medium ${X===I?"bg-sky-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:[I," (",$[I]||0,")"]},I))})]}),e.jsxs("ul",{className:"flex-grow overflow-y-auto p-2 space-y-2",children:[C.length===0&&e.jsx("li",{className:"text-center text-gray-600 py-4",children:"관계를 찾을 수 없습니다."}),C.map(I=>{const ne=p(I.from),pe=p(I.to);if(!ne||!pe)return null;const we=Ie=>{const Ue=i(Ie),Oe=()=>{s.tags.has(Ie.id)?jt(Ie):s.descriptions.has(Ie.id)&&(ae(Ie.id),M(Ie.page),M(Ie.page))};return e.jsx("span",{onClick:Oe,className:"font-mono text-sky-600 hover:underline cursor-pointer",children:Ue})},_e=Ie=>{switch(Ie){case te.Connection:return{icon:"⟶",title:"Connection"};case te.Installation:return{icon:"📌",title:"Installation"};case te.Annotation:return{icon:"📝",title:"Annotation"};case te.Note:return{icon:"🏷️",title:"Note"};case te.Description:return{icon:"📄",title:"Description"};default:return{icon:"🔗",title:"Unknown"}}},{icon:qe,title:Ke}=_e(I.type);return e.jsxs("li",{className:"p-2 bg-gray-100 rounded-md text-sm text-gray-700 flex items-center justify-between hover:bg-gray-200 cursor-pointer transition-colors",onClick:()=>J(I),title:`PDF에서 강조 표시: ${Ke}`,children:[e.jsxs("div",{className:"flex items-center space-x-2 flex-grow",children:[e.jsx("span",{className:"text-xs text-gray-500 font-medium",children:I.type}),e.jsx("span",{className:"text-gray-700 text-xs",children:"출처"}),we(ne),e.jsx("span",{className:"text-gray-700 text-xs",children:"대상"}),we(pe)]}),e.jsx(bt,{onClick:()=>{Ye(I.id)}})]},I.id)})]})]})},[n,h,w,f,M,Y,ae,me,jt,Ye]),Z=["All",N.Line,N.Instrument,N.NotesAndHolds,N.DrawingNumber],K=o.useMemo(()=>n.filter(c=>!Te||c.page===f).length,[n,Te,f]);return e.jsxs("aside",{className:"h-full bg-white border-r border-gray-200 flex flex-col flex-shrink-0 relative",style:{width:`${ut}px`},children:[e.jsxs("div",{className:"border-b border-gray-200 flex text-xs",children:[e.jsxs("button",{onClick:()=>g("tags"),className:`flex-1 py-2 px-1 font-semibold ${ge==="tags"?"bg-gray-100 text-sky-600":"text-gray-700"}`,children:["태그 (",K,")"]}),e.jsxs("button",{onClick:()=>g("descriptions"),className:`flex-1 py-2 px-1 font-semibold ${ge==="descriptions"?"bg-gray-100 text-sky-600":"text-gray-700"}`,children:["노트 (",Ee.length,")"]}),e.jsxs("button",{onClick:()=>g("loops"),className:`flex-1 py-2 px-1 font-semibold ${ge==="loops"?"bg-gray-100 text-sky-600":"text-gray-700"}`,children:["루프 (",rt.length,")"]}),e.jsxs("button",{onClick:()=>g("relationships"),className:`flex-1 py-2 px-1 font-semibold ${ge==="relationships"?"bg-gray-100 text-sky-600":"text-gray-700"}`,children:["관계 (",vt.length,")"]})]}),ge==="tags"&&e.jsxs("div",{className:"flex-grow flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-3 space-y-2 border-b border-gray-200 flex-shrink-0",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"태그 검색...",value:Pe,onChange:c=>He(c.target.value),className:"w-full bg-white border border-gray-300 rounded-md px-2 py-1.5 pr-8 text-sm text-gray-900 focus:ring-sky-500 focus:border-sky-500"}),Pe&&e.jsx("button",{onClick:()=>He(""),className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors p-0.5 rounded",title:"검색 지우기",children:e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("hr",{className:"border-gray-200"}),e.jsx("div",{className:"border-b border-gray-200 flex text-xs",children:Z.map((c,D)=>{const R=n.filter(p=>!Te||p.page===f),X=c==="All"?R.length:R.filter(p=>p.category===c).length,t=Q===c,s=c==="Equipment"?"장비":c==="Instrument"?"계기":c==="DrawingNumber"?"도면번호":c==="NotesAndHolds"?"노트":c==="SpecialItem"?"특수":c==="All"?"전체":c;return e.jsx("button",{onClick:()=>ye(c),className:`flex-1 py-1.5 px-1 font-semibold text-center border-r border-gray-300 last:border-r-0 ${t?"bg-gray-100 text-sky-600":"text-gray-700"}`,disabled:X===0&&c!=="All",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-xs leading-tight text-gray-700",children:s}),e.jsxs("span",{className:"text-xs text-gray-600 leading-tight",children:["(",X,")"]})]})},c)})})]}),k.length>1&&e.jsx("div",{className:"p-2 flex-shrink-0",children:e.jsxs("button",{onClick:ue,className:"w-full flex items-center justify-center space-x-2 bg-red-600 hover:bg-red-700 text-white font-semibold py-1.5 px-2 rounded-md transition-colors text-sm",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),e.jsxs("span",{children:["선택한 항목 삭제 (",k.length,")"]})]})}),e.jsxs("ul",{ref:We,className:"flex-grow overflow-y-auto p-2 divide-y divide-gray-200",onScroll:O,children:[be.length>100&&e.jsx("div",{style:{height:`${Ae.start*90}px`}}),Se.map((c,D)=>{const R=be.length>100?Ae.start+D:D;return e.jsx(Hn,{tag:c,isSelected:k.includes(c.id),onItemClick:X=>kt(c,R,X),onGoToTag:jt,relationships:j,allTags:n,allRawTextItems:w,descriptions:h,onToggleReviewStatus:Ne,onDeleteRelationship:Ye,onDeleteTag:xe,onUpdateTagText:se,onDeleteItem:At,onUpdateItemText:F,loops:y,onUpdateLoop:de,showDetails:it},c.id)}),be.length>100&&e.jsx("div",{style:{height:`${Math.max(0,(be.length-Ae.end)*90)}px`}})]})]}),ge==="descriptions"&&e.jsxs("div",{className:"flex-grow flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-3 border-b border-gray-200",children:e.jsx("div",{className:"text-xs text-gray-600 mb-2",children:"Press 'N' to create descriptions from selected items"})}),e.jsx("div",{ref:Nt,className:"flex-grow overflow-y-auto p-3 space-y-2",children:Ee.length===0?e.jsxs("div",{className:"text-center text-gray-500 mt-8",children:[e.jsx("div",{className:"text-lg mb-2",children:"📝"}),e.jsx("div",{className:"text-sm text-gray-600",children:Te&&h.length>0?`${f} 페이지에 설명이 없습니다`:"아직 설명이 없습니다"}),e.jsx("div",{className:"text-xs mt-1",children:"Select items and press 'N' to create"})]}):Ee.map(c=>{const D=z.includes(c.id),R=xt===c.id,X=j.filter(t=>t.to===c.id&&t.type===te.Description).map(t=>n.find(s=>s.id===t.from)).filter(Boolean);return e.jsxs("div",{"data-description-id":c.id,className:`group border rounded-lg p-3 hover:bg-gray-100 transition-colors ${D?"bg-purple-100 border-purple-400":"bg-gray-50 border-gray-300"}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("div",{className:"text-xs text-gray-600",children:[c.metadata.type," ",c.metadata.number," - ",c.metadata.scope]})}),X.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1",children:X.map(t=>e.jsxs("span",{onClick:s=>{s.stopPropagation(),Y(t.id)},className:"inline-flex items-center space-x-1 px-2 py-0.5 bg-sky-600/30 text-sky-300 rounded text-xs border border-sky-600/50 hover:bg-sky-500/40 hover:text-sky-200 cursor-pointer transition-colors",title:`Click to focus on note tag: ${t.text}`,children:[e.jsx("span",{children:"📝"}),e.jsx("span",{className:"font-mono text-gray-700",children:t.text})]},t.id))})]}),e.jsxs("div",{className:"flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx(zt,{onClick:()=>{R||(pt(c.id),mt(c.text),nt(c.metadata))},title:"Edit description"}),e.jsx(Xt,{onClick:()=>re([c.id])})]})]}),R?e.jsxs("div",{className:"space-y-2",children:[e.jsx("textarea",{value:lt,onChange:t=>mt(t.target.value),className:"w-full bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900 resize-none",rows:3,placeholder:"Enter description text...",autoFocus:!0}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-xs",children:[e.jsxs("select",{value:Be.type,onChange:t=>nt({...Be,type:t.target.value}),className:"bg-white border border-gray-300 rounded px-2 py-1 text-gray-900",children:[e.jsx("option",{value:"Note",children:"노트"}),e.jsx("option",{value:"Hold",children:"홀드"})]}),e.jsxs("select",{value:Be.scope,onChange:t=>nt({...Be,scope:t.target.value}),className:"bg-white border border-gray-300 rounded px-2 py-1 text-gray-900",children:[e.jsx("option",{value:"General",children:"일반"}),e.jsx("option",{value:"Specific",children:"특정"})]}),e.jsx("input",{type:"number",min:"1",value:Be.number,onChange:t=>nt({...Be,number:parseInt(t.target.value)||1}),className:"bg-white border border-gray-300 rounded px-2 py-1 text-gray-900"})]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Page ",c.page," • ",c.sourceItems.length," source items"]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(Gt,{onClick:()=>{pt(null),mt(""),nt({})}}),e.jsx(Ut,{onClick:()=>{le(c.id,lt,Be),pt(null),mt(""),nt({})}})]})]}):e.jsxs("div",{className:"cursor-pointer",onClick:()=>l(c),children:[e.jsx("div",{className:"text-xs text-gray-700 leading-relaxed mb-2",children:c.text}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Page ",c.page," • ",c.sourceItems.length," source items"]})]})]},c.id)})})]}),ge==="loops"&&e.jsxs("div",{className:"flex-grow flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-3 space-y-2 border-b border-gray-200",children:[e.jsx("input",{type:"text",placeholder:"루프 검색...",value:Re,onChange:c=>Fe(c.target.value),className:"w-full bg-slate-900 border border-gray-300 rounded-md px-2 py-1.5 text-sm focus:ring-sky-500 focus:border-sky-500"}),e.jsx("div",{className:"text-xs text-gray-600",children:"Press 'L' to create loops from selected instrument tags"})]}),e.jsx("div",{className:"flex-grow overflow-y-auto p-3 space-y-2",children:rt.length===0?e.jsxs("div",{className:"text-center text-gray-500 mt-8",children:[e.jsx("div",{className:"text-lg mb-2",children:"🔗"}),e.jsx("div",{className:"text-sm",children:"아직 생성된 루프가 없습니다"}),e.jsx("div",{className:"text-xs mt-1",children:"Select instrument tags and press 'L' to create"})]}):rt.filter(c=>Re?(c.name||c.id).toLowerCase().includes(Re.toLowerCase()):!0).sort((c,D)=>{const R=c.name||c.id,X=D.name||D.id;return R.localeCompare(X)}).map(c=>{const D=c.tagIds.map(t=>n.find(s=>s.id===t)).filter(Boolean),R=()=>D.length===0?null:D.reduce((t,s)=>s.bbox.y1<t.bbox.y1||s.bbox.y1===t.bbox.y1&&s.bbox.x1<t.bbox.x1?s:t),X=()=>{A(c.tagIds);const t=R();t&&Y(t.id)};return e.jsxs("div",{className:"group border border-gray-300 rounded-lg p-3 bg-slate-700/30 cursor-pointer hover:bg-slate-600/30 transition-colors",onClick:X,title:"Click to select all tags in this loop",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"flex items-center space-x-2 flex-grow",children:L===c.id?e.jsxs("div",{className:"flex items-center space-x-2 flex-grow",children:[e.jsx("input",{type:"text",value:_,onChange:t=>{t.stopPropagation(),ee(t.target.value)},onKeyDown:t=>{t.stopPropagation(),t.key==="Enter"?Tt():t.key==="Escape"&&wt()},className:"bg-slate-800 border border-gray-300 rounded px-2 py-1 text-sky-300 font-mono font-semibold text-sm flex-grow focus:ring-sky-500 focus:border-sky-500",autoFocus:!0,onClick:t=>t.stopPropagation()}),e.jsx(Ut,{onClick:Tt}),e.jsx(Gt,{onClick:wt})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-sky-600 font-mono font-semibold text-sm",children:c.name||c.id}),e.jsxs("span",{className:"text-xs text-gray-600",children:["(",D.length," tags)",D.length>0&&` P. ${D.map(t=>t.page).filter((t,s,p)=>p.indexOf(t)===s).sort((t,s)=>t-s).join(", ")}`]}),e.jsx(zt,{onClick:()=>ft(c.id),title:"Edit loop name"})]})}),L!==c.id&&e.jsx("button",{onClick:t=>{t.stopPropagation(),ie([c.id])},className:"text-red-400 hover:text-red-300 p-1",title:"Delete loop",children:"✕"})]}),e.jsx("div",{className:"flex flex-wrap gap-1",children:D.map(t=>e.jsxs("div",{className:"inline-flex items-center bg-gray-200 text-gray-700 rounded text-xs font-mono overflow-hidden",children:[e.jsxs("span",{onClick:s=>{s.stopPropagation(),Y(t.id)},className:"px-2 py-1 cursor-pointer hover:bg-slate-500/50 transition-colors",title:`Click to center on tag: ${t.text}`,children:[t.text," ",e.jsxs("span",{className:"text-gray-600",children:["P.",t.page]})]}),e.jsx("button",{onClick:s=>{s.stopPropagation(),de(c.id,{...c,tagIds:c.tagIds.filter(p=>p!==t.id)})},className:"px-1 py-1 text-red-400 hover:text-red-300 hover:bg-red-900/30 transition-colors",title:`Remove ${t.text} from loop`,children:"✕"})]},t.id))})]},c.id)})})]}),ge==="relationships"&&e.jsx(G,{relationships:vt}),e.jsx("div",{className:"p-4 border-t border-gray-200 flex-shrink-0",children:e.jsxs("button",{onClick:a,className:"w-full flex items-center justify-center space-x-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded transition-colors",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z",clipRule:"evenodd"})}),e.jsx("span",{children:"엑셀로 내보내기"})]})}),e.jsx("div",{className:`absolute top-0 right-0 w-1 h-full cursor-col-resize group hover:bg-sky-500/50 transition-colors ${Ze?"bg-sky-500":"bg-transparent"}`,onMouseDown:St,title:"Drag to resize sidebar",children:e.jsx("div",{className:"absolute top-1/2 right-0 transform -translate-y-1/2 translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsxs("div",{className:"flex flex-col items-center justify-center w-3 h-8 bg-slate-700 border border-gray-300 rounded-sm",children:[e.jsx("div",{className:"w-0.5 h-1 bg-slate-400 mb-0.5"}),e.jsx("div",{className:"w-0.5 h-1 bg-slate-400 mb-0.5"}),e.jsx("div",{className:"w-0.5 h-1 bg-slate-400"})]})})})]})},Fn=({selectedTagIds:n,setSelectedTagIds:r,allTags:w,relationships:h,onDeselect:y,onClear:x,rawTextItems:j,selectedRawTextItemIds:u,onDeselectRawTextItem:d,onCreateTag:T,manualCreationData:f,onManualTagCreate:M,onClearManualCreation:k})=>{const[A,z]=o.useState(""),[B,P]=o.useState(!1);o.useEffect(()=>{f&&z("")},[f]);const W=n.length>0,se=u.length>0;if(f){const re=le=>{A.trim()?M({text:A.trim(),category:le}):alert("태그에 텍스트를 입력해주세요.")};return e.jsx("div",{className:"absolute bottom-5 left-1/2 -translate-x-1/2 w-full max-w-3xl z-20 px-4 animate-fade-in-up",children:e.jsxs("div",{className:"bg-white/95 backdrop-blur-lg border border-gray-200 rounded-xl shadow-2xl p-3",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 px-1",children:[e.jsx("h3",{className:"font-bold text-md text-gray-900",children:"수동으로 태그 생성"}),e.jsx("button",{onClick:k,className:"text-sm font-semibold text-sky-400 hover:text-sky-300 transition-colors",children:"취소"})]}),e.jsx("div",{className:"mb-3",children:e.jsx("input",{type:"text",placeholder:"태그 텍스트 입력...",value:A,onChange:le=>z(le.target.value),className:"w-full bg-white border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-sky-500 focus:border-sky-500",autoFocus:!0})}),e.jsxs("div",{className:"flex items-center justify-between border-t border-slate-700 pt-2",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700",children:"카테고리 선택:"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("button",{onClick:()=>re(N.Uncategorized),className:"px-3 py-1.5 text-sm font-semibold text-gray-900 bg-orange-600 rounded-md hover:bg-orange-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"1"}),e.jsx("span",{children:"장비"})]}),e.jsxs("button",{onClick:()=>re(N.Line),className:"px-3 py-1.5 text-sm font-semibold text-gray-900 bg-rose-600 rounded-md hover:bg-rose-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"2"}),e.jsx("span",{children:"라인"})]}),e.jsxs("button",{onClick:()=>re(N.Uncategorized),className:"px-3 py-1.5 text-sm font-semibold text-gray-900 bg-purple-600 rounded-md hover:bg-purple-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"3"}),e.jsx("span",{children:"특수 항목"})]}),e.jsxs("button",{onClick:()=>re(N.Instrument),className:"px-3 py-1.5 text-sm font-semibold text-gray-900 bg-amber-500 rounded-md hover:bg-amber-600 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"4"}),e.jsx("span",{children:"계기"})]}),e.jsxs("button",{onClick:()=>re(N.NotesAndHolds),className:"px-3 py-1.5 text-sm font-semibold text-gray-900 bg-teal-600 rounded-md hover:bg-teal-700 transition-colors flex items-center space-x-1",children:[e.jsx("span",{className:"bg-white/20 px-1.5 py-0.5 rounded text-xs font-mono",children:"5"}),e.jsx("span",{children:"노트/홀드"})]}),e.jsx("button",{onClick:()=>re(N.DrawingNumber),className:"px-3 py-1.5 text-sm font-semibold text-gray-900 bg-indigo-600 rounded-md hover:bg-indigo-700 transition-colors",children:"도면 번호"})]})]})]})})}return!W&&!se?null:e.jsx("div",{className:"absolute bottom-5 left-1/2 -translate-x-1/2 w-full max-w-4xl z-20 px-4 animate-fade-in-up",children:e.jsx("div",{className:"bg-white/95 backdrop-blur-lg border border-gray-200 rounded-xl shadow-2xl p-3",children:e.jsxs("div",{className:"flex flex-col space-y-3 max-h-72 overflow-y-auto pr-1",children:[se&&(()=>{let re=u.map(F=>j.find(H=>H.id===F)).filter(Boolean);B&&(re=[...re].sort((F,H)=>F.text.localeCompare(H.text)));const le=h.find(F=>F.type===te.Annotation&&u.includes(F.to));let U=null;return le&&(U=w.find(F=>F.id===le.from)),e.jsxs("div",{className:W?"pb-3 mb-3 border-b border-slate-700":"",children:[U&&e.jsx("div",{className:"mb-2 px-1 py-1 bg-amber-500/10 rounded-md border border-amber-500/30",children:e.jsxs("p",{className:"text-xs text-amber-400",children:["📎 ",U.text," 설명 (",re.length,"줄)"]})}),e.jsxs("div",{className:"flex justify-between items-center mb-2 px-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("h3",{className:"font-bold text-md text-gray-900",children:[re.length,"개의 텍스트 선택됨"]}),e.jsx("button",{onClick:()=>P(!B),className:`p-1.5 rounded-md transition-colors ${B?"bg-sky-600 text-gray-900 hover:bg-sky-500":"bg-gray-200 text-gray-600 hover:bg-gray-300 hover:text-gray-900"}`,title:`정렬: ${B?"가나다순":"선택 순서"}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"})})})]}),e.jsx("button",{onClick:x,className:"text-sm font-semibold text-sky-400 hover:text-sky-300 transition-colors",children:"선택 취소"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 max-h-20 overflow-y-auto pr-2 mb-3",children:re.map(F=>e.jsxs("div",{className:"flex items-center bg-gray-200 rounded-full py-1 pl-3 pr-2 text-sm text-gray-900",children:[e.jsx("span",{className:"font-mono text-gray-900 mr-2",children:F.text}),e.jsx("button",{onClick:()=>d(F.id),className:"w-5 h-5 flex items-center justify-center rounded-full bg-gray-300 hover:bg-red-500 transition-colors","aria-label":`Deselect ${F.text}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]},F.id))})]})})(),W&&(()=>{let re=n.map(b=>w.find(q=>q.id===b)).filter(b=>!!b);if(B){const b={[N.Line]:0,[N.Instrument]:1,[N.DrawingNumber]:2,[N.NotesAndHolds]:3,[N.Uncategorized]:4};re=[...re].sort((q,V)=>{const ie=b[q.category]??99,de=b[V.category]??99;return ie!==de?ie-de:q.text.localeCompare(V.text)})}const le=n.length===1?w.find(b=>b.id===n[0]):null;let U=[];le&&le.category===N.Line&&(U=h.filter(b=>b.type===te.Installation&&b.to===le.id).map(b=>w.find(q=>q.id===b.from)).filter(Boolean));const F=b=>{n.includes(b)||r(q=>[...q,b])},H=()=>{const b=U.map(q=>q.id);r(q=>[...new Set([...q,...b])])};return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 px-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("h3",{className:"font-bold text-md text-gray-900",children:[re.length,"개의 태그 선택됨"]}),e.jsx("button",{onClick:()=>P(!B),className:`p-1.5 rounded-md transition-colors ${B?"bg-sky-600 text-gray-900 hover:bg-sky-500":"bg-gray-200 text-gray-600 hover:bg-gray-300 hover:text-gray-900"}`,title:`정렬: ${B?"가나다순":"선택 순서"}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"})})})]}),e.jsx("button",{onClick:x,className:"text-sm font-semibold text-sky-400 hover:text-sky-300 transition-colors",children:"Clear Selection"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 max-h-28 overflow-y-auto pr-2",children:re.map(b=>e.jsxs("div",{className:"flex items-center bg-gray-200 rounded-full py-1 pl-3 pr-2 text-sm text-gray-900",children:[e.jsx("span",{className:"font-mono text-gray-900 mr-2",children:b.text}),e.jsx("button",{onClick:()=>y(b.id),className:"w-5 h-5 flex items-center justify-center rounded-full bg-gray-300 hover:bg-red-500 transition-colors","aria-label":`Deselect ${b.text}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]},b.id))}),U.length>0&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-slate-700",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 px-1",children:[e.jsxs("h4",{className:"font-semibold text-sm text-gray-900",children:["설치된 계기 (",U.length,")"]}),e.jsx("button",{onClick:H,className:"text-sm font-semibold text-sky-400 hover:text-sky-300 transition-colors",children:"모두 선택"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 max-h-28 overflow-y-auto pr-2",children:U.map(b=>{const q=n.includes(b.id);return e.jsxs("div",{className:`flex items-center rounded-full py-1 pl-3 pr-2 text-sm text-gray-900 transition-colors ${q?"bg-gray-300":"bg-gray-200"}`,children:[e.jsx("span",{className:`font-mono mr-2 ${q?"text-gray-500":"text-gray-900"}`,children:b.text}),!q&&e.jsx("button",{onClick:()=>F(b.id),className:"w-5 h-5 flex items-center justify-center rounded-full bg-gray-300 hover:bg-sky-500 transition-colors","aria-label":`Select ${b.text}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z",clipRule:"evenodd"})})})]},b.id)})})]})]})})()]})})})},Ct=Qe.memo(({onClick:n})=>e.jsx("button",{onClick:r=>{r.stopPropagation(),n()},className:"p-0.5 rounded-full text-slate-500 hover:bg-red-500/20 hover:text-red-400 transition-colors",title:"Delete relationship",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})),Jt=Qe.memo(({onClick:n,title:r="Edit"})=>e.jsx("button",{onClick:w=>{w.stopPropagation(),n()},className:"p-1 rounded-full text-slate-500 hover:bg-sky-500/20 hover:text-sky-400 transition-colors opacity-0 group-hover:opacity-100",title:r,children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:[e.jsx("path",{d:"M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"}),e.jsx("path",{d:"M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"})]})})),Qt=Qe.memo(({onClick:n})=>e.jsx("button",{onClick:r=>{r.stopPropagation(),n()},className:"p-1 rounded-full text-slate-500 hover:bg-red-500/20 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100",title:"Delete",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})),Vn=({pdfDoc:n,tags:r,setTags:w,relationships:h,setRelationships:y,rawTextItems:x,descriptions:j,setDescriptions:u,detectedLines:d,loops:T,setLoops:f,appSettings:M,onCreateTag:k,onCreateManualTag:A,onCreateDescription:z,onCreateHoldDescription:B,onDeleteTags:P,onUpdateTagText:W,onDeleteDescriptions:se,onUpdateDescription:re,onMergeRawTextItems:le,onDeleteRawTextItems:U,onUpdateRawTextItemText:F,onAutoLinkDescriptions:H,onAutoLinkNotesAndHolds:b,onAutoGenerateLoops:q,onManualCreateLoop:V,onDeleteLoops:ie,onUpdateLoop:de,showConfirmation:ce,currentPage:Y,setCurrentPage:ae,scale:me,setScale:De,mode:Le,setMode:ke,relationshipStartTag:fe,setRelationshipStartTag:Ce,visibilitySettings:$e,updateVisibilitySettings:Te,toggleTagVisibility:Me,toggleRelationshipVisibility:it,toggleAllTags:et,toggleAllRelationships:Pe,isSidePanelVisible:He,showAutoLinkRanges:Re,tolerances:Fe,colorSettings:ge,showAllRelationships:g,setShowAllRelationships:L,showOnlySelectedRelationships:oe,setShowOnlySelectedRelationships:_})=>{var kt,jt;const[ee,Q]=o.useState([]),[ye,ve]=o.useState([]),[Ve,he]=o.useState([]),[at,ut]=o.useState(null),[tt,Ze]=o.useState(null),[Lt,xt]=o.useState(null),[pt,lt]=o.useState(null),[mt,Be]=o.useState(null),[nt,ht]=o.useState(null),[st,Ae]=o.useState(!1),[ct,We]=o.useState(""),[Nt,ot]=o.useState(new Set),[ze,Ye]=o.useState(!1),xe=ze?r.find(ue=>ue.id===ee[0]):null;Qe.useEffect(()=>{if(!He&&ee.length===1){const a=setTimeout(()=>{Ye(!0)},50);return()=>clearTimeout(a)}else Ye(!1)},[He,ee.length]);const At=ue=>{Q(a=>a.filter(l=>l!==ue)),ee.length<=1&&ut(null)},Ne=ue=>{ve(a=>a.filter(l=>l!==ue))},ft=()=>{Q([]),ve([]),he([]),ut(null)},Tt=(ue,a)=>{Ze({bbox:ue,page:a})},wt=({text:ue,category:a})=>{tt&&(A({...tt,text:ue,category:a}),Ze(null))},St=()=>{Ze(null)},gt=ue=>{Ae(!0),We(ue.text)},dt=()=>{ct.trim()&&ct!==xe.text&&xe&&W(xe.id,ct.trim()),Ae(!1),We("")},be=()=>{Ae(!1),We("")},Se=ue=>{y(a=>a.filter(l=>l.id!==ue))},Ee=o.useCallback(ue=>{const a=r.find(l=>l.id===ue);a&&a.page!==Y&&ae(a.page),xt(ue),setTimeout(()=>xt(null),2e3),ht({tagId:ue,timestamp:Date.now()}),setTimeout(()=>ht(null),100)},[r,Y,ae]),rt=o.useCallback(ue=>{const a=j.find(l=>l.id===ue);a&&a.page!==Y&&ae(a.page),lt(ue),setTimeout(()=>lt(null),2e3),a&&(ht({descriptionId:ue,timestamp:Date.now()}),setTimeout(()=>ht(null),100))},[j,Y,ae]),vt=o.useCallback(ue=>{const a=h.find(l=>l.id===ue);if(a){const l=r.find(S=>S.id===a.from)||x.find(S=>S.id===a.from),m=r.find(S=>S.id===a.to)||x.find(S=>S.id===a.to),E=(l==null?void 0:l.page)||(m==null?void 0:m.page);E&&E!==Y&&ae(E)}Be(ue),setTimeout(()=>Be(null),2e3)},[h,Y,ae]);return e.jsxs("div",{className:"flex h-full bg-gray-50 relative",children:[He&&e.jsx($n,{tags:r,setTags:w,rawTextItems:x,descriptions:j,loops:T,setLoops:f,detectedLines:d,appSettings:M,currentPage:Y,setCurrentPage:ae,selectedTagIds:ee,setSelectedTagIds:ue=>{Q(ue),ut("panel")},tagSelectionSource:at,selectedDescriptionIds:Ve,setSelectedDescriptionIds:he,relationships:h,setRelationships:y,onDeleteTags:P,onUpdateTagText:W,onDeleteDescriptions:se,onUpdateDescription:re,onDeleteRawTextItems:U,onUpdateRawTextItemText:F,onAutoLinkDescriptions:H,onAutoLinkNotesAndHolds:b,onAutoGenerateLoops:q,onManualCreateLoop:V,onDeleteLoops:ie,onUpdateLoop:de,showConfirmation:ce,onPingTag:Ee,onPingDescription:rt,onPingRelationship:vt,visibilitySettings:$e,updateVisibilitySettings:Te,toggleTagVisibility:Me,toggleRelationshipVisibility:it,toggleAllTags:et,toggleAllRelationships:Pe}),e.jsx("div",{className:"flex-grow h-full overflow-auto bg-gray-100",children:e.jsx(Rn,{pdfDoc:n,tags:r,setTags:w,relationships:h,setRelationships:y,currentPage:Y,setCurrentPage:ae,selectedTagIds:ee,setSelectedTagIds:ue=>{Q(ue),ut("pdf")},selectedDescriptionIds:Ve,setSelectedDescriptionIds:he,rawTextItems:x,descriptions:j,onCreateTag:k,onCreateDescription:z,onCreateHoldDescription:B,selectedRawTextItemIds:ye,setSelectedRawTextItemIds:ve,onDeleteTags:P,onMergeRawTextItems:le,onManualCreateLoop:V,onManualAreaSelect:Tt,onOPCTagClick:()=>{},onUpdateTagText:W,onUpdateRawTextItemText:F,scale:me,setScale:De,mode:Le,setMode:ke,relationshipStartTag:fe,setRelationshipStartTag:Ce,visibilitySettings:$e,updateVisibilitySettings:Te,pingedTagId:Lt,pingedDescriptionId:pt,pingedRelationshipId:mt,colorSettings:ge,scrollToCenter:nt,setScrollToCenter:ht,showAutoLinkRanges:Re,tolerances:Fe,showAllRelationships:g,setShowAllRelationships:L,showOnlySelectedRelationships:oe,setShowOnlySelectedRelationships:_,detectedLines:d})}),e.jsx(Fn,{selectedTagIds:ee,setSelectedTagIds:Q,allTags:r,relationships:h,onDeselect:At,onClear:ft,rawTextItems:x,selectedRawTextItemIds:ye,onDeselectRawTextItem:Ne,onCreateTag:k,manualCreationData:tt,onManualTagCreate:wt,onClearManualCreation:St}),ze&&xe&&e.jsx("div",{className:"fixed left-4 top-20 w-80 bg-white border border-gray-200 rounded-lg shadow-xl z-40 max-h-96 overflow-y-auto transition-opacity duration-150",style:{transform:"translateZ(0)"},children:e.jsxs("div",{className:"group p-2 rounded-md hover:bg-gray-100",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-grow mr-2",children:[e.jsxs("div",{className:"flex items-center space-x-2 flex-grow min-w-0",children:[e.jsx("input",{type:"checkbox",checked:xe.isReviewed||!1,onChange:ue=>{ue.stopPropagation(),w(a=>a.map(l=>l.id===xe.id?{...l,isReviewed:!l.isReviewed}:l))},className:"w-4 h-4 text-sky-600 bg-white border-gray-400 rounded focus:ring-sky-500 focus:ring-2",title:"Mark as reviewed"}),e.jsx("span",{className:`inline-flex items-center justify-center w-5 h-5 rounded text-xs font-bold text-gray-900 ${((kt=Wt[xe.category])==null?void 0:kt.bg)||"bg-gray-200"} ${((jt=Wt[xe.category])==null?void 0:jt.border)||"border-gray-400"} border flex-shrink-0`,children:xe.category===N.Line?"L":xe.category===N.Instrument?"I":xe.category===N.DrawingNumber?"D":xe.category===N.NotesAndHolds?"N":"U"}),st?e.jsx("div",{className:"flex items-center space-x-1 flex-grow",children:e.jsx("input",{type:"text",value:ct,onChange:ue=>We(ue.target.value),onKeyDown:ue=>{ue.key==="Enter"&&dt(),ue.key==="Escape"&&be()},onBlur:dt,autoFocus:!0,className:"font-mono text-sm text-gray-900 bg-gray-100 border border-sky-500 rounded px-1 flex-grow"})}):e.jsx("span",{className:"font-mono text-sm text-gray-900 truncate",children:xe.text})]}),xe.category===N.Instrument&&(()=>{const ue=(T==null?void 0:T.filter(a=>a.tagIds.includes(xe.id)))||[];return ue.length>0&&e.jsx("div",{className:"mt-1",children:ue.map(a=>e.jsx("div",{className:"mb-1",children:e.jsxs("span",{className:"text-xs text-blue-400 font-mono ml-8",children:["Loop: ",a.name||a.id]})},a.id))})})()]}),e.jsxs("div",{className:"flex items-center space-x-1 flex-shrink-0",children:[e.jsxs("span",{className:"text-xs text-gray-600",children:["P. ",xe.page]}),e.jsx(Jt,{onClick:()=>gt(xe),title:"Edit tag text"}),e.jsx(Qt,{onClick:()=>{confirm(`Delete tag "${xe.text}"?`)&&(P([xe.id]),Q([]))}}),e.jsx("button",{onClick:()=>Q([]),className:"text-gray-600 hover:text-gray-900 transition-colors p-1 rounded hover:bg-gray-100 ml-2",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}),(()=>{const ue=h.filter(t=>t.from===xe.id&&t.type==="Connection"),a=h.filter(t=>t.to===xe.id&&t.type==="Connection"),l=h.find(t=>t.from===xe.id&&t.type==="Installation"),m=h.filter(t=>t.to===xe.id&&t.type==="Installation"),E=h.filter(t=>(t.from===xe.id||t.to===xe.id)&&t.type==="Annotation"),S=h.filter(t=>t.from===xe.id&&t.type==="Note"),O=h.filter(t=>t.to===xe.id&&t.type==="Note"),G=h.filter(t=>t.from===xe.id&&t.type==="Description"),Z=h.filter(t=>t.to===xe.id&&t.type==="Description"),c=(()=>{if(!xe||xe.category!==N.Instrument)return null;const t=r.filter(v=>v.category===N.Line&&v.page===xe.page);if(t.length===0)return null;const s=(v,C)=>{const $=(v.bbox.x1+v.bbox.x2)/2,J=(v.bbox.y1+v.bbox.y2)/2,I=(C.bbox.x1+C.bbox.x2)/2,ne=(C.bbox.y1+C.bbox.y2)/2,pe=I-$,we=ne-J;return Math.sqrt(pe*pe+we*we)};let p=null,i=1/0;for(const v of t){const C=s(xe,v);C<i&&(i=C,p=v)}return p})(),D=ue.length>0||a.length>0||l||m.length>0||E.length>0||S.length>0||O.length>0||G.length>0||Z.length>0||c!==null,R=(t,s)=>e.jsx("button",{onClick:p=>{p.stopPropagation();const i=r.find(v=>v.id===t);i&&(Q([i.id]),ae(i.page),ut("panel"),Ee(i.id))},className:"text-sky-400 hover:text-sky-300 font-mono cursor-pointer",children:s},t),X=new Map(r.map(t=>[t.id,t]));return(D||c)&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-gray-300/50 space-y-1 text-xs text-gray-600",children:[ue.map(t=>{const s=X.get(t.to);return s?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{className:"text-gray-600 text-xs",children:"To"}),R(s.id,s.text)]}),e.jsx(Ct,{onClick:()=>Se(t.id)})]},t.id):null}),a.map(t=>{const s=X.get(t.from);return s?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{className:"text-gray-600 text-xs",children:"From"}),R(s.id,s.text)]}),e.jsx(Ct,{onClick:()=>Se(t.id)})]},t.id):null}),l&&X.get(l.to)&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{title:"Installation",children:"📌"}),e.jsx("span",{className:"text-gray-600",children:"Installed on:"}),R(l.to,X.get(l.to).text)]}),e.jsx(Ct,{onClick:()=>Se(l.id)})]}),m.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"Installed Instruments:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:m.map(t=>{const s=X.get(t.from);return s?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:R(s.id,s.text)}),e.jsx(Ct,{onClick:()=>Se(t.id)})]},t.id):null})})]}),E.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Related Text:"}),e.jsx("div",{className:"pl-3 space-y-1 mt-1",children:E.map(t=>{const s=t.from===xe.id?t.to:t.from,p=x.find(v=>v.id===s),i=Nt.has(s);return p?e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3 text-slate-500 flex-shrink-0",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z",clipRule:"evenodd"})}),i?e.jsx("input",{type:"text",defaultValue:p.text,onBlur:v=>{v.target.value.trim()!==p.text&&F(s,v.target.value.trim()),ot(C=>{const $=new Set(C);return $.delete(s),$})},onKeyDown:v=>{v.key==="Enter"&&v.target.blur(),v.key==="Escape"&&ot(C=>{const $=new Set(C);return $.delete(s),$})},autoFocus:!0,className:"text-gray-700 font-mono bg-gray-100 border border-sky-500 rounded px-1 flex-grow text-xs"}):e.jsxs("span",{className:"text-gray-700 font-mono truncate max-w-[180px]",children:['"',p.text,'"']})]}),e.jsxs("div",{className:"flex items-center flex-shrink-0",children:[e.jsx(Jt,{onClick:()=>{ot(v=>{const C=new Set(v);return C.add(s),C})}}),e.jsx(Qt,{onClick:()=>U([s])}),e.jsx(Ct,{onClick:()=>Se(t.id)})]})]},t.id):null})})]}),c&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"Connected Line:"}),e.jsx("div",{className:"pl-3 mt-1",children:e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{title:"Line",children:"📐"}),e.jsx("button",{onClick:t=>{t.stopPropagation(),Q([c.id]),ut("panel"),Ee(c.id)},className:"text-sky-400 hover:text-sky-300 font-mono cursor-pointer",children:c.text})]})})]}),S.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 font-semibold",children:"Notes:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:S.map(t=>{const s=X.get(t.to);return s?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx("span",{title:"Note",children:"📝"}),R(s.id,s.text)]}),e.jsx(Ct,{onClick:()=>Se(t.id)})]},t.id):null})})]}),O.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Note for:"}),e.jsx("div",{className:"pl-3 space-y-0.5 mt-1",children:O.map(t=>{const s=X.get(t.from);return s?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:R(s.id,s.text)}),e.jsx(Ct,{onClick:()=>Se(t.id)})]},t.id):null})})]}),(G.length>0||Z.length>0)&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400 font-semibold",children:"Descriptions:"}),e.jsxs("div",{className:"pl-3 space-y-0.5 mt-1",children:[G.map(t=>{const s=j.find(p=>p.id===t.to);return s?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-purple-300",children:["📄 ",s.metadata.type," ",s.metadata.number]}),e.jsx(Ct,{onClick:()=>Se(t.id)})]},t.id):null}),Z.map(t=>{const s=j.find(p=>p.id===t.from);return s?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-purple-300",children:["📄 ",s.metadata.type," ",s.metadata.number]}),e.jsx(Ct,{onClick:()=>Se(t.id)})]},t.id):null})]})]})]})})()]})})]})},Bn=({hasData:n,onOpenSettings:r,pdfDoc:w,currentPage:h,setCurrentPage:y,onToggleSidePanel:x})=>e.jsx("header",{className:"relative flex-shrink-0 bg-white border-b border-gray-200 p-2 z-50",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-2 justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("img",{src:"/gs-logo.png",alt:"GS Logo",className:"h-6 w-6 lg:h-8 lg:w-8 object-contain"}),e.jsx("h1",{className:"text-lg lg:text-xl font-bold text-gray-900 tracking-tight hidden sm:inline",children:"계장태그 추출기"}),e.jsx("h1",{className:"text-lg font-bold text-gray-900 tracking-tight sm:hidden",children:"태그추출기"}),n&&e.jsx("button",{onClick:x,className:"p-1.5 rounded-md text-gray-600 hover:bg-gray-100 hover:text-gray-900 transition-colors",title:"사이드 패널 토글 (S)",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 lg:h-5 lg:w-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"9",y1:"3",x2:"9",y2:"21"})]})})]}),n&&w&&e.jsxs("div",{className:"bg-white p-1 rounded-xl shadow-lg flex items-center gap-2 border border-gray-200",children:[e.jsx("button",{onClick:()=>y(Math.max(1,h-1)),disabled:h===1,className:"px-2 py-1 bg-gray-200 rounded disabled:opacity-50 hover:bg-gray-300 transition-colors text-sm text-gray-900",children:"←"}),e.jsxs("span",{className:"text-sm whitespace-nowrap text-gray-700",children:["페이지 ",h,"/",w.numPages]}),e.jsx("button",{onClick:()=>y(Math.min(w.numPages,h+1)),disabled:h===w.numPages,className:"px-2 py-1 bg-gray-200 rounded disabled:opacity-50 hover:bg-gray-300 transition-colors text-sm text-gray-900",children:"→"})]}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("button",{onClick:r,className:"p-2 text-sm font-semibold text-white bg-gray-600 rounded-md hover:bg-gray-700 transition-colors",title:"설정",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.532 1.532 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z",clipRule:"evenodd"})})})})]})});function en(n){if(!n)return"";const r=/^(\d+(?:\/\d+)?)"?-([A-Z]{1,4})-(\d{3,})(?:-([A-Z0-9]+))?$/i,w=/^(\d+)"?-(\d{4})-([A-Z])-(\d{3})-([A-Z0-9-]+)$/i,h=/^(\d+(?:\/\d+)?)"?-([A-Z]{2,})-(\d+)$/i;if(r.test(n))return'\\d+(?:[/\\d]+)?"?-[A-Z]{1,4}-\\d{3,}(?:-[A-Z0-9]+)?';if(w.test(n))return'\\d+"?-\\d{4}-[A-Z]-\\d{3}-[A-Z0-9-]+';if(h.test(n))return'\\d+(?:[/\\d]+)?"?-[A-Z]{2,}-\\d+';const y=n.split(/[-"]/);let x="";for(let j=0;j<y.length;j++){const u=y[j];u&&(j>0&&(x+="-"),/^\d+$/.test(u)?x+=`\\d{${u.length}}`:/^\d+\/\d+$/.test(u)?x+="\\d+/\\d+":/^[A-Z]+$/i.test(u)?x+=`[A-Z]{${u.length}}`:/^[A-Z0-9]+$/i.test(u)?x+="[A-Z0-9]+":x+="[A-Z0-9-]+")}return n.includes('"')&&(x=x.replace(/^(\\d[^-]*)/,'$1"?')),x||'\\d+(?:[/\\d]+)?"?-[A-Z]{1,4}-\\d{3,}'}function Wn(n){if(!n)return{func:"",num:""};const r=n.trim().replace(/\s+/g," "),w=/^([A-Z]{2,5})[-\s]?(\d{3,4}[A-Z]?)$/i,h=/^([A-Z]{2,5})\s+(\d{3,4}[A-Z]?)$/i,y=/^([A-Z]{2,6})[-\s]?(\d{3,4}[A-Z]?)$/i,x=r.match(w)||r.match(h)||r.match(y);if(x){const j=x[1],u=x[2],d=j.length<=3?"[A-Z]{2,3}":`[A-Z]{${Math.min(j.length-1,2)},${Math.min(j.length+1,6)}}`,T=/[A-Z]$/.test(u),f=u.replace(/[A-Z]/g,"").length,M=T?`\\d{${f}}[A-Z]?`:`\\d{${Math.max(3,f)},${Math.max(4,f)}}`;return{func:d,num:M}}return{func:"[A-Z]{2,4}",num:"\\d{3,4}(?:\\s?[A-Z])?"}}function tn(n){if(!n)return"";const r=/^[A-Z0-9]+(-[A-Z0-9]+){2,}$/i,w=/^P&ID-\d+-REV-[A-Z]$/i,h=/^[0-9]{3,}[A-Z]{2,}-[0-9]{4}-[A-Z]{2,}-[A-Z]-[0-9]{3,}$/i;if(w.test(n))return"P&ID-\\d+-REV-[A-Z]";if(h.test(n))return"\\d{3,}[A-Z]{2,}-\\d{4}-[A-Z]{2,}-[A-Z]-\\d{3,}";if(r.test(n)){const y=n.split("-"),x=Math.max(3,y.length-1),j=y.length+2,d=/[A-Z]/i.test(n)?"[A-Z0-9]+":"\\d+";let T=d;for(let f=1;f<x;f++)T+=`(-${d})`;for(let f=x;f<j;f++)T+=`(-${d})?`;return T}return"[A-Z0-9][A-Z0-9\\-]{10,}"}function nn(n,r,w){const h={};if(n){const y=n.split(",").map(x=>x.trim()).filter(Boolean);if(y.length===1)h.line=en(y[0]);else if(y.length>1){const x=y.map(en).filter(Boolean);x.length>0&&(h.line=x.length===1?x[0]:`(${x.join("|")})`)}}if(r){const y=r.split(",").map(x=>x.trim()).filter(Boolean);if(y.length>0){const x=y.map(Wn),j=[...new Set(x.map(d=>d.func).filter(Boolean))],u=[...new Set(x.map(d=>d.num).filter(Boolean))];h.instrument={func:j.length===1?j[0]:`(${j.join("|")})`,num:u.length===1?u[0]:`(${u.join("|")})`}}}if(w){const y=w.split(",").map(x=>x.trim()).filter(Boolean);if(y.length===1)h.drawing=tn(y[0]);else if(y.length>1){const x=y.map(tn).filter(Boolean);x.length>0&&(h.drawing=x.length===1?x[0]:`(${x.join("|")})`)}}return h}const cn="https://api.openai.com/v1/chat/completions",zn="gpt-4-turbo-preview";async function Un(n,r,w,h){var j,u,d;if(!n)throw new Error("OpenAI API key is required");const y=`You are an expert regex pattern generator specialized in P&ID (Piping and Instrumentation Diagram) tag recognition across multiple industries and standards.

COMPREHENSIVE P&ID PATTERN RULES:

1. LINE NUMBERS (Process/Piping Lines):
Common formats across industries:
- Size-Service-Number: "8"-PL-30001", "1/2"-WS-10001", "DN100-CW-2001"
- Size-Number-Service-Details: "42"-7300-P-037-11051XR-PP", "12"-1234-HC-567-A1B"
- Complex with specifications: "8"-PL-30001-C1C-INS", "3"-GL-30401-N1E-H2B3"
- With material codes: "4"-SS-304L-PL-1001", "6"-CS-A106B-ST-2002"
- International formats: "100-L-12345-CS", "DN150-W-67890-SS316"

Size variations: 1/8", 1/4", 1/2", 3/4", 1", 2", 3", 4", 6", 8", 10", 12", 14", 16", 18", 20", 24", 30", 36", 42", 48"
Or metric: DN15, DN20, DN25, DN32, DN40, DN50, DN65, DN80, DN100, DN150, DN200, DN250, DN300

Service codes: PL, GL, WS, ST, CW, CHW, RW, CS, SS, HC, LC, AC, NG, FG, IA, N2, H2, O2, AR, HE

Key characteristics:
- Usually contains size (with quotes " or DN prefix)
- Multiple hyphen-separated segments (minimum 3)
- May include material specs, insulation codes, tracing info

2. INSTRUMENT TAGS (ISA Standard):
Format: [Function Letters][Loop Number][Suffix]

Function Letters (First letter + modifiers):
First Letter (Measured Variable):
- A (Analysis), B (Burner), C (Conductivity), D (Density), E (Voltage)
- F (Flow), G (Gauging), H (Hand/Manual), I (Current), J (Power)
- K (Time/Schedule), L (Level), M (Moisture), N (User Choice), O (User Choice)
- P (Pressure), Q (Quantity), R (Radiation), S (Speed), T (Temperature)
- U (Multi-variable), V (Vibration), W (Weight), X (Unclassified), Y (Event), Z (Position)

Succeeding Letters:
- A (Alarm), B (User Choice), C (Control), D (Differential), E (Element)
- F (Ratio), G (Glass/Gauge), H (High), I (Indicate), J (Scan), K (Control Station)
- L (Light/Low), M (Momentary), N (User Choice), O (Orifice), P (Point/Test)
- Q (Integrate), R (Record), S (Switch), T (Transmit), U (Multifunction)
- V (Valve), W (Well), X (Unclassified), Y (Relay), Z (Driver/Actuator)

Common combinations:
- FT, FE, FI, FIC, FICA, FCV, FV, FSL, FSH (Flow)
- PT, PE, PI, PIC, PCV, PSV, PSL, PSH, PDI, PDT (Pressure)
- LT, LE, LI, LIC, LCV, LSL, LSH, LAL, LAH (Level)
- TT, TE, TI, TIC, TCV, TSL, TSH, TW, TR (Temperature)
- XV, HV, HCV, HS, HIC, XCV (Valves/Hand)

Loop numbers: 001-9999, may include area prefix (11-FT-101, 2-PT-2001)
Suffixes: A, B, C (for multiple devices in same loop)

3. DRAWING NUMBERS:
Various company standards:
- Project-Area-Type-Sequential: "00342GS-7300-PRP-D-105"
- Simple sequential: "P&ID-001", "PID-2023-001-REV-A"
- Complex hierarchical: "PRJ-UNIT-DISC-TYPE-SHEET": "ABC-U01-PROC-PID-001"
- With revision: "DWG-12345-R1", "SK-67890-REV-B", "P123-456-789-R0"
- ISO format: "XXXX-YY-ZZ-NNNN" where X=project, Y=area, Z=type, N=number
- Company specific: "CLIENT-PLANT-AREA-DOC-NUMBER"

Common prefixes: P&ID, PID, PFD, DWG, SK, ISO, GA, PROC, INST, LOOP
Common suffixes: REV-X, R0/R1/R2, -SH1/-SH2 (sheet numbers)

REGEX GENERATION RULES:
- Be flexible enough to catch variations but specific enough to avoid false positives
- Use character classes for variable parts: [A-Z], \\d, [A-Z0-9]
- Use quantifiers appropriately: {2,4} for 2-4 chars, + for one or more, * for zero or more
- Account for optional parts with ?: (...)? for optional groups
- Consider word boundaries \\b when needed to avoid partial matches
- For hyphens in patterns, remember they're literal characters not ranges

Return ONLY a JSON object with the regex patterns, no explanation or markdown. Use double backslashes for regex escapes.`,x=`Generate regex patterns for these P&ID samples. Analyze the structure and create patterns that will match similar formats:

${r?`Line Sample(s): "${r}"
Analyze: Look for size indicators (numbers with " or DN prefix), service codes (2-4 letters), sequential numbers, and any suffixes. The pattern should match lines with similar structure but different values.`:"Line Sample: (not provided)"}

${w?`Instrument Sample(s): "${w}"
Analyze: Identify the function code (2-6 uppercase letters indicating instrument type), loop number (typically 3-4 digits, may have area prefix), and any suffix letters. Consider ISA naming standards.`:"Instrument Sample: (not provided)"}

${h?`Drawing Number Sample(s): "${h}"
Analyze: Identify the document structure - project codes, area/unit identifiers, document type, sequential numbers, and revision indicators. Look for consistent separator patterns.`:"Drawing Number Sample: (not provided)"}

IMPORTANT PATTERN REQUIREMENTS:
- For lines: Must handle size variations (fractional, whole numbers, DN format), flexible service codes, variable segment counts
- For instruments: Separate patterns for function code (letters) and tag number (digits with optional suffix)
- For drawings: Flexible enough for various company standards but specific enough to avoid false matches
- All patterns should use proper escaping (double backslashes) and be tested against the provided samples

Return a JSON object with this exact structure:
{
  "line": "regex_pattern or null",
  "instrument": {
    "func": "function_code_pattern or null",
    "num": "tag_number_pattern or null"
  },
  "drawing": "drawing_number_pattern or null"
}

Examples of good patterns:
- Line: "(?:\\d+(?:[/\\d]+)?\\"|DN\\d+)-[A-Z]{2,4}-\\d{3,}(?:-[A-Z0-9]+)*"
- Instrument func: "[A-Z]{2,5}"
- Instrument num: "\\d{3,4}[A-Z]?"
- Drawing: "[A-Z0-9]{3,}-\\d{4}-[A-Z]{2,}-[A-Z]-\\d{3,}"

Return null for any pattern not requested. Ensure all backslashes are doubled for JSON.`;try{const T=await fetch(cn,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({model:zn,messages:[{role:"system",content:y},{role:"user",content:x}],temperature:.2,max_tokens:500,response_format:{type:"json_object"}})});if(!T.ok){const z=await T.text();throw T.status===401?new Error("Invalid API key. Please check your OpenAI API key."):T.status===429?new Error("Rate limit exceeded. Please try again later."):T.status===400?new Error("Invalid request. Please check your input samples."):new Error(`API request failed: ${T.status} ${T.statusText}`)}const M=((d=(u=(j=(await T.json()).choices)==null?void 0:j[0])==null?void 0:u.message)==null?void 0:d.content)||"";if(!M)throw new Error("Empty response from OpenAI API");let k;try{k=JSON.parse(M)}catch{const z=M.match(/\{[\s\S]*\}/);if(z)k=JSON.parse(z[0]);else throw new Error("Invalid response format from OpenAI API")}const A={};return k.line&&r&&(A.line=k.line),k.instrument&&w&&(A.instrument={func:k.instrument.func||"[A-Z]{2,4}",num:k.instrument.num||"\\d{3,4}(?:\\s?[A-Z])?"}),k.drawing&&h&&(A.drawing=k.drawing),A}catch(T){throw T}}async function Gn(n){if(!n)return!1;try{return(await fetch(cn,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"user",content:'Say "OK"'}],max_tokens:5})})).ok}catch{return!1}}function Xn(n){n?localStorage.setItem("openai_api_key",n):localStorage.removeItem("openai_api_key")}function Zn(){return localStorage.getItem("openai_api_key")}const Yn=({patterns:n,tolerances:r,appSettings:w,colorSettings:h,onSaveOnly:y,onSaveAndRescan:x,onClose:j})=>{const[u,d]=o.useState(n),[T,f]=o.useState(r),[M,k]=o.useState(w),[A,z]=o.useState(h||Xe),[B,P]=o.useState(w.instrumentMappings||Je.instrumentMappings||{}),[W,se]=o.useState(w.loopRules||Je.loopRules||{}),[re,le]=o.useState(!1),[U,F]=o.useState("patterns"),H=g=>{F(g),q(""),ie("")},[b,q]=o.useState(""),[V,ie]=o.useState(""),[de,ce]=o.useState(""),[Y,ae]=o.useState(""),[me,De]=o.useState(""),[Le,ke]=o.useState(!1),[fe,Ce]=o.useState(Zn()||""),[$e,Te]=o.useState(!1),[Me,it]=o.useState(null);o.useEffect(()=>{const g=L=>{L.key==="Escape"&&j()};return window.addEventListener("keydown",g),()=>window.removeEventListener("keydown",g)},[j]);const et=()=>{const g={...M,instrumentMappings:B,loopRules:W};y(u,T,g,A)},Pe=()=>{const g={...M,instrumentMappings:B,loopRules:W};x(u,T,g,A,U)},He=()=>{d(yt),f(Et),k(Je),se(Je.loopRules||{}),P(Je.instrumentMappings||{}),q(""),ie("")},Re=(g,L)=>{d(oe=>({...oe,[g]:L}))},Fe=(g,L)=>{d(oe=>({...oe,[N.Instrument]:{...oe[N.Instrument],[g]:L}}))},ge={[N.Line]:{description:"배관 라인 태그를 매칭하기 위한 정규식 패턴입니다."},[N.Instrument]:{description:"기능 코드와 번호로 구성된 계기 태그를 매칭하기 위한 두 부분 패턴입니다."},[N.DrawingNumber]:{description:"도면 번호를 식별하기 위한 패턴입니다. 페이지당 하나만 선택되며, 우하단에서 선택됩니다."},[N.NotesAndHolds]:{description:"노트 및 홀드 주석을 매칭하기 위한 패턴입니다."}};return T[N.Instrument],e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in-up",style:{animationDuration:"0.2s"},onClick:j,children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl shadow-2xl w-full max-w-7xl text-gray-900",onClick:g=>g.stopPropagation(),children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900",children:"설정"}),e.jsx("button",{onClick:j,className:"p-1 rounded-full text-gray-600 hover:bg-gray-100",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("button",{onClick:()=>H("patterns"),className:`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors ${U==="patterns"?"bg-gray-200 text-gray-900":"bg-transparent text-gray-600 hover:text-gray-900 hover:bg-gray-100"}`,children:"패턴 설정"}),e.jsx("button",{onClick:()=>H("instruments"),className:`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors ${U==="instruments"?"bg-gray-200 text-gray-900":"bg-transparent text-gray-600 hover:text-gray-900 hover:bg-gray-100"}`,children:"계기 타입"}),e.jsx("button",{onClick:()=>H("loops"),className:`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors ${U==="loops"?"bg-gray-200 text-gray-900":"bg-transparent text-gray-600 hover:text-gray-900 hover:bg-gray-100"}`,children:"Loop Number"})]})]}),e.jsx("div",{className:"p-6 space-y-4 max-h-[70vh] overflow-y-auto",children:U==="patterns"?e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"lg:col-span-2",children:[e.jsx("div",{className:"flex items-center gap-2 mb-4",children:e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"정규식 패턴"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"p-3 bg-gray-100 rounded-lg",children:[e.jsx("h4",{className:"text-sm font-semibold mb-3 text-gray-800",children:"라인"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"pattern-Line",className:"block text-xs font-medium text-gray-700 mb-1",children:"라인"}),e.jsx("input",{id:"pattern-Line",type:"text",value:u[N.Line],onChange:g=>Re(N.Line,g.target.value),className:"w-full bg-white border border-gray-300 rounded-md p-2 text-sm font-mono text-gray-900 focus:ring-sky-500 focus:border-sky-500",placeholder:"라인을 위한 정규식 패턴 입력..."}),e.jsx("div",{className:"mt-1 text-xs text-gray-600",children:e.jsx("p",{children:ge[N.Line].description})})]})]})}),e.jsxs("div",{className:"space-y-4",children:[(()=>{var L,oe;const g=ge[N.Instrument];return e.jsxs("div",{className:"p-3 bg-white border border-gray-300 rounded-lg",children:[e.jsx("label",{className:"block text-sm font-semibold mb-2 text-gray-800",children:"계기"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"pattern-inst-func",className:"block text-xs font-medium text-gray-600 mb-1",children:"기능 부분"}),e.jsx("input",{id:"pattern-inst-func",type:"text",value:((L=u[N.Instrument])==null?void 0:L.func)||"",onChange:_=>Fe("func",_.target.value),className:"w-full bg-white border border-gray-300 rounded-md p-2 text-sm font-mono text-gray-900 focus:ring-sky-500 focus:border-sky-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"pattern-inst-num",className:"block text-xs font-medium text-gray-600 mb-1",children:"번호 부분"}),e.jsx("input",{id:"pattern-inst-num",type:"text",value:((oe=u[N.Instrument])==null?void 0:oe.num)||"",onChange:_=>Fe("num",_.target.value),className:"w-full bg-white border border-gray-300 rounded-md p-2 text-sm font-mono text-gray-900 focus:ring-sky-500 focus:border-sky-500"})]})]}),g&&e.jsx("div",{className:"mt-3 text-xs text-gray-600",children:e.jsx("p",{children:g.description})})]},N.Instrument)})(),(()=>{const g=ge[N.NotesAndHolds];return e.jsxs("div",{className:"p-3 bg-white border border-gray-300 rounded-lg",children:[e.jsx("label",{htmlFor:`pattern-${N.NotesAndHolds}`,className:"block text-sm font-semibold mb-2 text-gray-800",children:"노트 및 홀드"}),e.jsx("input",{id:`pattern-${N.NotesAndHolds}`,type:"text",value:u[N.NotesAndHolds],onChange:L=>Re(N.NotesAndHolds,L.target.value),className:"w-full bg-white border border-gray-300 rounded-md p-3 text-sm font-mono text-gray-900 focus:ring-sky-500 focus:border-sky-500",placeholder:"노트 및 홀드를 위한 정규식 패턴 입력..."}),g&&e.jsx("div",{className:"mt-2 text-xs text-gray-600",children:e.jsx("p",{children:g.description})})]},N.NotesAndHolds)})(),(()=>{const g=ge[N.DrawingNumber];return e.jsxs("div",{className:"p-3 bg-white border border-gray-300 rounded-lg",children:[e.jsx("label",{htmlFor:`pattern-${N.DrawingNumber}`,className:"block text-sm font-semibold mb-2 text-gray-800",children:"Drawing Number"}),e.jsx("input",{id:`pattern-${N.DrawingNumber}`,type:"text",value:u[N.DrawingNumber],onChange:L=>Re(N.DrawingNumber,L.target.value),className:"w-full bg-white border border-gray-300 rounded-md p-3 text-sm font-mono text-gray-900 focus:ring-sky-500 focus:border-sky-500",placeholder:"Enter regex pattern for Drawing Number..."}),g&&e.jsx("div",{className:"mt-2 text-xs text-gray-600",children:e.jsx("p",{children:g.description})})]},N.DrawingNumber)})()]})]})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"p-4 bg-gray-100 rounded-lg",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-800 mb-4",children:"AI 정규식 생성"}),e.jsx("p",{className:"text-xs text-gray-600 mb-4",children:"실제 P&ID 예시 데이터를 입력하면 AI가 적합한 정규식을 생성합니다."}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"라인 번호 예시"}),e.jsx("input",{type:"text",value:de,onChange:g=>ce(g.target.value),className:"w-full bg-white border border-gray-300 rounded px-2 py-1.5 text-xs font-mono text-gray-900",placeholder:'42"-7300-P-037-11051XR-PP'})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"계기 태그 예시"}),e.jsx("input",{type:"text",value:Y,onChange:g=>ae(g.target.value),className:"w-full bg-white border border-gray-300 rounded px-2 py-1.5 text-xs font-mono text-gray-900",placeholder:"TT-205, FIC-301A, PSV-102"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Drawing Number 예시"}),e.jsx("input",{type:"text",value:me,onChange:g=>De(g.target.value),className:"w-full bg-white border border-gray-300 rounded px-2 py-1.5 text-xs font-mono text-gray-900",placeholder:"00342GS-7300-PRP-D-105"})]})]}),e.jsxs("div",{className:"mt-4 p-3 bg-gray-50 border border-gray-200 rounded",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:"OpenAI API Key (ChatGPT)"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:$e?"text":"password",value:fe,onChange:g=>{Ce(g.target.value),Xn(g.target.value),it(null)},className:"w-full bg-white border border-gray-300 rounded px-2 py-1.5 text-xs font-mono text-gray-900 pr-20",placeholder:"sk-..."}),e.jsxs("div",{className:"absolute right-1 top-1/2 -translate-y-1/2 flex gap-1",children:[e.jsx("button",{onClick:()=>Te(!$e),className:"p-1 text-gray-500 hover:text-gray-700",type:"button",children:$e?e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"})}):e.jsxs("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]})}),e.jsx("button",{onClick:async()=>{if(fe){const g=await Gn(fe);it(g),alert(g?"API 키가 유효합니다.":"API 키가 유효하지 않습니다.")}},className:"px-2 py-0.5 text-xs bg-gray-200 hover:bg-gray-300 rounded",type:"button",children:"테스트"})]})]}),Me!==null&&e.jsx("p",{className:`text-xs mt-1 ${Me?"text-green-600":"text-red-600"}`,children:Me?"✓ API 키 유효함":"✗ API 키 유효하지 않음"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["ChatGPT를 사용하여 더 정확한 정규식을 생성합니다."," ",e.jsx("a",{href:"https://platform.openai.com/api-keys",target:"_blank",rel:"noopener noreferrer",className:"text-sky-600 hover:text-sky-700 underline",children:"API 키 받기"})]})]}),e.jsx("button",{onClick:async()=>{ke(!0);try{let g;if(fe)try{g=await Un(fe,de,Y,me)}catch(L){g=nn(de,Y,me),alert(`ChatGPT API 실패: ${L.message}
규칙 기반 생성을 사용합니다.`)}else g=nn(de,Y,me);g.line&&de&&Re(N.Line,g.line),g.instrument&&Y&&(Fe("func",g.instrument.func),Fe("num",g.instrument.num)),g.drawing&&me&&Re(N.DrawingNumber,g.drawing),alert(fe?"ChatGPT로 정규식이 생성되었습니다.":"규칙 기반으로 정규식이 생성되었습니다.")}catch(g){alert(`정규식 생성 실패: ${g.message}`)}finally{ke(!1)}},disabled:Le||!de&&!Y&&!me,className:`
                    w-full mt-4 px-4 py-2 text-sm font-semibold rounded-md transition-colors
                    ${Le||!de&&!Y&&!me?"bg-gray-300 text-gray-500 cursor-not-allowed":fe?"bg-violet-600 text-white hover:bg-violet-700":"bg-sky-600 text-white hover:bg-sky-700"}
                  `,children:Le?"생성 중...":fe?"ChatGPT로 정규식 생성":"규칙 기반 정규식 생성"}),e.jsxs("div",{className:"mt-4 p-3 bg-blue-50 border border-blue-200 rounded text-xs",children:[e.jsx("p",{className:"text-blue-800 font-semibold mb-1",children:"팁:"}),e.jsxs("ul",{className:"text-blue-700 space-y-1",children:[e.jsx("li",{children:"• 실제 사용 중인 태그 예시를 입력하세요"}),e.jsx("li",{children:"• 여러 개의 예시는 쉼표로 구분합니다"}),e.jsx("li",{children:"• 생성된 패턴은 수동 조정 가능합니다"})]})]})]})})]}):U==="instruments"?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"border border-gray-300 rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"계기 타입 및 I/O 타입 설정"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"인식된 계기 태그 패턴에 대한 기본 계기 타입과 I/O 타입을 설정하세요."}),e.jsxs("div",{className:"mb-4 p-3 bg-gray-100 rounded",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-2",children:"새 매핑 추가"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx("input",{type:"text",placeholder:"패턴 (예: PT)",className:"bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900",id:"new-pattern"}),e.jsx("input",{type:"text",placeholder:"계기 타입",className:"bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900",id:"new-instrument-type"}),e.jsxs("select",{className:"bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900",id:"new-io-type",defaultValue:"",children:[e.jsx("option",{value:"",disabled:!0,children:"I/O 타입 선택"}),e.jsx("option",{value:"AI",children:"AI (Analog Input)"}),e.jsx("option",{value:"AO",children:"AO (Analog Output)"}),e.jsx("option",{value:"DI",children:"DI (Digital Input)"}),e.jsx("option",{value:"DO",children:"DO (Digital Output)"}),e.jsx("option",{value:"Local",children:"Local"})]}),e.jsx("button",{onClick:()=>{var _,ee,Q;const g=(_=document.getElementById("new-pattern"))==null?void 0:_.value.toUpperCase(),L=(ee=document.getElementById("new-instrument-type"))==null?void 0:ee.value,oe=(Q=document.getElementById("new-io-type"))==null?void 0:Q.value;g&&L&&oe&&(P(ye=>({...ye,[g]:{instrumentType:L,ioType:oe}})),document.getElementById("new-pattern").value="",document.getElementById("new-instrument-type").value="",document.getElementById("new-io-type").value="")},className:"bg-sky-600 hover:bg-sky-700 text-white font-semibold px-2 py-1 rounded text-sm",children:"추가"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700",children:"현재 매핑"}),e.jsxs("div",{className:"relative w-48",children:[e.jsx("input",{type:"text",placeholder:"계기 검색...",value:b,onChange:g=>q(g.target.value),className:"w-full bg-white border border-gray-300 rounded-md px-2 py-1 pr-8 text-sm text-gray-900 focus:ring-sky-500 focus:border-sky-500"}),b&&e.jsx("button",{onClick:()=>q(""),className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors p-0.5 rounded",title:"검색 지우기",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18L18 6M6 6l12 12"})})})]})]}),e.jsx("div",{className:"h-96 overflow-y-auto bg-gray-50 border border-gray-200 rounded",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"sticky top-0 bg-gray-100",children:e.jsxs("tr",{className:"border-b border-gray-300",children:[e.jsx("th",{className:"text-left py-2 px-2 text-gray-700",children:"패턴"}),e.jsx("th",{className:"text-left py-2 px-2 text-gray-700",children:"계기 타입"}),e.jsx("th",{className:"text-left py-2 px-2 text-gray-700",children:"I/O 타입"}),e.jsx("th",{className:"py-2 px-2"})]})}),e.jsx("tbody",{children:(()=>{const g=Object.entries(B).filter(([L,oe])=>{const _=b.toLowerCase();return L.toLowerCase().includes(_)||oe.instrumentType.toLowerCase().includes(_)||oe.ioType.toLowerCase().includes(_)}).sort();return g.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-8 text-center text-gray-500",children:"검색 결과가 없습니다"})}):g.map(([L,oe])=>e.jsxs("tr",{className:"border-b border-gray-200 hover:bg-gray-50",children:[e.jsx("td",{className:"py-2 px-2 font-mono text-gray-900",children:L}),e.jsx("td",{className:"py-2 px-2",children:e.jsx("input",{type:"text",value:oe.instrumentType,onChange:_=>{P(ee=>({...ee,[L]:{...ee[L],instrumentType:_.target.value}}))},className:"bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900 w-full"})}),e.jsx("td",{className:"py-2 px-2",children:e.jsxs("select",{value:oe.ioType,onChange:_=>{P(ee=>({...ee,[L]:{...ee[L],ioType:_.target.value}}))},className:"bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900 w-full",children:[e.jsx("option",{value:"AI",children:"AI (Analog Input)"}),e.jsx("option",{value:"AO",children:"AO (Analog Output)"}),e.jsx("option",{value:"DI",children:"DI (Digital Input)"}),e.jsx("option",{value:"DO",children:"DO (Digital Output)"}),e.jsx("option",{value:"Local",children:"Local"})]})}),e.jsx("td",{className:"py-2 px-2",children:e.jsx("button",{onClick:()=>{const _={...B};delete _[L],P(_)},className:"text-red-400 hover:text-red-300",title:"삭제",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})})]},L))})()})]})})]})]})}):U==="loops"?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"border border-gray-300 rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900",children:"Loop Number 추출 규칙"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"각 계기 태그 패턴에 대한 Loop Number 추출 규칙을 설정하세요. 예: FXI, FXLL, FXT → FX, TT-205 → T-205"}),e.jsxs("div",{className:"mb-4 p-3 bg-gray-100 rounded",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-2",children:"새 규칙 추가"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx("input",{type:"text",placeholder:"태그 패턴 (예: FXI, FXT)",className:"bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900",id:"new-loop-pattern"}),e.jsx("input",{type:"text",placeholder:"Loop 추출 규칙 (예: FX)",className:"bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900",id:"new-loop-rule"}),e.jsx("button",{onClick:()=>{var oe,_;const g=(oe=document.getElementById("new-loop-pattern"))==null?void 0:oe.value.toUpperCase(),L=(_=document.getElementById("new-loop-rule"))==null?void 0:_.value.toUpperCase();g&&L&&(g.split(",").map(Q=>Q.trim()).filter(Q=>Q).forEach(Q=>{se(ye=>({...ye,[Q]:L}))}),document.getElementById("new-loop-pattern").value="",document.getElementById("new-loop-rule").value="")},className:"bg-sky-600 hover:bg-sky-700 text-white font-semibold px-2 py-1 rounded text-sm",children:"추가"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"여러 패턴을 쉼표로 구분하여 같은 규칙을 적용할 수 있습니다."})]}),e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-1",children:"기본 규칙 안내"}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"아래 기본 규칙이 자동으로 적용됩니다. 필요시 수정하거나 추가 규칙을 만들 수 있습니다."}),e.jsx("p",{className:"text-xs text-gray-500",children:"※ 규칙에 없는 태그: 첫 번째 문자 + 숫자 (TT-205 → T-205)"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700",children:"현재 규칙"}),e.jsxs("span",{className:"text-xs text-gray-500",children:["(기본 ",Object.keys(Je.loopRules||{}).length,"개 + 사용자 ",Object.keys(W).length-Object.keys(Je.loopRules||{}).length,"개)"]})]}),e.jsxs("div",{className:"relative w-48",children:[e.jsx("input",{type:"text",placeholder:"Loop 규칙 검색...",value:V,onChange:g=>ie(g.target.value),className:"w-full bg-white border border-gray-300 rounded-md px-2 py-1 pr-8 text-sm text-gray-900 focus:ring-sky-500 focus:border-sky-500"}),V&&e.jsx("button",{onClick:()=>ie(""),className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors p-0.5 rounded",title:"검색 지우기",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18L18 6M6 6l12 12"})})})]})]}),e.jsx("div",{className:"h-96 overflow-y-auto bg-gray-50 border border-gray-200 rounded",children:Object.keys(W).length===0?e.jsx("p",{className:"text-sm text-gray-500 py-2 px-4",children:"규칙을 불러오는 중..."}):e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"sticky top-0 bg-gray-100",children:e.jsxs("tr",{className:"border-b border-gray-300",children:[e.jsx("th",{className:"text-left py-2 px-2 text-gray-700",children:"태그 패턴"}),e.jsx("th",{className:"text-left py-2 px-2 text-gray-700",children:"Loop 추출 규칙"}),e.jsx("th",{className:"text-left py-2 px-2 text-gray-700",children:"예시"}),e.jsx("th",{className:"py-2 px-2"})]})}),e.jsx("tbody",{children:(()=>{const g=Object.entries(W).filter(([L,oe])=>{const _=V.toLowerCase(),ee=`${L}-123 → ${oe}-123`;return L.toLowerCase().includes(_)||String(oe).toLowerCase().includes(_)||ee.toLowerCase().includes(_)}).sort((L,oe)=>{const _=String(L[1]||L[0][0]),ee=String(oe[1]||oe[0][0]);return _!==ee?_.localeCompare(ee):L[0].localeCompare(oe[0])});return g.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-8 text-center text-gray-500",children:"검색 결과가 없습니다"})}):g.map(([L,oe])=>{const _=Je.loopRules&&Je.loopRules[L]===oe,ee="205",Q=`${L}-${ee} → ${oe}-${ee}`;return e.jsxs("tr",{className:`border-b border-gray-200 hover:bg-gray-50 ${_?"bg-gray-50":""}`,children:[e.jsxs("td",{className:"py-2 px-2",children:[e.jsx("span",{className:"font-mono text-gray-900",children:L}),_&&e.jsx("span",{className:"ml-2 text-xs text-blue-600 font-normal",children:"기본"})]}),e.jsx("td",{className:"py-2 px-2",children:e.jsx("input",{type:"text",value:oe,onChange:ye=>{se(ve=>({...ve,[L]:ye.target.value.toUpperCase()}))},className:"bg-white border border-gray-300 rounded px-2 py-1 text-sm text-gray-900 font-mono w-20"})}),e.jsx("td",{className:"py-2 px-2 text-gray-500 text-xs",children:Q}),e.jsx("td",{className:"py-2 px-2",children:e.jsx("button",{onClick:()=>{const ye={...W};delete ye[L],se(ye)},className:"text-red-400 hover:text-red-300",title:"삭제",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})})]},L)})})()})]})})]})]})}):null}),e.jsxs("div",{className:"p-4 border-t border-gray-200 flex justify-between items-center",children:[e.jsx("button",{onClick:He,className:"px-4 py-2 text-sm font-semibold text-white bg-gray-600 rounded-md hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-white",children:"기본값으로 재설정"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:j,className:"px-4 py-2 text-sm font-semibold text-gray-700 bg-transparent rounded-md hover:bg-gray-100 transition-colors",children:"취소"}),e.jsx("button",{onClick:et,className:"px-4 py-2 text-sm font-semibold text-white bg-sky-600 rounded-md hover:bg-sky-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 focus:ring-offset-white",children:"저장"}),e.jsx("button",{onClick:Pe,className:"px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-white",children:"저장 및 다시 스캔"})]})]})]})})};class Ot extends o.Component{constructor(r){super(r),this.handleRetry=()=>{this.setState({hasError:!1,error:void 0,errorInfo:void 0})},this.handleReload=()=>{window.location.reload()},this.state={hasError:!1}}static getDerivedStateFromError(r){return{hasError:!0,error:r}}componentDidCatch(r,w){this.setState({error:r,errorInfo:w})}render(){return this.state.hasError?this.props.fallback?this.props.fallback:e.jsx("div",{className:"flex items-center justify-center min-h-screen p-4 bg-gray-50",children:e.jsxs("div",{className:"bg-red-50 border border-red-300 rounded-lg p-6 max-w-lg w-full",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx("svg",{className:"w-6 h-6 text-red-500 mr-3",fill:"none",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("h2",{className:"text-xl font-bold text-red-600",children:"Application Error"})]}),e.jsx("p",{className:"text-red-600 mb-4",children:"Something went wrong while running the application. This error has been logged."}),!1,e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsx("button",{onClick:this.handleRetry,className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-white",children:"Try Again"}),e.jsx("button",{onClick:this.handleReload,className:"px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-white",children:"Reload Page"})]})]})}):this.props.children}}const sn=(n,r,w)=>!w||r===N.NotesAndHolds?n:n.replace(/\s+/g,""),Mt=(n,r=0,w=0,h=null,y=0)=>{const{transform:x,width:j,height:u}=n,[d,T,,,f,M]=x,k=f,A=M,z=Math.atan2(T,d),B=u*.2,P=[{x:0,y:-B},{x:j,y:-B},{x:j,y:u},{x:0,y:u}],W=Math.cos(z),se=Math.sin(z),re=P.map(H=>({x:H.x*W-H.y*se+k-r,y:H.x*se+H.y*W+A-w})),le=re.map(H=>H.x),U=re.map(H=>H.y),F={x1:Math.min(...le),y1:Math.min(...U),x2:Math.max(...le),y2:Math.max(...U)};if(h&&y===90){const H=h.viewBox||[0,0,h.width,h.height];return H[2],H[3],{x1:F.y1,y1:F.x1,x2:F.y2,y2:F.x2}}else if(h&&y===270){const H=h.viewBox||[0,0,h.width,h.height],b=H[2],q=H[3];return{x1:q-F.y2,y1:b-F.x2,x2:q-F.y1,y2:b-F.x1}}else if(h&&y===180){const H=h.width,b=h.height;return{x1:H-F.x2,y1:b-F.y2,x2:H-F.x1,y2:b-F.y1}}else if(h){const H=h.height;return{x1:F.x1,y1:H-F.y2,x2:F.x2,y2:H-F.y1}}return F},_n=(n,r)=>{const{width:w,height:h}=n;switch(r){case 0:return{x:w,y:h};case 90:return{x:0,y:h};case 180:return{x:0,y:0};case 270:return{x:h,y:0};default:return{x:w,y:h}}},dn=async(n,r,w,h,y={autoRemoveWhitespace:!0})=>{const x=await n.getPage(r),j=await x.getTextContent(),u=x.getViewport({scale:1}),d=u.rotation||0,T=u.viewBox?u.viewBox[0]:0,f=u.viewBox?u.viewBox[1]:0,M=[],k=[],A=j.items.filter(U=>"str"in U&&U.str.trim()!==""),z=new Set,B=A.filter(U=>U.str.includes("-")&&U.str.length>10);if(B.length>0&&B.forEach((U,F)=>{}),w[N.Instrument]&&w[N.Instrument].func&&w[N.Instrument].num)try{const U=new RegExp(`^${w[N.Instrument].func}$`),F=new RegExp(`^${w[N.Instrument].num}$`),H=h[N.Instrument],b=[],q=[];A.forEach((V,ie)=>{if(U.test(V.str)){const de=Mt(V,T,f,u,d);if(b.push({item:V,index:ie,bbox:de}),V.str==="TXT"){const ce={x:(de.x1+de.x2)/2,y:(de.y1+de.y2)/2}}}else if(F.test(V.str)){const de=Mt(V,T,f,u,d);if(q.push({item:V,index:ie,bbox:de}),V.str==="596B"){const ce={x:(de.x1+de.x2)/2,y:(de.y1+de.y2)/2}}}else V.str==="TXT"||V.str});for(const V of b){if(z.has(V.index)||V.item.str.toUpperCase()==="FF")continue;let ie=null,de=1/0;const ce={x:(V.bbox.x1+V.bbox.x2)/2,y:(V.bbox.y1+V.bbox.y2)/2};V.item.str;for(const Y of q){if(z.has(Y.index))continue;const ae={x:(Y.bbox.x1+Y.bbox.x2)/2,y:(Y.bbox.y1+Y.bbox.y2)/2};V.item.str==="TXT"&&Y.item.str;const me=ce.y<ae.y;if(V.item.str==="TXT"&&Y.item.str,!me){V.item.str==="TXT"&&Y.item.str;continue}const De=Math.abs(ce.x-ae.x),Le=Math.abs(ce.y-ae.y);if(V.item.str==="TXT"&&Y.item.str,De<=H.horizontal&&Le<=H.vertical){const ke=De*De+Le*Le;V.item.str==="TXT"&&Y.item.str,ke<de&&(de=ke,ie=Y,V.item.str==="TXT"&&Y.item.str)}else V.item.str==="TXT"&&Y.item.str}if(ie){const Y=`${V.item.str}-${ie.item.str}`,ae=sn(Y,N.Instrument,y.autoRemoveWhitespace),me={x1:Math.min(V.bbox.x1,ie.bbox.x1),y1:Math.min(V.bbox.y1,ie.bbox.y1),x2:Math.max(V.bbox.x2,ie.bbox.x2),y2:Math.max(V.bbox.y2,ie.bbox.y2)};M.push({id:je(),text:ae,page:r,bbox:me,category:N.Instrument,sourceItems:[{...V.item,id:je(),bbox:V.bbox,page:r},{...ie.item,id:je(),bbox:ie.bbox,page:r}]}),z.add(V.index),z.add(ie.index)}}}catch{}const P=w.Line||w[N.Line]||yt[N.Line],W=[{category:N.Line,regex:P},{category:N.NotesAndHolds,regex:w[N.NotesAndHolds]}],se=A.filter(U=>U.str.includes('"-')&&!z.has(A.indexOf(U)));se.length>0&&se.slice(0,5).forEach(U=>{});for(let U=0;U<A.length;U++){if(z.has(U))continue;const F=A[U];let H=!1;for(const b of W)if(b.regex)try{const q=new RegExp(b.regex,"gi"),V=F.str.match(q);if(b.category===N.Line&&F.str.includes('"-'),V){H=!0;for(const ie of V){if(ie.toUpperCase().startsWith("FF"))continue;const de=sn(ie,b.category,y.autoRemoveWhitespace);M.push({id:je(),text:de,page:r,bbox:Mt(F,T,f,u,d),category:b.category})}}}catch{}H&&z.add(U)}const re=w[N.DrawingNumber];if(re)try{const U=new RegExp(re,"i"),F=_n(u,d),H=A.filter(ce=>ce.str.includes("-")&&ce.str.length>10);H.length>0&&H.forEach(ce=>{const Y=ce.str.match(U)});let b=null,q=1/0;const V=[];for(let ce=0;ce<A.length;ce++){if(z.has(ce))continue;const Y=A[ce],ae=Y.str.match(U);if(ae){const me=Mt(Y,T,f,u,d),De=F.x-me.x2;let Le;switch(d){case 0:Le=Math.max(me.y1,me.y2);break;case 90:Le=Math.max(me.y1,me.y2);break;case 180:Le=Math.min(me.y1,me.y2);break;case 270:Le=Math.min(me.y1,me.y2);break;default:Le=Math.max(me.y1,me.y2);break}const ke=F.y-Le,fe=De*De+ke*ke,Ce=Math.sqrt(fe);V.push({item:Y,index:ce,bbox:me,text:ae[0],distance:Ce,distanceSq:fe,dx:De,dy:ke,targetY:Le,isSelected:!1})}}const ie=ce=>{var me;let Y=0;const ae=ce.text;return ae.startsWith("-")||(Y+=1e3),/^[A-Z0-9]/i.test(ae)&&(Y+=500),/^[0-9]{5}[A-Z]/.test(ae)&&(Y+=300),((me=ae.match(/-/g))==null?void 0:me.length)>=3&&(Y+=200),ae.length>15&&(Y+=100),Y-=Math.sqrt(ce.distanceSq)*.1,Y};V.forEach(ce=>{ce.score=ie(ce)});const de=[...V].sort((ce,Y)=>Y.score-ce.score);if(de.slice(0,3).forEach((ce,Y)=>{}),de.length>0&&(b=de[0]),b&&V.forEach(ce=>{ce.isSelected=ce.index===b.index}),V.length>0&&[...V].sort((Y,ae)=>Y.distance-ae.distance).forEach((Y,ae)=>{const me=Y.isSelected?"🏆 SELECTED:":`${ae+1}.`}),b){const ce=b.text;M.push({id:je(),text:ce,page:r,bbox:b.bbox,category:N.DrawingNumber}),z.add(b.index)}}catch{}for(let U=0;U<A.length;U++){if(z.has(U))continue;const F=A[U],H=Mt(F,T,f,u,d);k.push({id:je(),text:F.str,page:r,bbox:H})}const le=M.filter(U=>U.category===N.Line);return M.filter(U=>U.category===N.Instrument),le.length>0,{tags:M,rawTextItems:k}},qn=(n,r,w)=>{const h=n.filter(A=>A.page===r);if(h.length===0)return[];const y=w.width,x=w.height,j=y*.45,u=/^(?:NOTE\s*)?(\d+)[.:)]?\s*(.*)/i,d=[...h].sort((A,z)=>{const B=A.bbox.y1-z.bbox.y1;return Math.abs(B)<5?A.bbox.x1-z.bbox.x1:B}),T=[];for(let A=0;A<d.length;A++){const z=d[A],P=z.text.trim().match(u);if(P&&z.bbox.x1>=j){const W=parseInt(P[1],10),se=P[2]?P[2].trim():"";T.push({number:W,initialText:se,startItem:z,startIndex:A,items:[z],text:se})}}if(T.length===0)return[];const f=[],M=200,k=y*.3;for(let A=0;A<T.length;A++){const z=T[A],B=T[A+1]||null;z.startItem.bbox.y1;const P=B?B.startItem.bbox.y1:x,W=[z.startItem];let se=z.initialText,re=z.startItem.bbox.y2;for(let U=z.startIndex+1;U<d.length;U++){const F=d[U];if(F.bbox.y1>=P)break;const H=F.text.trim();if(!H)continue;if(u.test(H)&&F.bbox.x1>=j)break;const b=Math.max(0,F.bbox.y1-re),q=F.bbox.x1>=k,V=b<=M||F.bbox.y1<re+20;if(q&&V)se.length>0?se+=" "+H:se=H,W.push(F),re=Math.max(re,F.bbox.y2);else if(q){if(!V&&b>M*1.5)break}}const le={x1:Math.min(...W.map(U=>U.bbox.x1)),y1:Math.min(...W.map(U=>U.bbox.y1)),x2:Math.max(...W.map(U=>U.bbox.x2)),y2:Math.max(...W.map(U=>U.bbox.y2))};f.push({number:z.number,text:se,items:W,bbox:le,page:r})}return f.forEach(A=>{A.items&&A.items.length,A.text.substring(0,80)}),f.length>0&&(f.reduce((z,B)=>z+(B.items?B.items.length:1),0)/f.length).toFixed(1),f};function Kn(n,r,w){if(n.length===0)return 0;const h=Math.log(n.length+1)*15,y=n.reduce((k,A)=>k+A.distance,0)/n.length,x=Math.max(0,30-y/10),d=new Set(n.map(k=>k.note.id)).size/Math.max(1,w.length)*30,T=new Set(n.map(k=>k.instrument.page)).size,f=Math.min(T*8,25);return h+x+d+f+25}function Jn(n){if(n.length===0)return{width:30,height:15,diagonal:33.5};let r=0,w=0;for(const j of n){const u=j.bbox.x2-j.bbox.x1,d=j.bbox.y2-j.bbox.y1;r+=u,w+=d}const h=r/n.length,y=w/n.length,x=Math.sqrt(h*h+y*y);return{width:h,height:y,diagonal:x}}async function Qn(n,r,w,h){const y=[],x=u=>{const d=u.toLowerCase();return d.includes("note")?"Note":d.includes("hold")?"Hold":null};for(const u of h){const d=n.filter(f=>f.page===u),T=r.filter(f=>f.page===u&&x(f.text)==="Note");for(const f of T){let M=null;const k=f.bbox.x2-f.bbox.x1,A=f.bbox.y2-f.bbox.y1,B=Math.sqrt(k*k+A*A)*w;for(const P of d){const W=Math.abs((P.bbox.x1+P.bbox.x2)/2-(f.bbox.x1+f.bbox.x2)/2),se=Math.abs((P.bbox.y1+P.bbox.y2)/2-(f.bbox.y1+f.bbox.y2)/2),re=Math.sqrt(W*W+se*se);re<=B&&(!M||re<M.distance)&&(M={instrument:P,distance:re})}M&&y.push({instrument:M.instrument,note:f,distance:M.distance})}}const j=Kn(y,n,r);return{connections:y,quality:j}}async function es(n,r,w,h){const y=[4,5,6],x=Jn(r),j=w.numPages;let u;j<=3?u=Math.min(2,j):j<=10?u=Math.floor(j/2):u=Math.floor(j*.4);const T=(await Promise.all(y.map(async(B,P)=>{h&&h(P/y.length*100,`박스 크기 ${B}배 테스트 중...`);const{connections:W,quality:se}=await Qn(n.filter(le=>le.page===u),r.filter(le=>le.page===u),B,[u]);return{distance:x.diagonal*B,quality:se,connections:W,multiplier:B}}))).reduce((B,P)=>P.quality>B.quality?P:B),f=new Map;f.set(u,T.connections.length);const M=T.connections.length>0?T.connections.reduce((B,P)=>B+P.distance,0)/T.connections.length:0,k=new Set(T.connections.map(B=>B.note.id)),A=r.filter(B=>B.page===u&&B.text.toLowerCase().includes("note")),z=A.length>0?k.size/A.length:0;return{distance:T.distance,score:T.quality,connectionCount:T.connections.length,details:{testedPages:[u],connectionsByPage:f,avgProximity:M,coverageRate:z*100}}}function ts(n,r,w){const h=[],y=new Set,x=d=>{const T=d.toLowerCase();return T.includes("note")?"Note":T.includes("hold")?"Hold":null},j=r.filter(d=>x(d.text)==="Note"),u=(d,T,f)=>{const M=Math.max(f.x1,Math.min(d.x,f.x2)),k=Math.max(f.y1,Math.min(d.y,f.y2)),A=d.x-M,z=d.y-k,B=Math.sqrt(A*A+z*z);return{intersects:B<=T,distance:B}};for(const d of n){const T={x:(d.bbox.x1+d.bbox.x2)/2,y:(d.bbox.y1+d.bbox.y2)/2},f=d.bbox.x2-d.bbox.x1,M=d.bbox.y2-d.bbox.y1,k=Math.sqrt(f*f+M*M)/2*3,A=j.filter(B=>B.page===d.page);let z=null;for(const B of A){const{intersects:P,distance:W}=u(T,k,B.bbox);P&&(!z||W<z.distance)&&(z={noteTag:B,distance:W})}if(z){const B=`${d.id}-${z.noteTag.id}`;y.has(B)||(h.push({id:je(),from:d.id,to:z.noteTag.id,type:te.Note}),y.add(B))}}return h}const on={numberPattern:/^(\d+)\s*[-.]?\s*(.*)$/,standaloneNumberPattern:/^(\d+)\s*[-.]?\s*$/,minXPosition:.35,alignmentTolerance:60,minAlignedNotes:1,maxYGap:400,maxHorizontalGap:250,maxLineGap:60};function un(n,r,w){const h=[],y=w*r.minXPosition,x=new Set,j=[...n].sort((T,f)=>T.bbox.y1-f.bbox.y1),u=j.filter(T=>T.bbox.x1>=y),d=[];for(let T=0;T<u.length;T++){const f=u[T],M=f.text.match(/^[\(\[]?(\d+)[\)\]]?\s*[-.:]?\s*(.*)$/);if(M){const k=M[1],A=M[2],z=f.text.match(/^[\(\[]?\d+[\)\]]?\s*[-.:]/),B=A.trim().length===0,P=f.text.match(/^[\(\[]?\d+[\)\]]/);if(z||B||P){const W=j.findIndex(se=>se===f);d.push({item:f,number:k,index:W})}}}for(let T=0;T<d.length;T++){const f=d[T],M=T<d.length-1?d[T+1].index:j.length,k=[f.item];x.add(f.item);const A=f.item.text.match(/^[\(\[]?\d+[\)\]]?\s*[-.:]?\s*(.*)$/);let z=A&&A[1]&&A[1].trim()?A[1].trim():"";const B=z.length===0;let P=f.item.bbox.x1,W=f.item.bbox.x2,se=!B,re=0;const le=3;for(let U=f.index+1;U<M;U++){const F=j[U];if(x.has(F))continue;const H=k[k.length-1],b=F.bbox.y1-H.bbox.y2;if(b>r.maxYGap)break;const q=U<M;!se&&F.text.trim().length>0&&(P=Math.min(P,F.bbox.x1),W=Math.max(W,F.bbox.x2),se=!0);const V=se?F.bbox.x1>=P-10&&F.bbox.x1<=W+10:!0,ie=Math.abs(F.bbox.y1-f.item.bbox.y1)<5&&F.bbox.x1>f.item.bbox.x2,de=B&&z.length===0&&U===f.index+1,ce=F.text.match(/^[A-Z]{4,}[:\s]/)||F.text.match(/^FIGURE\s+\d+/i)||F.text.match(/^TABLE\s+\d+/i);let Y=!1;if(!ce){if(q&&!ce&&V){const ae=F.text.match(/^[\(\[]?\d+[\)\]]?\s*[-.:]?\s/);F.bbox.x1>=y*.3,ae?F.bbox.x1>=y*.5&&V&&(Y=!0):(Y=!0,F.bbox.x1<y*.2&&F.bbox.x1<f.item.bbox.x1-400&&(Y=!1))}if(ie||de?Y=!0:!V&&se&&(Y=!1),Y){if(b>r.maxLineGap*2.5&&!ie&&!de){if(re++,re>le)break}else re=0;k.push(F),x.add(F),z&&(z+=" "),z+=F.text.trim()}else if(b>r.maxLineGap*4)break}}if(z||k.length>1){const U={x1:Math.min(...k.map(F=>F.bbox.x1)),y1:Math.min(...k.map(F=>F.bbox.y1)),x2:Math.max(...k.map(F=>F.bbox.x2)),y2:Math.max(...k.map(F=>F.bbox.y2))};h.push({number:f.number,text:z,bbox:U,items:k}),z.length>80&&z.substring(0,80)+""}}for(const T of u){if(x.has(T))continue;const f=T.text.match(/^[\(\[]?(\d+)[\)\]]?\s*[-.:]?\s+(.+)$/);f&&f[2].length>3&&(x.add(T),h.find(k=>k.number===f[1])||h.push({number:f[1],text:f[2],bbox:T.bbox,items:[T]}))}return h}function ns(n,r){const w=new Map;for(const h of n){const y=h.bbox.x1;let x=!1;for(const[j,u]of w.entries())if(Math.abs(y-j)<=r){u.push(h),x=!0;break}x||w.set(y,[h])}return w}function ss(n,r,w){if(n.length===0)return 0;const h=Math.min(n.length*10,30),x=Math.max(...Array.from(r.values()).map(k=>k.length))/Math.max(1,n.length)*30,j=n.map(k=>parseInt(k.number)).sort((k,A)=>k-A);let u=0;for(let k=1;k<j.length;k++)j[k]===j[k-1]+1&&u++;const d=u/Math.max(1,j.length-1)*20,T=[...n].sort((k,A)=>k.bbox.y1-A.bbox.y1),f=[];for(let k=1;k<T.length;k++)f.push(T[k].bbox.y1-T[k-1].bbox.y2);let M=0;if(f.length>0){const k=f.reduce((B,P)=>B+P,0)/f.length,A=f.reduce((B,P)=>B+Math.pow(P-k,2),0)/f.length,z=Math.sqrt(A);M=Math.max(0,20-z/k*20)}return h+x+d+M}async function os(n,r,w,h){const y=[],x=new Map;for(const u of h){const d=n.filter(f=>f.page===u),T=un(d,r,w);if(T.length>0){const f=ns(T,r.alignmentTolerance);y.push(...T.map(M=>({...M,page:u})));for(const[M,k]of f.entries()){const A=Array.from(x.keys()).find(z=>Math.abs(z-M)<=r.alignmentTolerance);A!==void 0?x.get(A).push(...k):x.set(M,k)}}}const j=ss(y,x);return{notes:y,score:j,alignmentGroups:x}}function rs(n,r,w,h){const y=[],x=new Map,j=new Map;for(const u of n)if(u.text.toUpperCase().includes("NOTE")){const d=j.get(u.page)||[];d.push(u),j.set(u.page,d)}for(const[u,d]of j.entries()){const T=r.filter(M=>M.page===u),f=un(T,w,h);for(const M of d){const k=M.text.match(/NOTE\s*(\d+)/i);if(!k){if(d.length===1&&f.length>0){for(const B of f){for(const se of B.items)y.push({id:je(),from:M.id,to:se.id,type:te.Annotation});const P=x.get(M.id)||"",W=P?P+`
`+B.text:B.text;x.set(M.id,W)}f.reduce((B,P)=>B+P.items.length,0)}continue}const A=k[1],z=f.find(B=>B.number===A);if(z&&z.items.length>0){for(const B of z.items)y.push({id:je(),from:M.id,to:B.id,type:te.Annotation});x.set(M.id,z.text),z.text.length>60?z.text.substring(0,60)+"":z.text}}}return{relationships:y,noteDescriptions:x}}async function is(n,r,w){const h=[{minXPosition:.45,alignmentTolerance:40,maxYGap:300,maxHorizontalGap:200,maxLineGap:50},{minXPosition:.5,alignmentTolerance:35,maxYGap:280,maxHorizontalGap:180,maxLineGap:45},{minXPosition:.4,alignmentTolerance:45,maxYGap:350,maxHorizontalGap:220,maxLineGap:55},{minXPosition:.55,alignmentTolerance:30,maxYGap:250,maxHorizontalGap:150,maxLineGap:40},{minXPosition:.35,alignmentTolerance:50,maxYGap:400,maxHorizontalGap:250,maxLineGap:60}],j=(await r.getPage(1)).getViewport({scale:1}).width,u=r.numPages,d=[],T=Math.min(5,Math.max(3,Math.floor(u*.3))),f=Math.min(2,Math.floor(u*.1));for(let k=0;k<T;k++){const A=f+Math.floor(k*(u-f)/T);d.push(Math.min(A+1,u))}let M={pattern:on,score:0,detectedNotes:[],alignmentGroups:new Map};for(let k=0;k<h.length;k++){w&&w(k/h.length*100,`빠른 테스트 ${k+1}/${h.length}`);const A={...on,...h[k]},{notes:z,score:B,alignmentGroups:P}=await os(n,A,j,d);B>M.score&&(M={pattern:A,score:B,detectedNotes:z.map(W=>({number:W.number,text:W.text,bbox:W.bbox,page:W.page})),alignmentGroups:P})}return M}const as={verticalRange:{min:5,max:30,step:5},horizontalRange:{min:5,max:40,step:5},autoLinkRange:{min:20,max:50,step:10},maxPagesToTest:3,minConfidenceScore:.7};function ls(n){const r=n.filter(T=>T.category===N.Instrument);if(r.length===0)return 0;const w=Math.log(r.length+1)*10,y=r.filter(T=>/^[A-Z]{2,4}[-\s]?\d{3,4}[A-Z]?$/i.test(T.text)).length/r.length*30,x=new Set(r.map(T=>T.page)).size,j=Math.min(x*5,20),u=r.length/x,d=u>100?Math.max(0,20-(u-100)*.2):20;return w+y+j+d}async function xn(n,r,w,h,y){const x=[];for(const u of r)try{const{tags:d}=await dn(n,u,w,h,y);x.push(...d)}catch{}const j=ls(x);return{tags:x,quality:j}}async function cs(n,r,w,h,y={},x){const j={...as,...y},u=n.numPages,d=[],T=u>5?3:1;if(u<=3)for(let P=1;P<=u;P++)d.push(P);else if(u<=10){const P=Math.floor(u/2);d.push(P),P-1>=T&&d.push(P-1),P+1<=u&&d.push(P+1),d.sort((W,se)=>W-se)}else{const P=Math.floor(u*.2),W=Math.floor(u*.8),se=W-P,re=Math.max(1,Math.floor(se/j.maxPagesToTest));for(let le=P;le<=W&&d.length<j.maxPagesToTest;le+=re)le>T&&d.push(le)}d.length===0&&d.push(Math.max(1,Math.floor(u/2)));const f=Math.floor((j.verticalRange.max-j.verticalRange.min)/j.verticalRange.step)+1,M=Math.floor((j.horizontalRange.max-j.horizontalRange.min)/j.horizontalRange.step)+1,k=Math.floor((j.autoLinkRange.max-j.autoLinkRange.min)/j.autoLinkRange.step)+1,A=f*M*k;let z=0,B={tolerances:w,score:0,tagCount:0,details:{vertical:w[N.Instrument].vertical,horizontal:w[N.Instrument].horizontal,autoLinkDistance:w[N.Instrument].autoLinkDistance,testedPages:d,tagsByPage:new Map}};for(let P=j.verticalRange.min;P<=j.verticalRange.max;P+=j.verticalRange.step)for(let W=j.horizontalRange.min;W<=j.horizontalRange.max;W+=j.horizontalRange.step)for(let se=j.autoLinkRange.min;se<=j.autoLinkRange.max;se+=j.autoLinkRange.step){z++;const re=z/A*100;x&&x(re,`테스트 중: 수직:${P}px, 수평:${W}px, 링크:${se}px`);const le={[N.Instrument]:{vertical:P,horizontal:W,autoLinkDistance:se}},{tags:U,quality:F}=await xn(n,d,r,le,h),H=U.filter(q=>q.category===N.Instrument),b=new Map;d.forEach(q=>{const V=H.filter(ie=>ie.page===q).length;b.set(q,V)}),F>B.score&&(B={tolerances:le,score:F,tagCount:H.length,details:{vertical:P,horizontal:W,autoLinkDistance:se,testedPages:d,tagsByPage:b}})}return B}async function ds(n,r,w,h,y){const x=[{vertical:15,horizontal:20,autoLinkDistance:30},{vertical:10,horizontal:15,autoLinkDistance:25},{vertical:20,horizontal:25,autoLinkDistance:35},{vertical:12,horizontal:18,autoLinkDistance:30}],j=n.numPages;let u;j<=3?u=Math.min(2,j):j<=10?u=Math.floor(j/2):u=Math.floor(j*.4);const T=(await Promise.all(x.map(async(k,A)=>{y&&y(A/x.length*30,`사전 설정 테스트 ${A+1}/${x.length}`);const z={[N.Instrument]:k},{tags:B,quality:P}=await xn(n,[u],r,z,h);return{values:k,quality:P,tags:B}}))).reduce((k,A)=>A.quality>k.quality?A:k),f={verticalRange:{min:Math.max(5,T.values.vertical-5),max:Math.min(30,T.values.vertical+5),step:2},horizontalRange:{min:Math.max(5,T.values.horizontal-5),max:Math.min(40,T.values.horizontal+5),step:2},autoLinkRange:{min:Math.max(20,T.values.autoLinkDistance-10),max:Math.min(50,T.values.autoLinkDistance+10),step:5},maxPagesToTest:Math.min(3,Math.max(1,n.numPages-3))};return y&&y(30,"파라미터 미세 조정 중..."),cs(n,r,w,h,f,y?(k,A)=>y(30+k*.7,A):void 0)}hn.workerSrc=new URL("/P-ID-Tag-Extractor/pdf.worker.min.mjs",import.meta.url).href;const us=({isOpen:n,message:r,onConfirm:w,onCancel:h})=>n?e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 animate-fade-in-up",style:{animationDuration:"0.2s"},onClick:h,children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl shadow-2xl w-full max-w-md text-gray-900",onClick:y=>y.stopPropagation(),children:[e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-bold mb-2 text-gray-900",children:"Confirm Action"}),e.jsx("div",{className:"text-gray-700 whitespace-pre-line",children:r})]}),e.jsxs("div",{className:"p-4 bg-gray-50 rounded-b-xl border-t border-gray-200 flex justify-end items-center space-x-2",children:[e.jsx("button",{onClick:h,className:"px-4 py-2 text-sm font-semibold text-gray-600 bg-transparent rounded-md hover:bg-gray-100 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:w,className:"px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-white",children:"Confirm"})]})]})}):null,xs=()=>{const[n,r]=o.useState(null),[w,h]=o.useState(null),[y,x]=o.useState([]),[j,u]=o.useState([]),[d,T]=o.useState([]),[f,M]=o.useState([]),[k,A]=o.useState([]),[z]=o.useState([]),[B,P]=o.useState(!1),[W,se]=o.useState({current:0,total:0}),[re,le]=o.useState(!1),[U,F]=o.useState(!1),[H,b]=o.useState({percent:0,message:""}),[q]=o.useState(()=>{const a=localStorage.getItem("pid-tagger-auto-optimize");return a!==null?a==="true":!0}),[V]=o.useState(()=>{const a=localStorage.getItem("pid-tagger-auto-optimize-notes");return a!==null?a==="true":!0}),[ie,de]=o.useState({isOpen:!1,message:"",onConfirm:()=>{}}),[ce,Y]=o.useState(1),[ae,me]=o.useState(1.5),[De,Le]=o.useState("select"),[ke,fe]=o.useState(null),[Ce,$e]=o.useState({tags:{line:!0,instrument:!0,drawingNumber:!0,notesAndHolds:!0},descriptions:!0,relationships:{connection:!0,installation:!0,annotation:!1,note:!1}}),Te=Object.values(Ce.relationships).some(Boolean),Me=o.useCallback(a=>{$e(l=>({...l,relationships:{connection:a,installation:a,annotation:a,note:a}}))},[]),[it,et]=o.useState(!0),[Pe,He]=o.useState(!1),[Re,Fe]=o.useState(()=>localStorage.getItem("pid-tagger-showAllRelationships")!=="false"),[ge,g]=o.useState(()=>localStorage.getItem("pid-tagger-showOnlySelectedRelationships")==="true"),[L,oe]=o.useState(()=>{try{const a=localStorage.getItem("pid-tagger-patterns");if(!a)return yt;let l=JSON.parse(a);if(l.Line||(l.라인?(l.Line=l.라인,delete l.라인):l.Line=yt.Line||yt[N.Line],localStorage.setItem("pid-tagger-patterns",JSON.stringify(l))),typeof l=="object"&&l!==null&&!Array.isArray(l)){let m=!1;for(const E in yt)l.hasOwnProperty(E)||(l[E]=yt[E],m=!0);if(typeof l[N.Instrument]=="string"){const E=l[N.Instrument],S="\\s?",O=E.indexOf(S);O>-1?l[N.Instrument]={func:E.substring(0,O),num:E.substring(O+S.length)}:l[N.Instrument]={func:E,num:""},m=!0}return m&&localStorage.setItem("pid-tagger-patterns",JSON.stringify(l)),l}return yt}catch{return yt}}),[_,ee]=o.useState(()=>{try{const a=localStorage.getItem("pid-tagger-tolerances");let l=a?JSON.parse(a):Et;return typeof l=="object"&&l!==null&&!Array.isArray(l)?(l[N.Instrument]?l[N.Instrument].hasOwnProperty("autoLinkDistance")||(l[N.Instrument].autoLinkDistance=Et[N.Instrument].autoLinkDistance):l[N.Instrument]={...Et[N.Instrument]},l):Et}catch{return Et}}),[Q,ye]=o.useState(()=>{try{const a=localStorage.getItem("pid-tagger-app-settings");if(a){const l=JSON.parse(a);return{...Je,...l,autoGenerateLoops:!0,autoRemoveWhitespace:!0,hyphenSettings:{...Je.hyphenSettings,...l.hyphenSettings||{}},loopRules:{...Je.loopRules,...l.loopRules||{}},instrumentMappings:{...Je.instrumentMappings,...l.instrumentMappings||{}}}}return Je}catch{return Je}}),[ve,Ve]=o.useState(()=>{var a,l,m,E,S,O;try{const G=localStorage.getItem("pid-tagger-color-settings");if(G){const Z=JSON.parse(G);if(Z.tags&&!Z.entities)return{entities:{...Z.tags,description:((a=Z.relationships)==null?void 0:a.description)||Xe.entities.description},relationships:{connection:((l=Z.relationships)==null?void 0:l.connection)||Xe.relationships.connection,installation:((m=Z.relationships)==null?void 0:m.installation)||Xe.relationships.installation,annotation:((E=Z.relationships)==null?void 0:E.annotation)||Xe.relationships.annotation,note:((S=Z.relationships)==null?void 0:S.note)||Xe.relationships.note},highlights:{noteRelated:((O=Z.relationships)==null?void 0:O.noteRelated)||Xe.highlights.noteRelated,selected:Xe.highlights.selected}};if(Z.entities)return Z}return Xe}catch{return Xe}});o.useEffect(()=>{try{localStorage.setItem("pid-tagger-patterns",JSON.stringify(L))}catch{}},[L]),o.useEffect(()=>{try{localStorage.setItem("pid-tagger-tolerances",JSON.stringify(_))}catch{}},[_]),o.useEffect(()=>{try{localStorage.setItem("pid-tagger-app-settings",JSON.stringify(Q))}catch{}},[Q]),o.useEffect(()=>{try{localStorage.setItem("pid-tagger-color-settings",JSON.stringify(ve))}catch{}},[ve]),o.useEffect(()=>{localStorage.setItem("pid-tagger-showAllRelationships",Re.toString())},[Re]),o.useEffect(()=>{localStorage.setItem("pid-tagger-showOnlySelectedRelationships",ge.toString())},[ge]),o.useEffect(()=>{const a=l=>{const m=l.target;m.tagName==="INPUT"||m.tagName==="TEXTAREA"||m.tagName==="SELECT"||(l.key.toLowerCase()==="s"?(l.preventDefault(),et(E=>!E)):l.key.toLowerCase()==="v"&&(l.preventDefault(),window.dispatchEvent(new CustomEvent("toggleVisibilityPanel"))))};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[]);const he=(a,l)=>{de({isOpen:!0,message:a,onConfirm:l})},at=()=>{de({isOpen:!1,message:"",onConfirm:()=>{}}),He(!1)},ut=()=>{ie.onConfirm(),at()},tt=o.useCallback(async(a,l,m,E)=>{P(!0),x([]),u([]),T([]),A([]),se({current:0,total:a.numPages}),Y(1);try{let S=[],O=[];for(let Z=1;Z<=a.numPages;Z++){const{tags:K,rawTextItems:c}=await dn(a,Z,l,m,Q);S=[...S,...K],O=[...O,...c],se(D=>({...D,current:Z}))}x(S),u(O),T([]);let G=[];if(V){const Z=S.filter(c=>c.category===N.Instrument),K=S.filter(c=>c.category===N.NotesAndHolds);if(Z.length>0&&K.length>0){F(!0),b({percent:0,message:"노트 연결 최적화 중..."});try{const c=await es(Z,K,a,(R,X)=>{b({percent:R,message:X})});localStorage.setItem("pid-tagger-optimized-note-distance",c.distance.toString());const D=ts(Z,K,c.distance);D.length>0&&(G=[...G,...D])}catch{}}if(K.length>0){b({percent:0,message:"노트 설명 패턴 최적화 중..."});try{const c=await is(O,a,(D,R)=>{b({percent:D,message:R})});if(c.score>0){localStorage.setItem("pid-tagger-optimized-note-description-pattern",JSON.stringify(c.pattern));const X=(await a.getPage(1)).getViewport({scale:1}).width,{relationships:t}=rs(K,O,c.pattern,X);t.length>0&&(G=[...G,...t])}}catch{}}F(!1),T(G)}(E!=null&&E.autoGenerateLoops||Q.autoGenerateLoops)&&setTimeout(()=>{Ee(S)},100)}catch{}finally{P(!1)}},[Q,V]),Ze=o.useCallback(async a=>{F(!0),b({percent:0,message:"최적화 시작 중..."});try{const l=await ds(a,L,_,Q,(m,E)=>{b({percent:m,message:E})});return ee(l.tolerances),localStorage.setItem("pid-tagger-tolerances",JSON.stringify(l.tolerances)),b({percent:100,message:`✅ 최적 설정 발견: ${l.tagCount}개 태그 감지됨`}),setTimeout(()=>{F(!1),b({percent:0,message:""})},2e3),l.tolerances}catch{return F(!1),b({percent:0,message:"최적화 실패"}),_}},[L,_,Q,ee]),Lt=o.useCallback(async a=>{r(a),P(!0),x([]),u([]),T([]),se({current:0,total:0}),Y(1);try{const l=await a.arrayBuffer(),E=await pn({data:l}).promise;h(E);let S=_;q&&(S=await Ze(E)),await tt(E,L,S,Q)}catch{P(!1)}},[L,_,Q,tt,q,Ze]),xt=(a,l,m,E)=>{const S={...a,[N.Line]:a[N.Line]||a.Line||yt[N.Line]};oe(S),ee(l);const O={...m,autoGenerateLoops:!0,autoRemoveWhitespace:!0};ye(O),Ve(E),le(!1),localStorage.setItem("pid-tagger-patterns",JSON.stringify(S)),localStorage.setItem("pid-tagger-tolerances",JSON.stringify(l)),localStorage.setItem("pid-tagger-app-settings",JSON.stringify(O)),localStorage.setItem("pid-tagger-color-settings",JSON.stringify(E))},pt=async(a,l,m,E,S)=>{const O={...a,[N.Line]:a[N.Line]||a.Line||yt[N.Line]};oe(O),ee(l);const G={...m,autoGenerateLoops:!0,autoRemoveWhitespace:!0};ye(G),Ve(E),le(!1),localStorage.setItem("pid-tagger-patterns",JSON.stringify(O)),localStorage.setItem("pid-tagger-tolerances",JSON.stringify(l)),localStorage.setItem("pid-tagger-app-settings",JSON.stringify(G)),localStorage.setItem("pid-tagger-color-settings",JSON.stringify(E)),S==="patterns"&&w&&(d.length>0||k.length>0||y.some(K=>K.isReviewed)||k.length>0?he(`패턴 설정이 변경되어 PDF를 다시 스캔해야 합니다.

⚠️ Rescanning will delete all manually created content:

• Tag relationships (Connection, Installation, Note, etc.)
• Manually created loops
• Tag review status (✓ checkmarks)

✅ Note & Hold descriptions will be preserved.

💡 If you have important work, please Export your project as backup first.

Do you want to continue?`,()=>tt(w,O,l,m)):await tt(w,O,l,m))},lt=o.useCallback(a=>{$e(l=>({...l,...a,tags:a.tags?{...l.tags,...a.tags}:l.tags,relationships:a.relationships?{...l.relationships,...a.relationships}:l.relationships}))},[]),mt=o.useCallback(a=>{$e(l=>({...l,tags:{...l.tags,[a]:!l.tags[a]}}))},[]),Be=o.useCallback(a=>{$e(l=>({...l,relationships:{...l.relationships,[a]:!l.relationships[a]}}))},[]),nt=o.useCallback(()=>{const l=!Object.values(Ce.tags).every(Boolean);$e(m=>({...m,tags:{line:l,instrument:l,drawingNumber:l,notesAndHolds:l},descriptions:l}))},[Ce.tags]),ht=o.useCallback(()=>{const l=!Object.values(Ce.relationships).every(Boolean);$e(m=>({...m,relationships:{connection:l,installation:l,annotation:l,note:l}}))},[Ce.relationships]),st=o.useCallback((a,l)=>{if(!a||a.length===0)return;const m=a[0].page;if(a.some(D=>D.page!==m))return;const E=[...a].sort((D,R)=>{const X=D.bbox.y1-R.bbox.y1;return Math.abs(X)>5?X:D.bbox.x1-R.bbox.x1}),O=(()=>{switch(l){case N.Line:return Q.hyphenSettings.line;case N.Instrument:return Q.hyphenSettings.instrument;case N.DrawingNumber:return Q.hyphenSettings.drawingNumber;case N.NotesAndHolds:return Q.hyphenSettings.notesAndHolds;default:return!1}})()?E.map(D=>D.text).join("-"):E.map(D=>D.text).join(""),G=Q.autoRemoveWhitespace&&l!==N.NotesAndHolds?O.replace(/\s+/g,""):O,Z=a.reduce((D,R)=>({x1:Math.min(D.x1,R.bbox.x1),y1:Math.min(D.y1,R.bbox.y1),x2:Math.max(D.x2,R.bbox.x2),y2:Math.max(D.y2,R.bbox.y2)}),{x1:1/0,y1:1/0,x2:-1/0,y2:-1/0}),K={id:je(),text:G,page:m,bbox:Z,category:l,sourceItems:a};x(D=>[...D,K]);const c=new Set(a.map(D=>D.id));u(D=>D.filter(R=>!c.has(R.id))),T(D=>D.filter(R=>!(R.type===te.Annotation&&c.has(R.to))))},[Q.autoRemoveWhitespace,Q.hyphenSettings]),Ae=o.useCallback(a=>{const{text:l,bbox:m,page:E,category:S}=a;if(!l||!m||!E||!S)return;const O=Q.autoRemoveWhitespace&&S!==N.NotesAndHolds?l.replace(/\s+/g,""):l,G={id:je(),text:O,page:E,bbox:m,category:S,sourceItems:[]};x(Z=>[...Z,G])},[Q.autoRemoveWhitespace]),ct=o.useCallback(a=>{const l=new Set(a),m=y.filter(S=>l.has(S.id)),E=[];for(const S of m)if(S.sourceItems&&S.sourceItems.length>0){const O=S.sourceItems.map(G=>({id:je(),text:G.text,page:S.page,bbox:G.bbox}));E.push(...O)}else{const O={id:je(),text:S.text,page:S.page,bbox:S.bbox};E.push(O)}x(S=>S.filter(O=>!l.has(O.id))),u(S=>[...S,...E]),T(S=>S.filter(O=>!l.has(O.from)&&!l.has(O.to)))},[y]),We=o.useCallback(a=>{if(!a||a.length<2)return;const l=j.filter(K=>a.includes(K.id));if(l.length<2)return;const m=l[0].page;if(l.some(K=>K.page!==m))return;const S=[...l].sort((K,c)=>{const D=K.bbox.y1-c.bbox.y1;return Math.abs(D)>5?D:K.bbox.x1-c.bbox.x1}).map(K=>K.text).join(" "),O=l.reduce((K,c)=>({x1:Math.min(K.x1,c.bbox.x1),y1:Math.min(K.y1,c.bbox.y1),x2:Math.max(K.x2,c.bbox.x2),y2:Math.max(K.y2,c.bbox.y2)}),{x1:1/0,y1:1/0,x2:-1/0,y2:-1/0}),G={id:je(),text:S,page:m,bbox:O},Z=new Set(a);u(K=>[...K.filter(c=>!Z.has(c.id)),G]),T(K=>K.filter(c=>!Z.has(c.to)))},[j]),Nt=o.useCallback(a=>{const l=new Set(a);u(m=>m.filter(E=>!l.has(E.id))),T(m=>m.filter(E=>!l.has(E.to)))},[]),ot=o.useCallback((a,l)=>{x(m=>m.map(E=>E.id===a?{...E,text:l}:E))},[]),ze=o.useCallback((a,l)=>{u(m=>m.map(E=>E.id===a?{...E,text:l}:E))},[]),Ye=o.useCallback((a,l="Note")=>{if(!a||a.length===0)return;const m=[...a].sort((i,v)=>i.bbox.y1-v.bbox.y1),E=m.map(i=>i.text).join(" "),S={x1:Math.min(...m.map(i=>i.bbox.x1)),y1:Math.min(...m.map(i=>i.bbox.y1)),x2:Math.max(...m.map(i=>i.bbox.x2)),y2:Math.max(...m.map(i=>i.bbox.y2))},O=m[0].page,G=l,Z=f.filter(i=>i.metadata.type===G&&i.page===O).map(i=>i.metadata.number),K=Z.length>0?Math.max(...Z)+1:1,c={id:je(),text:E,page:m[0].page,bbox:S,sourceItems:m,metadata:{type:G,scope:"Specific",number:K}};M(i=>[...i,c]);const D=i=>{const v=i.match(/\d+/g);return v?v.map(C=>parseInt(C,10)):[]},R=i=>{const v=i.toLowerCase();return v.includes("note")?"Note":v.includes("hold")?"Hold":null},X=y.filter(i=>i.category===N.NotesAndHolds&&i.page===O),t=[];for(const i of X){const v=R(i.text);if(!v||v!==G)continue;D(i.text).includes(K)&&(`${i.id}${c.id}`,d.some(J=>J.from===i.id&&J.to===c.id&&J.type===te.Description)||t.push({id:je(),from:i.id,to:c.id,type:te.Description}))}t.length>0&&T(i=>[...i,...t]);const s=a.filter(i=>"category"in i).map(i=>i.id);s.length>0&&x(i=>i.filter(v=>!s.includes(v.id)));const p=a.filter(i=>!("category"in i)).map(i=>i.id);p.length>0&&u(i=>i.filter(v=>!p.includes(v.id)))},[f,y,d]),xe=o.useCallback(a=>{Ye(a,"Hold")},[Ye]),At=o.useCallback(a=>{const l=new Set(a);f.filter(E=>l.has(E.id)).forEach(E=>{E.sourceItems.forEach(S=>{"category"in S?x(O=>O.some(Z=>Z.id===S.id)?O:[...O,S]):u(O=>O.some(Z=>Z.id===S.id)?O:[...O,S])})}),M(E=>E.filter(S=>!l.has(S.id))),T(E=>E.filter(S=>!l.has(S.from)&&!l.has(S.to)))},[f]),Ne=o.useCallback((a,l,m)=>{M(E=>{const S=E.find(G=>G.id===a);if(!S)return E;let O=m;if(S.metadata.type!==m.type){const G=E.filter(K=>K.id!==a&&K.metadata.type===m.type&&K.page===S.page).map(K=>K.metadata.number),Z=G.length>0?Math.max(...G)+1:1;O={...m,number:Z}}return E.map(G=>G.id===a?{...G,text:l,metadata:O}:G)})},[]),ft=a=>{if(!a||typeof a!="object")return!1;const l=["pdfFileName","exportDate","tags","relationships","rawTextItems"];for(const m of l)if(!(m in a))return!1;if(!Array.isArray(a.tags)||!Array.isArray(a.relationships)||!Array.isArray(a.rawTextItems)||a.descriptions&&!Array.isArray(a.descriptions))return!1;for(const m of a.tags)if(!m.id||!m.text||!m.page||!m.bbox||!m.category||!m.bbox.hasOwnProperty("x1")||!m.bbox.hasOwnProperty("y1")||!m.bbox.hasOwnProperty("x2")||!m.bbox.hasOwnProperty("y2"))return!1;for(const m of a.relationships)if(!m.id||!m.from||!m.to||!m.type||!Object.values(te).includes(m.type))return!1;for(const m of a.rawTextItems)if(!m.id||!m.text||!m.page||!m.bbox)return!1;return!0},Tt=a=>{const l=m=>m.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/javascript:/gi,"").replace(/on\w+="[^"]*"/gi,"");return{...a,pdfFileName:l(a.pdfFileName),tags:a.tags.map(m=>({...m,text:l(m.text)})),rawTextItems:a.rawTextItems.map(m=>({...m,text:l(m.text)})),descriptions:(a.descriptions||[]).map(m=>({...m,text:l(m.text)}))}},wt=o.useCallback(a=>{var m,E,S;if(!ft(a)){alert("프로젝트 파일 구조가 잘못되었거나 손상된 데이터입니다. 불러올 수 없습니다.");return}const l=Tt(a);x(l.tags),T(l.relationships),u(l.rawTextItems),M(l.descriptions||[]),A([]),(m=l.settings)!=null&&m.patterns&&oe(l.settings.patterns),(E=l.settings)!=null&&E.tolerances&&ee(l.settings.tolerances),(S=l.settings)!=null&&S.appSettings&&ye(l.settings.appSettings)},[]);o.useCallback(async a=>{if(!a||!n){alert("프로젝트 파일을 가져오기 전에 PDF 파일을 먼저 열어주세요.");return}const l=50*1024*1024;if(a.size>l){alert("프로젝트 파일이 너무 큽니다. 최대 파일 크기는 50MB입니다.");return}if(!a.name.toLowerCase().endsWith(".json")){alert("유효한 JSON 프로젝트 파일을 선택해주세요.");return}const m=new FileReader;m.onload=E=>{var S,O;try{const G=(S=E.target)==null?void 0:S.result;if(!G)throw new Error("File content is empty");if(G.includes("<script>")||G.includes("javascript:"))throw new Error("Project file contains potentially malicious content");const Z=JSON.parse(G);if(Z.pdfFileName!==n.name){const K=((O=Z.pdfFileName)==null?void 0:O.replace(/[<>]/g,""))||"Unknown";he(`이 프로젝트 파일은 다른 PDF("${K}")용인 것 같습니다. 현재 "${n.name}"이(가) 열려 있습니다. 그래도 프로젝트 데이터를 불러오시겠습니까?`,()=>wt(Z))}else wt(Z)}catch(G){let Z="Could not load project. ";G instanceof SyntaxError?Z+="The file contains invalid JSON format.":G.message.includes("malicious")?Z+="The file contains potentially unsafe content.":Z+="The file might be corrupted or in an invalid format.",alert(Z)}},m.onerror=()=>{alert("파일 읽기 오류. 다시 시도해주세요.")},m.readAsText(a)},[n,wt,he]),o.useCallback(()=>{if(!n)return;const a={pdfFileName:n.name,exportDate:new Date().toISOString(),tags:y,relationships:d,rawTextItems:j,descriptions:f,loops:k,settings:{patterns:L,tolerances:_,appSettings:Q}},l=JSON.stringify(a,null,2),m=new Blob([l],{type:"application/json"}),E=URL.createObjectURL(m),S=document.createElement("a");S.href=E;const O=n.name.replace(/\.pdf$/i,"")+"-project.json";S.download=O,document.body.appendChild(S),S.click(),document.body.removeChild(S),URL.revokeObjectURL(E)},[n,y,d,j,L,_]);const St=(a,l,m)=>{const E=[[m.x1,m.y1],[m.x2,m.y1],[m.x1,m.y2],[m.x2,m.y2],[(m.x1+m.x2)/2,(m.y1+m.y2)/2]];return Math.min(...E.map(([S,O])=>Math.sqrt((a-S)**2+(l-O)**2)))},gt=o.useCallback(()=>{var m;const a=(m=_[N.Instrument])==null?void 0:m.autoLinkDistance;if(typeof a!="number"){alert("자동 연결 거리가 설정되지 않았습니다. 설정을 확인해주세요.");return}He(!0),setTimeout(()=>{he(`현재 거리 설정(${a}px)에 따라 모든 계기 태그에 대한 설명 연결을 자동으로 생성합니다. 많은 관계가 생성될 수 있습니다. 계속하시겠습니까?`,()=>{He(!1),l()})},500);const l=()=>{const E=y.filter(Z=>Z.category===N.Instrument),S=new Set(d.filter(Z=>Z.type===te.Annotation).map(Z=>Z.to)),O=j.filter(Z=>!S.has(Z.id)),G=[];for(const Z of O){if(S.has(Z.id))continue;const K=E.filter(R=>R.page===Z.page);let c=null,D=1/0;for(const R of K){const X={x:(R.bbox.x1+R.bbox.x2)/2,y:(R.bbox.y1+R.bbox.y2)/2},t=St(X.x,X.y,Z.bbox);t<=a&&t<D&&(D=t,c=R)}c&&(G.push({id:je(),from:c.id,to:Z.id,type:te.Annotation}),S.add(Z.id))}if(G.length>0){const Z=new Set(d.map(c=>`${c.from}-${c.to}-${c.type}`)),K=G.filter(c=>!Z.has(`${c.from}-${c.to}-${c.type}`));K.length>0?(T(c=>[...c,...K]),alert(`${K.length}개의 새 설명 연결이 생성되었습니다.`)):alert("새로운 설명 연결을 찾을 수 없습니다. 이미 존재할 수 있습니다.")}else alert("현재 설정으로 새 설명 연결을 찾을 수 없습니다.")};he(`현재 거리 설정(${a}px)에 따라 모든 계기 태그에 대한 설명 연결을 자동으로 생성합니다. 많은 관계가 생성될 수 있습니다. 계속하시겠습니까?`,l)},[y,j,d,_,he]);o.useCallback(()=>{const a=d.filter(l=>l.type!==te.Note);T(a),alert("All NOTE connections have been cleared. Please re-run auto-link to create correct connections.")},[d,T]);const dt=o.useCallback(async()=>{const a=E=>{const S=E.toLowerCase();return S.includes("note")?"Note":S.includes("hold")?"Hold":null},l=E=>{const S=E.match(/\d+/g);return S?S.map(O=>parseInt(O,10)):[]};he("유형과 번호 매칭을 기반으로 노트 & 홀드 태그와 해당 설명 간의 연결을 자동으로 생성합니다. 계속하시겠습니까?",async()=>{const E=y.filter(t=>t.category===N.NotesAndHolds),S=new Set(d.filter(t=>t.type===te.Description).map(t=>`${t.from}-${t.to}`)),O=[];for(const t of E){const s=a(t.text);if(!s)continue;const p=l(t.text);if(p.length!==0)for(const i of p){const v=f.filter(C=>C.metadata.type===s&&C.metadata.number===i&&C.metadata.scope==="Specific"&&C.page===t.page);for(const C of v){const $=`${t.id}-${C.id}`;S.has($)||(O.push({id:je(),from:t.id,to:C.id,type:te.Description}),S.add($))}}}if(O.length>0){const t=new Set(d.map(p=>`${p.from}-${p.to}-${p.type}`)),s=O.filter(p=>!t.has(`${p.from}-${p.to}-${p.type}`));s.length>0&&T(p=>[...p,...s])}if(!w){alert("PDF 문서가 로드되지 않았습니다.");return}let G=[],Z=[],K=[];for(let t=1;t<=w.numPages;t++)try{const p=(await w.getPage(t)).getViewport({scale:1}),i=qn(j,t,p);if(i&&i.length>0){G.push(...i);for(const v of i)if(!f.find($=>$.page===t&&$.metadata.type==="Note"&&$.metadata.number===v.number)){const $={id:je(),text:v.text,page:v.page,bbox:v.bbox,sourceItems:v.items||[],metadata:{type:"Note",scope:"Specific",number:v.number}};Z.push($);const J=y.filter(I=>I.category===N.NotesAndHolds&&I.page===t&&a(I.text)==="Note");for(const I of J)l(I.text).includes(v.number)&&(d.some(we=>we.from===I.id&&we.type===te.Description)||K.some(we=>we.from===I.id&&we.to===$.id)||K.push({id:je(),from:I.id,to:$.id,type:te.Description}))}}}catch{}const c=(t,s,p,i="")=>{const v=Math.max(p.x1,Math.min(t.x,p.x2)),C=Math.max(p.y1,Math.min(t.y,p.y2)),$=t.x-v,J=t.y-C,I=$*$+J*J;return Math.sqrt(I)<=s},D=y.filter(t=>t.category===N.Instrument),R=[],X=new Set(d.filter(t=>t.type===te.Note).map(t=>`${t.from}-${t.to}`));for(const t of D){const s={x:(t.bbox.x1+t.bbox.x2)/2,y:(t.bbox.y1+t.bbox.y2)/2},p=t.bbox.x2-t.bbox.x1,i=t.bbox.y2-t.bbox.y1,v=Math.sqrt(p*p+i*i)/2*3,C=E.filter($=>$.page===t.page&&a($.text)==="Note");for(const $ of C)if(c(s,v,$.bbox,$.text)){const I=`${t.id}-${$.id}`;X.has(I)||(R.push({id:je(),from:t.id,to:$.id,type:te.Note}),X.add(I))}}if(Z.length>0&&M(t=>[...t,...Z]),K.length>0&&T(t=>[...t,...K]),R.length>0&&T(t=>[...t,...R]),G.length>0||R.length>0){const t=[];G.length>0&&t.push(`Extracted ${G.length} note description(s)`),Z.length>0&&t.push(`Created ${Z.length} new description(s)`),R.length>0&&t.push(`Created ${R.length} instrument->note relationship(s)`),K.length>0&&t.push(`Created ${K.length} note->description relationship(s)`),alert(t.join(`
`))}else O.length>0?alert(`기존 설명과 함께 ${O.length}개의 새 노트 & 홀드 연결이 생성되었습니다.`):alert("현재 데이터로 새 노트 & 홀드 연결을 찾을 수 없습니다.")})},[y,f,d,he,w,j]);o.useCallback(async()=>{he("모든 자동 연결 기능을 순차적으로 실행합니다: 설명 및 노트 & 홀드. 계속하시겠습니까?",async()=>{try{await new Promise(a=>{(()=>{var Z;const m=y.filter(K=>K.category===N.Instrument),E=(Z=_[N.Instrument])==null?void 0:Z.autoLinkDistance;if(typeof E!="number"||m.length===0){a();return}const S=new Set(d.filter(K=>K.type===te.Annotation).map(K=>K.to)),O=[],G=j.filter(K=>!S.has(K.id));for(const K of G){if(S.has(K.id))continue;const c=m.filter(X=>X.page===K.page);let D=null,R=1/0;for(const X of c){const t={x:(X.bbox.x1+X.bbox.x2)/2,y:(X.bbox.y1+X.bbox.y2)/2},s=St(t.x,t.y,K.bbox);s<=E&&s<R&&(R=s,D=X)}D&&(O.push({id:je(),from:D.id,to:K.id,type:te.Annotation}),S.add(K.id))}O.length>0&&T(K=>[...K,...O]),a()})()}),await new Promise(a=>{(()=>{const m=y.filter(O=>O.category===N.NotesAndHolds),E=new Set(d.filter(O=>O.type===te.Description).map(O=>`${O.from}-${O.to}`)),S=[];for(const O of m){const G=O.text.toLowerCase(),Z=G.includes("note")?"Note":G.includes("hold")?"Hold":null;if(!Z)continue;const K=O.text.match(/\d+/g),c=K?K.map(D=>parseInt(D,10)):[];if(c.length!==0)for(const D of c){const R=f.filter(X=>X.metadata.type===Z&&X.metadata.number===D&&X.metadata.scope==="Specific"&&X.page===O.page);for(const X of R){const t=`${O.id}-${X.id}`;E.has(t)||S.push({id:je(),from:O.id,to:X.id,type:te.Description})}}}S.length>0&&T(O=>[...O,...S]),a()})()}),alert("모든 자동 연결이 성공적으로 완료되었습니다!")}catch(a){alert("자동 연결 중 오류: "+a.message)}})},[y,j,f,d,_,he]),o.useCallback(()=>{},[]),o.useCallback(async()=>{if(!w)return;const a=await Ze(w);await tt(w,L,a,Q)},[w,Ze,tt,L,Q]),o.useCallback(()=>{he("라인 및 계기 태그에서 모든 공백을 제거하시겠습니까? 이 작업은 되돌릴 수 없습니다.",()=>{const a=y.map(m=>m.category===N.Line||m.category===N.Instrument?{...m,text:m.text.replace(/\s/g,"")}:m);x(a);const l=y.filter(m=>(m.category===N.Line||m.category===N.Instrument)&&m.text.includes(" ")).length;alert(`${l}개의 라인 및 계기 태그에서 공백이 제거되었습니다.`)})},[y,he]);const be=o.useCallback(a=>{const l=a.trim(),m=l.match(/^([A-Z]{1,4})-?(\d+)[\s]*([A-Z]*)$/);if(m)return{function:m[1].trim(),number:parseInt(m[2]),suffix:m[3].trim()};const E=l.match(/^([A-Z]{1,4})(\d+)([A-Z]*)$/);return E?{function:E[1].trim(),number:parseInt(E[2]),suffix:E[3].trim()}:null},[]),Se=o.useCallback(a=>{if(a.length===0)return null;const l=a[0],m=be(l.text);if(!m)return l.text.charAt(0)+"-000";let E=m.function;for(const S of a.slice(1)){const O=be(S.text);if(O&&O.number===m.number){let G=0;for(;G<E.length&&G<O.function.length&&E[G]===O.function[G];)G++;E=E.substring(0,G)}}return E.length===0&&(E=m.function.charAt(0)),`${E}-${m.number}`},[be]),Ee=o.useCallback(a=>{const l=a.filter(S=>S.category===N.Instrument);if(l.length===0)return;const m=new Map;for(const S of l){const O=be(S.text);if(!O)continue;const G=`${O.function.charAt(0)}-${O.number}`;m.has(G)||m.set(G,[]),m.get(G).push(S)}const E=[];m.forEach(S=>{if(S.length>1){const O=Se(S);if(O){const G={id:O,tagIds:S.map(Z=>Z.id),createdAt:new Date().toISOString(),isAutoGenerated:!0};E.push(G)}}}),E.length>0&&A(S=>[...S,...E])},[be,Se]),rt=o.useCallback(a=>{const l=y.filter(m=>m.category===N.Instrument&&(a?m.page===a:!0));if(l.length===0){alert("루프를 생성할 계기 태그를 찾을 수 없습니다.");return}he(`기능 접두사와 번호 매칭을 기반으로 ${l.length}개의 계기 태그에서 루프를 자동으로 생성합니다. 계속하시겠습니까?`,()=>{const m=new Map;for(const G of l){const Z=be(G.text);if(!Z)continue;const K=`${Z.function.charAt(0)}-${Z.number}`;m.has(K)||m.set(K,[]),m.get(K).push(G)}const E=m,S=[],O=new Set(k.map(G=>G.id));for(const[G,Z]of E.entries())if(Z.length>1){const K=Se(Z)||G;if(O.has(K))continue;S.push({id:K,tagIds:Z.map(c=>c.id),createdAt:new Date().toISOString(),isAutoGenerated:!0})}S.length>0?(A(G=>[...G,...S]),alert(`${S.reduce((G,Z)=>G+Z.tagIds.length,0)}개의 계기 태그로부터 ${S.length}개의 새 루프가 생성되었습니다.`)):alert("새 루프를 생성할 수 없습니다. 이미 존재하거나 일치하는 그룹을 찾을 수 없습니다.")})},[y,k,be,Se,he]),vt=o.useCallback(a=>{const l=y.filter(O=>a.includes(O.id)&&O.category===N.Instrument);if(l.length<2){alert("루프를 생성하려면 최소 2개 이상의 계기 태그를 선택해주세요.");return}const m=Se(l);if(!m){alert("선택한 태그에서 루프 ID를 생성할 수 없습니다.");return}if(k.find(O=>O.id===m)){alert(`Loop "${m}" already exists.`);return}const S={id:m,tagIds:l.map(O=>O.id),createdAt:new Date().toISOString(),isAutoGenerated:!1};A(O=>[...O,S]),alert(`Created loop "${m}" with ${l.length} instrument tags.`)},[y,k,Se]),kt=o.useCallback(a=>{A(l=>l.filter(m=>!a.includes(m.id)))},[]),jt=o.useCallback((a,l,m,E)=>{A(S=>S.map(G=>G.id===a?{...G,name:l,tagIds:m}:G).filter(G=>G.tagIds&&G.tagIds.length>0))},[]),ue=()=>B?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-900",children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-10 w-10 text-sky-400",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),e.jsx("p",{className:"mt-4 text-lg",children:"Processing PDF..."}),e.jsxs("p",{className:"text-gray-600",children:["Page ",W.current," of ",W.total]})]}):n&&w?e.jsx(Ot,{fallback:e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center text-red-600",children:[e.jsx("p",{className:"mb-4",children:"Error loading workspace. Please try refreshing the page."}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Reload"})]})}),children:e.jsx(Vn,{pdfDoc:w,tags:y,setTags:x,relationships:d,setRelationships:T,rawTextItems:j,descriptions:f,setDescriptions:M,loops:k,setLoops:A,detectedLines:z,appSettings:Q,onCreateTag:st,onCreateManualTag:Ae,onCreateDescription:Ye,onCreateHoldDescription:xe,onDeleteTags:ct,onUpdateTagText:ot,onDeleteDescriptions:At,onUpdateDescription:Ne,onMergeRawTextItems:We,onDeleteRawTextItems:Nt,onUpdateRawTextItemText:ze,onAutoLinkDescriptions:gt,onAutoLinkNotesAndHolds:dt,onAutoGenerateLoops:rt,onManualCreateLoop:vt,onDeleteLoops:kt,onUpdateLoop:jt,showConfirmation:he,currentPage:ce,setCurrentPage:Y,scale:ae,setScale:me,mode:De,setMode:Le,relationshipStartTag:ke,setRelationshipStartTag:fe,showRelationships:Te,setShowRelationships:Me,visibilitySettings:Ce,updateVisibilitySettings:lt,showAutoLinkRanges:Pe,tolerances:_,toggleTagVisibility:mt,toggleRelationshipVisibility:Be,toggleAllTags:nt,toggleAllRelationships:ht,showAllRelationships:Re,setShowAllRelationships:Fe,showOnlySelectedRelationships:ge,setShowOnlySelectedRelationships:g,isSidePanelVisible:it,colorSettings:ve})}):e.jsx(Ot,{fallback:e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center text-red-300",children:[e.jsx("p",{className:"mb-4",children:"Error loading file upload. Please refresh the page."}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Reload"})]})}),children:e.jsx(Cn,{onFileSelect:Lt})});return e.jsxs("div",{className:"flex flex-col h-screen bg-gray-50 font-sans",children:[U&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6 max-w-md w-full mx-4 shadow-lg",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"자동 최적화"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:H.message}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-sky-500 h-2 rounded-full transition-all duration-300",style:{width:`${H.percent}%`}})}),e.jsxs("div",{className:"text-xs text-slate-400 text-right",children:[Math.round(H.percent),"%"]})]})]})}),e.jsx(Ot,{fallback:e.jsx("div",{className:"h-16 bg-white border-b border-gray-200 flex items-center justify-center",children:e.jsx("p",{className:"text-red-300",children:"Error loading header"})}),children:e.jsx(Bn,{hasData:!!n,onOpenSettings:()=>le(!0),pdfDoc:w,currentPage:ce,setCurrentPage:Y,onToggleSidePanel:()=>et(a=>!a)})}),e.jsx("main",{className:"flex-grow overflow-hidden",children:ue()}),re&&e.jsx(Ot,{fallback:e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-lg",children:[e.jsx("p",{className:"text-red-300 mb-4",children:"Error loading settings modal"}),e.jsx("button",{onClick:()=>le(!1),className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Close"})]})}),children:e.jsx(Yn,{patterns:L,tolerances:_,appSettings:Q,colorSettings:ve,onSaveOnly:xt,onSaveAndRescan:pt,onClose:()=>le(!1)})}),e.jsx(us,{isOpen:ie.isOpen,message:ie.message,onConfirm:ut,onCancel:at})]})};wn.createRoot(document.getElementById("root")).render(e.jsx(Qe.StrictMode,{children:e.jsx(Ot,{children:e.jsx(xs,{})})}));
